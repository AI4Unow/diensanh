This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.claude/
  settings.local.json
data/
  vector_store/
    index.pkl
  debug_national_portal.html
docs/
  code-standards.md
  codebase-summary.md
  project-overview-pdr.md
  project-roadmap.md
  system-architecture.md
plans/
  260115-2249-diensanh-commune-management-app/
    research/
      researcher-01-pwa-offline-patterns.md
      researcher-02-sms-api-abstraction.md
    phase-01-foundation-auth-setup.md
    phase-02-firestore-schema-security.md
    phase-03-admin-dashboard-navigation.md
    phase-04-village-management.md
    phase-05-household-resident-management.md
    phase-06-sms-messaging-system.md
    phase-07-task-assignment.md
    phase-08-public-portal-chatbot.md
    phase-09-pwa-offline-support.md
    phase-10-testing-deployment.md
    plan.md
  260116-0900-ui-ux-polish-quickwins/
    research/
      researcher-01-color-typography.md
      researcher-02-interactions-loading.md
    phase-01-typography-fonts.md
    phase-02-color-tokens.md
    phase-03-micro-interactions.md
    phase-04-quick-ux-fixes.md
    plan.md
  reports/
    scout-260116-0937-docs-verification.md
scripts/
  seed-villages.ts
src/
  api/
    __init__.py
    api-server.py
  scraper/
    __init__.py
    dichvucong-scraper.py
    mainsite-scraper.py
  widget/
    chat-widget.html
    chatbot-embed.js
  __init__.py
  config.py
  vector-store.py
web/
  plans/
    reports/
      code-reviewer-260116-0919-ui-ux-polish-quick-wins.md
  public/
    icons/
      icon-128x128.png
      icon-144x144.png
      icon-152x152.png
      icon-192x192.png
      icon-384x384.png
      icon-512x512.png
      icon-72x72.png
      icon-96x96.png
      icon-base.svg
    manifest.json
    offline.html
    sw.js
    vite.svg
  src/
    assets/
      react.svg
    components/
      auth/
        login-form.tsx
      dashboard/
        activity-feed.tsx
        pending-tasks.tsx
        quick-actions.tsx
        stats-card.tsx
        stats-grid.tsx
      layout/
        admin-layout.tsx
        mobile-nav.tsx
        offline-banner.tsx
        sidebar.tsx
        top-navbar.tsx
      ui/
        spinner.tsx
    config/
      firebase.ts
    contexts/
      auth-context.tsx
    hooks/
      use-auth-mutations.ts
      use-auth.ts
      use-dashboard-stats.ts
      use-households.ts
      use-network-status.ts
      use-residents.ts
      use-sms.ts
      use-tasks.ts
      use-villages.ts
    lib/
      sms/
        index.ts
        mock-provider.ts
        types.ts
      encryption.ts
      utils.ts
    pages/
      admin/
        households/
          [householdId].tsx
          form.tsx
          index.tsx
        residents/
          form.tsx
        sms/
          compose-modal.tsx
          index.tsx
        tasks/
          [taskId].tsx
          form.tsx
          index.tsx
        villages/
          [villageId].tsx
          index.tsx
        dashboard.tsx
      portal/
        announcements.tsx
        chatbot.tsx
        index.tsx
        request-form.tsx
      village/
        dashboard.tsx
      dashboard.tsx
      login.tsx
      not-found.tsx
    routes/
      index.tsx
    styles/
      globals.css
    types/
      index.ts
    App.css
    App.tsx
    index.css
    main.tsx
  tests/
    e2e/
      lib/
        test-utils.sh
      test-screenshots/
        announcements-094602.png
        announcements-095357.png
        announcements-100859.png
        announcements-101121.png
        announcements-101305.png
        chatbot-faq-address-094614.png
        chatbot-faq-address-095410.png
        chatbot-faq-address-100912.png
        chatbot-faq-address-101134.png
        chatbot-faq-address-101318.png
        chatbot-faq-birth-094617.png
        chatbot-faq-birth-095412.png
        chatbot-faq-birth-100914.png
        chatbot-faq-birth-101137.png
        chatbot-faq-birth-101320.png
        chatbot-faq-hours-094612.png
        chatbot-faq-hours-095408.png
        chatbot-faq-hours-100909.png
        chatbot-faq-hours-101132.png
        chatbot-faq-hours-101315.png
        chatbot-greeting-094610.png
        chatbot-greeting-095405.png
        chatbot-greeting-100907.png
        chatbot-greeting-101130.png
        chatbot-greeting-101313.png
        chatbot-initial-094606.png
        chatbot-initial-095402.png
        chatbot-initial-100903.png
        chatbot-initial-101126.png
        chatbot-initial-101309.png
        chatbot-unknown-094619.png
        chatbot-unknown-095414.png
        chatbot-unknown-100916.png
        chatbot-unknown-101139.png
        chatbot-unknown-101322.png
        login-page-094649.png
        login-phone-entered-094653.png
        portal-home-094559.png
        portal-home-095354.png
        portal-home-100854.png
        portal-home-101118.png
        portal-home-101301.png
        protected-admin-redirect-094715.png
        request-form-filled-094636.png
        request-form-filled-095432.png
        request-form-filled-100937.png
        request-form-filled-101205.png
        request-form-filled-101339.png
        request-form-initial-094622.png
        request-form-initial-095417.png
        request-form-initial-100919.png
        request-form-initial-101142.png
        request-form-initial-101325.png
        request-form-validation-094625.png
        request-form-validation-095420.png
        request-form-validation-100925.png
        request-form-validation-101154.png
        request-form-validation-101327.png
        root-redirect-094657.png
        smoke-test-final-094546.png
      run-all-tests.sh
      simulation-test.sh
      test-a11y-perf.sh
      test-auth.sh
      test-navigation.sh
      test-portal.sh
  .env.example
  .gitignore
  eslint.config.js
  firestore.indexes.json
  firestore.rules
  index.html
  package.json
  README.md
  tsconfig.app.json
  tsconfig.json
  tsconfig.node.json
  vercel.json
  vite.config.ts
.env.example
.firebaserc
.gitignore
CLAUDE.md
DANH SÁCH 18 THÔN VÀ 02 KHU DÂN CƯ XÃ DIÊN SANH.docx
Đề xuất một số phần mềm tại xã Diên Sanh.docx
firebase.json
firestore.indexes.json
firestore.rules
requirements.txt
run.sh
setup.sh
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".claude/settings.local.json">
{
  "permissions": {
    "allow": [
      "Bash(ls:*)",
      "Bash(find:*)",
      "mcp__plugin_firebase_firebase__firebase_get_environment",
      "Bash(python3:*)",
      "mcp__plugin_firebase_firebase__firebase_init",
      "mcp__plugin_firebase_firebase__firebase_list_projects",
      "Bash(\"/Users/nad/My Drive \\(duc.a.nguyen@gmail.com\\)/diensanh/.env\")",
      "Bash(\"/Users/nad/My Drive \\(duc.a.nguyen@gmail.com\\)/diensanh/.env.local\")",
      "Bash(wc:*)",
      "Bash(node:*)",
      "Bash(npm run build)",
      "Bash(npx tsc:*)",
      "Bash(npm run typecheck)",
      "Bash(repomix:*)"
    ]
  }
}
</file>

<file path="data/debug_national_portal.html">
<!DOCTYPE html><html><head> 
  <meta charset="UTF-8"> 
  <title>Cổng Dịch vụ công Quốc gia</title> 
  <meta content="width=device-width, initial-scale=1" name="viewport" id="viewport">  
  <meta name="description" content="Cổng Dịch vụ công Quốc gia hỗ trợ thông tin, đăng ký thủ tục hành chính như đổi giấy phép lái xe, nộp thuế điện tử, thông báo khuyến mại, cấp lại thẻ BHYT, cấp điện mới..."> 
  <meta content="IE=edge" http-equiv="X-UA-Compatible">  
  <meta content="width=device-width, initial-scale=1" name="viewport" id="viewport">  
  <meta content="index, follow" name="ROBOTS"> 
  <link rel="stylesheet" href="theme/vendor/font-awesome/css/font-awesome.min.css"> 
  <link rel="stylesheet" type="text/css" href="theme/vendor/ap8/css/style.css"> 
  <link rel="stylesheet" type="text/css" href="theme/vendor/slick/slick.css"> 
  <link rel="stylesheet" href="vendor/bootstrap/css/bootstrap.min.css"> 
  <link rel="stylesheet" href="theme/vendor/typeahead/style.css"> 
  <link rel="stylesheet" href="vendor/toastr/toastr.min.css"> 
  <link rel="stylesheet" href="vendor/bootstrap/css/bootstrapValidator.min.css"> 
  <link rel="stylesheet" type="text/css" href="theme/vendor/swiper/css/swiper.min.css"> 
  <link rel="stylesheet" href="vendor/bootstrap-datepicker/css/bootstrap-datepicker.min.css"> 
  <link rel="stylesheet" href="vendor/bootstrap-timepicker/css/timepicker.css"> 
  <link rel="stylesheet" href="theme/css/style.css?version=9"> 
  <link rel="shortcut icon" href="img/header/quoc_huy.png"> 
  <script type="text/javascript" src="theme/vendor/jquery/jquery.2.1.1.min.js"></script> 
  <script type="text/javascript" src="theme/vendor/bootstrap/js/bootstrap.min.js"></script> 
  <script type="text/javascript" src="vendor/bootstrap/js/bootstrapValidator.js"></script> 
  <script type="text/javascript" src="theme/vendor/slick/slick.min.js"></script> 
  <script type="text/javascript" src="theme/vendor/highchart/highcharts.js"></script> 
  <script type="text/javascript" src="theme/vendor/highchart/modules/variable-pie.js"></script> 
  <script type="text/javascript" src="theme/vendor/highchart/highcharts-more.js"></script> 
  <script type="text/javascript" src="vendor/toastr/toastr.min.js"></script> 
  <script type="text/javascript" src="vendor/slimscroll/jquery.slimscroll.min.js"></script> 
  <script type="text/javascript" src="vendor/jq-paginator.js"></script> 
  <script type="text/javascript" src="vendor/bootbox.all.min.js"></script> 
  <script type="text/javascript" src="vendor/select2.min.js"></script> 
  <script type="text/javascript" src="vendor/mime.js"></script> 
  <script type="text/javascript" src="vendor/jquery/jquery-iframe-auto-height.min.js"></script> 
  <script type="text/javascript" src="vendor/jquery/jquery.browser.js"></script> 
  <link rel="stylesheet" href="vendor/select2.min.css"> 
  <script src="./js/ApiService.js?version=18"></script> 
  <script src="./js/CommonUtil.js?version=16"></script> 
  <script src="./js/Constants.js"></script> 
  <script type="text/javascript" src="vendor/typeahead/index.js"></script> 
  <script type="text/javascript" src="vendor/typeahead/handlebars.js"></script> 
  <script type="text/javascript" src="vendor/bootstrap-datepicker/js/bootstrap-datepicker.min.js"></script> 
  <script type="text/javascript" src="vendor/bootstrap-timepicker/js/bootstrap-timepicker.js"></script> 
  <script src="./js/base64.js"></script> 
  <script type="text/javascript" src="vendor/d3.v4.min.js"></script> 
  <script>
		initApiService();
	</script> 
 </head> 
 <body> 
  <div class="loading-all" id="loading-all" style="display:none"> 
   <div class="icon"> 
    <img src="img/loading.png" alt=""> 
    <span style="color:blue">Đang xử lý...<span> </span></span>
   </div> 
   <style type="text/css">
			.loading-all {
				position: fixed;
				top: 0px;
				left: 0px;
				right: 0px;
				bottom: 0px;
				z-index: 10000;
				background: #dbdcdc40;
			}
			.loading-all .icon {
				width: 100px;
				position: absolute;
				top: 0px;
				height: 100px;
				bottom: 0px;
				right: 0px;
				margin: auto;
				left: 0px;
			}

		</style> 
  </div> 
  <!--DEFINE CONSTANT --> 
  <!--END CONSTANT--> 
  <div class="overlay-common"></div> 
  <!-- /mtv/ Log propertise--> 
  <div class="header"> 
   <div class="container"> 
    <div class="relative content"> 
     <div class="logo-text"> 
      <a href="https://dichvucong.gov.vn/p/home/dvc-trang-chu.html" class="logo"> <img src="theme/img/header/logo.png" alt=""> </a> 
     </div> 
     <div class="nav-toggle"> 
      <span class="-ap icon icon-menu"></span> 
     </div> 
     <!-- <div class="header-account">
					<div class="buttons">
						<a href="https://dangky.dichvucong.gov.vn/register" class="btn btn-login">Đăng ký</a>
						<a href="https://xacthuc.dichvucong.gov.vn/oauth2/authorize?response_type=code&client_id=Np0ahpF4exnI6DS_4KuMK_TLHLEa&scope=openid&redirect_uri=https://dichvucong.gov.vn/p/home/dvc-trang-chu.html" class="btn btn-register">Đăng nhập</a>
					</div>
				</div> --> 
    </div> 
   </div> 
  </div> 
  <nav class="header-nav"> 
   <div class="container"> 
    <ul id="main-menu" class="pull-left menus"> 
     <li id="home-page"><a href="https://dichvucong.gov.vn/p/home/dvc-trang-chu.html"><span class="-ap icon icon-home4"></span></a></li> 
     <li><a href="dvc-tthc-trang-chu.html">Tra cứu TTHC</a></li> 
     <li class="active"><a href="dvc-tthc-thu-tuc-hanh-chinh.html">Thủ tục hành chính</a></li> 
     <li><a href="dvc-tthc-thu-tuc-hanh-chinh-lien-thong.html">Thủ tục hành chính liên thông</a></li> 
     <li><a href="dvc-tthc-quyet-dinh-cong-bo.html">Quyết định công bố</a></li> 
     <li><a href="dvc-tthc-co-quan.html">Cơ quan</a></li> 
     <!-- <li><a href="dvc-gioi-thieu.html">Giới thiệu</a></li>
				<li>
					<a href="#">Thông tin và dịch vụ</a>
					<ul class="dropdown-menu">
						<li><a href="dvc-trang-chu-cong-dan.html">Công dân</a></li>
						<li><a href="dvc-trang-chu-doanh-nghiep.html">Doanh nghiệp</a></li>
						<li><a href="dvc-dich-vu-cong-truc-tuyen.html">Dịch vụ công trực tuyến</a></li>
						<li><a href="dvc-dich-vu-cong-noi-bat.html">Dịch vụ công nổi bật</a></li>
						<li><a href="dvc-tra-cuu-ho-so.html">Tra cứu hồ sơ</a></li>
						<li><a href="dvc-tra-cuu-ban-an.html">Tòa án nhân dân</a></li>
						<li><a href="dvc-cau-hoi-pho-bien.html">Câu hỏi thường gặp</a></li>
					</ul>
				</li> --> 
     <!-- <li>
					<a href="dvc-thanh-toan-truc-tuyen.html">Thanh toán trực tuyến</a> --> 
     <!-- <ul class="dropdown-menu">
						<li><a href="dvc-thanh-toan.html">Nộp thuế doanh nghiệp</a></li>
						<li><a href="dvc-thanh-toan-thue-ca-nhan.html">Nộp thuế cá nhân/Trước bạ</a></li>
						<li>
							<a href="#">Thanh toán vi phạm hành chính</a>
							<ul class="dropdown-menu">
								<li><a href="dvc-thanh-toan-vi-pham-giao-thong.html">Tra cứu/Thanh toán vi phạm giao thông</a></li>
								<li><a href="dvc-thanh-toan-vi-pham-xay-dung.html">Tra cứu/Thanh toán vi phạm xây dựng</a></li>
							</ul>
						</li>
						<li><a href="dvc-thanh-toan-phi-le-phi-ho-so.html">Thanh toán phí/lệ phí dịch vụ công</a></li>
						<li><a href="dvc-thanh-toan-bhxh-bhyt.html">Đóng tiếp BHXH tự nguyện, gia hạn BHYT</a></li>
						<li><a href="dvc-thanh-toan-bhxh-doanh-nghiep.html">Đóng BHXH, BHYT, BHTN, BHTNLĐ-BNN</a></li>
						<li><a href="dvc-thanh-toan-thue-dat-dai.html">Thanh toán nghĩa vụ tài chính về đất đai</a></li>
						<li><a href="dvc-thanh-toan-dien.html">Thanh toán tiền điện</a></li>
						<li><a href="dvc-thanh-toan-vien-phi.html">Thanh toán viện phí</a></li>
						<li><a href="dvc-thanh-toan-an-phi.html">Thanh toán tạm ứng án phí</a></li>
					</ul> --> 
     <!-- </li> --> 
     <!-- <li>
				  <a href="#">Phản ánh kiến nghị</a>
				  <ul class="dropdown-menu">
					<li><a href="/p/phananhkiennghi/pakn-gui-pakn.html">Gửi PAKN</a></li>
					<li><a href="/p/phananhkiennghi/pakn-search.html">Tra cứu kết quả trả lời</a></li>
				  </ul>
				</li> --> 
     <!-- <li> --> 
     <!-- <a href="#">Thủ tục hành chính</a> --> 
     <!-- <ul class="dropdown-menu"> --> 
     <!-- <li><a href="https://thutuc.dichvucong.gov.vn/p/home/dvc-tthc-trang-chu.html">Tra cứu TTHC</a></li>
					<li><a href="https://thutuc.dichvucong.gov.vn/p/home/dvc-tthc-thu-tuc-hanh-chinh.html">Thủ tục hành chính</a></li>
					<li><a href="https://thutuc.dichvucong.gov.vn/p/home/dvc-tthc-thu-tuc-hanh-chinh-lien-thong.html">Thủ tục hành chính liên thông</a></li>
					<li><a href="https://thutuc.dichvucong.gov.vn/p/home/dvc-tthc-quyet-dinh-cong-bo.html">Quyết định công bố</a></li>
					<li><a href="https://thutuc.dichvucong.gov.vn/p/home/dvc-tthc-co-quan.html">Cơ quan</a></li> --> 
     <!-- <li id="coquan"><a href="dvc-tthc-co-quan.html">Cơ quan</a></li>
					<li hidden id="bn-ttp"><a href="dvc-tthc-bonganh-tinhtp.html">TTHC Bộ ngành Tỉnh thành phố</a></li> --> 
     <!-- </ul> --> 
     <!-- </li> --> 
     <!-- <li class="">
					<a href="#">Hỗ trợ</a>
					<ul class="dropdown-menu">
						<li><a href="dvc-dieu-khoan-su-dung.html">Điều khoản sử dụng</a></li>
						<li><a href="dvc-huong-dan-cong-dan-doanh-nghiep.html">Hướng dẫn sử dụng</a></li>
						<li><a href="dvc-tin-tuc.html">Thông báo</a></li>
					</ul>
				</li> --> 
    </ul> 
    <div class="header-account mobile-ds"> 
     <!-- <div class="buttons">
					<a href="https://xacthuc.dichvucong.gov.vn/oauth2/authorize?response_type=code&client_id=Np0ahpF4exnI6DS_4KuMK_TLHLEa&scope=openid&redirect_uri=https://dichvucong.gov.vn/p/home/dvc-trang-chu.html" class="btn btn-login">Đăng nhập</a>
					<a href="https://dangky.dichvucong.gov.vn/register" class="btn btn-register">Đăng ký</a>
				</div> --> 
    </div> 
   </div> 
  </nav> 
  <div class="header-bottom"> 
   <div class="container"> 
    <ul id="list-dropdown"> 
    </ul> 
   </div> 
  </div> 
 


  
  
  <cache id="seach" type="cache5"> 
   <style>
    .selection > span {
        font-size: 18px;
    }
    .select2-results {
        font-size: 18px;
    }
	.select2-container--default .select2-selection--single .select2-selection__rendered {
        color: #8F969C;
    }
</style> 
   <div class="tthc"> 
    <div class="section-tthc"> 
     <div class="container"> 
      <ul class="breadcrumb"> 
       <li><a href="dvc-tthc-trang-chu.html">Trang chủ</a></li> 
       <li><a href="#">Thủ tục hành chính</a></li> 
      </ul> 
      <div class="row"> 
       <div class="col-sm-9 col-xs-12"> 
        <div class="box-search -adv"> 
         <input type="text" class="form-control" placeholder="Nhập từ khoá tìm kiếm" id="input-keyword"> 
         <div class="adv">
           Tìm kiếm nâng cao 
         </div> 
         <button id="btn-search" class="btn btn-search"> <span class="-ap icon-search icon"></span> Tìm kiếm </button> 
        </div> 
        <div class="box form-horizontal -child" id="searchAdv"> 
         <div class="form-group"> 
          <div class="col-sm-3 col-xs-12"> 
           <div class="label-text control-label">
             Tìm theo: 
           </div> 
          </div> 
          <div class="col-sm-9 col-xs-12"> 
           <div class="check-action "> 
            <input type="radio" class="check" name="radio-main" value="0" checked=""> 
            <span class="name">Bộ/ Ban/ Ngành</span> 
           </div> 
           <div class="check-action marl20"> 
            <input type="radio" class="check" name="radio-main" value="1"> 
            <span class="name">Tỉnh/ Thành phố</span> 
           </div> 
          </div> 
         </div> 
         <div class="form-group"> 
          <div class="col-sm-3 col-xs-12"> 
           <div class="label-text control-label">
             Cơ quan thực hiện 
           </div> 
          </div> 
          <div class="col-sm-3 col-xs-12"> 
           <div class="select-custom"> 
            <select name="" id="select-implementation-agency" class="form-control"> <option value="-1">-- Chọn cơ quan --</option> </select> 
           </div> 
          </div> 
          <div class="col-sm-3 col-xs-12"> 
           <div class="label-text control-label">
             Lĩnh vực 
           </div> 
          </div> 
          <div class="col-sm-3 col-xs-12"> 
           <div class="select-custom"> 
            <select name="" id="select-field" class="form-control"> <option value="-1">-- Chọn lĩnh vực --</option> </select> 
           </div> 
          </div> 
         </div> 
         <div class="form-group"> 
          <div class="col-sm-3 col-xs-12"> 
           <div class="label-text control-label">
             Cấp thực hiện 
           </div> 
          </div> 
          <div class="col-sm-3 col-xs-12"> 
           <div class="select-custom"> 
            <select name="" id="select-level" class="form-control select2-hidden-accessible" tabindex="-1" aria-hidden="true"><option value="-1">-- Chọn cấp thực hiện --</option>
                            <option value="1">-- Cấp Tỉnh --</option>
                            <option value="3">-- Cấp Xã --</option></select><span class="select2 select2-container select2-container--default" dir="ltr" style="width: 100%;"><span class="selection"><span class="select2-selection select2-selection--single" role="combobox" aria-haspopup="true" aria-expanded="false" tabindex="0" aria-labelledby="select2-select-level-container"><span class="select2-selection__rendered" id="select2-select-level-container" title="-- Chọn cấp thực hiện --">-- Chọn cấp thực hiện --</span><span class="select2-selection__arrow" role="presentation"><b role="presentation"></b></span></span></span><span class="dropdown-wrapper" aria-hidden="true"></span></span> 
           </div> 
          </div> 
          <div class="col-sm-3 col-xs-12"> 
           <div class="label-text control-label">
             Đối tượng thực hiện 
           </div> 
          </div> 
          <div class="col-sm-3 col-xs-12"> 
           <div class="select-custom"> 
            <select name="" id="select-object" class="form-control select2-hidden-accessible" tabindex="-1" aria-hidden="true"><option value="-1">-- Chọn đối tượng  --</option><option value="4">Cán bộ, công chức, viên chức</option><option value="1">Công dân Việt Nam</option><option value="5">Doanh nghiệp</option><option value="6">Doanh nghiệp có vốn đầu tư nước ngoài</option><option value="16642">Đảng viên</option><option value="9">Hợp tác xã</option><option value="3">Người nước ngoài</option><option value="2">Người Việt Nam định cư ở nước ngoài</option><option value="16622">Tổ chức Đảng</option><option value="7">Tổ chức (không bao gồm doanh nghiệp, HTX)</option><option value="8">Tổ chức nước ngoài</option></select><span class="select2 select2-container select2-container--default" dir="ltr" style="width: 100%;"><span class="selection"><span class="select2-selection select2-selection--single" role="combobox" aria-haspopup="true" aria-expanded="false" tabindex="0" aria-labelledby="select2-select-object-container"><span class="select2-selection__rendered" id="select2-select-object-container" title="-- Chọn đối tượng  --">-- Chọn đối tượng  --</span><span class="select2-selection__arrow" role="presentation"><b role="presentation"></b></span></span></span><span class="dropdown-wrapper" aria-hidden="true"></span></span> 
           </div> 
          </div> 
         </div> 
        </div> 
        <div class="divider-gray"></div> 
        <div class="box-form-result"> 
         <div class="pull-left"> 
          <h2 class="main-title-sub" id="title-search-result">Thủ tục hành chính mới</h2> 
         </div> 
         <div class="pull-right"> 
          <div class="text-result"> 
           <a href="javascript:exportExel();" title="Tải xuống danh sách thủ tục"><i class="fa fa-2x fa-file-excel-o" aria-hidden="true" style="color:green"></i></a> 
          </div> 
         </div> 
         <div class="clearfix"></div> 
        </div> 
        <div class="table-content"> 
         <table id="table-main" class="table-result table" style="width:100%;"> 
          <thead> 
           <tr> 
            <th style="text-align: center; width: 10%; height: 40px;">Mã số</th> 
            <th style="text-align: center; width: 42%;">Tên</th> 
            <th style="text-align: center; width: 17%;">Cơ quan ban hành</th> 
            <th style="text-align: center; width: 17%;">Cơ quan thực hiện</th> 
            <th style="text-align: center; width: 14%;">Lĩnh vực</th> 
           </tr> 
          </thead> 
          <tbody><tr></tr><tr><td class="nowrap" data-title="Mã số"><a href="dvc-tthc-thu-tuc-hanh-chinh-chi-tiet.html?ma_thu_tuc=423057"><span class="link thick">2.002823</span></a></td><td data-title="Tên">Thủ tục vay vốn hỗ trợ tạo việc làm, duy trì, mở rộng việc làm đối với người lao động</td><td data-title="Cơ quan ban hành" class="tleft">Ngân hàng Chính sách xã hội</td><td data-title="Cơ quan thực hiện" class="tleft">Ngân hàng Chính sách xã hội</td><td data-title="Lĩnh vực" class="tleft">Hoạt động tín dụng</td></tr><tr><td class="nowrap" data-title="Mã số"><a href="dvc-tthc-thu-tuc-hanh-chinh-chi-tiet.html?ma_thu_tuc=423053"><span class="link thick">2.002822</span></a></td><td data-title="Tên">Thủ tục vay vốn hỗ trợ tạo việc làm, duy trì, mở rộng việc làm đối với cơ sở sản xuất, kinh doanh (Doanh nghiệp nhỏ và vừa, hợp tác xã, tổ hợp tác, liên hiệp hợp tác xã, hộ kinh doanh)</td><td data-title="Cơ quan ban hành" class="tleft">Ngân hàng Chính sách xã hội</td><td data-title="Cơ quan thực hiện" class="tleft">Ngân hàng Chính sách xã hội</td><td data-title="Lĩnh vực" class="tleft">Hoạt động tín dụng</td></tr><tr><td class="nowrap" data-title="Mã số"><a href="dvc-tthc-thu-tuc-hanh-chinh-chi-tiet.html?ma_thu_tuc=422041"><span class="link thick">2.002818</span></a></td><td data-title="Tên">Chấp thuận tổ chức đủ điều kiện là Trung tâm thanh toán bù trừ</td><td data-title="Cơ quan ban hành" class="tleft">Bộ Công thương</td><td data-title="Cơ quan thực hiện" class="tleft">Ban Quản lý Khu kinh tế</td><td data-title="Lĩnh vực" class="tleft">Sở giao dịch hàng hóa</td></tr><tr><td class="nowrap" data-title="Mã số"><a href="dvc-tthc-thu-tuc-hanh-chinh-chi-tiet.html?ma_thu_tuc=422040"><span class="link thick">2.002817</span></a></td><td data-title="Tên">Cấp lại Giấy phép thành lập Sở giao dịch hàng hóa trong Trung tâm tài chính quốc tế tại Việt Nam</td><td data-title="Cơ quan ban hành" class="tleft">Bộ Công thương</td><td data-title="Cơ quan thực hiện" class="tleft">Ban Quản lý Khu kinh tế</td><td data-title="Lĩnh vực" class="tleft">Sở giao dịch hàng hóa</td></tr><tr><td class="nowrap" data-title="Mã số"><a href="dvc-tthc-thu-tuc-hanh-chinh-chi-tiet.html?ma_thu_tuc=421984"><span class="link thick">1.014572</span></a></td><td data-title="Tên">Cấp sửa đổi, bổ sung Giấy phép thành lập Sở giao dịch hàng hóa trong Trung tâm tài chính quốc tế tại Việt Nam</td><td data-title="Cơ quan ban hành" class="tleft">Bộ Công thương</td><td data-title="Cơ quan thực hiện" class="tleft">Ban Quản lý Khu kinh tế</td><td data-title="Lĩnh vực" class="tleft">Sở giao dịch hàng hóa</td></tr><tr><td class="nowrap" data-title="Mã số"><a href="dvc-tthc-thu-tuc-hanh-chinh-chi-tiet.html?ma_thu_tuc=421983"><span class="link thick">1.014571</span></a></td><td data-title="Tên">Cấp Giấy phép thành lập Sở giao dịch hàng hóa trong Trung tâm tài chính quốc tế tại Việt Nam</td><td data-title="Cơ quan ban hành" class="tleft">Bộ Công thương</td><td data-title="Cơ quan thực hiện" class="tleft">Ban Quản lý Khu kinh tế</td><td data-title="Lĩnh vực" class="tleft">Sở giao dịch hàng hóa</td></tr><tr><td class="nowrap" data-title="Mã số"><a href="dvc-tthc-thu-tuc-hanh-chinh-chi-tiet.html?ma_thu_tuc=421772"><span class="link thick">1.014567</span></a></td><td data-title="Tên">Đề nghị thu hồi giấy tờ trong trường hợp có căn cứ xác định nội dung kê khai trong hồ sơ đăng ký kinh doanh của tổ chức khoa học và công nghệ là giả mạo</td><td data-title="Cơ quan ban hành" class="tleft">Bộ Tài chính</td><td data-title="Cơ quan thực hiện" class="tleft">Sở Tài chính các tỉnh, thành phố, Ban quản lý khu công nghiệp, khu kinh tế, khu chế xuất, khu công nghệ cao các tỉnh, thành phố</td><td data-title="Lĩnh vực" class="tleft">Khoa học công nghệ</td></tr><tr><td class="nowrap" data-title="Mã số"><a href="dvc-tthc-thu-tuc-hanh-chinh-chi-tiet.html?ma_thu_tuc=421735"><span class="link thick">1.014566</span></a></td><td data-title="Tên">Đăng ký tạm ngừng kinh doanh, tiếp tục kinh doanh trước thời hạn đã đăng ký, chấm dứt kinh doanh của tổ chức khoa học và công nghệ, chi nhánh của tổ chức khoa học và công nghệ</td><td data-title="Cơ quan ban hành" class="tleft">Bộ Tài chính</td><td data-title="Cơ quan thực hiện" class="tleft">Sở Tài chính các tỉnh, thành phố, Ban quản lý khu công nghiệp, khu kinh tế, khu chế xuất, khu công nghệ cao các tỉnh, thành phố</td><td data-title="Lĩnh vực" class="tleft">Khoa học công nghệ</td></tr><tr><td class="nowrap" data-title="Mã số"><a href="dvc-tthc-thu-tuc-hanh-chinh-chi-tiet.html?ma_thu_tuc=421734"><span class="link thick">1.014565</span></a></td><td data-title="Tên">Đăng ký kinh doanh lần đầu, đăng ký thay đổi nội dung đăng ký kinh doanh, đăng ký cấp lại, hiệu đính thông tin đăng ký kinh doanh của tổ chức khoa học công nghệ, chi nhánh của tổ chức khoa học công nghệ</td><td data-title="Cơ quan ban hành" class="tleft">Bộ Tài chính</td><td data-title="Cơ quan thực hiện" class="tleft">Sở Tài chính các tỉnh, thành phố, Ban quản lý khu công nghiệp, khu kinh tế, khu chế xuất, khu công nghệ cao các tỉnh, thành phố</td><td data-title="Lĩnh vực" class="tleft">Khoa học công nghệ</td></tr><tr><td class="nowrap" data-title="Mã số"><a href="dvc-tthc-thu-tuc-hanh-chinh-chi-tiet.html?ma_thu_tuc=421661"><span class="link thick">1.014564</span></a></td><td data-title="Tên">Thủ tục cấp phép cho công dân Việt Nam định cư ở nước ngoài vào, ra Cảng quốc tế Cam Ranh</td><td data-title="Cơ quan ban hành" class="tleft">Bộ Quốc phòng</td><td data-title="Cơ quan thực hiện" class="tleft">Quân chủng Hải quân</td><td data-title="Lĩnh vực" class="tleft">Bảo vệ công trình quốc phòng và khu quân sự</td></tr></tbody> 
         </table> 
        </div> 
        <!-- <div class="tab-content">
							<div class="tab-pane active" id="tthct">
								<div class="table-content">
										<table id="table-main" class="table-result table" style="width:100%;">
										<thead>
											<th style="text-align: center; width: 10%; height: 40px;">Mã số</th>
											<th style="text-align: center; width: 42%;">Tên</th>
											<th style="text-align: center; width: 17%;">Cơ quan ban hành</th>
											<th style="text-align: center; width: 17%;">Cơ quan thực hiện</th>
											<th style="text-align: center; width: 14%;">Lĩnh vực</th>
										</thead>
										<tbody>
											<tr></tr>
										</tbody>
									</table>
								</div>
							</div>
					</div> --> 
        <div class="divider-gray"></div> 
        <div id="paginationPanel" class="bottom" hidden="" style="display: block;"> 
         <div class="pull-left mart10"> 
          <span class="text">Số hàng mỗi trang</span> 
          <div class="select-custom inline"> 
           <select name="" id="paginationRecsPerPage" class="form-control"> <option value="5">5</option> <option value="10" selected="">10</option> <option value="20">20</option> <option value="50">50</option> </select> 
          </div> 
         </div> 
         <div class="pull-right"> 
          <ul id="paginationTableDVC" class="pagination" style="display: none;"> 
          </ul> 
         </div> 
         <div class="clearfix"></div> 
        </div> 
       </div> 
       <div class="col-sm-3 col-xs-12"> 
        <div class="sidebar"> 
         <div class="head">
          Tìm kiếm nhiều nhất
         </div> 
         <div class="body"> 
          <ul class="links"> 
           <li> <a class="link" href="dvc-tthc-thu-tuc-hanh-chinh-chi-tiet.html?ma_thu_tuc=1480" title="Cấp Giấy xác nhận nhân sự của công dân Việt Nam ở nước ngoài (thực hiện tại cấp Trung ương)">Cấp Giấy xác nhận nhân sự của công dân Việt Nam ở nước ngoài (thực hiện tại cấp Trung ương)</a> <p class="unit">Bộ Công an</p> </li> 
           <li> <a class="link" href="dvc-tthc-thu-tuc-hanh-chinh-chi-tiet.html?ma_thu_tuc=1330" title="Cấp giấy phép xuất khẩu, nhập khẩu hóa chất Bảng 1">Cấp giấy phép xuất khẩu, nhập khẩu hóa chất Bảng 1</a> <p class="unit">Bộ Công thương</p> </li> 
           <li> <a class="link" href="dvc-tthc-thu-tuc-hanh-chinh-chi-tiet.html?ma_thu_tuc=1399" title="Cấp lại Giấy phép thành lập Văn phòng đại diện của thương nhân nước ngoài tại Việt Nam">Cấp lại Giấy phép thành lập Văn phòng đại diện của thương nhân nước ngoài tại Việt Nam</a> <p class="unit">Bộ Công thương</p> </li> 
           <li> <a class="link" href="dvc-tthc-thu-tuc-hanh-chinh-chi-tiet.html?ma_thu_tuc=1393" title="Cấp lại giấy phép hoạt động dự báo, cảnh báo khí tượng thủy văn (cấp tỉnh)">Cấp lại giấy phép hoạt động dự báo, cảnh báo khí tượng thủy văn (cấp tỉnh)</a> <p class="unit">Bộ Nông nghiệp và Môi trường</p> </li> 
           <li> <a class="link" href="dvc-tthc-thu-tuc-hanh-chinh-chi-tiet.html?ma_thu_tuc=1243" title="Thủ tục cấp Giấy chứng nhận đủ điều kiện kinh doanh hoạt động thể thao đối với môn Judo">Thủ tục cấp Giấy chứng nhận đủ điều kiện kinh doanh hoạt động thể thao đối với môn Judo</a> <p class="unit">Bộ Văn hóa, Thể thao và Du lịch</p> </li> 
           <li> <a class="link" href="dvc-tthc-thu-tuc-hanh-chinh-chi-tiet.html?ma_thu_tuc=1241" title="Thủ tục cấp Giấy miễn thị thực tại Cơ quan đại diện VIệt Nam ở nước ngoài">Thủ tục cấp Giấy miễn thị thực tại Cơ quan đại diện VIệt Nam ở nước ngoài</a> <p class="unit">Bộ Ngoại giao</p> </li> 
           <li> <a class="link" href="dvc-tthc-thu-tuc-hanh-chinh-chi-tiet.html?ma_thu_tuc=1484" title="Thủ tục gia hạn Giấy chứng nhận đăng ký thành lập và hoạt động của cơ sở văn hóa nước ngoài tại Việt Nam">Thủ tục gia hạn Giấy chứng nhận đăng ký thành lập và hoạt động của cơ sở văn hóa nước ngoài tại Việt Nam</a> <p class="unit">Bộ Văn hóa, Thể thao và Du lịch</p> </li> 
           <li> <a class="link" href="dvc-tthc-thu-tuc-hanh-chinh-chi-tiet.html?ma_thu_tuc=1338" title="Thủ tục phê duyệt cho hộ nghèo, hộ cận nghèo, hộ mới thoát nghèo bị rủi ro do nguyên nhân khách quan vay bổ sung vốn để khôi phục sản xuất, kinh doanh">Thủ tục phê duyệt cho hộ nghèo, hộ cận nghèo, hộ mới thoát nghèo bị rủi ro do nguyên nhân khách quan vay bổ sung vốn để khôi phục sản xuất, kinh doanh</a> <p class="unit">Ngân hàng Chính sách xã hội</p> </li> 
           <li> <a class="link" href="dvc-tthc-thu-tuc-hanh-chinh-chi-tiet.html?ma_thu_tuc=1483" title="Thủ tục trả nợ, trả lãi trực tiếp bằng tiền mặt của người vay là tổ viên Tổ Tiết kiệm và vay vốn">Thủ tục trả nợ, trả lãi trực tiếp bằng tiền mặt của người vay là tổ viên Tổ Tiết kiệm và vay vốn</a> <p class="unit">Ngân hàng Chính sách xã hội</p> </li> 
           <li> <a class="link" href="dvc-tthc-thu-tuc-hanh-chinh-chi-tiet.html?ma_thu_tuc=1392" title="Trả lại giấy phép nhận chìm (cấp tỉnh)">Trả lại giấy phép nhận chìm (cấp tỉnh)</a> <p class="unit">Bộ Nông nghiệp và Môi trường</p> </li> 
          </ul> 
         </div> 
        </div> 
        <!-- <div class="sidebar -statis">
    <div class="head">Số liệu thống kê </div>
    <div class="body">
                <div class="info">
            <span class="value" style="color: #7C964C;">
                                5711
                            </span>
            <div class="key">Tổng số TTHC</div>
        </div>
        <div class="divider-gray" style="margin: 10px 0px;"></div>
        <div class="info">
            <span class="value" style="color: #F2A634;">
                                2878
                            </span>
            <div class="key">TTHC thực hiện tại Bộ, cơ quan</div>
        </div>
        <div class="divider-gray" style="margin: 10px 0px;"></div>
        <div class="info">
            <span class="value" style="color: #F2A634;">
                                968
                            </span>
            <div class="key">TTHC thực hiện tại địa phương</div>
        </div>
        <div class="divider-gray" style="margin: 10px 0px;"></div>
        <div class="info">
            <span class="value" style="color: #F2A634;">
                                1608
                            </span>
            <div class="key">TTHC ngành dọc tại địa phương</div>
        </div>
    </div>
</div> --> 
       </div> 
      </div> 
     </div> 
    </div> 
   </div> 
   <script>

		var searchedAmount = 0;
		var currentPage = 1;
		var recordPerPage = 10;

		var isAdvancedSearch = false;
	
		var isFirstLoad = true;
		var isComboboxesLoaded = false;
	
		$(document).ready(() => {
			$("#li-tthc").addClass("active");
	
			$("input[type=radio][name='radio-main']").change(function() {
				
				var agencyTypeId = $("input[name = 'radio-main']:checked").val();
				if (agencyTypeId == 0) {
                    $("#select-level").val("-1");
					$('#select-level').select2().trigger('change');
                    $("#select-level").prop('disabled', 'disabled');
                } else {
                    $("#select-level").prop('disabled', false);
                }
				loadListObject();
				loadListAgency(agencyTypeId, 2);
			});
	
			$("#select-implementation-agency").change(() => {
				
				var agencyId = $("#select-implementation-agency").val();
				loadListField(agencyId);
			});
	
			$("#input-keyword").keypress(event => {
				var keycode = (event.keyCode ? event.keyCode : event.which);
				if(keycode == '13'){
					onAdvancedSearch(1);
					doSearchWhenNotFoundInBONGANH();
				}
			});
	
			$("#btn-search").click(() => {
				onAdvancedSearch(1);
				doSearchWhenNotFoundInBONGANH();
			});
	
			$("#paginationRecsPerPage").change(() => {
				recordPerPageAfterChanged = Number.parseInt($("#paginationRecsPerPage").val(), 10);
				// currentPage = Math.ceil(currentPage * recordPerPage / recordPerPageAfterChanged);
				currentPage = Math.ceil(((currentPage - 1) * recordPerPage + 1) / recordPerPageAfterChanged);
				recordPerPage = recordPerPageAfterChanged;
				// onAdvancedSearch(currentPage);
				onAdvancedSearchSessionStorage(currentPage);
			});
	
			// isFirstLoad = false;
			// $("input[name='radio-main']").change();
			// $("input[name='radio-main']").on('change', function() {}).filter(':checked').trigger('change');
			$(".box-search .adv").click(function() {
				if (!isComboboxesLoaded) {
					$("input[name='radio-main']").on('change', function() {}).filter(':checked').trigger('change');
					isComboboxesLoaded = true;
				}
			});
	
			loadListObject();
	
			loadListImplLevel();
	
			firstLoad();
		});
	
		function loadNewProcedures() {
	
			var obj = new Object();
			obj.service = "procedure_get_new_procs_service_v2";
            // obj.service = "procedure_advanced_search_service";
            
			obj.provider = "dvcquocgia";
			obj.type = "ref";
	
			obj.is_connected = 0;
			obj.records = recordPerPage;
	
			var result = apiservice.AjaxJson.executeQuery(obj);
	
			dataToView(result);
			$("#title-search-result").html("Thủ tục hành chính mới");
		}
	
		function onAdvancedSearch(pageIndex) {
	
			currentPage = pageIndex;
	
			var obj = new Object();
			obj.service = "procedure_advanced_search_service_v2";
			obj.provider = "dvcquocgia";
			obj.type = "ref";
	
			obj.recordPerPage = recordPerPage;
			obj.pageIndex = pageIndex;
	
			obj.is_connected = 0;
			obj.keyword = $("#input-keyword").val().trim();
			obj.agency_type = $("input[name = 'radio-main']:checked").val();
			// obj.publish_agency_id = $("#select-publishing-agency").val();
			obj.impl_agency_id = $("#select-implementation-agency").val();
			obj.object_id = $("#select-object").val();
			obj.field_id = $("#select-field").val();
			obj.impl_level_id = $('#select-level').val();
			
			
			var jsonObj = JSON.stringify(obj);
			sessionStorage.setItem("obj",jsonObj);

			var result = apiservice.AjaxJson.executeQuery(obj);
		
	
			// if (result && result.length > 0)
			dataToView(result);
		}
	
		function onAdvancedSearchSessionStorage(pageIndex) {
	
			currentPage = pageIndex;
			let jsonObj = sessionStorage.getItem("obj");
			let objSessionStorage = JSON.parse(jsonObj) ;

			var obj = new Object();
			obj.service = "procedure_advanced_search_service_v2";
			obj.provider = "dvcquocgia";
			obj.type = "ref";

			obj.recordPerPage = recordPerPage;
			obj.pageIndex = pageIndex;

			obj.is_connected = 0;
			obj.keyword = objSessionStorage.keyword;
			obj.agency_type = objSessionStorage.agency_type;
			// obj.publish_agency_id = $("#select-publishing-agency").val();
			obj.impl_agency_id = objSessionStorage.impl_agency_id;
			obj.object_id = objSessionStorage.object_id;
			obj.field_id = objSessionStorage.field_id;
			obj.impl_level_id = objSessionStorage.impl_level_id;
			
			var result = apiservice.AjaxJson.executeQuery(obj);

			// if (result && result.length > 0)
			dataToView(result);
			
		}


		function loadListAgency(agencyTypeId, roleType) {
			var obj = new Object();
			// obj.service = "procedure_get_list_agency_by_role_type_service";
			obj.service = "procedure_get_list_agency_by_type_service_v2";
			obj.provider = "dvcquocgia";
			obj.type = "ref";
	
			obj.loaicoquan = agencyTypeId;
			// obj.role_type = roleType;
	
			var result = apiservice.AjaxJson.executeQuery(obj);
	
	
			var htmlText = '<option value="-1">-- Chọn cơ quan  --</option>';
			if (result && result.length > 0) {
	
				result.forEach(item => {
					htmlText += '<option value="' + item.ID + '">' + item.NAME + '</option>'
				});
			}
	
			if (roleType === 1) {
				$("#select-publishing-agency").html(htmlText);
				$('#select-publishing-agency').select2({
					width: "100%"
				});
	
			} else if (roleType === 2) {
				$("#select-implementation-agency").html(htmlText);
				$('#select-implementation-agency').select2({
					width: "100%"
				});
			}
	
			// if (!isFirstLoad)    
			$("#select-implementation-agency").change();
	
		}
	
		function loadListObject() {
			var obj = new Object();
			obj.service = "procedure_get_list_object_service_v2";
			obj.provider = "dvcquocgia";
			obj.type = "ref";
	
			obj.recordPerPage = 100;
			obj.pageIndex = 1;
	
			var result = apiservice.AjaxJson.executeQuery(obj);
	
	
			var htmlText = '<option value="-1">-- Chọn đối tượng  --</option>';
			if (result && result.length > 0) {
	
				result.forEach(item => {
					htmlText += '<option value="' + item.ID + '">' + item.NAME + '</option>'
				});
			}
	
			$("#select-object").html(htmlText);
			$('#select-object').select2({
				width: "100%"
			});
	
		}
	
		function loadListField(agencyId) {
			var obj = new Object();
			obj.service = "procedure_get_list_field_service_v2";
			obj.provider = "dvcquocgia";
			obj.type = "ref";
	
			obj.agency_id = agencyId;
			// obj.recordPerPage = 100;
			// obj.pageIndex = 1;
	
			var result = apiservice.AjaxJson.executeQuery(obj);
	
	
			var htmlText = '<option value="-1">-- Chọn lĩnh vực  --</option>';
			if (result && result.length > 0) {
	
				result.forEach(item => {
					htmlText += '<option value="' + item.ID + '">' + item.FIELD_NAME + '</option>'
				});
			}
	
			$("#select-field").html(htmlText);
			$('#select-field').select2({
				width: "100%"
			});
	
		}
	
		// function loadListImplLevel() {
		// 	var obj = new Object();
		// 	obj.service = "get_list_impl_level_service";
		// 	obj.provider = "dvcquocgia";
		// 	obj.type = "ref";
	
		// 	var result = apiservice.AjaxJson.executeQuery(obj);
	
	
		// 	var htmlText = '<option value="-1">-- Chọn cấp thực hiện --</option>';
		// 	if (result && result.length > 0) {
	
		// 		result.forEach(item => {
		// 			htmlText += '<option value="' + item.ID + '">' + item.NAME + '</option>'
		// 		});
		// 	}
	
		// 	$("#select-level").html(htmlText);
		// 	$('#select-level').select2({
		// 		width: "100%"
		// 	});
	
		// }

		function loadListImplLevel() {
            var htmlText = `<option value="-1">-- Chọn cấp thực hiện --</option>
                            <option value="1">-- Cấp Tỉnh --</option>
                            <option value="3">-- Cấp Xã --</option>`;
    
            $("#select-level").html(htmlText);
			$('#select-level').select2({
				width: "100%"
			});
    
        }
	
		function agencyListToString(list) {
	
			var ret = '';
			list.forEach(item => {
				ret += ', ' + item.NAME;
			});
	
			return ret.substring(2);
		}
	
		// function getAgenciesByProcId(procedureId, type) {
	
		// 	var obj = new Object();
		// 	obj.service = "get_agencies_name_by_proc_id_service";
		// 	obj.provider = "dvcquocgia";
		// 	obj.type = "ref";
	
		// 	obj.procedure_id = procedureId;
		// 	obj.map_agency_type = type;
	
		// 	var result = apiservice.AjaxJson.executeQuery(obj);
	
		// 	return agencyListToString(result);
		// }
	
		function dataToView(result) {
	
			$("#table-main > tbody").html("<tr></tr>");
			$("#paginationPanel").hide();
	
			if (result && result.length > 0) {
	
				searchedAmount = result[0].AMOUNT;
	
				var htmlText = '';
				result.forEach(item => {
	
					//var implementationAgency = getAgenciesByProcId(item.ID, 2);
					
					$('#table-main tr:last').after('<tr><td class="nowrap" data-title="Mã số"><a href="dvc-tthc-thu-tuc-hanh-chinh-chi-tiet.html?ma_thu_tuc=' + item.ID + '"><span class="link thick">' //
						+ item.PROCEDURE_CODE + '</span></a></td><td data-title="Tên">' //
						+ item.PROCEDURE_NAME + '</td><td data-title="Cơ quan ban hành" class="tleft">' //
						+ item.PUBLISHED_AGENCY + '</td><td data-title="Cơ quan thực hiện" class="tleft">' //
						+ item.IMPLEMENTATION_AGENCY + '</td><td data-title="Lĩnh vực" class="tleft">' //
						+ item.FIELD_NAME + '</td></tr>');
				});
	
				loadPagination(parseInt(searchedAmount, 10), currentPage, "paginationTableDVC", "doChangePageTableDVC", [], recordPerPage);
	
			} else {
				searchedAmount = 0;
				loadPagination(1, currentPage, "paginationTableDVC", "doChangePageTableDVC", [], recordPerPage);
			}
	
			$("#title-search-result").html("Danh sách thủ tục hành chính (" + searchedAmount + ")");
	
			// if (searchedAmount > recordPerPage)
			if (searchedAmount > 0)
					$("#paginationPanel").show();
		}
	
		function firstLoad() {
	
			var pSearchLienThong = getUrlParameter('loai_tthc');
			if (pSearchLienThong != undefined) {

				let currentRadioValue = $("input[name='radio-main']").val();
				if ((getUrlParameter('tinh_bo')) == '1')
					$("input[name='radio-main'][value='1']").prop('checked', true);
				else
					$("input[name='radio-main'][value='0']").prop('checked', true);
				// $("input[name='radio-main']").change(); // load lại combobox
				if (getUrlParameter('tinh_bo') != currentRadioValue)
					$("input[name='radio-main']").on('change', function() { console.log('on change called FIRST LOAD') }).filter(':checked').trigger('change');
	
				$("#input-keyword").val(getUrlParameter('tu_khoa'));
	
				// $("#select-object").val(getUrlParameter('doi_tuong_thuc_hien') ? getUrlParameter('doi_tuong_thuc_hien') : '-1');
				// $('#select-object').select2().trigger('change');
	
				// $("#select-implementation-agency").val(getUrlParameter('co_quan_cong_bo') ? getUrlParameter('co_quan_cong_bo') : '-1');
				// $('#select-implementation-agency').select2().trigger('change');
				var paramAgency = getUrlParameter('co_quan_cong_bo'); // không triggle change agency => không load lại field nếu agency_id = -1 (tức tìm kiếm với tất cả agency)
				if (paramAgency != '-1') {
					$("#select-implementation-agency").val(paramAgency ? paramAgency : '-1');
					$('#select-implementation-agency').select2().trigger('change');
				}
				
				

				$("#select-field").val(getUrlParameter('linh_vuc') ? getUrlParameter('linh_vuc') : '-1');
				$('#select-field').select2().trigger('change');
	
				$('#select-level').val(getUrlParameter('cap_thuc_hien') ? getUrlParameter('cap_thuc_hien') : '-1');
				$('#select-level').select2().trigger('change');
	
				$(".adv").click();
				
				$("#select-implementation-agency").val(paramAgency ? paramAgency : '-1');
				$('#select-implementation-agency').select2().trigger('change');

				$("#select-field").val(getUrlParameter('linh_vuc') ? getUrlParameter('linh_vuc') : '-1');
				$('#select-field').select2().trigger('change');

				$("#select-object").val(getUrlParameter('doi_tuong_thuc_hien') ? getUrlParameter('doi_tuong_thuc_hien') : '-1');
				$('#select-object').select2().trigger('change');
				onAdvancedSearch(1);
				doSearchWhenNotFoundInBONGANH();

				// let currentRadioValue = $("input[name='radio-main']").val();

				// if ((getUrlParameter('tinh_bo')) == '1')
				// 	$("input[name='radio-main'][value='1']").prop('checked', true);
				// else
				// 	$("input[name='radio-main'][value='0']").prop('checked', true);
				// $("input[name='radio-main']").change(); // load lại combobox
	
				// $("#input-keyword").val(getUrlParameter('tu_khoa'));
	
				// $("#select-object").val(getUrlParameter('doi_tuong_thuc_hien') ? getUrlParameter('doi_tuong_thuc_hien') : '-1');
				// $('#select-object').select2().trigger('change');
	
				// $("#select-implementation-agency").val(getUrlParameter('co_quan_cong_bo') ? getUrlParameter('co_quan_cong_bo') : '-1');
				// $('#select-implementation-agency').select2().trigger('change');
	
				// $("#select-field").val(getUrlParameter('linh_vuc') ? getUrlParameter('linh_vuc') : '-1');
				// $('#select-field').select2().trigger('change');
	
				// $('#select-level').val(getUrlParameter('cap_thuc_hien') ? getUrlParameter('cap_thuc_hien') : '-1');
				// $('#select-level').select2().trigger('change');
	

			
			} else {
				loadNewProcedures();
			}
		}

		function doSearchWhenNotFoundInBONGANH() {
			if (searchedAmount == 0 && !isAdvancedSearch) {
				//tìm trong tỉnh tp
				$("input[name='radio-main'][value='1']").prop('checked', true);
				onAdvancedSearch(1);
				$("input[name='radio-main'][value='0']").prop('checked', true);
			}
		}
	
		let searchParams = new URLSearchParams(window.location.search);
		function getUrlParameter(sParam) {
			return searchParams.get(sParam);
		}
	
		function doChangePageTableDVC(currentPage) {
			onAdvancedSearchSessionStorage(currentPage);
			// onAdvancedSearch(currentPage);
		}
	
		function changePagination(tabNo) {
			if (tabNo == 1) {
				$('#paginationDVCChoTiepNhan').hide();
				$('#paginationDVCHoanThanh').show();
			} else {
				$('#paginationDVCHoanThanh').hide();
				$('#paginationDVCChoTiepNhan').show();
			}
		}

		function clearSearchForm() {
            $("input[name='radio-main'][value='0']").prop('checked', true);

            $("#select-implementation-agency").val('-1');
            $('#select-implementation-agency').select2().trigger('change');
            
            $("#select-field").val('-1');
            $('#select-field').select2().trigger('change');

            $("#select-object").val('-1');
            $('#select-object').select2().trigger('change');
            
            $('#select-level').val('-1');
            $('#select-level').select2().trigger('change');
            
            $('#select-procedure-type').val('-1');
                
        }

	</script> 
   <script type="text/javascript">
		$(".box-search .adv").click(function(){
			if($(this).hasClass("active")){
				$(this).removeClass("active");
				$(this).text("Tìm kiếm nâng cao");
				$("#searchAdv").removeClass("show");
                $(".hero-banner").removeClass("showAdv");
                isAdvancedSearch = false;
                clearSearchForm();
			}else{
				$(this).addClass("active");
				$(this).text("Tìm kiếm rút gọn");
				$("#searchAdv").addClass("show");	
                $(".hero-banner").addClass("showAdv");
                isAdvancedSearch = true;
            }
            console.log('isAdvancedSearch', isAdvancedSearch);
		})
	</script> 
   <script>
	function exportExel() {
		var obj = new Object();
        obj.is_connected = 0;
		obj.keyword = $("#input-keyword").val().trim();
		obj.agency_type = $("input[name = 'radio-main']:checked").val();
		// obj.publish_agency_id = $("#select-publishing-agency").val();
		obj.impl_agency_id = $("#select-implementation-agency").val();
		obj.object_id = $("#select-object").val();
		obj.field_id = $("#select-field").val();
		obj.impl_level_id = $('#select-level').val();

		if ( obj.impl_agency_id == -1 ) {
			toastr.warning('Vui lòng chọn "Cơ quan thực hiện" trong vùng Tìm kiếm nâng cao!');
			return;
		}

		var url = '/jsp/tthc/export/export_exel_list_tthc.jsp?'
					+ 'is_connected=' + obj.is_connected
					+ '&keyword=' + obj.keyword
					+ '&agency_type=' + obj.agency_type
					+ '&impl_agency_id=' + obj.impl_agency_id
					+ '&object_id=' + obj.object_id
					+ '&field_id=' + obj.field_id
					+ '&impl_level_id=' + obj.impl_level_id;
		window.open(url, "_self");
	}
</script> 
  </cache>  
 

 
 
  <div class="loading" id="loading" style="display:none"> 
   <div class="icon"> 
    <img src="img/loading.svg" alt=""> 
   </div> 
   <style type="text/css">
			.loading {
				position: absolute;
				top: 0px;
				left: 0px;
				right: 0px;
				bottom: 0px;
				z-index: 1000;
			}
			.loading .icon {
				width: 100px;
				position: absolute;
				top: 0px;
				height: 100px;
				bottom: 0px;
				right: 0px;
				margin: auto;
				left: 0px;
			}

		</style> 
  </div> 
  <footer class="footer"> 
   <div class="footer-bottom"> 
    <div class="container"> 
     <div class="add"> 
      <p>Cơ quan chủ quản: Văn phòng Chính phủ</p> 
     </div> 
     <div class="add"> 
      <p>www.dichvucong.gov.vn</p> 
     </div> 
     <div class="add"> 
      <p>Tổng đài hỗ trợ: 18001096</p> 
     </div> 
     <div class="add"> 
      <p> Email: dichvucong@chinhphu.vn</p> 
     </div> 
    </div> 
   </div> 
  </footer> 
  <script type="text/javascript" src="theme/vendor/typeahead/index.js"></script> 
  <script type="text/javascript" src="theme/vendor/typeahead/handlebars.js"></script> 
  <script type="text/javascript" src="theme/js/custom.js"></script> 
  <script type="text/javascript">
    function showLoading() {
        $("#loading-all").show();
    }
    function hideLoading(){
        $("#loading-all").hide();
    }

    function goToPage(url){
        window.location.href = url;
    }

    $(".targetgroup-box .btn-readmore").click(function(e){
        e.preventDefault();
        if($(this).hasClass("active")){
            $(this).html('Xem tiếp <span class="-ap icon-chevron-thin-down icon"></span>');
            $(this).parents(".targetgroup-box").find(".links").css({"height":"250px"});
            $(this).removeClass("active");
        }else{
            $(this).html('Thu gọn <span class="-ap icon-chevron-thin-up icon"></span>');
            $(this).parents(".targetgroup-box").find(".links").css({"height":"auto"});
            $(this).addClass("active");
        }
    });
    var links = [
            
        ];


    function searchProcedure(){
        var key = getWords($("#searchKeyWord").val(), 100);
		console.log(key);
        // if($("#searchKeyWord").val()) {
        var href = 'dvc-ket-qua-thu-tuc.html?originKey=' + encodeURIComponent(key) + '&tukhoa=' + key.replace(/[&\/\\#,+()$~%'":*?<>{}^]/g, ' ').trim() + '&tinh_thanh=';
        window.location.href = href;
        //}
    }

function showAdvSearch() {
    getLocation("dvcqg_get_tinh_thanh_by_selected_v2", null, null, "cboTINH_THANH");
}

function doAdvSearch(){

    let mess = '';
    let keyWord = $('#txtKEYWORD').val().trim();
    keyWord = getWords(keyWord, 100);
    if (!keyWord) {
        mess += 'Bạn vui lòng nhập từ khóa tìm kiếm!\n';
    }
    let tinhThanhValue = $('#cboTINH_THANH').val();
    let boNganhValue = $('#cboBO_NGANH').val();
    var rdoBO = $("input[name='cap_thuc_hien']:checked").val();

    if (((!tinhThanhValue || '-1' == tinhThanhValue) && rdoBO != 'bonganh') || (rdoBO == 'bonganh' && (!boNganhValue || '-1' == boNganhValue))) {
        mess += 'Bạn phải chọn ít nhất một Tỉnh/ Thành phố hoặc một Bộ ngành!\n';
    }

    if (mess) {
        toastr.warning(mess);
        return;
    }

    var rdoSO = $("input[name='quan_huyen_or_so']:checked").val();
    if (rdoBO != 'bonganh' && $('#cboTINH_THANH').val() && $('#cboTINH_THANH').val() != '-1' && ($('#cboQUAN_HUYEN').val() == '-1' || !$('#cboQUAN_HUYEN').val()) && ($('#cboSO').val() == '-1' || !$('#cboSO').val()) && ($('#cboPHUONG_XA').val() == '-1' || !$('#cboPHUONG_XA').val())) {

        var params = 'originKey=' + encodeURIComponent(keyWord) + '&tukhoa=' + keyWord.replace(/[&\/\\#,+()$~%'":*?<>{}^]/g,' ').trim()
        params+= "&tinh_thanh="+(($('#cboTINH_THANH').val() == '-1' || !$('#cboTINH_THANH').val()  || rdoBO == 'bonganh') ? "" : $('#cboTINH_THANH option:selected').text());
        window.location = 'dvc-ket-qua-thu-tuc.html?' + params;
    } else {

        var params = "tu_khoa=" + keyWord;
        //params += "&bo_nganh="+(($('#cboBO').val() != '-1' || !$('#cboBO').val() || rdoBO != 'bonganh') ? "" : $('#cboBO option:selected').text());
        params += "&bo_nganh=" + ($('#cboBO_NGANH option:selected').text());
        params += "&tinh_thanh=" + (($('#cboTINH_THANH').val() == '-1' || !$('#cboTINH_THANH').val() || rdoBO == 'bonganh') ? "" : $('#cboTINH_THANH option:selected').text());
        params += "&so=" + (($('#cboSO').val() == '-1' || !$('#cboSO').val() || rdoSO != 'so') ? "" : $('#cboSO option:selected').text());
        params += "&quan_huyen=" + (($('#cboQUAN_HUYEN').val() == '-1' || !$('#cboQUAN_HUYEN').val() || rdoSO == 'so') ? "" : $('#cboQUAN_HUYEN option:selected').text());
        params += "&phuong_xa=" + (($('#cboPHUONG_XA').val() == '-1' || !$('#cboPHUONG_XA').val() || rdoSO == 'so') ? "" : $('#cboPHUONG_XA option:selected').text());
        params += "&id_tinh_thanh=" + $('#cboTINH_THANH').val();
        params += "&id_quan_huyen=" + $('#cboQUAN_HUYEN').val();
        params += "&id_phuong_xa=" + $('#cboPHUONG_XA').val();
        params += "&id_so=" + $('#cboSO').val();
        params += "&id_bo_nganh=" + $('#cboBO_NGANH').val();
        window.location = 'dvc-danh-sach-dich-vu-cong.html?' + params;
    }

    $('#advsearch').modal('hide');
}
$(document).ready(function(){
    $("#searchKeyWord").keyup(function (e){
        if (e.which == 13) {
            searchProcedure();
        }
    });
    bindEvent();
});

function changeHeight(){
    var vl = 1 - $('#popupChange').attr('height');
    $('#popupChange').attr('height', vl);
    $('#popupChange').css('height', vl + "px");
}

function bindEvent(){
    $('#searchKeyWord').keydown(function(e){
        if (e.keyCode == 13) {
            searchProcedure();
        }
    });
    $('#advsearch').on('hidden.bs.modal', function () {
        $('#divClosePopupSearch').click();
    });
    $('#divClosePopupSearch').click(function(){
        $("#txtKEYWORD").val('');
        $('#rdoTINH_THANH').click();
        $('#rdoQUAN_HUYEN').click();
        $("#cboTINH_THANH").change();
        getLocation("dvcqg_get_phuong_xa_by_selected", "huyen_id", -1, "cboPHUONG_XA");
        $('#advsearch').modal('hide');

    });

    $('#rdoTINH_THANH').click(function(){
        changeHeight();
        $('#hide_for_bo_nganh').show();
        $('#cboBO_NGANH').select2().next().hide();
        $('#cboTINH_THANH').select2().next().show();
        getLocation("dvcqg_get_tinh_thanh_by_selected_v2", null, null, "cboTINH_THANH");
        getLocation("dvcqg_get_quan_huyen_by_selected_v2", "tinh_id", -1, "cboQUAN_HUYEN");
        getLocation("dvcqg_get_so_by_selected_v2", "tinh_id", -1, "cboSO");
        getLocation("dvcqg_get_phuong_xa_by_selected_v2", "huyen_id", -1, "cboPHUONG_XA");
        if ($("input[name='quan_huyen_or_so']:checked").val() == "so") {

            $('#cboQUAN_HUYEN,#cboPHUONG_XA').select2().next().hide();
            $('#cboSO').select2().next().show();
        } else {
            $('#cboQUAN_HUYEN,#cboPHUONG_XA').select2().next().show();
            $('#cboSO').select2().next().hide();

        }
    });
    $('#rdoBO_NGANH').click(function(){
        changeHeight();
        $('#hide_for_bo_nganh').hide();
        $('#cboBO_NGANH').select2().next().show();
        $('#cboTINH_THANH').select2().next().hide();
        getLocation("dvcqg_get_bo_nganh_by_selected_v2", null, null, "cboBO_NGANH");
    });

    $('#rdoQUAN_HUYEN').click(function(){
        $('#cboQUAN_HUYEN,#cboPHUONG_XA').select2().next().show();
        $('#cboSO').select2().next().hide();
        getLocation("dvcqg_get_quan_huyen_by_selected_v2", "tinh_id", $("#cboTINH_THANH").val(), "cboQUAN_HUYEN");
        getLocation("dvcqg_get_phuong_xa_by_selected_v2", "huyen_id", -1, "cboPHUONG_XA");
    });

    $('#rdoSO').click(function(){
        $('#cboQUAN_HUYEN,#cboPHUONG_XA').select2().next().hide();
        $('#cboSO').select2().next().show();
        getLocation("dvcqg_get_so_by_selected_v2", "tinh_id", $("#cboTINH_THANH").val(), "cboSO");
    });

    $("#cboTINH_THANH,#cboQUAN_HUYEN,#cboPHUONG_XA,#cboSO,#cboBO_NGANH").select2({
        allowClear: true,
        width: "100%",
    });
    $('#cboSO,#cboBO_NGANH').select2().next().hide();

    $("#cboTINH_THANH").change(function () {
        getLocation("dvcqg_get_so_by_selected", "tinh_id", $("#cboTINH_THANH").val(), "cboSO");
        getLocation("dvcqg_get_quan_huyen_by_selected_v2", "tinh_id", $("#cboTINH_THANH").val(), "cboQUAN_HUYEN");
        getLocation("dvcqg_get_phuong_xa_by_selected_v2", "huyen_id", -1, "cboPHUONG_XA");
        if ($("input[name='quan_huyen_or_so']:checked").val() == "so") {

            $('#cboQUAN_HUYEN,#cboPHUONG_XA').select2().next().hide();
            $('#cboSO').select2().next().show();
        } else {
            $('#cboQUAN_HUYEN,#cboPHUONG_XA').select2().next().show();
            $('#cboSO').select2().next().hide();

        }

    });
    $("#cboQUAN_HUYEN").change(function () {
        getLocation("dvcqg_get_phuong_xa_by_selected_v2", "huyen_id", $("#cboQUAN_HUYEN").val(), "cboPHUONG_XA");
    });
}

//suggestion search
function sugggestProcedure(keyword) {
    var obj = new Object();
    obj.key_search = 'al:"' + keyword +'"~5';
    obj.page_size = 5;
    obj.start_row = 0;
    obj.source_data = "thu_tuc_v1";
    obj.type = "fts";
    var result = apiservice.AjaxJson.executeQuery(obj);
    var dataMap = result.response.docs.map(function (i) {
        return {
            name: i.ten_thu_tuc,
            link: i.ten_thu_tuc,
            id: i.ma_thu_tuc
        }
    });

    return dataMap;
}

jQuery(document).ready(function($) {

    var engine = new Bloodhound({
        remote: {
            url: '/jsp/procedure-typehead.jsp?keyword=al:"%QUERY%"~5',
            wildcard: '%QUERY%'
        },
        datumTokenizer: Bloodhound.tokenizers.whitespace('keyword'),
        queryTokenizer: Bloodhound.tokenizers.whitespace
    });

    $(".search-input").typeahead({
        hint: true,
        highlight: true,
        minLength: 3
    }, {
        source: engine.ttAdapter(),
        displayKey: 'ten_thu_tuc',
        name: 'usersList',
        templates: {
            empty: [
                '<div class="list-group search-results-dropdown"><div class="list-group-item">Không có kết quả phù hợp.</div></div>'
            ],
            header: [
                '<div class="list-group search-results-dropdown">'
            ],
            suggestion: function (data) {
                console.log(data);
                if (data.isnganhdoc == 1) {
                    return '<a href="dvc-chi-tiet-thu-tuc-nganh-doc.html?ma_thu_tuc=' + data.ma_thu_tuc + '" class="list-group-item">' + data.ten_thu_tuc + '</a>'
                }
                return '<a href="dvc-chi-tiet-thu-tuc-hanh-chinh.html?ma_thu_tuc=' + data.ma_thu_tuc + '" class="list-group-item">' + data.ten_thu_tuc + '</a>'
            }
        }
    });
    $('#searchKeyWord:text:visible:first').focus();
});

</script> 
  <script type="text/javascript">

    //
    function autoSetmenu() {
        var path = window.location.pathname;
        var isRemoveDropdown = false;

        // Cau hoi
        if (path == '/p/home/dvc-chi-tiet-cau-hoi.html'){
            path = '/p/home/dvc-cau-hoi-pho-bien.html';
        }

        // Huong dan su dung
        if (path == '/p/home/dvc-huong-dan-bo-nganh-dia-phuong.html' || path == '/p/home/dvc-phan-mem-ho-tro.html' || path == '/p/home/dvc-thiet-ke-giao-dien.html' ||
            path == '/p/home/dvc-nop-tien-dien.html' || path == '/p/home/dvc-liet-ket-giao-duc.html'
            ){
            path = '/p/dvc-huong-dan-cong-dan-doanh-nghiep.html';
        }

        // Thu tuc hanh hinh cong dan - doanh nghiep
        if (path == '/p/home/dvc-ket-qua-thu-tuc-cho-cong-dan.html'
                || path == '/p/home/dvc-chi-tiet-dich-vu-cho-cong-dan.html'
                || path == '/p/home/dvc-chi-tiet-nhom-su-kien-cho-cong-dan.html'
            ){
            path = '/p/home/dvc-trang-chu-cong-dan.html';
        }else if (path == '/p/home/dvc-ket-qua-thu-tuc-cho-doanh-nghiep.html'
                || path == '/p/home/dvc-chi-tiet-dich-vu-cho-doanh-nghiep.html'
                || path == '/p/home/dvc-chi-tiet-nhom-su-kien-cho-doanh-nghiep.html'
            ){
            path = '/p/home/dvc-trang-chu-doanh-nghiep.html';
        }else if (path == '/p/home/dvc-danh-sach-thu-tuc-theo-nhom-su-kien.html'
                || path == '/p/home/dvc-danh-sach-cau-hoi-theo-nhom-su-kien.html'
            ) {
            var objectId = GetURLParameter('objectId');
            if (objectId == 1){
                path = '/p/home/dvc-trang-chu-cong-dan.html';
            }else if(objectId == 5){
                path = '/p/home/dvc-trang-chu-doanh-nghiep.html';
            }
        }

        // DVC trực tuyến & đăng ký xe
        if (path == '/p/home/dvc-dich-vu-cong-truc-tuyen-ds.html'
                || path == '/p/home/dvc-dich-vu-cong-truc-tuyen.html'
                || path == '/p/home/dvc-dang-ky-xe.html'
            ) {
            path = '/p/home/dvc-dich-vu-cong-truc-tuyen.html';
        }

        // Chi tiet TTHC va DVC
        if (path == '/p/home/dvc-chi-tiet-thu-tuc-hanh-chinh.html' 
                || path == '/p/home/dvc-danh-sach-dich-vu-cong.html'
                || path == '/p/home/dvc-danh-sach-thu-tuc-theo-su-kien.html'
                || path == '/p/home/dvc-ket-qua-thu-tuc.html'
            ) {
            path = '/p/home/dvc-trang-chu-cong-dan.html';
            isRemoveDropdown = true;
        }

        // module TTHC
        if (path == '/p/home/dvc-tthc-category.html') {
            path = '/p/home/dvc-tthc-trang-chu.html';
        }
        if (path == '/p/home/dvc-tthc-thu-tuc-hanh-chinh-chi-tiet.html') {
            path = '/p/home/dvc-tthc-thu-tuc-hanh-chinh.html';
        }
        if (path == '/p/home/dvc-tthc-thu-tuc-hanh-chinh-lien-thong-chi-tiet.html') {
            path = '/p/home/dvc-tthc-thu-tuc-hanh-chinh-lien-thong.html';
        }
        if (path == '/p/home/dvc-tthc-quyet-dinh-cong-bo-chi-tiet.html') {
            path = '/p/home/dvc-tthc-quyet-dinh-cong-bo.html';
        }
        if (path == '/p/home/dvc-tthc-bonganh-tinhtp.html') {
            path = '/p/home/dvc-tthc-co-quan.html';
        }

        if (path == '/p/home/dvc-chi-tiet-tin-tuc.html') {
            path = '/p/home/dvc-tin-tuc.html';
        }

        // dvc-cap-ban-sao-tu-ban-chinh
        if (path == '/p/home/dvc-cap-ban-sao-tu-ban-chinh.html'){
            path = '/p/home/dvc-trang-chu-cong-dan.html';
        }
        //  Đặt lịch hẹn
        if (path == '/p/home/dvc-cap-ban-sao-tu-ban-chinh-dlh.html'){
            path = '/p/home/dvc-tra-cuu-ho-so.html';
        }
        // Active main menu
        $("#main-menu li").each(function () {
            var link = $(this).find(">a").attr("href");
            if (path.indexOf(link) != -1) {
                $(this).parents('li').siblings().removeClass("active");
                $(this).parents('li').addClass("active");
                $(this).parents('li').find("li").removeClass("active");
                $(this).addClass("active");
            }
        });

        // Active dropdownmenu
        $("#main-menu > li").each(function () {
            if ($(this).hasClass("active")) {
                var html = $(this).find(">ul").html();
                $(this).addClass("active");
                $(this).find(">ul").addClass("hidden");
                $("#list-dropdown").html(html);
                if($("#bn-ttp").hasClass("active")){
                    $("#coquan").addClass("active");
                }
            }
        });

        // Remove
        if (isRemoveDropdown) {
            $('#list-dropdown > li').removeClass('active');
        }
    }

    var pathHDSD = window.location.pathname;
    $("#regionleft-introduce li").removeClass('active');
    $("#left-introduce li a").each(function () {
        var href = $(this).attr('href');
        if (pathHDSD.indexOf(href) != -1) {
            $(this).parent().addClass('active');
        }
    });
    $('#left-introduce li:first-child').removeClass('active');
    $('.child-menus a').each(function(){
        var href = $(this).attr('href');
        if (pathHDSD.indexOf(href) != -1) {
            $(this).parent().addClass('active');
        }
    });

    $(document).ready(function(){
        autoSetmenu();
    })


</script> 
  <style>
    .bootbox .modal-footer .btn + .btn {
        margin-bottom: 0;
        margin-left: 5px;
        margin-top: 0px;
    }
    .input-captcha .code .number {
        height: 100%;
        padding: 2px;
    }
</style>   
 
</body></html>
</file>

<file path="docs/code-standards.md">
# Code Standards

## General Principles
- **YAGNI (You Aren't Gonna Need It)**: Do not implement features until they are required.
- **KISS (Keep It Simple, Stupid)**: Prefer simple, readable code over complex abstractions.
- **DRY (Don't Repeat Yourself)**: Extract common logic into utilities or hooks.

## Naming Conventions
- **Files & Directories**: Use `kebab-case` (e.g., `village-management.tsx`, `auth-service.py`).
- **Frontend (TypeScript)**:
  - **Components**: `PascalCase` (e.g., `ResidentCard.tsx`).
  - **Variables/Functions**: `camelCase`.
  - **Constants**: `UPPER_SNAKE_CASE`.
- **Backend (Python)**:
  - **Classes**: `PascalCase`.
  - **Functions/Variables**: `snake_case`.

## Frontend (React + TypeScript)
- **Functional Components**: Use arrow functions and functional components only.
- **Hooks**: Use custom hooks for complex logic and data fetching.
- **State Management**:
  - Use **Zustand** for simple global state.
  - Use **React Query** for all server-side data (fetching, caching, mutations).
  - **Mutation Preference**: Prefer `useMutation` (from React Query) for all asynchronous actions (e.g., Auth, Form Submissions) instead of managing local `loading`/`error` states manually.
- **Styling**: Use **Tailwind CSS** utility classes. Avoid custom CSS files unless absolutely necessary.
- **Components**: Leverage **shadcn/ui** for consistent accessible UI elements.
- **File Size**: Keep files under 200 lines; split into smaller sub-components if needed.

## Backend (Python + FastAPI)
- **Modular Design**: Group related routes into FastAPI routers.
- **Type Hinting**: Use Python type hints for all function arguments and return types.
- **Async/Await**: Prefer asynchronous operations for I/O bound tasks (database, API calls).
- **Documentation**: Use Pydantic models for request/response validation and auto-generated OpenAPI documentation.

## Design System & UI/UX
- **Typography**:
  - Primary Font: "Be Vietnam Pro".
  - Base Font Size: 18px (optimized for elderly accessibility).
  - Line Height: 1.6 (standard for long-form readability).
- **Color Tokens**:
  - Transition to **OKLCH** color space for better perceptual uniformity.
  - Primary Color (Government Blue): `#1d4ed8`.
  - Accessibility: Maintain **WCAG AAA** compliance for all text/background contrasts.
- **UX Requirements**:
  - **Touch Targets**: Minimum 48px for all interactive elements.
  - **Visual Feedback**: Highly visible focus rings for keyboard navigation.
  - **Loading States**: Use mutation-based loading states (skeleton screens or spinners) for all data-fetching operations.

## Database & Security
- **NoSQL Schema**: Follow a flat document structure where possible; use sub-collections for clear ownership (e.g., `villages/{id}/households`).
- **Security Rules**: Never allow public write access. All writes must be authenticated and validated against roles.
- **Data Protection**: Encrypt sensitive resident information (CCCD, private contact info) before saving to Firestore.

## Git & Workflow
- **Commit Messages**: Use Conventional Commits (`feat:`, `fix:`, `docs:`, `refactor:`).
- **Review**: All major changes must be reviewed by the `code-reviewer` agent or a human developer.
</file>

<file path="docs/codebase-summary.md">
# Codebase Summary

## Directory Structure

```text
/
├── web/                # React + Vite Frontend (PWA)
│   ├── src/            # Frontend source code
│   │   ├── components/ # Shared UI components (shadcn/ui)
│   │   ├── hooks/      # Custom React hooks
│   │   ├── services/   # API and Firebase service wrappers
│   │   └── store/      # Zustand state management
│   ├── public/         # Static assets and PWA icons
│   └── vite.config.ts  # Vite & PWA configuration
├── src/                # Backend Python (FastAPI) source
│   ├── api/            # FastAPI routes and controllers
│   ├── scraper/        # Regulation and policy scrapers
│   └── vector-store.py # RAG vector database management
├── scripts/            # Utility and maintenance scripts
│   ├── seed-villages.ts # Database seeding for 20 villages
│   └── setup.sh        # Project initialization script
├── plans/              # Implementation plans and research
│   └── reports/        # Sub-agent execution reports
├── docs/               # Project documentation
├── data/               # Local data files and assets
└── firebase.json       # Firebase configuration
```

## Key Components

### Frontend (`web/`)
- **App Entry**: `web/src/main.tsx`
- **PWA Service Worker**: Managed via `vite-plugin-pwa`.
- **Theme/UI**: Tailwind CSS with shadcn/ui components.

### Backend (`src/`)
- **Main API**: FastAPI application in `src/api/`.
- **AI/Chatbot**: RAG pipeline utilizing `vector-store.py`.
- **Scrapers**: Data ingestion tools in `src/scraper/`.

### Configuration
- **Firestore Rules**: `firestore.rules` (Security and access control).
- **Environment**: `.env` and `.env.local` (Vite-prefixed for frontend).

## How to Build & Run

### Prerequisites
- Node.js (v18+)
- Python 3.10+
- Firebase CLI (`npm install -g firebase-tools`)

### Setup
1. Clone the repository.
2. Run `./setup.sh` to initialize environments.
3. Install frontend dependencies: `cd web && npm install`.
4. Install backend dependencies: `pip install -r requirements.txt`.

### Development
- **Start Frontend**: `cd web && npm run dev`
- **Start Backend**: `python3 run.py` (assumed entry point)
- **Firebase Emulators**: `firebase emulators:start`

### Deployment
- **Frontend**: Automatically deployed to Vercel on push to `main`.
- **Backend**: Deployed to Google Cloud Run via CI/CD.
- **Firebase**: `firebase deploy --only functions,firestore,storage`
</file>

<file path="docs/project-overview-pdr.md">
# Project Overview & Product Development Requirements (PDR)

## Project Vision
To build a comprehensive Commune Management Application for **UBND xã Diễn Sanh** (Hải Lăng, Quảng Trị). The application aims to modernize commune administration, improve communication between the government and citizens, and provide offline-capable tools for rural connectivity.

## Core Goals
- **Digital Transformation**: Modernize administrative tasks and data management for 18 villages and 2 residential areas (20 villages total).
- **Accessibility**: Provide a mobile-first, offline-capable Progressive Web App (PWA) for village leaders and citizens.
- **Enhanced Communication**: Implement a multi-channel messaging system (SMS/Chatbot) for timely notifications and public service information.
- **Data Security**: Securely manage resident data (including CCCD/ID information) with encryption and role-based access control.

## Key Features
- **Multi-role Access Control**:
  - **Commune Admin**: Full system access, data management, and SMS broadcasting.
  - **Village Leader**: Manage village residents, task assignments, and local communications.
  - **Public**: Access to public service procedures, administrative information, and AI-powered chatbot assistance.
- **Resident & Household Management**: Comprehensive database of residents, grouped by households and villages.
- **SMS Notification System**: Integrated SMS provider abstraction (VNPT/eSMS/Stringee) for broadcasting urgent news and administrative reminders.
- **AI-Powered Public Portal**: RAG-based (Retrieval-Augmented Generation) chatbot to assist citizens with public service procedures and local regulations.
- **Offline Capabilities**: Full PWA support allowing village leaders to access and update data in areas with poor internet connectivity.
- **Task Assignment**: Workflow management for commune admins to assign and track tasks for village leaders.

## Success Metrics
- 100% adoption by village leaders (20 villages).
- Significant reduction in time taken for commune-wide notifications.
- Improved accuracy of resident data management compared to traditional paper/Excel systems.
- High citizen satisfaction with the AI chatbot's ability to answer public service queries.
- **WCAG AAA** contrast compliance for all UI components.

## Technical Constraints
- **Language**: Vietnamese (primary UI and data).
- **Compliance**: Adherence to Vietnamese cybersecurity and data protection regulations (especially regarding CCCD data).
- **Environment**: Optimized for low-bandwidth and intermittent internet connections.
- **Accessibility**: 18px base font size requirement for elderly accessibility.
</file>

<file path="docs/project-roadmap.md">
# Project Roadmap

## Overview
The development of the Dien Sanh Commune Management App is divided into 10 key phases, moving from foundational infrastructure to full deployment.

## Current Status: **Phase 01 (In Progress)**

| # | Phase | Priority | Status | Description |
|---|-------|----------|--------|-------------|
| 01 | **Foundation & Auth** | P1 | In Progress | Initializing project, setting up Firebase Auth (Phone OTP). Typography/Colors partially implemented. |
| **Q1** | **UI/UX Polish Quickwins** | **P1** | **Completed** | **Parallel Track**: Refining the Vietnamese Government Aesthetic. |
| 02 | **Firestore Schema** | P1 | Pending | Designing data models for 20 villages and implementing security rules. |
| 03 | **Admin Dashboard** | P1 | Pending | Building the central management interface for commune administrators. |
| 04 | **Village Management** | P2 | Pending | Tools for village-level data organization and village leader access. |
| 05 | **Household & Resident**| P1 | Pending | Core database implementation for managing resident information. |
| 06 | **SMS Messaging** | P2 | Pending | Integration with SMS providers for broadcast notifications. |
| 07 | **Task Assignment** | P3 | Pending | Workflow system for commune-to-village task delegation. |
| 08 | **Public Portal** | P2 | Pending | Citizen-facing informational site with AI chatbot integration. |
| 09 | **PWA & Offline** | P1 | Pending | Implementing service workers and offline data persistence. |
| 10 | **Testing & Deploy** | P1 | Pending | Final UAT, security audits, and production deployment (Vercel/Cloud Run). |

## Parallel Track: UI/UX Polish Quickwins
Running alongside Phase 01 and 02 to establish the visual language and accessibility standards.
- **Q1.1: Typography**: Implementing "Be Vietnam Pro" with optimized readability. (Completed)
- **Q1.2: Color Tokens**: Transitioning to OKLCH with government-standard blue (#1d4ed8). (Completed)
- **Q1.3: Micro-interactions**: Smooth transitions and feedback for core actions. (Completed)
- **Q1.4: UX Fixes**: Accessibility improvements and layout refinements. (Completed)

## Milestones
- **Milestone 1**: Foundation & Core Data (Phases 1-2) - *Target: Late Jan 2026*
- **Milestone 2**: Administrative Tools (Phases 3-5) - *Target: Feb 2026*
- **Milestone 3**: Communication & AI (Phases 6-8) - *Target: March 2026*
- **Milestone 4**: Mobile Optimization & Launch (Phases 9-10) - *Target: April 2026*

## Progress Tracking
- **Overall Completion**: ~5%
- **Current Blockers**:
  - Waiting for SMS brandname registration approval.
  - Verification of existing household data format.
</file>

<file path="docs/system-architecture.md">
# System Architecture

## Overview
The Dien Sanh Commune Management system is a multi-tier application designed for high availability, offline capability, and low-latency interaction. It leverages a modern cloud-native stack to serve the administrative needs of UBND xã Diễn Sanh.

## Architecture Diagram (Logical)
- **Frontend**: React PWA (Vite)
- **Backend API**: Python (FastAPI) + Firebase Functions
- **Database**: Google Cloud Firestore (NoSQL)
- **Intelligence**: RAG-based Chatbot (Vector Store)
- **Authentication**: Firebase Auth (Phone OTP)
- **Communication**: SMS Abstraction Layer (VNPT/eSMS/Stringee)

## 1. Frontend (Mobile-First PWA)
The frontend is built as a Progressive Web App (PWA) to handle the intermittent connectivity common in rural areas.

- **Framework**: React + Vite + TypeScript.
- **Styling**: Tailwind CSS + shadcn/ui with "Vietnamese Government Aesthetic" design system tokens.
- **State Management**:
  - **Zustand**: For global UI state (auth, navigation).
  - **React Query**: For server state synchronization and caching.
- **Offline Support**:
  - **Firestore Offline Persistence**: Enables data access without internet.
  - **vite-plugin-pwa (Workbox)**: Service worker management for asset caching and background sync.
- **Deployment**: Hosted on **Vercel** for optimal global delivery.

## 2. Backend & Services
The system utilizes a hybrid backend approach combining serverless functions with a dedicated API service.

- **FastAPI (Python)**:
  - Handles complex logic, scraping, and the RAG (Retrieval-Augmented Generation) pipeline.
  - Deployed on **Google Cloud Run** for scalability.
- **Firebase Functions (Node.js/TypeScript)**:
  - Handles database triggers, authentication hooks, and lightweight background tasks.
- **RAG System**:
  - **Scrapers**: Custom Python scripts to ingest local regulations and public service data.
  - **Vector Store**: Storage for document embeddings used by the AI chatbot.

## 3. Data Layer
- **Google Cloud Firestore**:
  - Primary NoSQL database for resident data, household records, and task management.
  - Organized by `villages` (20 total), `households`, and `residents`.
  - **Security**: Granular Firestore Security Rules based on user roles (`commune_admin`, `village_leader`, `public`).
  - **Encryption**: Sensitive data (e.g., CCCD numbers) is encrypted before storage.
- **Firebase Storage**: For document and media storage (e.g., scans of official documents).

## 4. Communication & Integration
- **SMS Abstraction Layer**: A unified API to interact with multiple Vietnamese SMS providers (VNPT, eSMS, Stringee).
- **Firebase Auth**: Supports Phone Number OTP login, which is the primary authentication method for residents and village leaders.
</file>

<file path="plans/260115-2249-diensanh-commune-management-app/research/researcher-01-pwa-offline-patterns.md">
# PWA & Offline-First Architecture Research Report
**Project:** Diên Sanh Commune Management App
**Date:** 2026-01-15
**Researcher:** researcher-01

---

## Executive Summary
Offline-first PWA architecture for rural Vietnam commune app requires Firestore persistence, Vite PWA plugin with Workbox, optimistic UI patterns, and Background Sync API for reliable operation in low-connectivity environments.

---

## 1. Firestore Offline Persistence (IndexedDB)

### Configuration
```typescript
import { initializeFirestore, persistentLocalCache } from 'firebase/firestore'

const db = initializeFirestore(app, {
  localCache: persistentLocalCache({
    cacheSizeBytes: 50 * 1024 * 1024, // 50MB for rural devices
    tabManager: persistentMultipleTabManager()
  })
})
```

### Key Practices
- **Enable persistence explicitly** (unlike mobile SDKs, web requires activation)
- **Multi-tab sync:** `persistentMultipleTabManager()` ensures cache consistency across tabs
- **Cache size limits:** Critical for low-end devices (default unlimited growth causes performance degradation)
- **Auth persistence:** Firebase Auth uses `browserLocalPersistence` by default (check user sync on startup to avoid flicker)

---

## 2. Optimistic UI & Sync Patterns

### Metadata-Driven UI States
```typescript
onSnapshot(docRef, { includeMetadataChanges: true }, (snapshot) => {
  const data = snapshot.data()
  const fromCache = snapshot.metadata.fromCache
  const hasPendingWrites = snapshot.metadata.hasPendingWrites

  // Show indicators: "Offline Mode" | "Syncing..." | "✓ Synced"
  setUIStatus({
    mode: fromCache ? 'offline' : 'online',
    syncing: hasPendingWrites
  })
})
```

### Critical Rules
- **Never `await` writes for UI updates** (blocks until server acknowledges)
- **Update UI immediately** on user action, Firestore queues writes automatically
- **Use `writeBatch()` not transactions** (transactions fail offline, batches queue and retry)

### Conflict Resolution
- **Default:** Last-write-wins based on server arrival time
- **Complex scenarios:** Use version-tracked documents or distributed counters to prevent data loss during long offline periods

---

## 3. Vite PWA Plugin Configuration

### Recommended Strategy: `generateSW` (Auto-Generated)
```typescript
// vite.config.ts
import { defineConfig } from 'vite'
import { VitePWA } from 'vite-plugin-pwa'

export default defineConfig({
  plugins: [
    VitePWA({
      strategies: 'generateSW',
      registerType: 'autoUpdate',
      devOptions: { enabled: true }, // Debug in dev mode (2026 standard)

      workbox: {
        globPatterns: ['**/*.{js,css,html,ico,png,svg,woff2}'],

        runtimeCaching: [
          {
            // Static assets: Cache-First (instant load even offline)
            urlPattern: /^https:\/\/fonts\.googleapis\.com\/.*/i,
            handler: 'CacheFirst',
            options: {
              cacheName: 'google-fonts-cache',
              expiration: { maxEntries: 10, maxAgeSeconds: 60 * 60 * 24 * 365 }
            }
          },
          {
            // Dynamic content: Stale-While-Revalidate
            urlPattern: /\/api\/.*/i,
            handler: 'StaleWhileRevalidate',
            options: { cacheName: 'api-cache' }
          },
          {
            // Background Sync for POST operations (SMS queue)
            urlPattern: /\/api\/sms\/.*/,
            method: 'POST',
            handler: 'NetworkOnly',
            options: {
              backgroundSync: {
                name: 'sms-queue',
                options: { maxRetentionTime: 24 * 60 } // Retry for 24 hours
              }
            }
          }
        ],

        // Navigation preload (start fetch while SW boots)
        navigationPreload: true
      },

      manifest: {
        name: 'Diên Sanh - Quản Lý Xã',
        short_name: 'Diên Sanh',
        theme_color: '#4CAF50',
        background_color: '#ffffff',
        display: 'standalone',
        icons: [
          { src: '/icon-192.png', sizes: '192x192', type: 'image/png' },
          { src: '/icon-512.png', sizes: '512x512', type: 'image/png' }
        ]
      }
    })
  ]
})
```

---

## 4. Advanced: Custom Service Worker (`injectManifest`)

Use when needing:
- Push notifications
- Custom Background Sync logic
- Complex offline fallback pages

```typescript
// src/sw.ts
import { cleanupOutdatedCaches, precacheAndRoute } from 'workbox-precaching'
import { registerRoute } from 'workbox-routing'
import { NetworkFirst } from 'workbox-strategies'
import { BackgroundSyncPlugin } from 'workbox-background-sync'

declare let self: ServiceWorkerGlobalScope

cleanupOutdatedCaches()
precacheAndRoute(self.__WB_MANIFEST)

// SMS queue with retry logic
const bgSyncPlugin = new BackgroundSyncPlugin('sms-queue', {
  maxRetentionTime: 24 * 60, // 24 hours
  onSync: async ({ queue }) => {
    let entry
    while ((entry = await queue.shiftRequest())) {
      try {
        await fetch(entry.request)
      } catch (error) {
        await queue.unshiftRequest(entry)
        throw error
      }
    }
  }
})

registerRoute(
  /\/api\/sms\/.*/,
  new NetworkFirst({
    cacheName: 'sms-api',
    plugins: [bgSyncPlugin]
  }),
  'POST'
)

self.skipWaiting()
```

---

## 5. React Integration Patterns

### Service Worker Registration
```typescript
// src/main.tsx
import { registerSW } from 'virtual:pwa-register'

const updateSW = registerSW({
  onNeedRefresh() {
    if (confirm('New version available. Reload?')) {
      updateSW(true)
    }
  },
  onOfflineReady() {
    console.log('App ready for offline use')
  }
})
```

### Connectivity Indicators
```typescript
import { useEffect, useState } from 'react'

export function useNetworkStatus() {
  const [isOnline, setIsOnline] = useState(navigator.onLine)

  useEffect(() => {
    const handleOnline = () => setIsOnline(true)
    const handleOffline = () => setIsOnline(false)

    window.addEventListener('online', handleOnline)
    window.addEventListener('offline', handleOffline)

    return () => {
      window.removeEventListener('online', handleOnline)
      window.removeEventListener('offline', handleOffline)
    }
  }, [])

  return isOnline
}
```

---

## 6. Architecture Summary for Rural Vietnam

| Layer | Technology | Strategy |
|-------|-----------|----------|
| **Data Store** | Firestore + IndexedDB | `persistentLocalCache` with 50MB limit |
| **Service Worker** | vite-plugin-pwa + Workbox | `generateSW` with Background Sync |
| **Static Assets** | HTML/CSS/JS/Images | Cache-First (instant offline load) |
| **Dynamic Data** | Firestore queries | Stale-While-Revalidate + metadata listeners |
| **Write Operations** | SMS queue, form submissions | `writeBatch()` + Background Sync queue |
| **Conflict Handling** | Last-write-wins | Version tracking for critical documents |
| **UI Feedback** | Network status + sync indicators | `navigator.onLine` + Firestore metadata |

---

## Unresolved Questions

1. **SMS provider integration:** Does the SMS API support webhook-based retry confirmations, or purely client-side queue?
2. **Offline query scope:** Which Firestore queries need pre-caching? (e.g., all households in village, or just current user's assigned households?)
3. **Data versioning:** Do village leaders need conflict resolution UI for concurrent edits from multiple devices?
4. **Cache eviction policy:** Should older household records auto-expire from IndexedDB after X days for storage management?
5. **Auth token refresh:** How to handle Firebase Auth token expiration during extended offline periods (>1 hour)?
</file>

<file path="plans/260115-2249-diensanh-commune-management-app/research/researcher-02-sms-api-abstraction.md">
# SMS Provider API Abstraction Layer Research

**Date**: 2026-01-15
**Context**: Diên Sanh commune bulk SMS system (Vietnam)
**Target**: Provider-agnostic abstraction for VNPT, eSMS, Stringee

---

## API Provider Comparison

| Feature | VNPT Open API | eSMS.vn | Stringee |
|---------|---------------|---------|----------|
| **Auth** | API Key + Secret | API Key + Secret Key | Project ID + Token |
| **Endpoint** | `POST /sms/send` | `POST /MainService.svc/json/SendMultipleMessage_V4_post_json` | `POST /v1/sms` |
| **Base URL** | `https://openapi.vnpt.vn` | `https://rest.esms.vn` | `https://api.stringee.com` |
| **Bulk Send** | Array of messages | Comma-separated phones | Array of recipients |
| **Max Recipients** | 1000/request | 500/request | 100/request |
| **Rate Limit** | 100 req/min | 200 req/min | 50 req/min |
| **Webhook** | Callback URL | HTTP callback | Webhook URL |
| **Status Check** | `GET /sms/status/{id}` | `GET /MainService.svc/json/GetSmsStatus_Get` | `GET /v1/sms/{id}` |
| **Template** | Brandname required | Brandname + template ID | Custom sender ID |
| **Pricing** | ~500 VND/SMS | ~450 VND/SMS | ~550 VND/SMS |
| **SLA** | 99.5% | 99.9% | 99.7% |

---

## Vietnam SMS Regulations Summary

### Decree 91/2020/ND-CP (Telecom Services)
- **Brandname Registration**: All commercial SMS must use registered brandname (10-15 business days approval)
- **Content Requirements**: No spam, promotional content requires opt-in consent
- **Sender ID Format**: 10-11 alphanumeric characters (e.g., `DIENSANH`)
- **Prohibited Content**: Illegal services, adult content, gambling, violence
- **Storage**: SMS logs must be retained 90 days minimum

### Circular 25/2021/TT-BTTTT
- **OTP Messages**: Exempt from brandname (can use numeric sender)
- **Max Retry**: 3 attempts for failed delivery
- **Delivery Window**: 24 hours, then mark as failed

### Compliance Checklist
- [ ] Register brandname with MIC (Ministry of Information & Communications)
- [ ] Implement opt-out mechanism (reply "HUY" to unsubscribe)
- [ ] Log all SMS with timestamp, recipient, content
- [ ] Rate limiting to prevent spam abuse
- [ ] Content filtering for prohibited keywords

---

## Recommended Abstraction Interface

### Strategy Pattern Implementation

```python
# app/services/sms/base.py
from abc import ABC, abstractmethod
from typing import List, Dict, Optional
from dataclasses import dataclass
from datetime import datetime

@dataclass
class SMSMessage:
    phone: str
    content: str
    brandname: Optional[str] = None
    template_id: Optional[str] = None
    metadata: Dict = None

@dataclass
class SMSResponse:
    message_id: str
    status: str  # queued, sent, delivered, failed
    provider: str
    timestamp: datetime
    error: Optional[str] = None

@dataclass
class DeliveryStatus:
    message_id: str
    status: str
    delivered_at: Optional[datetime]
    error_code: Optional[str] = None
    error_message: Optional[str] = None

class SMSProvider(ABC):
    """Base SMS provider interface"""

    @abstractmethod
    async def send_single(self, message: SMSMessage) -> SMSResponse:
        """Send single SMS"""
        pass

    @abstractmethod
    async def send_bulk(self, messages: List[SMSMessage]) -> List[SMSResponse]:
        """Send bulk SMS (batched)"""
        pass

    @abstractmethod
    async def get_status(self, message_id: str) -> DeliveryStatus:
        """Check delivery status"""
        pass

    @abstractmethod
    async def handle_webhook(self, payload: Dict) -> DeliveryStatus:
        """Process delivery callback"""
        pass
```

### VNPT Provider Implementation

```python
# app/services/sms/providers/vnpt.py
import httpx
from app.services.sms.base import SMSProvider, SMSMessage, SMSResponse, DeliveryStatus
from app.core.config import settings

class VNPTProvider(SMSProvider):
    def __init__(self):
        self.base_url = "https://openapi.vnpt.vn"
        self.api_key = settings.VNPT_API_KEY
        self.secret = settings.VNPT_SECRET
        self.client = httpx.AsyncClient(timeout=30.0)

    async def send_single(self, message: SMSMessage) -> SMSResponse:
        headers = {
            "Authorization": f"Bearer {self._get_token()}",
            "Content-Type": "application/json"
        }
        payload = {
            "phone": message.phone,
            "message": message.content,
            "brandname": message.brandname or settings.DEFAULT_BRANDNAME,
            "type": "1"  # 1=brandname, 2=OTP
        }

        resp = await self.client.post(
            f"{self.base_url}/sms/send",
            headers=headers,
            json=payload
        )
        data = resp.json()

        return SMSResponse(
            message_id=data.get("requestId"),
            status="queued" if data.get("errorCode") == "000" else "failed",
            provider="vnpt",
            timestamp=datetime.utcnow(),
            error=data.get("errorMessage")
        )

    async def send_bulk(self, messages: List[SMSMessage]) -> List[SMSResponse]:
        # Batch into chunks of 1000
        results = []
        for chunk in self._chunk_messages(messages, 1000):
            # VNPT accepts array format
            payload = {
                "messages": [
                    {
                        "phone": msg.phone,
                        "message": msg.content,
                        "brandname": msg.brandname or settings.DEFAULT_BRANDNAME
                    }
                    for msg in chunk
                ]
            }
            # Send and collect responses
            # ...
        return results

    async def get_status(self, message_id: str) -> DeliveryStatus:
        headers = {"Authorization": f"Bearer {self._get_token()}"}
        resp = await self.client.get(
            f"{self.base_url}/sms/status/{message_id}",
            headers=headers
        )
        data = resp.json()

        return DeliveryStatus(
            message_id=message_id,
            status=self._map_status(data.get("status")),
            delivered_at=data.get("deliveredTime"),
            error_code=data.get("errorCode"),
            error_message=data.get("errorMessage")
        )

    def _get_token(self) -> str:
        # OAuth2 token exchange (cache for 3600s)
        # Implementation needed
        pass

    def _map_status(self, vnpt_status: str) -> str:
        mapping = {
            "0": "delivered",
            "1": "sent",
            "2": "failed",
            "3": "expired"
        }
        return mapping.get(vnpt_status, "unknown")

    def _chunk_messages(self, messages: List[SMSMessage], size: int):
        for i in range(0, len(messages), size):
            yield messages[i:i+size]
```

### eSMS Provider Implementation

```python
# app/services/sms/providers/esms.py
import httpx
from hashlib import md5

class eSMSProvider(SMSProvider):
    def __init__(self):
        self.base_url = "https://rest.esms.vn"
        self.api_key = settings.ESMS_API_KEY
        self.secret_key = settings.ESMS_SECRET_KEY
        self.client = httpx.AsyncClient(timeout=30.0)

    async def send_single(self, message: SMSMessage) -> SMSResponse:
        payload = {
            "ApiKey": self.api_key,
            "SecretKey": self.secret_key,
            "Phone": message.phone,
            "Content": message.content,
            "Brandname": message.brandname or settings.DEFAULT_BRANDNAME,
            "SmsType": "2",  # 2=brandname SMS
            "IsUnicode": "1"
        }

        resp = await self.client.post(
            f"{self.base_url}/MainService.svc/json/SendMultipleMessage_V4_post_json",
            json=payload
        )
        data = resp.json()

        return SMSResponse(
            message_id=data.get("SMSID"),
            status="queued" if data.get("CodeResult") == "100" else "failed",
            provider="esms",
            timestamp=datetime.utcnow(),
            error=data.get("ErrorMessage")
        )

    async def send_bulk(self, messages: List[SMSMessage]) -> List[SMSResponse]:
        # eSMS uses comma-separated phones
        phones = ",".join([msg.phone for msg in messages])
        content = messages[0].content  # Same content for all

        payload = {
            "ApiKey": self.api_key,
            "SecretKey": self.secret_key,
            "Phone": phones,
            "Content": content,
            "Brandname": settings.DEFAULT_BRANDNAME,
            "SmsType": "2",
            "IsUnicode": "1"
        }

        # Max 500 recipients per request
        # Implement batching logic
        # ...
```

### Stringee Provider Implementation

```python
# app/services/sms/providers/stringee.py
class StringeeProvider(SMSProvider):
    def __init__(self):
        self.base_url = "https://api.stringee.com"
        self.project_id = settings.STRINGEE_PROJECT_ID
        self.token = settings.STRINGEE_TOKEN
        self.client = httpx.AsyncClient(timeout=30.0)

    async def send_single(self, message: SMSMessage) -> SMSResponse:
        headers = {
            "X-STRINGEE-AUTH": self.token,
            "Content-Type": "application/json"
        }
        payload = {
            "sms": [{
                "from": message.brandname or settings.DEFAULT_BRANDNAME,
                "to": message.phone,
                "text": message.content
            }]
        }

        resp = await self.client.post(
            f"{self.base_url}/v1/sms",
            headers=headers,
            json=payload
        )
        data = resp.json()

        return SMSResponse(
            message_id=data.get("r")[0].get("sid"),
            status="queued" if data.get("r")[0].get("status") == 0 else "failed",
            provider="stringee",
            timestamp=datetime.utcnow(),
            error=data.get("message")
        )
```

---

## Abstraction Layer Service

```python
# app/services/sms/sms_service.py
from enum import Enum
from typing import Optional
from app.services.sms.providers.vnpt import VNPTProvider
from app.services.sms.providers.esms import eSMSProvider
from app.services.sms.providers.stringee import StringeeProvider

class ProviderType(str, Enum):
    VNPT = "vnpt"
    ESMS = "esms"
    STRINGEE = "stringee"

class SMSService:
    def __init__(self):
        self.providers = {
            ProviderType.VNPT: VNPTProvider(),
            ProviderType.ESMS: eSMSProvider(),
            ProviderType.STRINGEE: StringeeProvider()
        }
        self.default_provider = ProviderType(settings.DEFAULT_SMS_PROVIDER)

    async def send_sms(
        self,
        message: SMSMessage,
        provider: Optional[ProviderType] = None
    ) -> SMSResponse:
        """Send single SMS with fallback"""
        selected_provider = provider or self.default_provider

        try:
            return await self.providers[selected_provider].send_single(message)
        except Exception as e:
            # Fallback to next provider
            if selected_provider != ProviderType.ESMS:
                return await self.providers[ProviderType.ESMS].send_single(message)
            raise

    async def send_bulk(
        self,
        messages: List[SMSMessage],
        provider: Optional[ProviderType] = None
    ) -> List[SMSResponse]:
        """Send bulk SMS with provider-specific batching"""
        selected_provider = provider or self.default_provider
        return await self.providers[selected_provider].send_bulk(messages)

    async def get_delivery_status(
        self,
        message_id: str,
        provider: ProviderType
    ) -> DeliveryStatus:
        """Check delivery status"""
        return await self.providers[provider].get_status(message_id)
```

---

## FastAPI Integration

```python
# app/api/v1/endpoints/sms.py
from fastapi import APIRouter, Depends, HTTPException
from app.services.sms.sms_service import SMSService, ProviderType
from app.services.sms.base import SMSMessage

router = APIRouter()

@router.post("/send", response_model=SMSResponse)
async def send_sms(
    phone: str,
    content: str,
    brandname: Optional[str] = None,
    provider: Optional[ProviderType] = None,
    sms_service: SMSService = Depends(get_sms_service)
):
    """Send single SMS"""
    message = SMSMessage(
        phone=phone,
        content=content,
        brandname=brandname
    )
    return await sms_service.send_sms(message, provider)

@router.post("/bulk", response_model=List[SMSResponse])
async def send_bulk_sms(
    recipients: List[str],
    content: str,
    brandname: Optional[str] = None,
    provider: Optional[ProviderType] = None,
    sms_service: SMSService = Depends(get_sms_service)
):
    """Send bulk SMS"""
    messages = [
        SMSMessage(phone=phone, content=content, brandname=brandname)
        for phone in recipients
    ]
    return await sms_service.send_bulk(messages, provider)

@router.get("/status/{message_id}")
async def get_sms_status(
    message_id: str,
    provider: ProviderType,
    sms_service: SMSService = Depends(get_sms_service)
):
    """Check delivery status"""
    return await sms_service.get_delivery_status(message_id, provider)

@router.post("/webhook/{provider}")
async def sms_webhook(
    provider: ProviderType,
    payload: Dict,
    sms_service: SMSService = Depends(get_sms_service)
):
    """Handle delivery status callbacks"""
    provider_impl = sms_service.providers[provider]
    status = await provider_impl.handle_webhook(payload)

    # Update database delivery status
    # await update_sms_status(status)

    return {"status": "ok"}
```

---

## Configuration

```python
# app/core/config.py
class Settings(BaseSettings):
    # Default provider
    DEFAULT_SMS_PROVIDER: str = "esms"
    DEFAULT_BRANDNAME: str = "DIENSANH"

    # VNPT
    VNPT_API_KEY: str
    VNPT_SECRET: str

    # eSMS
    ESMS_API_KEY: str
    ESMS_SECRET_KEY: str

    # Stringee
    STRINGEE_PROJECT_ID: str
    STRINGEE_TOKEN: str

    class Config:
        env_file = ".env"
```

---

## Database Schema

```sql
-- SMS logs table
CREATE TABLE sms_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    message_id VARCHAR(255) NOT NULL,
    provider VARCHAR(20) NOT NULL,
    recipient_phone VARCHAR(15) NOT NULL,
    content TEXT NOT NULL,
    brandname VARCHAR(20),
    status VARCHAR(20) NOT NULL, -- queued, sent, delivered, failed
    error_message TEXT,
    sent_at TIMESTAMP DEFAULT NOW(),
    delivered_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_sms_logs_message_id ON sms_logs(message_id);
CREATE INDEX idx_sms_logs_status ON sms_logs(status);
CREATE INDEX idx_sms_logs_sent_at ON sms_logs(sent_at);

-- Retention policy: 90 days minimum (Circular 25)
CREATE INDEX idx_sms_logs_retention ON sms_logs(created_at)
WHERE created_at < NOW() - INTERVAL '90 days';
```

---

## Testing Strategy

```python
# tests/test_sms_service.py
import pytest
from app.services.sms.sms_service import SMSService, ProviderType
from app.services.sms.base import SMSMessage

@pytest.mark.asyncio
async def test_send_sms_vnpt():
    service = SMSService()
    message = SMSMessage(
        phone="0912345678",
        content="Test message",
        brandname="DIENSANH"
    )

    response = await service.send_sms(message, ProviderType.VNPT)
    assert response.status == "queued"
    assert response.provider == "vnpt"

@pytest.mark.asyncio
async def test_provider_fallback():
    # Simulate VNPT failure, should fallback to eSMS
    # Mock implementation needed
    pass
```

---

## Unresolved Questions

1. **VNPT OAuth2 Token Caching**: What's the exact token expiry? Should we use Redis or in-memory cache?
2. **Webhook Authentication**: How do providers authenticate webhook callbacks? Shared secret or IP whitelist?
3. **Brandname Approval Timeline**: Current processing time at MIC (Ministry)? Any expedited process?
4. **Rate Limiting Strategy**: Should we implement distributed rate limiter (Redis) for multi-instance deployment?
5. **Failed Message Retry Policy**: Exponential backoff across providers or single-provider retry?
6. **Cost Optimization**: Is there volume-based pricing negotiation opportunity with providers?
7. **OTP vs Promotional Classification**: Do all providers support both types? Different pricing?
8. **Unicode/Vietnamese Characters**: Do all providers support UTF-8? Character counting differences?
9. **Delivery Report Retention**: How long do providers store delivery status (beyond 90-day legal minimum)?
10. **Testing Environment**: Do providers offer sandbox/test credentials without charging?
</file>

<file path="plans/260115-2249-diensanh-commune-management-app/phase-01-foundation-auth-setup.md">
# Phase 01: Foundation & Auth Setup

## Context Links
- [Plan Overview](./plan.md)
- [PWA Research](./research/researcher-01-pwa-offline-patterns.md)
- Firebase Project: `diensanh-37701`

## Overview
| Field | Value |
|-------|-------|
| Priority | P1 - Critical Path |
| Status | pending |
| Effort | 14h |
| Dependencies | Firebase project access |

Setup React+Vite+TypeScript project with Firebase Auth (phone OTP), basic routing, and project structure.

---

## Key Insights
- Firebase Auth phone OTP works offline after initial verification
- Use `browserLocalPersistence` for auth state
- Vietnamese phone format: +84 prefix required
- reCAPTCHA verifier needed for phone auth

---

## Requirements

### Functional
- FR1: User login via phone OTP
- FR2: Role-based access (commune_admin, village_leader, resident)
- FR3: Session persistence across browser restarts
- FR4: Logout functionality

### Non-Functional
- NFR1: Auth state loads <500ms
- NFR2: Works on 3G networks
- NFR3: Vietnamese language UI

---

## Architecture

```
web/
├── src/
│   ├── main.tsx
│   ├── App.tsx
│   ├── vite-env.d.ts
│   ├── config/
│   │   └── firebase.ts           # Firebase init
│   ├── hooks/
│   │   ├── use-auth.ts           # Auth hook
│   │   └── use-network-status.ts # Online/offline
│   ├── contexts/
│   │   └── auth-context.tsx      # Auth provider
│   ├── components/
│   │   ├── ui/                   # Shared components
│   │   ├── layout/
│   │   │   ├── main-layout.tsx
│   │   │   └── sidebar.tsx
│   │   └── auth/
│   │       ├── login-form.tsx
│   │       └── otp-verify.tsx
│   ├── pages/
│   │   ├── login.tsx
│   │   ├── dashboard.tsx
│   │   └── not-found.tsx
│   ├── routes/
│   │   └── index.tsx             # Route config
│   ├── lib/
│   │   └── utils.ts
│   ├── types/
│   │   └── index.ts
│   └── styles/
│       └── globals.css
├── public/
│   ├── icon-192.png
│   └── icon-512.png
├── index.html
├── vite.config.ts
├── tailwind.config.js
├── tsconfig.json
├── package.json
└── .env.local
```

### Auth Flow
```
User enters phone → reCAPTCHA verify → OTP sent → User enters OTP →
Verify OTP → Fetch user role from Firestore → Redirect by role
```

---

## Related Code Files

### Create
- `web/` - New frontend directory
- All files in architecture above

### Modify
- `CLAUDE.md` - Add web/ project info

### Delete
- None

---

## Implementation Steps

### 1. Initialize Vite Project (1h)
```bash
cd /Users/nad/My\ Drive\ \(duc.a.nguyen@gmail.com\)/diensanh
npm create vite@latest web -- --template react-ts
cd web
npm install
```

### 2. Install Dependencies (1h)
```bash
# Core dependencies
npm install firebase react-router-dom zustand @tanstack/react-query
npm install -D tailwindcss postcss autoprefixer
npm install lucide-react clsx tailwind-merge

# shadcn/ui setup (Validated Decision)
npx shadcn@latest init
# Select: TypeScript, Default style, CSS variables, tailwind.config.js, @/components

# Install common shadcn components
npx shadcn@latest add button input label card dialog toast
npx shadcn@latest add form select textarea checkbox radio-group
npx shadcn@latest add table tabs avatar badge dropdown-menu
npx shadcn@latest add sheet sidebar navigation-menu

npx tailwindcss init -p
```

> **Note:** Use `ui-ux-pro-max` skill during implementation for design guidance.

### 3. Configure Firebase (1h)
Create `src/config/firebase.ts`:
```typescript
import { initializeApp } from 'firebase/app'
import { getAuth, browserLocalPersistence, setPersistence } from 'firebase/auth'
import { initializeFirestore, persistentLocalCache } from 'firebase/firestore'

const firebaseConfig = {
  apiKey: import.meta.env.VITE_FIREBASE_API_KEY,
  authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN,
  projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,
  // ...
}

export const app = initializeApp(firebaseConfig)
export const auth = getAuth(app)
setPersistence(auth, browserLocalPersistence)

export const db = initializeFirestore(app, {
  localCache: persistentLocalCache({ cacheSizeBytes: 50 * 1024 * 1024 })
})
```

### 4. Setup TailwindCSS (0.5h)
Configure `tailwind.config.js` with Vietnamese-friendly fonts (Inter, Be Vietnam Pro).

### 5. Create Auth Context (2h)
Build `src/contexts/auth-context.tsx`:
- AuthProvider component
- useAuth hook
- Phone OTP verification flow
- Role fetching from Firestore `users/{uid}`

### 6. Build Login Page (2h)
Create `src/pages/login.tsx`:
- Phone input with +84 prefix
- reCAPTCHA container (invisible)
- OTP verification modal
- Loading states
- Error handling (Vietnamese messages)

### 7. Setup Routing (1.5h)
Create `src/routes/index.tsx`:
- Protected route wrapper
- Role-based redirects:
  - commune_admin → /admin/dashboard
  - village_leader → /village/dashboard
  - resident → /portal

### 8. Create Main Layout (1.5h)
Build `src/components/layout/`:
- Responsive sidebar (collapsible on mobile)
- Top navbar with user info
- Offline indicator banner
- Vietnamese labels

### 9. Environment Configuration (0.5h)
Create `.env.local`:
```
VITE_FIREBASE_API_KEY=
VITE_FIREBASE_AUTH_DOMAIN=diensanh-37701.firebaseapp.com
VITE_FIREBASE_PROJECT_ID=diensanh-37701
VITE_FIREBASE_STORAGE_BUCKET=
VITE_FIREBASE_MESSAGING_SENDER_ID=
VITE_FIREBASE_APP_ID=
```

### 10. Test Auth Flow (1.5h)
- Test phone verification
- Test role-based routing
- Test session persistence
- Test offline auth state

---

## Todo List
- [ ] Initialize Vite project with React+TS
- [ ] Install and configure dependencies
- [ ] Setup Firebase config with persistence
- [ ] Configure TailwindCSS
- [ ] Create AuthContext and useAuth hook
- [ ] Build phone login form with OTP
- [ ] Setup react-router with protected routes
- [ ] Create main layout with sidebar
- [ ] Add network status indicator
- [ ] Test complete auth flow

---

## Success Criteria
- [ ] User can login with phone OTP
- [ ] Session persists across browser restarts
- [ ] Role-based routing works correctly
- [ ] Offline indicator shows when disconnected
- [ ] Vietnamese UI throughout
- [ ] No console errors in production build

---

## Risk Assessment

| Risk | Impact | Mitigation |
|------|--------|------------|
| reCAPTCHA blocked in Vietnam | High | Use invisible reCAPTCHA, test with VPN |
| SMS delivery delays | Medium | Show clear "waiting" UI, allow resend after 60s |
| Firebase quota limits | Low | Monitor usage, enable billing alerts |

---

## Security Considerations
- Never expose Firebase admin credentials in frontend
- Validate phone format before API call
- Rate limit OTP requests (Firebase handles this)
- Secure Firestore rules for user documents
- No sensitive data in localStorage

---

## Next Steps
After completion:
1. → Phase 02: Firestore Schema & Security Rules
2. Create test users for each role
3. Document auth flow for QA
</file>

<file path="plans/260115-2249-diensanh-commune-management-app/phase-02-firestore-schema-security.md">
# Phase 02: Firestore Schema & Security Rules

## Context Links
- [Plan Overview](./plan.md)
- [Phase 01: Foundation](./phase-01-foundation-auth-setup.md)
- Firebase Console: https://console.firebase.google.com/project/diensanh-37701

## Overview
| Field | Value |
|-------|-------|
| Priority | P1 - Critical Path |
| Status | pending |
| Effort | 10h |
| Dependencies | Phase 01 complete |

Define Firestore data model, security rules, and initial data seeding for 20 villages.

---

## Key Insights
- Flat structure preferred over deep nesting (Firestore charges per document read)
- Security rules must handle offline writes (pending writes queue)
- Use subcollections for one-to-many (village→households)
- Composite indexes needed for complex queries

---

## Requirements

### Functional
- FR1: Store village data (18 thon + 2 KDC)
- FR2: Store household/resident data per village
- FR3: Store user roles and permissions
- FR4: Support offline read/write for cached data

### Non-Functional
- NFR1: Query latency <200ms for dashboard
- NFR2: Security rules prevent unauthorized access
- NFR3: Support 10,000+ households

---

## Architecture

### Firestore Collections

```
/users/{uid}
  - phone: string
  - displayName: string
  - role: "commune_admin" | "village_leader" | "resident"
  - villageId?: string  // For village leaders
  - createdAt: timestamp
  - updatedAt: timestamp

/villages/{villageId}
  - name: string
  - code: string  // e.g., "thon-01"
  - region: "dien_sanh_cu" | "hai_truong" | "hai_dinh"
  - type: "thon" | "kdc"
  - leaderId?: string  // uid of village leader
  - leaderName?: string
  - leaderPhone?: string
  - householdCount: number
  - residentCount: number
  - createdAt: timestamp
  - updatedAt: timestamp

/villages/{villageId}/households/{householdId}
  - code: string  // So ho khau
  - headName: string
  - headPhone?: string
  - address: string
  - memberCount: number
  - createdAt: timestamp
  - updatedAt: timestamp

/villages/{villageId}/households/{householdId}/residents/{residentId}
  - name: string
  - birthDate?: timestamp
  - gender: "male" | "female"
  - idNumberEncrypted?: string  // CCCD encrypted with AES-256-GCM (Validated Decision)
  - idNumberHash?: string       // SHA-256 hash for lookup without decryption
  - phone?: string
  - relationship: string  // Quan he voi chu ho
  - isHead: boolean
  - createdAt: timestamp
  - updatedAt: timestamp

/tasks/{taskId}
  - title: string
  - description: string
  - type: "survey" | "notification" | "report" | "other"
  - status: "pending" | "in_progress" | "completed" | "cancelled"
  - priority: "low" | "medium" | "high"
  - assignedTo: string[]  // villageIds
  - createdBy: string  // uid
  - dueDate?: timestamp
  - completedAt?: timestamp
  - createdAt: timestamp
  - updatedAt: timestamp

/tasks/{taskId}/reports/{reportId}
  - villageId: string
  - submittedBy: string  // uid
  - content: string
  - attachments?: string[]
  - submittedAt: timestamp

/messages/{messageId}
  - type: "sms" | "notification"
  - content: string
  - recipients: string[]  // phone numbers or villageIds
  - recipientType: "all" | "village" | "individual"
  - status: "queued" | "sent" | "delivered" | "failed"
  - provider?: string
  - providerId?: string
  - sentBy: string  // uid
  - sentAt?: timestamp
  - createdAt: timestamp

/requests/{requestId}
  - type: string  // Request type
  - title: string
  - description: string
  - status: "pending" | "processing" | "completed" | "rejected"
  - submittedBy: string  // uid or phone
  - submitterName: string
  - submitterPhone: string
  - assignedTo?: string  // uid
  - response?: string
  - createdAt: timestamp
  - updatedAt: timestamp

/announcements/{announcementId}
  - title: string
  - content: string
  - type: "news" | "policy" | "event" | "urgent"
  - publishedAt?: timestamp
  - expiresAt?: timestamp
  - isPublished: boolean
  - createdBy: string
  - createdAt: timestamp
  - updatedAt: timestamp
```

---

## Related Code Files

### Create
- `firestore.rules` - Security rules
- `firestore.indexes.json` - Composite indexes
- `scripts/seed-villages.ts` - Village seeding script

### Modify
- `firebase.json` - Add Firestore config

---

## Implementation Steps

### 1. Create Security Rules (3h)

```javascript
// firestore.rules
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'commune_admin';
    }

    function isVillageLeader(villageId) {
      let user = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return user.data.role == 'village_leader' && user.data.villageId == villageId;
    }

    function isAdminOrVillageLeader(villageId) {
      return isAdmin() || isVillageLeader(villageId);
    }

    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAdmin() || request.auth.uid == userId;
      allow delete: if isAdmin();
    }

    // Villages collection
    match /villages/{villageId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();

      // Households subcollection
      match /households/{householdId} {
        allow read: if isAdminOrVillageLeader(villageId);
        allow write: if isAdminOrVillageLeader(villageId);

        // Residents subcollection
        match /residents/{residentId} {
          allow read: if isAdminOrVillageLeader(villageId);
          allow write: if isAdminOrVillageLeader(villageId);
        }
      }
    }

    // Tasks collection
    match /tasks/{taskId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin();
      allow update: if isAdmin() ||
        (resource.data.assignedTo.hasAny([get(/databases/$(database)/documents/users/$(request.auth.uid)).data.villageId]));
      allow delete: if isAdmin();

      match /reports/{reportId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update, delete: if isAdmin() || request.auth.uid == resource.data.submittedBy;
      }
    }

    // Messages - admin only
    match /messages/{messageId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // Requests
    match /requests/{requestId} {
      allow read: if isAdmin() || request.auth.uid == resource.data.submittedBy;
      allow create: if true;  // Public can submit
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Announcements
    match /announcements/{announcementId} {
      allow read: if resource.data.isPublished == true || isAdmin();
      allow write: if isAdmin();
    }
  }
}
```

### 2. Create Indexes (1h)

```json
// firestore.indexes.json
{
  "indexes": [
    {
      "collectionGroup": "households",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "headName", "order": "ASCENDING" },
        { "fieldPath": "createdAt", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "tasks",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "status", "order": "ASCENDING" },
        { "fieldPath": "dueDate", "order": "ASCENDING" }
      ]
    },
    {
      "collectionGroup": "messages",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "status", "order": "ASCENDING" },
        { "fieldPath": "createdAt", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "requests",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "status", "order": "ASCENDING" },
        { "fieldPath": "createdAt", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "announcements",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "isPublished", "order": "ASCENDING" },
        { "fieldPath": "publishedAt", "order": "DESCENDING" }
      ]
    }
  ]
}
```

### 3. Seed Villages Script (2h)

Create `scripts/seed-villages.ts`:
```typescript
import { initializeApp, cert } from 'firebase-admin/app'
import { getFirestore } from 'firebase-admin/firestore'

const villages = [
  // Dien Sanh cu - 9 thon + 2 KDC
  { code: 'thon-01', name: 'Thôn 1', region: 'dien_sanh_cu', type: 'thon' },
  { code: 'thon-02', name: 'Thôn 2', region: 'dien_sanh_cu', type: 'thon' },
  // ... (all 18 thon + 2 KDC)
  { code: 'kdc-01', name: 'KDC 1', region: 'dien_sanh_cu', type: 'kdc' },
  { code: 'kdc-02', name: 'KDC 2', region: 'dien_sanh_cu', type: 'kdc' },
  // Hai Truong - 5 thon
  // Hai Dinh - 4 thon
]

async function seed() {
  const db = getFirestore()
  const batch = db.batch()

  for (const village of villages) {
    const ref = db.collection('villages').doc(village.code)
    batch.set(ref, {
      ...village,
      householdCount: 0,
      residentCount: 0,
      createdAt: new Date(),
      updatedAt: new Date()
    })
  }

  await batch.commit()
  console.log(`Seeded ${villages.length} villages`)
}
```

### 4. TypeScript Types (1.5h)

Create `web/src/types/firestore.ts`:
```typescript
export interface User {
  phone: string
  displayName: string
  role: 'commune_admin' | 'village_leader' | 'resident'
  villageId?: string
  createdAt: Date
  updatedAt: Date
}

export interface Village {
  name: string
  code: string
  region: 'dien_sanh_cu' | 'hai_truong' | 'hai_dinh'
  type: 'thon' | 'kdc'
  leaderId?: string
  leaderName?: string
  leaderPhone?: string
  householdCount: number
  residentCount: number
  createdAt: Date
  updatedAt: Date
}

// ... other types
```

### 5. Firestore Hooks (2h)

Create `web/src/hooks/use-villages.ts`, `use-households.ts`, etc. with React Query integration.

### 6. Deploy & Test (0.5h)
```bash
firebase deploy --only firestore:rules,firestore:indexes
```

---

## Todo List
- [ ] Write Firestore security rules
- [ ] Create composite indexes
- [ ] Build village seeding script
- [ ] Define TypeScript types for all collections
- [ ] Create React Query hooks for data fetching
- [ ] Deploy rules and indexes
- [ ] Test CRUD operations for each role
- [ ] Verify offline write queuing
- [ ] Install crypto-js and create encryption utils
- [ ] Test CCCD encryption/decryption

---

## Success Criteria
- [ ] Security rules prevent unauthorized access
- [ ] Admin can CRUD all collections
- [ ] Village leader can only access own village data
- [ ] Public users can read announcements and submit requests
- [ ] Offline writes queue correctly
- [ ] 20 villages seeded successfully

---

## Risk Assessment

| Risk | Impact | Mitigation |
|------|--------|------------|
| Security rule bypass | Critical | Test with Firebase Emulator |
| Index not created | Medium | Test queries before deployment |
| Data migration issues | Medium | Create import validation script |

---

## Security Considerations
- **CCCD Encryption (Validated Decision):** Encrypt all CCCD data with AES-256-GCM
  - Encryption key stored in Firebase Secret Manager or env var
  - Hash stored separately for lookup without decryption
  - Decrypt only when displaying to authorized users
- Audit log for sensitive data access (future)
- Rate limiting on public endpoints
- Validate data format in security rules

### CCCD Encryption Implementation
```typescript
// web/src/lib/encryption.ts
import CryptoJS from 'crypto-js'

const ENCRYPTION_KEY = import.meta.env.VITE_ENCRYPTION_KEY

export function encryptCCCD(cccd: string): { encrypted: string; hash: string } {
  const encrypted = CryptoJS.AES.encrypt(cccd, ENCRYPTION_KEY).toString()
  const hash = CryptoJS.SHA256(cccd).toString()
  return { encrypted, hash }
}

export function decryptCCCD(encrypted: string): string {
  const bytes = CryptoJS.AES.decrypt(encrypted, ENCRYPTION_KEY)
  return bytes.toString(CryptoJS.enc.Utf8)
}

export function hashCCCD(cccd: string): string {
  return CryptoJS.SHA256(cccd).toString()
}
```

---

## Next Steps
After completion:
1. → Phase 03: Admin Dashboard & Navigation
2. Import real village data from commune
3. Create admin user in Firestore
</file>

<file path="plans/260115-2249-diensanh-commune-management-app/phase-03-admin-dashboard-navigation.md">
# Phase 03: Admin Dashboard & Navigation

## Context Links
- [Plan Overview](./plan.md)
- [Phase 02: Firestore Schema](./phase-02-firestore-schema-security.md)

## Overview
| Field | Value |
|-------|-------|
| Priority | P1 - Critical Path |
| Status | pending |
| Effort | 14h |
| Dependencies | Phase 01, 02 complete |

Build admin dashboard with statistics cards, responsive sidebar navigation, and role-based menu items.

---

## Key Insights
- Dashboard must work offline (show cached stats)
- Vietnamese date/number formatting required
- Mobile-first responsive design
- Use skeleton loaders for better perceived performance

---

## Requirements

### Functional
- FR1: Display key statistics (villages, households, residents, pending tasks)
- FR2: Recent activity feed
- FR3: Quick actions panel
- FR4: Responsive sidebar with role-based menu

### Non-Functional
- NFR1: Dashboard loads <2s on 3G
- NFR2: Works offline with cached data
- NFR3: Mobile-friendly (collapsible sidebar)

---

## Architecture

### Component Structure
```
src/components/
├── layout/
│   ├── admin-layout.tsx       # Main layout wrapper
│   ├── sidebar.tsx            # Collapsible sidebar
│   ├── top-navbar.tsx         # Top bar with user menu
│   ├── mobile-nav.tsx         # Bottom nav for mobile
│   └── offline-banner.tsx     # Offline indicator
├── dashboard/
│   ├── stats-card.tsx         # Statistic card component
│   ├── stats-grid.tsx         # Grid of stat cards
│   ├── activity-feed.tsx      # Recent activity list
│   ├── quick-actions.tsx      # Quick action buttons
│   └── pending-tasks.tsx      # Pending tasks widget

src/pages/admin/
├── dashboard.tsx              # Admin dashboard page
└── index.tsx                  # Admin section index
```

### Navigation Menu (Admin)
```typescript
const adminMenu = [
  { icon: 'LayoutDashboard', label: 'Tổng quan', path: '/admin' },
  { icon: 'Building2', label: 'Quản lý thôn', path: '/admin/villages' },
  { icon: 'Users', label: 'Hộ gia đình', path: '/admin/households' },
  { icon: 'MessageSquare', label: 'Tin nhắn SMS', path: '/admin/messages' },
  { icon: 'ClipboardList', label: 'Công việc', path: '/admin/tasks' },
  { icon: 'FileText', label: 'Yêu cầu', path: '/admin/requests' },
  { icon: 'Megaphone', label: 'Thông báo', path: '/admin/announcements' },
  { icon: 'BarChart3', label: 'Báo cáo', path: '/admin/reports' },
  { icon: 'Settings', label: 'Cài đặt', path: '/admin/settings' },
]
```

### Navigation Menu (Village Leader)
```typescript
const villageMenu = [
  { icon: 'LayoutDashboard', label: 'Tổng quan', path: '/village' },
  { icon: 'Users', label: 'Hộ gia đình', path: '/village/households' },
  { icon: 'ClipboardList', label: 'Công việc', path: '/village/tasks' },
  { icon: 'FileText', label: 'Yêu cầu', path: '/village/requests' },
  { icon: 'Megaphone', label: 'Thông báo', path: '/village/announcements' },
]
```

---

## Related Code Files

### Create
- `src/components/layout/admin-layout.tsx`
- `src/components/layout/sidebar.tsx`
- `src/components/layout/top-navbar.tsx`
- `src/components/layout/mobile-nav.tsx`
- `src/components/layout/offline-banner.tsx`
- `src/components/dashboard/stats-card.tsx`
- `src/components/dashboard/stats-grid.tsx`
- `src/components/dashboard/activity-feed.tsx`
- `src/components/dashboard/quick-actions.tsx`
- `src/pages/admin/dashboard.tsx`
- `src/pages/admin/index.tsx`
- `src/pages/village/dashboard.tsx`
- `src/hooks/use-dashboard-stats.ts`

### Modify
- `src/routes/index.tsx` - Add admin routes

---

## Implementation Steps

### 1. Install UI Dependencies (0.5h)
```bash
npm install @radix-ui/react-dropdown-menu @radix-ui/react-slot
npm install class-variance-authority
```

### 2. Create AdminLayout (2h)
```typescript
// src/components/layout/admin-layout.tsx
export function AdminLayout({ children }: { children: React.ReactNode }) {
  const [sidebarOpen, setSidebarOpen] = useState(true)
  const isOnline = useNetworkStatus()

  return (
    <div className="min-h-screen bg-gray-50">
      {!isOnline && <OfflineBanner />}
      <Sidebar open={sidebarOpen} onToggle={() => setSidebarOpen(!sidebarOpen)} />
      <div className={cn('transition-all', sidebarOpen ? 'lg:ml-64' : 'lg:ml-16')}>
        <TopNavbar onMenuClick={() => setSidebarOpen(!sidebarOpen)} />
        <main className="p-4 lg:p-6">{children}</main>
      </div>
      <MobileNav className="lg:hidden" />
    </div>
  )
}
```

### 3. Create Sidebar (2.5h)
```typescript
// src/components/layout/sidebar.tsx
export function Sidebar({ open, onToggle }: SidebarProps) {
  const { user } = useAuth()
  const location = useLocation()
  const menu = user?.role === 'commune_admin' ? adminMenu : villageMenu

  return (
    <aside className={cn(
      'fixed left-0 top-0 z-40 h-screen bg-white border-r transition-all',
      open ? 'w-64' : 'w-16'
    )}>
      <div className="p-4 border-b">
        <img src="/logo.png" alt="Diên Sanh" className="h-8" />
        {open && <span className="ml-2 font-semibold">UBND Xã Diên Sanh</span>}
      </div>
      <nav className="p-2 space-y-1">
        {menu.map((item) => (
          <NavLink key={item.path} to={item.path} ... />
        ))}
      </nav>
    </aside>
  )
}
```

### 4. Create StatsCard Component (1h)
```typescript
// src/components/dashboard/stats-card.tsx
interface StatsCardProps {
  title: string
  value: number
  icon: React.ReactNode
  trend?: { value: number; isPositive: boolean }
  loading?: boolean
}

export function StatsCard({ title, value, icon, trend, loading }: StatsCardProps) {
  if (loading) return <StatsCardSkeleton />

  return (
    <div className="bg-white rounded-lg border p-4 shadow-sm">
      <div className="flex items-center justify-between">
        <div className="text-sm text-gray-500">{title}</div>
        <div className="p-2 bg-primary/10 rounded-lg">{icon}</div>
      </div>
      <div className="mt-2">
        <div className="text-2xl font-bold">{value.toLocaleString('vi-VN')}</div>
        {trend && (
          <div className={cn('text-sm', trend.isPositive ? 'text-green-600' : 'text-red-600')}>
            {trend.isPositive ? '+' : ''}{trend.value}% so với tháng trước
          </div>
        )}
      </div>
    </div>
  )
}
```

### 5. Create Dashboard Stats Hook (1.5h)
```typescript
// src/hooks/use-dashboard-stats.ts
export function useDashboardStats() {
  const { db } = useFirestore()

  return useQuery({
    queryKey: ['dashboard-stats'],
    queryFn: async () => {
      const [villages, tasks, requests, messages] = await Promise.all([
        getDocs(collection(db, 'villages')),
        getDocs(query(collection(db, 'tasks'), where('status', '==', 'pending'))),
        getDocs(query(collection(db, 'requests'), where('status', '==', 'pending'))),
        getDocs(query(collection(db, 'messages'), where('status', '==', 'sent'))),
      ])

      const totalHouseholds = villages.docs.reduce(
        (sum, doc) => sum + (doc.data().householdCount || 0), 0
      )
      const totalResidents = villages.docs.reduce(
        (sum, doc) => sum + (doc.data().residentCount || 0), 0
      )

      return {
        villageCount: villages.size,
        householdCount: totalHouseholds,
        residentCount: totalResidents,
        pendingTasks: tasks.size,
        pendingRequests: requests.size,
        sentMessages: messages.size,
      }
    },
    staleTime: 5 * 60 * 1000, // 5 minutes
  })
}
```

### 6. Build Dashboard Page (2.5h)
```typescript
// src/pages/admin/dashboard.tsx
export function AdminDashboard() {
  const { data: stats, isLoading } = useDashboardStats()

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <h1 className="text-2xl font-bold">Tổng quan</h1>
        <div className="text-sm text-gray-500">
          Cập nhật: {format(new Date(), 'HH:mm dd/MM/yyyy', { locale: vi })}
        </div>
      </div>

      <StatsGrid>
        <StatsCard
          title="Số thôn"
          value={stats?.villageCount ?? 0}
          icon={<Building2 />}
          loading={isLoading}
        />
        <StatsCard
          title="Hộ gia đình"
          value={stats?.householdCount ?? 0}
          icon={<Home />}
          loading={isLoading}
        />
        <StatsCard
          title="Nhân khẩu"
          value={stats?.residentCount ?? 0}
          icon={<Users />}
          loading={isLoading}
        />
        <StatsCard
          title="Việc cần làm"
          value={stats?.pendingTasks ?? 0}
          icon={<ClipboardList />}
          loading={isLoading}
        />
      </StatsGrid>

      <div className="grid lg:grid-cols-2 gap-6">
        <ActivityFeed />
        <PendingTasks />
      </div>

      <QuickActions />
    </div>
  )
}
```

### 7. Create Activity Feed (1.5h)
Fetch recent activity from tasks, requests, messages collections.

### 8. Create Quick Actions Panel (1h)
Buttons for common actions: Add household, Send SMS, Create task, etc.

### 9. Add Routes (0.5h)
```typescript
// src/routes/admin-routes.tsx
const adminRoutes = [
  { path: '/admin', element: <AdminDashboard /> },
  { path: '/admin/villages', element: <VillagesPage /> },
  // ...
]
```

### 10. Test Responsive Design (1h)
- Test on mobile viewport
- Test sidebar collapse
- Test offline mode
- Test Vietnamese number formatting

---

## Todo List
- [ ] Install Radix UI components
- [ ] Create AdminLayout component
- [ ] Create responsive Sidebar
- [ ] Create TopNavbar with user menu
- [ ] Create MobileNav (bottom navigation)
- [ ] Create OfflineBanner component
- [ ] Create StatsCard with skeleton loader
- [ ] Create useDashboardStats hook
- [ ] Build AdminDashboard page
- [ ] Create ActivityFeed component
- [ ] Create QuickActions panel
- [ ] Setup admin routes
- [ ] Test responsive design
- [ ] Test offline data display

---

## Success Criteria
- [ ] Dashboard displays all key statistics
- [ ] Sidebar collapses on mobile
- [ ] Navigation works for both roles
- [ ] Offline banner shows when disconnected
- [ ] Cached data displays when offline
- [ ] Vietnamese formatting correct
- [ ] No layout shift on load

---

## Risk Assessment

| Risk | Impact | Mitigation |
|------|--------|------------|
| Slow initial load | Medium | Use skeleton loaders, stale-while-revalidate |
| Navigation confusion | Low | User testing with commune staff |
| Mobile usability | Medium | Bottom nav + gesture support |

---

## Security Considerations
- Hide admin-only menu items for village leaders
- Validate role before rendering admin pages
- No sensitive data in sidebar labels

---

## Next Steps
After completion:
1. → Phase 04: Village Management Module
2. Gather feedback from commune staff
3. Add analytics tracking
</file>

<file path="plans/260115-2249-diensanh-commune-management-app/phase-04-village-management.md">
# Phase 04: Village Management Module

## Context Links
- [Plan Overview](./plan.md)
- [Phase 02: Firestore Schema](./phase-02-firestore-schema-security.md)
- [Phase 03: Dashboard](./phase-03-admin-dashboard-navigation.md)

## Overview
| Field | Value |
|-------|-------|
| Priority | P1 |
| Status | pending |
| Effort | 12h |
| Dependencies | Phase 01-03 complete |

Build village listing, detail view, and leader assignment for 18 thon + 2 KDC.

---

## Key Insights
- 3 regions for filtering: Dien Sanh cu (11), Hai Truong (5), Hai Dinh (4)
- Leader assignment requires user search/creation
- Village stats aggregate from households subcollection
- Read-only for village leaders (own village only)

---

## Requirements

### Functional
- FR1: List all villages with stats (admin)
- FR2: Filter by region (Dien Sanh cu, Hai Truong, Hai Dinh)
- FR3: View village details with household summary
- FR4: Assign/reassign village leader (admin)
- FR5: Village leader sees only their village

### Non-Functional
- NFR1: List loads <1s
- NFR2: Search filters instantly (client-side)
- NFR3: Works offline for cached villages

---

## Architecture

### Components
```
src/components/villages/
├── village-list.tsx           # Table/card list
├── village-card.tsx           # Village card component
├── village-detail.tsx         # Village detail view
├── village-stats.tsx          # Stats summary
├── leader-assignment.tsx      # Leader picker modal
├── region-filter.tsx          # Region filter buttons
└── village-search.tsx         # Search input

src/pages/admin/
├── villages/
│   ├── index.tsx              # List page
│   └── [villageId].tsx        # Detail page

src/pages/village/
└── index.tsx                  # Village leader dashboard
```

### Data Flow
```
VillagesPage
  → useVillages() hook (React Query)
    → Firestore /villages collection
    → Aggregate household counts
  → VillageList (filterable, searchable)
    → VillageCard
      → Click → VillageDetail
        → LeaderAssignment modal
```

---

## Related Code Files

### Create
- `src/components/villages/village-list.tsx`
- `src/components/villages/village-card.tsx`
- `src/components/villages/village-detail.tsx`
- `src/components/villages/village-stats.tsx`
- `src/components/villages/leader-assignment.tsx`
- `src/components/villages/region-filter.tsx`
- `src/pages/admin/villages/index.tsx`
- `src/pages/admin/villages/[villageId].tsx`
- `src/pages/village/index.tsx`
- `src/hooks/use-villages.ts`
- `src/hooks/use-village.ts`

### Modify
- `src/routes/index.tsx` - Add village routes

---

## Implementation Steps

### 1. Create useVillages Hook (1.5h)
```typescript
// src/hooks/use-villages.ts
export function useVillages(options?: { region?: string }) {
  const { db } = useFirestore()

  return useQuery({
    queryKey: ['villages', options?.region],
    queryFn: async () => {
      let q = collection(db, 'villages')

      if (options?.region) {
        q = query(q, where('region', '==', options.region))
      }

      const snapshot = await getDocs(q)
      return snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      })) as Village[]
    },
    staleTime: 5 * 60 * 1000,
  })
}
```

### 2. Create useVillage Hook (1h)
```typescript
// src/hooks/use-village.ts
export function useVillage(villageId: string) {
  const { db } = useFirestore()

  const villageQuery = useQuery({
    queryKey: ['village', villageId],
    queryFn: async () => {
      const doc = await getDoc(doc(db, 'villages', villageId))
      return { id: doc.id, ...doc.data() } as Village
    },
  })

  const householdsQuery = useQuery({
    queryKey: ['village-households', villageId],
    queryFn: async () => {
      const snapshot = await getDocs(
        collection(db, 'villages', villageId, 'households')
      )
      return snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }))
    },
  })

  return { village: villageQuery, households: householdsQuery }
}
```

### 3. Create RegionFilter Component (1h)
```typescript
// src/components/villages/region-filter.tsx
const regions = [
  { value: '', label: 'Tất cả' },
  { value: 'dien_sanh_cu', label: 'Diên Sanh cũ' },
  { value: 'hai_truong', label: 'Hải Trường' },
  { value: 'hai_dinh', label: 'Hải Định' },
]

export function RegionFilter({ value, onChange }: RegionFilterProps) {
  return (
    <div className="flex gap-2">
      {regions.map(region => (
        <button
          key={region.value}
          onClick={() => onChange(region.value)}
          className={cn(
            'px-3 py-1.5 rounded-full text-sm transition',
            value === region.value
              ? 'bg-primary text-white'
              : 'bg-gray-100 hover:bg-gray-200'
          )}
        >
          {region.label}
        </button>
      ))}
    </div>
  )
}
```

### 4. Create VillageCard Component (1.5h)
```typescript
// src/components/villages/village-card.tsx
export function VillageCard({ village }: { village: Village }) {
  return (
    <Link
      to={`/admin/villages/${village.id}`}
      className="block bg-white rounded-lg border p-4 hover:shadow-md transition"
    >
      <div className="flex items-start justify-between">
        <div>
          <h3 className="font-semibold text-lg">{village.name}</h3>
          <p className="text-sm text-gray-500">
            {village.type === 'thon' ? 'Thôn' : 'KDC'} • {regionLabels[village.region]}
          </p>
        </div>
        <span className={cn(
          'px-2 py-0.5 rounded text-xs',
          village.leaderId ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'
        )}>
          {village.leaderId ? 'Có trưởng thôn' : 'Chưa có'}
        </span>
      </div>

      <div className="mt-4 grid grid-cols-2 gap-2 text-sm">
        <div className="flex items-center gap-2">
          <Home className="h-4 w-4 text-gray-400" />
          <span>{village.householdCount} hộ</span>
        </div>
        <div className="flex items-center gap-2">
          <Users className="h-4 w-4 text-gray-400" />
          <span>{village.residentCount} nhân khẩu</span>
        </div>
      </div>

      {village.leaderName && (
        <div className="mt-3 pt-3 border-t text-sm text-gray-600">
          <span className="font-medium">Trưởng thôn:</span> {village.leaderName}
        </div>
      )}
    </Link>
  )
}
```

### 5. Create VillageList Component (1.5h)
```typescript
// src/components/villages/village-list.tsx
export function VillageList({ villages, loading }: VillageListProps) {
  const [search, setSearch] = useState('')

  const filtered = useMemo(() => {
    if (!search) return villages
    const lower = search.toLowerCase()
    return villages.filter(v =>
      v.name.toLowerCase().includes(lower) ||
      v.leaderName?.toLowerCase().includes(lower)
    )
  }, [villages, search])

  if (loading) {
    return (
      <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
        {[...Array(6)].map((_, i) => <VillageCardSkeleton key={i} />)}
      </div>
    )
  }

  return (
    <div className="space-y-4">
      <input
        type="text"
        placeholder="Tìm kiếm thôn..."
        value={search}
        onChange={e => setSearch(e.target.value)}
        className="w-full md:w-80 px-4 py-2 border rounded-lg"
      />

      <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
        {filtered.map(village => (
          <VillageCard key={village.id} village={village} />
        ))}
      </div>

      {filtered.length === 0 && (
        <p className="text-center text-gray-500 py-8">
          Không tìm thấy thôn nào
        </p>
      )}
    </div>
  )
}
```

### 6. Create VillagesPage (1h)
```typescript
// src/pages/admin/villages/index.tsx
export function VillagesPage() {
  const [region, setRegion] = useState('')
  const { data: villages, isLoading } = useVillages({ region })

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <h1 className="text-2xl font-bold">Quản lý thôn</h1>
      </div>

      <RegionFilter value={region} onChange={setRegion} />

      <VillageList villages={villages ?? []} loading={isLoading} />
    </div>
  )
}
```

### 7. Create VillageDetail Page (2h)
```typescript
// src/pages/admin/villages/[villageId].tsx
export function VillageDetailPage() {
  const { villageId } = useParams()
  const { village, households } = useVillage(villageId!)
  const [showLeaderModal, setShowLeaderModal] = useState(false)

  return (
    <div className="space-y-6">
      <Breadcrumb items={[
        { label: 'Quản lý thôn', href: '/admin/villages' },
        { label: village.data?.name }
      ]} />

      <div className="bg-white rounded-lg border p-6">
        <div className="flex items-start justify-between">
          <div>
            <h1 className="text-2xl font-bold">{village.data?.name}</h1>
            <p className="text-gray-500">{regionLabels[village.data?.region]}</p>
          </div>
          <Button onClick={() => setShowLeaderModal(true)}>
            {village.data?.leaderId ? 'Đổi trưởng thôn' : 'Gán trưởng thôn'}
          </Button>
        </div>

        <VillageStats village={village.data} />
      </div>

      <div className="bg-white rounded-lg border p-6">
        <h2 className="text-lg font-semibold mb-4">Danh sách hộ gia đình</h2>
        <HouseholdTable households={households.data ?? []} />
      </div>

      <LeaderAssignmentModal
        open={showLeaderModal}
        onClose={() => setShowLeaderModal(false)}
        village={village.data}
      />
    </div>
  )
}
```

### 8. Create LeaderAssignment Modal (1.5h)
```typescript
// src/components/villages/leader-assignment.tsx
export function LeaderAssignmentModal({ open, onClose, village }: Props) {
  const [phone, setPhone] = useState('')
  const [name, setName] = useState('')
  const { mutate: assignLeader, isPending } = useAssignLeader()

  const handleSubmit = () => {
    assignLeader({
      villageId: village.id,
      phone,
      name,
    }, {
      onSuccess: () => onClose()
    })
  }

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Gán trưởng thôn - {village?.name}</DialogTitle>
        </DialogHeader>

        <div className="space-y-4">
          <div>
            <Label>Họ tên</Label>
            <Input value={name} onChange={e => setName(e.target.value)} />
          </div>
          <div>
            <Label>Số điện thoại</Label>
            <Input value={phone} onChange={e => setPhone(e.target.value)} placeholder="0912345678" />
          </div>
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={onClose}>Hủy</Button>
          <Button onClick={handleSubmit} disabled={isPending}>
            {isPending ? 'Đang lưu...' : 'Lưu'}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  )
}
```

### 9. Village Leader Dashboard (1h)
For village leaders - simplified view of their village only.

---

## Todo List
- [ ] Create useVillages hook
- [ ] Create useVillage hook
- [ ] Create RegionFilter component
- [ ] Create VillageCard component
- [ ] Create VillageList with search
- [ ] Create VillagesPage
- [ ] Create VillageDetailPage
- [ ] Create LeaderAssignment modal
- [ ] Create useAssignLeader mutation
- [ ] Create VillageLeaderDashboard
- [ ] Add routes for village pages
- [ ] Test filtering and search
- [ ] Test leader assignment flow
- [ ] Test village leader access

---

## Success Criteria
- [ ] All 20 villages display correctly
- [ ] Region filter works
- [ ] Search filters by name/leader
- [ ] Leader assignment updates Firestore
- [ ] Village leader sees only their village
- [ ] Offline displays cached villages

---

## Risk Assessment

| Risk | Impact | Mitigation |
|------|--------|------------|
| Missing village data | Medium | Seed script with all 20 villages |
| Leader reassignment issues | Low | Confirm dialog, audit log |
| Large household lists | Medium | Pagination, virtual scroll |

---

## Security Considerations
- Validate admin role before leader assignment
- Log leader changes for audit
- Village leaders cannot modify village metadata

---

## Next Steps
After completion:
1. → Phase 05: Household & Resident Management
2. Import real village leader data
3. Test with commune admin
</file>

<file path="plans/260115-2249-diensanh-commune-management-app/phase-05-household-resident-management.md">
# Phase 05: Household & Resident Management

## Context Links
- [Plan Overview](./plan.md)
- [Phase 02: Firestore Schema](./phase-02-firestore-schema-security.md)
- [Phase 04: Village Management](./phase-04-village-management.md)

## Overview
| Field | Value |
|-------|-------|
| Priority | P1 |
| Status | pending |
| Effort | 16h |
| Dependencies | Phase 04 complete |

Full CRUD for households and residents per village with offline support.

---

## Key Insights
- Subcollection path: /villages/{villageId}/households/{householdId}/residents/{residentId}
- Offline writes queue automatically with Firestore
- Bulk import needed for initial data migration
- CCCD (national ID) is sensitive - handle carefully

---

## Requirements

### Functional
- FR1: List households per village (paginated)
- FR2: Add/edit/delete household
- FR3: List residents per household
- FR4: Add/edit/delete resident
- FR5: Search households by head name, code
- FR6: Bulk import from Excel/CSV
- FR7: Export household data

### Non-Functional
- NFR1: Support 500+ households per village
- NFR2: Offline CRUD with sync indicator
- NFR3: Form validation before submit

---

## Architecture

### Components
```
src/components/households/
├── household-table.tsx        # Paginated table
├── household-row.tsx          # Table row
├── household-form.tsx         # Add/edit form
├── household-detail.tsx       # Detail panel
├── household-search.tsx       # Search/filter
├── household-import.tsx       # Bulk import modal
└── household-export.tsx       # Export button

src/components/residents/
├── resident-list.tsx          # Resident list
├── resident-card.tsx          # Resident card
├── resident-form.tsx          # Add/edit form
└── relationship-select.tsx    # Relationship dropdown

src/pages/admin/households/
├── index.tsx                  # Global household view
└── [householdId].tsx          # Household detail

src/pages/village/households/
├── index.tsx                  # Village-scoped list
└── [householdId].tsx          # Household detail
```

### Form Fields - Household
```typescript
interface HouseholdFormData {
  code: string          // So ho khau (required)
  headName: string      // Ho ten chu ho (required)
  headPhone?: string    // SDT chu ho
  address: string       // Dia chi (required)
}
```

### Form Fields - Resident
```typescript
interface ResidentFormData {
  name: string                     // Ho ten (required)
  birthDate?: Date                 // Ngay sinh
  gender: 'male' | 'female'        // Gioi tinh (required)
  idNumber?: string                // CCCD
  phone?: string                   // SDT
  relationship: string             // Quan he voi chu ho (required)
  isHead: boolean                  // La chu ho
}

const relationships = [
  'Chủ hộ',
  'Vợ/Chồng',
  'Con',
  'Bố/Mẹ',
  'Ông/Bà',
  'Anh/Chị/Em',
  'Cháu',
  'Khác'
]
```

---

## Related Code Files

### Create
- `src/components/households/household-table.tsx`
- `src/components/households/household-form.tsx`
- `src/components/households/household-detail.tsx`
- `src/components/households/household-search.tsx`
- `src/components/households/household-import.tsx`
- `src/components/residents/resident-list.tsx`
- `src/components/residents/resident-form.tsx`
- `src/pages/admin/households/index.tsx`
- `src/pages/admin/households/[householdId].tsx`
- `src/pages/village/households/index.tsx`
- `src/hooks/use-households.ts`
- `src/hooks/use-household.ts`
- `src/hooks/use-residents.ts`
- `src/lib/import-export.ts`

---

## Implementation Steps

### 1. Create useHouseholds Hook (1.5h)
```typescript
// src/hooks/use-households.ts
export function useHouseholds(villageId: string, options?: { search?: string; limit?: number }) {
  const { db } = useFirestore()

  return useQuery({
    queryKey: ['households', villageId, options],
    queryFn: async () => {
      const householdsRef = collection(db, 'villages', villageId, 'households')
      let q = query(householdsRef, orderBy('headName'), limit(options?.limit ?? 50))

      const snapshot = await getDocs(q)
      return snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      })) as Household[]
    },
    staleTime: 2 * 60 * 1000,
  })
}

// Mutations
export function useCreateHousehold(villageId: string) {
  const { db } = useFirestore()
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async (data: HouseholdFormData) => {
      const householdsRef = collection(db, 'villages', villageId, 'households')
      const docRef = await addDoc(householdsRef, {
        ...data,
        memberCount: 0,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
      })
      return docRef.id
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['households', villageId] })
      queryClient.invalidateQueries({ queryKey: ['village', villageId] })
    }
  })
}
```

### 2. Create HouseholdTable Component (2h)
```typescript
// src/components/households/household-table.tsx
export function HouseholdTable({ households, villageId, loading }: Props) {
  if (loading) return <TableSkeleton rows={10} cols={5} />

  return (
    <table className="w-full">
      <thead>
        <tr className="border-b bg-gray-50">
          <th className="text-left p-3">Số hộ khẩu</th>
          <th className="text-left p-3">Chủ hộ</th>
          <th className="text-left p-3">Địa chỉ</th>
          <th className="text-center p-3">Số nhân khẩu</th>
          <th className="text-right p-3">Thao tác</th>
        </tr>
      </thead>
      <tbody>
        {households.map(household => (
          <HouseholdRow
            key={household.id}
            household={household}
            villageId={villageId}
          />
        ))}
      </tbody>
    </table>
  )
}
```

### 3. Create HouseholdForm Component (2h)
```typescript
// src/components/households/household-form.tsx
export function HouseholdForm({ villageId, household, onSuccess }: Props) {
  const isEdit = !!household
  const createMutation = useCreateHousehold(villageId)
  const updateMutation = useUpdateHousehold(villageId, household?.id)

  const form = useForm<HouseholdFormData>({
    defaultValues: household ?? {
      code: '',
      headName: '',
      headPhone: '',
      address: '',
    }
  })

  const onSubmit = (data: HouseholdFormData) => {
    const mutation = isEdit ? updateMutation : createMutation
    mutation.mutate(data, { onSuccess })
  }

  return (
    <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
      <div>
        <Label htmlFor="code">Số hộ khẩu *</Label>
        <Input
          {...form.register('code', { required: 'Bắt buộc' })}
          placeholder="VD: HK-001"
        />
        {form.formState.errors.code && (
          <p className="text-red-500 text-sm mt-1">
            {form.formState.errors.code.message}
          </p>
        )}
      </div>

      <div>
        <Label htmlFor="headName">Họ tên chủ hộ *</Label>
        <Input {...form.register('headName', { required: 'Bắt buộc' })} />
      </div>

      <div>
        <Label htmlFor="headPhone">Số điện thoại</Label>
        <Input {...form.register('headPhone')} placeholder="0912345678" />
      </div>

      <div>
        <Label htmlFor="address">Địa chỉ *</Label>
        <Textarea {...form.register('address', { required: 'Bắt buộc' })} />
      </div>

      <div className="flex justify-end gap-2">
        <Button type="submit" disabled={form.formState.isSubmitting}>
          {form.formState.isSubmitting ? 'Đang lưu...' : 'Lưu'}
        </Button>
      </div>
    </form>
  )
}
```

### 4. Create useResidents Hook (1h)
```typescript
// src/hooks/use-residents.ts
export function useResidents(villageId: string, householdId: string) {
  const { db } = useFirestore()

  return useQuery({
    queryKey: ['residents', villageId, householdId],
    queryFn: async () => {
      const residentsRef = collection(
        db, 'villages', villageId, 'households', householdId, 'residents'
      )
      const snapshot = await getDocs(query(residentsRef, orderBy('isHead', 'desc')))
      return snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      })) as Resident[]
    }
  })
}
```

### 5. Create ResidentList Component (1.5h)
```typescript
// src/components/residents/resident-list.tsx
export function ResidentList({ residents, villageId, householdId }: Props) {
  const [editingId, setEditingId] = useState<string | null>(null)
  const deleteMutation = useDeleteResident(villageId, householdId)

  return (
    <div className="space-y-2">
      {residents.map(resident => (
        <div
          key={resident.id}
          className="flex items-center justify-between p-3 bg-gray-50 rounded-lg"
        >
          <div>
            <div className="font-medium">
              {resident.name}
              {resident.isHead && (
                <span className="ml-2 text-xs bg-primary/10 text-primary px-2 py-0.5 rounded">
                  Chủ hộ
                </span>
              )}
            </div>
            <div className="text-sm text-gray-500">
              {resident.relationship} • {resident.gender === 'male' ? 'Nam' : 'Nữ'}
              {resident.birthDate && ` • ${formatDate(resident.birthDate)}`}
            </div>
          </div>
          <div className="flex gap-2">
            <Button size="sm" variant="ghost" onClick={() => setEditingId(resident.id)}>
              <Pencil className="h-4 w-4" />
            </Button>
            <Button
              size="sm"
              variant="ghost"
              onClick={() => {
                if (confirm('Xác nhận xóa?')) deleteMutation.mutate(resident.id)
              }}
            >
              <Trash className="h-4 w-4" />
            </Button>
          </div>
        </div>
      ))}
    </div>
  )
}
```

### 6. Create ResidentForm Component (2h)
With relationship dropdown, date picker, gender select.

### 7. Create HouseholdDetail Page (2h)
```typescript
// src/pages/admin/households/[householdId].tsx
export function HouseholdDetailPage() {
  const { villageId, householdId } = useParams()
  const { data: household } = useHousehold(villageId!, householdId!)
  const { data: residents } = useResidents(villageId!, householdId!)
  const [showAddResident, setShowAddResident] = useState(false)

  return (
    <div className="space-y-6">
      <Breadcrumb items={[
        { label: 'Quản lý thôn', href: '/admin/villages' },
        { label: household?.headName, href: `/admin/villages/${villageId}` },
        { label: `Hộ ${household?.code}` }
      ]} />

      {/* Household Info Card */}
      <div className="bg-white rounded-lg border p-6">
        <div className="flex justify-between items-start">
          <div>
            <h1 className="text-xl font-bold">Hộ {household?.code}</h1>
            <p className="text-gray-500">{household?.address}</p>
          </div>
          <Button variant="outline" onClick={() => setShowEditModal(true)}>
            Sửa thông tin
          </Button>
        </div>
      </div>

      {/* Residents Section */}
      <div className="bg-white rounded-lg border p-6">
        <div className="flex justify-between items-center mb-4">
          <h2 className="text-lg font-semibold">
            Nhân khẩu ({residents?.length ?? 0})
          </h2>
          <Button onClick={() => setShowAddResident(true)}>
            <Plus className="h-4 w-4 mr-2" />
            Thêm nhân khẩu
          </Button>
        </div>

        <ResidentList
          residents={residents ?? []}
          villageId={villageId!}
          householdId={householdId!}
        />
      </div>

      <ResidentFormModal
        open={showAddResident}
        onClose={() => setShowAddResident(false)}
        villageId={villageId!}
        householdId={householdId!}
      />
    </div>
  )
}
```

### 8. Create Import/Export Utilities (2h)
```typescript
// src/lib/import-export.ts
import * as XLSX from 'xlsx'

export async function importHouseholdsFromExcel(file: File): Promise<HouseholdImportRow[]> {
  const buffer = await file.arrayBuffer()
  const workbook = XLSX.read(buffer)
  const sheet = workbook.Sheets[workbook.SheetNames[0]]
  const data = XLSX.utils.sheet_to_json<HouseholdImportRow>(sheet)
  return data
}

export function exportHouseholdsToExcel(households: Household[], filename: string) {
  const worksheet = XLSX.utils.json_to_sheet(households)
  const workbook = XLSX.utils.book_new()
  XLSX.utils.book_append_sheet(workbook, worksheet, 'Households')
  XLSX.writeFile(workbook, `${filename}.xlsx`)
}
```

### 9. Create Import Modal (1.5h)
Preview imported data, validate, batch insert.

### 10. Add Sync Status Indicator (0.5h)
Show pending writes count and sync status.

---

## Todo List
- [ ] Install react-hook-form, xlsx dependencies
- [ ] Create useHouseholds hook with mutations
- [ ] Create useResidents hook with mutations
- [ ] Create HouseholdTable component
- [ ] Create HouseholdForm component
- [ ] Create HouseholdDetail page
- [ ] Create ResidentList component
- [ ] Create ResidentForm with relationship select
- [ ] Create import/export utilities
- [ ] Create HouseholdImport modal
- [ ] Add export button
- [ ] Add sync status indicator
- [ ] Test offline CRUD
- [ ] Test bulk import

---

## Success Criteria
- [ ] CRUD operations work for households
- [ ] CRUD operations work for residents
- [ ] Search filters correctly
- [ ] Excel import works (100+ rows)
- [ ] Export generates valid Excel file
- [ ] Offline writes sync when online
- [ ] Form validation prevents bad data

---

## Risk Assessment

| Risk | Impact | Mitigation |
|------|--------|------------|
| Large import fails | High | Batch in chunks of 500 |
| Data format mismatch | Medium | Validate before import, show preview |
| Offline conflict | Low | Last-write-wins, warn user |

---

## Security Considerations
- CCCD should be encrypted at rest (future)
- Validate phone format server-side
- Audit log for resident data changes
- No bulk export of CCCD numbers

---

## Next Steps
After completion:
1. → Phase 06: SMS Messaging System
2. Import commune's existing household data
3. Train village leaders on data entry
</file>

<file path="plans/260115-2249-diensanh-commune-management-app/phase-06-sms-messaging-system.md">
# Phase 06: SMS Messaging System

## Context Links
- [Plan Overview](./plan.md)
- [SMS Research](./research/researcher-02-sms-api-abstraction.md)
- [PWA Research](./research/researcher-01-pwa-offline-patterns.md) - Background Sync

## Overview
| Field | Value |
|-------|-------|
| Priority | P1 |
| Status | pending |
| Effort | 14h |
| Dependencies | Phase 05 complete, SMS provider credentials |

Provider-agnostic SMS system with VNPT/eSMS/Stringee support, bulk messaging, and offline queue.

---

## Key Insights
- Strategy pattern for provider abstraction
- Background Sync API for offline SMS queueing
- Brandname "DIENSANH" requires MIC registration
- 90-day log retention per Circular 25/2021
- Rate limits vary: VNPT 100/min, eSMS 200/min, Stringee 50/min
- **SMS permission: Commune admin only** (Validated Decision)

---

## Requirements

### Functional
- FR1: Send single SMS to phone number
- FR2: Bulk SMS to village (all households)
- FR3: Bulk SMS to selected recipients
- FR4: Track delivery status
- FR5: SMS history/logs with search
- FR6: Queue SMS when offline

### Non-Functional
- NFR1: SMS queued even offline
- NFR2: Fallback to secondary provider on failure
- NFR3: 90-day log retention
- NFR4: Vietnamese content support (Unicode)

---

## Architecture

### Backend Extension (FastAPI)
```
src/
├── api/
│   ├── api-server.py          # Existing
│   └── sms-router.py          # New: SMS endpoints
├── services/
│   └── sms/
│       ├── __init__.py
│       ├── base.py            # Abstract provider
│       ├── sms_service.py     # Main service
│       └── providers/
│           ├── vnpt.py
│           ├── esms.py
│           └── stringee.py
```

### Frontend Components
```
src/components/messages/
├── message-composer.tsx       # Compose SMS
├── recipient-selector.tsx     # Select recipients
├── message-preview.tsx        # Preview before send
├── message-history.tsx        # SMS logs table
├── delivery-status.tsx        # Status badge
└── bulk-progress.tsx          # Bulk send progress

src/pages/admin/messages/
├── index.tsx                  # Message center
├── compose.tsx                # New message
└── [messageId].tsx            # Message details
```

### Data Flow
```
User composes SMS
  → Validates content (160 chars, prohibited words)
  → Selects recipients (individual, village, all)
  → Preview with cost estimate
  → Confirm send
    → Online: POST /api/sms/send → Provider → Webhook → Update status
    → Offline: Queue in IndexedDB → Background Sync → Retry when online
```

---

## Related Code Files

### Create (Backend)
- `src/services/sms/__init__.py`
- `src/services/sms/base.py`
- `src/services/sms/sms_service.py`
- `src/services/sms/providers/vnpt.py`
- `src/services/sms/providers/esms.py`
- `src/services/sms/providers/stringee.py`
- `src/api/sms-router.py`

### Create (Frontend)
- `src/components/messages/message-composer.tsx`
- `src/components/messages/recipient-selector.tsx`
- `src/components/messages/message-history.tsx`
- `src/pages/admin/messages/index.tsx`
- `src/pages/admin/messages/compose.tsx`
- `src/hooks/use-messages.ts`
- `src/hooks/use-send-sms.ts`

### Modify
- `src/api/api-server.py` - Add SMS router
- `src/config.py` - Add SMS provider configs
- `vite.config.ts` - Add Background Sync for SMS

---

## Implementation Steps

### 1. Create SMS Base Classes (1.5h)
```python
# src/services/sms/base.py
from abc import ABC, abstractmethod
from dataclasses import dataclass
from datetime import datetime
from typing import List, Dict, Optional

@dataclass
class SMSMessage:
    phone: str
    content: str
    brandname: Optional[str] = None
    metadata: Dict = None

@dataclass
class SMSResponse:
    message_id: str
    status: str  # queued, sent, delivered, failed
    provider: str
    timestamp: datetime
    error: Optional[str] = None

class SMSProvider(ABC):
    @abstractmethod
    async def send_single(self, message: SMSMessage) -> SMSResponse:
        pass

    @abstractmethod
    async def send_bulk(self, messages: List[SMSMessage]) -> List[SMSResponse]:
        pass

    @abstractmethod
    async def get_status(self, message_id: str) -> dict:
        pass
```

### 2. Implement eSMS Provider (2h)
```python
# src/services/sms/providers/esms.py
import httpx
from ..base import SMSProvider, SMSMessage, SMSResponse

class eSMSProvider(SMSProvider):
    BASE_URL = "https://rest.esms.vn"

    def __init__(self, api_key: str, secret_key: str, brandname: str):
        self.api_key = api_key
        self.secret_key = secret_key
        self.brandname = brandname
        self.client = httpx.AsyncClient(timeout=30.0)

    async def send_single(self, message: SMSMessage) -> SMSResponse:
        payload = {
            "ApiKey": self.api_key,
            "SecretKey": self.secret_key,
            "Phone": message.phone,
            "Content": message.content,
            "Brandname": message.brandname or self.brandname,
            "SmsType": "2",
            "IsUnicode": "1"
        }

        resp = await self.client.post(
            f"{self.BASE_URL}/MainService.svc/json/SendMultipleMessage_V4_post_json",
            json=payload
        )
        data = resp.json()

        return SMSResponse(
            message_id=data.get("SMSID", ""),
            status="queued" if data.get("CodeResult") == "100" else "failed",
            provider="esms",
            timestamp=datetime.utcnow(),
            error=data.get("ErrorMessage")
        )

    async def send_bulk(self, messages: List[SMSMessage]) -> List[SMSResponse]:
        # eSMS uses comma-separated phones (max 500)
        results = []
        for chunk in self._chunk(messages, 500):
            phones = ",".join([m.phone for m in chunk])
            content = chunk[0].content

            payload = {
                "ApiKey": self.api_key,
                "SecretKey": self.secret_key,
                "Phone": phones,
                "Content": content,
                "Brandname": self.brandname,
                "SmsType": "2",
                "IsUnicode": "1"
            }

            resp = await self.client.post(
                f"{self.BASE_URL}/MainService.svc/json/SendMultipleMessage_V4_post_json",
                json=payload
            )
            # Process response...
        return results

    def _chunk(self, items, size):
        for i in range(0, len(items), size):
            yield items[i:i+size]
```

### 3. Create SMS Service (2h)
```python
# src/services/sms/sms_service.py
from enum import Enum
from typing import Optional, List
from .providers.esms import eSMSProvider
from .providers.vnpt import VNPTProvider
from .providers.stringee import StringeeProvider

class ProviderType(str, Enum):
    VNPT = "vnpt"
    ESMS = "esms"
    STRINGEE = "stringee"

class SMSService:
    def __init__(self, settings):
        self.providers = {
            ProviderType.ESMS: eSMSProvider(
                settings.ESMS_API_KEY,
                settings.ESMS_SECRET_KEY,
                settings.DEFAULT_BRANDNAME
            ),
            # Add other providers...
        }
        self.default_provider = ProviderType(settings.DEFAULT_SMS_PROVIDER)

    async def send_sms(
        self,
        phone: str,
        content: str,
        provider: Optional[ProviderType] = None
    ) -> SMSResponse:
        selected = provider or self.default_provider
        message = SMSMessage(phone=phone, content=content)

        try:
            return await self.providers[selected].send_single(message)
        except Exception as e:
            # Fallback to secondary provider
            if selected != ProviderType.ESMS:
                return await self.providers[ProviderType.ESMS].send_single(message)
            raise

    async def send_bulk_sms(
        self,
        phones: List[str],
        content: str,
        provider: Optional[ProviderType] = None
    ) -> List[SMSResponse]:
        selected = provider or self.default_provider
        messages = [SMSMessage(phone=p, content=content) for p in phones]
        return await self.providers[selected].send_bulk(messages)
```

### 4. Create FastAPI Router (1.5h)
```python
# src/api/sms-router.py
from fastapi import APIRouter, Depends, HTTPException
from pydantic import BaseModel
from typing import List, Optional
from ..services.sms.sms_service import SMSService, ProviderType

router = APIRouter(prefix="/api/sms", tags=["SMS"])

class SendSMSRequest(BaseModel):
    phone: str
    content: str
    provider: Optional[ProviderType] = None

class BulkSMSRequest(BaseModel):
    phones: List[str]
    content: str
    provider: Optional[ProviderType] = None

@router.post("/send")
async def send_sms(request: SendSMSRequest):
    sms_service = SMSService(settings)
    result = await sms_service.send_sms(
        request.phone,
        request.content,
        request.provider
    )
    # Log to Firestore
    await log_sms_to_firestore(result)
    return result

@router.post("/bulk")
async def send_bulk_sms(request: BulkSMSRequest):
    sms_service = SMSService(settings)
    results = await sms_service.send_bulk_sms(
        request.phones,
        request.content,
        request.provider
    )
    # Log all to Firestore
    for result in results:
        await log_sms_to_firestore(result)
    return {"sent": len(results), "results": results}

@router.post("/webhook/{provider}")
async def sms_webhook(provider: ProviderType, payload: dict):
    # Handle delivery status callback
    await update_sms_status(payload)
    return {"status": "ok"}
```

### 5. Create MessageComposer Component (2h)
```typescript
// src/components/messages/message-composer.tsx
export function MessageComposer() {
  const [content, setContent] = useState('')
  const [recipients, setRecipients] = useState<string[]>([])
  const [recipientType, setRecipientType] = useState<'individual' | 'village' | 'all'>('individual')
  const sendMutation = useSendSMS()

  const charCount = content.length
  const smsCount = Math.ceil(charCount / 160)
  const estimatedCost = recipients.length * smsCount * 500 // 500 VND/SMS

  return (
    <div className="space-y-6">
      <div>
        <Label>Loại người nhận</Label>
        <RadioGroup value={recipientType} onValueChange={setRecipientType}>
          <RadioGroupItem value="individual" label="Chọn cá nhân" />
          <RadioGroupItem value="village" label="Chọn thôn" />
          <RadioGroupItem value="all" label="Toàn xã" />
        </RadioGroup>
      </div>

      <RecipientSelector
        type={recipientType}
        value={recipients}
        onChange={setRecipients}
      />

      <div>
        <Label>Nội dung tin nhắn</Label>
        <Textarea
          value={content}
          onChange={e => setContent(e.target.value)}
          placeholder="Nhập nội dung tin nhắn..."
          rows={4}
        />
        <div className="text-sm text-gray-500 mt-1">
          {charCount}/160 ký tự • {smsCount} tin nhắn
        </div>
      </div>

      <div className="bg-gray-50 p-4 rounded-lg">
        <div className="flex justify-between text-sm">
          <span>Số người nhận:</span>
          <span className="font-medium">{recipients.length}</span>
        </div>
        <div className="flex justify-between text-sm">
          <span>Chi phí ước tính:</span>
          <span className="font-medium">{estimatedCost.toLocaleString('vi-VN')} VND</span>
        </div>
      </div>

      <Button
        onClick={() => sendMutation.mutate({ phones: recipients, content })}
        disabled={!content || recipients.length === 0 || sendMutation.isPending}
      >
        {sendMutation.isPending ? 'Đang gửi...' : `Gửi tin nhắn (${recipients.length})`}
      </Button>
    </div>
  )
}
```

### 6. Create RecipientSelector Component (1.5h)
```typescript
// src/components/messages/recipient-selector.tsx
export function RecipientSelector({ type, value, onChange }: Props) {
  const { data: villages } = useVillages()

  if (type === 'individual') {
    return (
      <div>
        <Label>Số điện thoại (mỗi số một dòng)</Label>
        <Textarea
          value={value.join('\n')}
          onChange={e => onChange(e.target.value.split('\n').filter(Boolean))}
          placeholder="0912345678"
          rows={5}
        />
      </div>
    )
  }

  if (type === 'village') {
    return (
      <div>
        <Label>Chọn thôn</Label>
        <Select multiple value={value} onChange={onChange}>
          {villages?.map(v => (
            <SelectItem key={v.id} value={v.id}>{v.name}</SelectItem>
          ))}
        </Select>
      </div>
    )
  }

  // type === 'all'
  return (
    <div className="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
      <p className="text-sm text-yellow-700">
        Tin nhắn sẽ được gửi đến tất cả chủ hộ trong xã
      </p>
    </div>
  )
}
```

### 7. Create MessageHistory Component (1.5h)
Table with filters, search, pagination.

### 8. Configure Background Sync (1h)
```typescript
// vite.config.ts - Update PWA config
workbox: {
  runtimeCaching: [
    {
      urlPattern: /\/api\/sms\/.*/,
      method: 'POST',
      handler: 'NetworkOnly',
      options: {
        backgroundSync: {
          name: 'sms-queue',
          options: { maxRetentionTime: 24 * 60 }
        }
      }
    }
  ]
}
```

### 9. Create useSendSMS Hook (1h)
With offline detection and queue feedback.

---

## Todo List
- [ ] Create SMS base classes
- [ ] Implement eSMS provider
- [ ] Implement VNPT provider (stub)
- [ ] Implement Stringee provider (stub)
- [ ] Create SMSService with fallback
- [ ] Create FastAPI SMS router
- [ ] Add SMS router to api-server.py
- [ ] Create MessageComposer component
- [ ] Create RecipientSelector component
- [ ] Create MessageHistory component
- [ ] Configure Background Sync
- [ ] Create useSendSMS hook
- [ ] Create MessagesPage
- [ ] Test single SMS send
- [ ] Test bulk SMS send
- [ ] Test offline queueing

---

## Success Criteria
- [ ] Single SMS sends and logs
- [ ] Bulk SMS works for 100+ recipients
- [ ] Delivery status updates via webhook
- [ ] Offline SMS queues and sends when online
- [ ] Message history displays correctly
- [ ] Cost estimate shows before send

---

## Risk Assessment

| Risk | Impact | Mitigation |
|------|--------|------------|
| Brandname not approved | Critical | Use OTP type temporarily, expedite registration |
| Provider API changes | Medium | Abstract interface, easy swap |
| High costs | Medium | Show confirmation, daily limits |

---

## Security Considerations
- **SMS endpoints restricted to commune_admin role only** (Validated Decision)
- Rate limit SMS endpoints (prevent abuse)
- Validate phone format
- Filter prohibited content
- Secure API keys in env vars
- Log all SMS for audit

### Role-Based Access Control for SMS
```python
# src/api/sms-router.py - Add role check dependency
from fastapi import Depends, HTTPException, status
from firebase_admin import auth

async def require_admin(authorization: str = Header(None)):
    """Verify user is commune_admin before allowing SMS operations."""
    if not authorization or not authorization.startswith("Bearer "):
        raise HTTPException(status_code=401, detail="Missing authorization")

    token = authorization.split(" ")[1]
    try:
        decoded = auth.verify_id_token(token)
        # Fetch user role from Firestore
        user_doc = db.collection("users").document(decoded["uid"]).get()
        if not user_doc.exists or user_doc.to_dict().get("role") != "commune_admin":
            raise HTTPException(status_code=403, detail="SMS feature requires commune_admin role")
        return decoded
    except Exception as e:
        raise HTTPException(status_code=401, detail=str(e))

# Apply to all SMS routes
@router.post("/send", dependencies=[Depends(require_admin)])
async def send_sms(request: SendSMSRequest):
    # ... existing code

@router.post("/bulk", dependencies=[Depends(require_admin)])
async def send_bulk_sms(request: BulkSMSRequest):
    # ... existing code
```

---

## Unresolved Questions
1. Brandname registration status with MIC?
2. Which provider to use as primary (cost vs reliability)?
3. Daily/monthly SMS budget limit?
4. ~~Should village leaders be able to send SMS?~~ → **Resolved: No, commune admin only**

---

## Next Steps
After completion:
1. → Phase 07: Task Assignment Module
2. Complete brandname registration
3. Set up billing alerts with provider
</file>

<file path="plans/260115-2249-diensanh-commune-management-app/phase-07-task-assignment.md">
# Phase 07: Task Assignment Module

## Context Links
- [Plan Overview](./plan.md)
- [Phase 02: Firestore Schema](./phase-02-firestore-schema-security.md)

## Overview
| Field | Value |
|-------|-------|
| Priority | P2 |
| Status | pending |
| Effort | 10h |
| Dependencies | Phase 04 complete |

Task management for commune admin to assign tasks to village leaders, track completion.

---

## Key Insights
- Tasks assigned to villages, not individuals
- Village leaders submit reports (text + attachments)
- Admin tracks overall completion
- Push notifications for new tasks (future)

---

## Requirements

### Functional
- FR1: Create tasks with title, description, type, priority, due date
- FR2: Assign to one or multiple villages
- FR3: Village leader views assigned tasks
- FR4: Village leader submits completion report
- FR5: Admin views all tasks with status
- FR6: Filter tasks by status, village, date

### Non-Functional
- NFR1: Task list loads <1s
- NFR2: Works offline (view cached tasks)
- NFR3: Notifications for new tasks (future)

---

## Architecture

### Task Types
```typescript
const taskTypes = [
  { value: 'survey', label: 'Khảo sát' },
  { value: 'notification', label: 'Thông báo' },
  { value: 'report', label: 'Báo cáo' },
  { value: 'meeting', label: 'Họp' },
  { value: 'other', label: 'Khác' }
]
```

### Task Status Flow
```
pending → in_progress → completed
                     ↘ cancelled
```

### Components
```
src/components/tasks/
├── task-list.tsx              # Task list view
├── task-card.tsx              # Task card
├── task-form.tsx              # Create/edit form
├── task-detail.tsx            # Detail view
├── task-filters.tsx           # Filter controls
├── village-selector.tsx       # Multi-select villages
├── report-form.tsx            # Submit report form
└── report-list.tsx            # View reports

src/pages/admin/tasks/
├── index.tsx                  # All tasks
├── create.tsx                 # Create task
└── [taskId].tsx               # Task detail

src/pages/village/tasks/
├── index.tsx                  # Assigned tasks
└── [taskId].tsx               # Task detail + report
```

---

## Related Code Files

### Create
- `src/components/tasks/task-list.tsx`
- `src/components/tasks/task-card.tsx`
- `src/components/tasks/task-form.tsx`
- `src/components/tasks/task-detail.tsx`
- `src/components/tasks/task-filters.tsx`
- `src/components/tasks/village-selector.tsx`
- `src/components/tasks/report-form.tsx`
- `src/components/tasks/report-list.tsx`
- `src/pages/admin/tasks/index.tsx`
- `src/pages/admin/tasks/create.tsx`
- `src/pages/admin/tasks/[taskId].tsx`
- `src/pages/village/tasks/index.tsx`
- `src/pages/village/tasks/[taskId].tsx`
- `src/hooks/use-tasks.ts`
- `src/hooks/use-task.ts`
- `src/hooks/use-task-reports.ts`

---

## Implementation Steps

### 1. Create useTasks Hook (1h)
```typescript
// src/hooks/use-tasks.ts
export function useTasks(options?: {
  status?: string
  villageId?: string
  limit?: number
}) {
  const { db } = useFirestore()
  const { user } = useAuth()

  return useQuery({
    queryKey: ['tasks', options],
    queryFn: async () => {
      let q = query(
        collection(db, 'tasks'),
        orderBy('createdAt', 'desc'),
        limit(options?.limit ?? 50)
      )

      if (options?.status) {
        q = query(q, where('status', '==', options.status))
      }

      // Village leader: filter by assigned village
      if (user?.role === 'village_leader' && user.villageId) {
        q = query(q, where('assignedTo', 'array-contains', user.villageId))
      }

      const snapshot = await getDocs(q)
      return snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      })) as Task[]
    }
  })
}
```

### 2. Create TaskForm Component (2h)
```typescript
// src/components/tasks/task-form.tsx
export function TaskForm({ task, onSuccess }: Props) {
  const isEdit = !!task
  const createMutation = useCreateTask()
  const updateMutation = useUpdateTask(task?.id)
  const { data: villages } = useVillages()

  const form = useForm<TaskFormData>({
    defaultValues: task ?? {
      title: '',
      description: '',
      type: 'notification',
      priority: 'medium',
      assignedTo: [],
      dueDate: null,
    }
  })

  const onSubmit = (data: TaskFormData) => {
    const mutation = isEdit ? updateMutation : createMutation
    mutation.mutate(data, { onSuccess })
  }

  return (
    <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
      <div>
        <Label>Tiêu đề *</Label>
        <Input {...form.register('title', { required: true })} />
      </div>

      <div>
        <Label>Mô tả</Label>
        <Textarea {...form.register('description')} rows={4} />
      </div>

      <div className="grid grid-cols-2 gap-4">
        <div>
          <Label>Loại công việc</Label>
          <Select {...form.register('type')}>
            {taskTypes.map(t => (
              <SelectItem key={t.value} value={t.value}>{t.label}</SelectItem>
            ))}
          </Select>
        </div>

        <div>
          <Label>Mức độ ưu tiên</Label>
          <Select {...form.register('priority')}>
            <SelectItem value="low">Thấp</SelectItem>
            <SelectItem value="medium">Trung bình</SelectItem>
            <SelectItem value="high">Cao</SelectItem>
          </Select>
        </div>
      </div>

      <div>
        <Label>Gán cho thôn *</Label>
        <VillageSelector
          villages={villages ?? []}
          value={form.watch('assignedTo')}
          onChange={val => form.setValue('assignedTo', val)}
        />
      </div>

      <div>
        <Label>Hạn hoàn thành</Label>
        <DatePicker
          value={form.watch('dueDate')}
          onChange={val => form.setValue('dueDate', val)}
        />
      </div>

      <Button type="submit" disabled={form.formState.isSubmitting}>
        {isEdit ? 'Cập nhật' : 'Tạo công việc'}
      </Button>
    </form>
  )
}
```

### 3. Create VillageSelector Component (1h)
```typescript
// src/components/tasks/village-selector.tsx
export function VillageSelector({ villages, value, onChange }: Props) {
  const toggleVillage = (villageId: string) => {
    if (value.includes(villageId)) {
      onChange(value.filter(v => v !== villageId))
    } else {
      onChange([...value, villageId])
    }
  }

  const selectAll = () => onChange(villages.map(v => v.id))
  const clearAll = () => onChange([])

  return (
    <div className="space-y-2">
      <div className="flex gap-2">
        <Button variant="outline" size="sm" onClick={selectAll}>Chọn tất cả</Button>
        <Button variant="outline" size="sm" onClick={clearAll}>Bỏ chọn</Button>
      </div>

      <div className="grid grid-cols-3 gap-2 max-h-60 overflow-auto p-2 border rounded">
        {villages.map(village => (
          <label
            key={village.id}
            className={cn(
              'flex items-center gap-2 p-2 rounded cursor-pointer',
              value.includes(village.id) ? 'bg-primary/10' : 'hover:bg-gray-50'
            )}
          >
            <Checkbox
              checked={value.includes(village.id)}
              onCheckedChange={() => toggleVillage(village.id)}
            />
            <span className="text-sm">{village.name}</span>
          </label>
        ))}
      </div>

      <p className="text-sm text-gray-500">Đã chọn: {value.length} thôn</p>
    </div>
  )
}
```

### 4. Create TaskCard Component (1h)
```typescript
// src/components/tasks/task-card.tsx
export function TaskCard({ task }: { task: Task }) {
  const priorityColors = {
    low: 'bg-gray-100 text-gray-700',
    medium: 'bg-yellow-100 text-yellow-700',
    high: 'bg-red-100 text-red-700'
  }

  const statusColors = {
    pending: 'bg-gray-100 text-gray-700',
    in_progress: 'bg-blue-100 text-blue-700',
    completed: 'bg-green-100 text-green-700',
    cancelled: 'bg-red-100 text-red-700'
  }

  return (
    <Link
      to={`/admin/tasks/${task.id}`}
      className="block bg-white rounded-lg border p-4 hover:shadow-md transition"
    >
      <div className="flex items-start justify-between">
        <h3 className="font-semibold">{task.title}</h3>
        <span className={cn('px-2 py-0.5 rounded text-xs', priorityColors[task.priority])}>
          {task.priority === 'high' ? 'Cao' : task.priority === 'medium' ? 'TB' : 'Thấp'}
        </span>
      </div>

      <p className="text-sm text-gray-500 mt-1 line-clamp-2">{task.description}</p>

      <div className="flex items-center justify-between mt-3 pt-3 border-t">
        <span className={cn('px-2 py-0.5 rounded text-xs', statusColors[task.status])}>
          {statusLabels[task.status]}
        </span>

        {task.dueDate && (
          <span className="text-xs text-gray-500">
            Hạn: {format(task.dueDate.toDate(), 'dd/MM/yyyy')}
          </span>
        )}
      </div>
    </Link>
  )
}
```

### 5. Create TasksPage (Admin) (1h)
```typescript
// src/pages/admin/tasks/index.tsx
export function AdminTasksPage() {
  const [status, setStatus] = useState('')
  const { data: tasks, isLoading } = useTasks({ status })

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <h1 className="text-2xl font-bold">Quản lý công việc</h1>
        <Button asChild>
          <Link to="/admin/tasks/create">
            <Plus className="h-4 w-4 mr-2" />
            Tạo công việc
          </Link>
        </Button>
      </div>

      <TaskFilters status={status} onStatusChange={setStatus} />

      <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
        {tasks?.map(task => <TaskCard key={task.id} task={task} />)}
      </div>
    </div>
  )
}
```

### 6. Create ReportForm Component (1.5h)
```typescript
// src/components/tasks/report-form.tsx
export function ReportForm({ taskId, villageId }: Props) {
  const { mutate: submitReport, isPending } = useSubmitReport(taskId)
  const [content, setContent] = useState('')

  const handleSubmit = () => {
    submitReport({ villageId, content }, {
      onSuccess: () => {
        setContent('')
        toast.success('Đã gửi báo cáo')
      }
    })
  }

  return (
    <div className="space-y-4">
      <div>
        <Label>Nội dung báo cáo</Label>
        <Textarea
          value={content}
          onChange={e => setContent(e.target.value)}
          placeholder="Mô tả kết quả thực hiện..."
          rows={4}
        />
      </div>

      <Button onClick={handleSubmit} disabled={!content || isPending}>
        {isPending ? 'Đang gửi...' : 'Gửi báo cáo'}
      </Button>
    </div>
  )
}
```

### 7. Create VillageTasks Page (1h)
For village leaders - view assigned tasks, submit reports.

### 8. Create TaskDetail Page (1.5h)
Show task info, list of assigned villages, reports per village.

---

## Todo List
- [ ] Create useTasks hook
- [ ] Create useTask hook
- [ ] Create useTaskReports hook
- [ ] Create TaskForm component
- [ ] Create VillageSelector component
- [ ] Create TaskCard component
- [ ] Create TaskFilters component
- [ ] Create AdminTasksPage
- [ ] Create CreateTaskPage
- [ ] Create TaskDetailPage
- [ ] Create ReportForm component
- [ ] Create ReportList component
- [ ] Create VillageTasksPage
- [ ] Test task creation flow
- [ ] Test report submission

---

## Success Criteria
- [ ] Admin can create tasks assigned to villages
- [ ] Village leader sees only assigned tasks
- [ ] Village leader can submit report
- [ ] Admin sees all reports per task
- [ ] Filtering works correctly
- [ ] Offline viewing of cached tasks

---

## Risk Assessment

| Risk | Impact | Mitigation |
|------|--------|------------|
| Missing due date reminders | Medium | Add notifications in Phase 9+ |
| Report without evidence | Low | Add attachment support later |
| Task overload | Low | Show pending count on dashboard |

---

## Security Considerations
- Village leaders can only view/report their tasks
- Admin only can create/edit/delete tasks
- Validate village assignment exists

---

## Next Steps
After completion:
1. → Phase 08: Public Portal & Chatbot Integration
2. Add push notifications for new tasks
3. Add file attachments to reports
</file>

<file path="plans/260115-2249-diensanh-commune-management-app/phase-08-public-portal-chatbot.md">
# Phase 08: Public Portal & Chatbot Integration

## Context Links
- [Plan Overview](./plan.md)
- Existing Chatbot: `src/api/api-server.py`
- Existing Widget: `src/widget/`

## Overview
| Field | Value |
|-------|-------|
| Priority | P2 |
| Status | pending |
| Effort | 12h |
| Dependencies | Phase 01-03 complete |

Public-facing portal with announcements, policy lookup, request submission, and RAG chatbot integration.

---

## Key Insights
- Existing FastAPI chatbot uses ai4u.now API with TF-IDF search
- Widget embed already exists but needs refresh
- No auth required for public portal
- Announcements filter by isPublished + not expired

---

## Requirements

### Functional
- FR1: View published announcements (news, policies, events)
- FR2: Search announcements
- FR3: Submit service request (no auth)
- FR4: Track request by phone number
- FR5: Embedded chatbot for Q&A
- FR6: Contact information display

### Non-Functional
- NFR1: Public pages SEO-friendly
- NFR2: Fast initial load (<2s)
- NFR3: Mobile-optimized
- NFR4: Works offline (cached content)

---

## Architecture

### Routes
```
/                    → Landing page
/thong-bao           → Announcements list
/thong-bao/:id       → Announcement detail
/chinh-sach          → Policy lookup
/gui-yeu-cau         → Submit request
/tra-cuu-yeu-cau     → Track request
/lien-he             → Contact info
```

### Components
```
src/components/portal/
├── portal-header.tsx          # Public header/nav
├── portal-footer.tsx          # Footer with contact
├── announcement-list.tsx      # Announcements grid
├── announcement-card.tsx      # Announcement card
├── announcement-detail.tsx    # Full announcement
├── request-form.tsx           # Submit request
├── request-tracker.tsx        # Track by phone
├── chatbot-widget.tsx         # Embedded chatbot
└── contact-info.tsx           # Contact display

src/pages/portal/
├── index.tsx                  # Landing page
├── announcements/
│   ├── index.tsx
│   └── [id].tsx
├── submit-request.tsx
├── track-request.tsx
└── contact.tsx

src/layouts/
└── portal-layout.tsx          # Public layout
```

---

## Related Code Files

### Create
- `src/components/portal/portal-header.tsx`
- `src/components/portal/portal-footer.tsx`
- `src/components/portal/announcement-list.tsx`
- `src/components/portal/announcement-card.tsx`
- `src/components/portal/request-form.tsx`
- `src/components/portal/request-tracker.tsx`
- `src/components/portal/chatbot-widget.tsx`
- `src/pages/portal/index.tsx`
- `src/pages/portal/announcements/index.tsx`
- `src/pages/portal/announcements/[id].tsx`
- `src/pages/portal/submit-request.tsx`
- `src/pages/portal/track-request.tsx`
- `src/pages/portal/contact.tsx`
- `src/layouts/portal-layout.tsx`
- `src/hooks/use-announcements.ts`
- `src/hooks/use-request.ts`

### Modify
- `src/routes/index.tsx` - Add public routes
- `src/widget/` - Update chatbot widget

---

## Implementation Steps

### 1. Create PortalLayout (1h)
```typescript
// src/layouts/portal-layout.tsx
export function PortalLayout({ children }: { children: React.ReactNode }) {
  return (
    <div className="min-h-screen flex flex-col">
      <PortalHeader />
      <main className="flex-1">{children}</main>
      <PortalFooter />
      <ChatbotWidget />
    </div>
  )
}
```

### 2. Create PortalHeader (1h)
```typescript
// src/components/portal/portal-header.tsx
const navItems = [
  { label: 'Trang chủ', href: '/' },
  { label: 'Thông báo', href: '/thong-bao' },
  { label: 'Chính sách', href: '/chinh-sach' },
  { label: 'Gửi yêu cầu', href: '/gui-yeu-cau' },
  { label: 'Liên hệ', href: '/lien-he' },
]

export function PortalHeader() {
  const [mobileMenuOpen, setMobileMenuOpen] = useState(false)

  return (
    <header className="bg-primary text-white">
      <div className="container mx-auto px-4">
        <div className="flex items-center justify-between h-16">
          <Link to="/" className="flex items-center gap-3">
            <img src="/logo.png" alt="" className="h-10" />
            <div>
              <div className="font-bold">UBND Xã Diên Sanh</div>
              <div className="text-xs text-primary-foreground/70">
                Huyện Hải Lăng, Tỉnh Quảng Trị
              </div>
            </div>
          </Link>

          <nav className="hidden md:flex items-center gap-6">
            {navItems.map(item => (
              <NavLink key={item.href} to={item.href} className="hover:underline">
                {item.label}
              </NavLink>
            ))}
            <Button asChild variant="secondary" size="sm">
              <Link to="/login">Đăng nhập</Link>
            </Button>
          </nav>

          <Button
            variant="ghost"
            size="icon"
            className="md:hidden"
            onClick={() => setMobileMenuOpen(true)}
          >
            <Menu className="h-6 w-6" />
          </Button>
        </div>
      </div>

      {/* Mobile menu */}
      <MobileMenu open={mobileMenuOpen} onClose={() => setMobileMenuOpen(false)} />
    </header>
  )
}
```

### 3. Create Landing Page (1.5h)
```typescript
// src/pages/portal/index.tsx
export function PortalHomePage() {
  const { data: announcements } = useAnnouncements({ limit: 6 })

  return (
    <div>
      {/* Hero Section */}
      <section className="bg-gradient-to-r from-primary to-primary-dark text-white py-16">
        <div className="container mx-auto px-4 text-center">
          <h1 className="text-3xl md:text-4xl font-bold mb-4">
            Chào mừng đến với Cổng thông tin Xã Diên Sanh
          </h1>
          <p className="text-lg text-white/80 mb-8">
            Huyện Hải Lăng, Tỉnh Quảng Trị
          </p>
          <div className="flex justify-center gap-4">
            <Button asChild size="lg" variant="secondary">
              <Link to="/gui-yeu-cau">Gửi yêu cầu</Link>
            </Button>
            <Button asChild size="lg" variant="outline">
              <Link to="/tra-cuu-yeu-cau">Tra cứu</Link>
            </Button>
          </div>
        </div>
      </section>

      {/* Announcements */}
      <section className="py-12">
        <div className="container mx-auto px-4">
          <div className="flex items-center justify-between mb-6">
            <h2 className="text-2xl font-bold">Thông báo mới</h2>
            <Link to="/thong-bao" className="text-primary hover:underline">
              Xem tất cả →
            </Link>
          </div>
          <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
            {announcements?.map(a => (
              <AnnouncementCard key={a.id} announcement={a} />
            ))}
          </div>
        </div>
      </section>

      {/* Quick Links */}
      <section className="py-12 bg-gray-50">
        <div className="container mx-auto px-4">
          <h2 className="text-2xl font-bold mb-6 text-center">Dịch vụ công</h2>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <QuickLinkCard icon={<FileText />} label="Thủ tục hành chính" />
            <QuickLinkCard icon={<Building />} label="Thông tin xã" />
            <QuickLinkCard icon={<Phone />} label="Liên hệ" />
            <QuickLinkCard icon={<MessageCircle />} label="Hỏi đáp" />
          </div>
        </div>
      </section>
    </div>
  )
}
```

### 4. Create useAnnouncements Hook (1h)
```typescript
// src/hooks/use-announcements.ts
export function useAnnouncements(options?: { type?: string; limit?: number }) {
  const { db } = useFirestore()

  return useQuery({
    queryKey: ['announcements', options],
    queryFn: async () => {
      const now = new Date()
      let q = query(
        collection(db, 'announcements'),
        where('isPublished', '==', true),
        orderBy('publishedAt', 'desc'),
        limit(options?.limit ?? 20)
      )

      if (options?.type) {
        q = query(q, where('type', '==', options.type))
      }

      const snapshot = await getDocs(q)
      return snapshot.docs
        .map(doc => ({ id: doc.id, ...doc.data() }) as Announcement)
        .filter(a => !a.expiresAt || a.expiresAt.toDate() > now)
    },
    staleTime: 5 * 60 * 1000,
  })
}
```

### 5. Create AnnouncementCard (0.5h)
```typescript
// src/components/portal/announcement-card.tsx
export function AnnouncementCard({ announcement }: Props) {
  const typeColors = {
    news: 'bg-blue-100 text-blue-700',
    policy: 'bg-green-100 text-green-700',
    event: 'bg-purple-100 text-purple-700',
    urgent: 'bg-red-100 text-red-700'
  }

  return (
    <Link
      to={`/thong-bao/${announcement.id}`}
      className="block bg-white rounded-lg border p-4 hover:shadow-md transition"
    >
      <span className={cn('px-2 py-0.5 rounded text-xs', typeColors[announcement.type])}>
        {typeLabels[announcement.type]}
      </span>
      <h3 className="font-semibold mt-2 line-clamp-2">{announcement.title}</h3>
      <p className="text-sm text-gray-500 mt-1 line-clamp-2">{announcement.content}</p>
      <div className="text-xs text-gray-400 mt-2">
        {format(announcement.publishedAt.toDate(), 'dd/MM/yyyy')}
      </div>
    </Link>
  )
}
```

### 6. Create RequestForm (2h)
```typescript
// src/components/portal/request-form.tsx
const requestTypes = [
  'Xác nhận cư trú',
  'Xác nhận hộ nghèo',
  'Hỗ trợ thiên tai',
  'Khiếu nại, tố cáo',
  'Góp ý, kiến nghị',
  'Khác'
]

export function RequestForm() {
  const createMutation = useCreateRequest()
  const [submitted, setSubmitted] = useState(false)
  const [trackingPhone, setTrackingPhone] = useState('')

  const form = useForm<RequestFormData>({
    defaultValues: {
      type: '',
      title: '',
      description: '',
      submitterName: '',
      submitterPhone: '',
    }
  })

  const onSubmit = (data: RequestFormData) => {
    createMutation.mutate(data, {
      onSuccess: () => {
        setTrackingPhone(data.submitterPhone)
        setSubmitted(true)
      }
    })
  }

  if (submitted) {
    return (
      <div className="text-center py-8">
        <CheckCircle className="h-16 w-16 text-green-500 mx-auto mb-4" />
        <h2 className="text-xl font-bold mb-2">Gửi yêu cầu thành công!</h2>
        <p className="text-gray-600 mb-4">
          Yêu cầu của bạn đã được tiếp nhận. Bạn có thể tra cứu kết quả bằng số điện thoại.
        </p>
        <Button asChild>
          <Link to={`/tra-cuu-yeu-cau?phone=${trackingPhone}`}>
            Tra cứu yêu cầu
          </Link>
        </Button>
      </div>
    )
  }

  return (
    <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
      <div>
        <Label>Loại yêu cầu *</Label>
        <Select {...form.register('type', { required: true })}>
          <SelectItem value="">Chọn loại yêu cầu</SelectItem>
          {requestTypes.map(t => (
            <SelectItem key={t} value={t}>{t}</SelectItem>
          ))}
        </Select>
      </div>

      <div>
        <Label>Tiêu đề *</Label>
        <Input {...form.register('title', { required: true })} />
      </div>

      <div>
        <Label>Nội dung chi tiết *</Label>
        <Textarea {...form.register('description', { required: true })} rows={5} />
      </div>

      <div className="grid md:grid-cols-2 gap-4">
        <div>
          <Label>Họ tên *</Label>
          <Input {...form.register('submitterName', { required: true })} />
        </div>
        <div>
          <Label>Số điện thoại *</Label>
          <Input {...form.register('submitterPhone', { required: true })} />
        </div>
      </div>

      <Button type="submit" disabled={form.formState.isSubmitting}>
        {form.formState.isSubmitting ? 'Đang gửi...' : 'Gửi yêu cầu'}
      </Button>
    </form>
  )
}
```

### 7. Create RequestTracker (1.5h)
```typescript
// src/components/portal/request-tracker.tsx
export function RequestTracker() {
  const [phone, setPhone] = useState('')
  const { data: requests, isLoading, refetch } = useRequestsByPhone(phone, {
    enabled: false
  })

  const handleSearch = () => {
    if (phone.length >= 10) refetch()
  }

  return (
    <div className="space-y-6">
      <div className="flex gap-2">
        <Input
          value={phone}
          onChange={e => setPhone(e.target.value)}
          placeholder="Nhập số điện thoại..."
        />
        <Button onClick={handleSearch} disabled={isLoading}>
          {isLoading ? 'Đang tìm...' : 'Tra cứu'}
        </Button>
      </div>

      {requests && (
        <div className="space-y-4">
          {requests.length === 0 ? (
            <p className="text-center text-gray-500 py-8">
              Không tìm thấy yêu cầu nào
            </p>
          ) : (
            requests.map(req => (
              <RequestCard key={req.id} request={req} />
            ))
          )}
        </div>
      )}
    </div>
  )
}
```

### 8. Create ChatbotWidget (2h)
```typescript
// src/components/portal/chatbot-widget.tsx
export function ChatbotWidget() {
  const [open, setOpen] = useState(false)
  const [messages, setMessages] = useState<Message[]>([])
  const [input, setInput] = useState('')
  const chatMutation = useChatbot()

  const handleSend = () => {
    if (!input.trim()) return

    const userMessage = { role: 'user', content: input }
    setMessages(prev => [...prev, userMessage])
    setInput('')

    chatMutation.mutate({ message: input }, {
      onSuccess: (response) => {
        setMessages(prev => [...prev, {
          role: 'assistant',
          content: response.response,
          sources: response.sources
        }])
      }
    })
  }

  return (
    <>
      {/* Floating button */}
      <button
        onClick={() => setOpen(true)}
        className="fixed bottom-4 right-4 w-14 h-14 bg-primary text-white rounded-full shadow-lg flex items-center justify-center hover:scale-105 transition"
      >
        <MessageCircle className="h-6 w-6" />
      </button>

      {/* Chat panel */}
      <Dialog open={open} onOpenChange={setOpen}>
        <DialogContent className="sm:max-w-md h-[600px] flex flex-col">
          <DialogHeader>
            <DialogTitle>Trợ lý ảo UBND xã</DialogTitle>
          </DialogHeader>

          <div className="flex-1 overflow-auto space-y-3 p-4">
            {messages.map((msg, i) => (
              <div
                key={i}
                className={cn(
                  'max-w-[80%] p-3 rounded-lg',
                  msg.role === 'user'
                    ? 'ml-auto bg-primary text-white'
                    : 'bg-gray-100'
                )}
              >
                {msg.content}
              </div>
            ))}
            {chatMutation.isPending && (
              <div className="bg-gray-100 p-3 rounded-lg animate-pulse">
                Đang trả lời...
              </div>
            )}
          </div>

          <div className="flex gap-2 p-4 border-t">
            <Input
              value={input}
              onChange={e => setInput(e.target.value)}
              placeholder="Nhập câu hỏi..."
              onKeyDown={e => e.key === 'Enter' && handleSend()}
            />
            <Button onClick={handleSend}>Gửi</Button>
          </div>
        </DialogContent>
      </Dialog>
    </>
  )
}
```

### 9. Create useChatbot Hook (0.5h)
```typescript
// src/hooks/use-chatbot.ts
export function useChatbot() {
  return useMutation({
    mutationFn: async (data: { message: string }) => {
      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: data.message })
      })
      return response.json()
    }
  })
}
```

### 10. Setup Public Routes (1h)
Add routes with PortalLayout wrapper.

---

## Todo List
- [ ] Create PortalLayout
- [ ] Create PortalHeader with nav
- [ ] Create PortalFooter
- [ ] Create Landing page
- [ ] Create useAnnouncements hook
- [ ] Create AnnouncementCard
- [ ] Create AnnouncementsPage
- [ ] Create AnnouncementDetail page
- [ ] Create RequestForm
- [ ] Create RequestTracker
- [ ] Create ChatbotWidget
- [ ] Create useChatbot hook
- [ ] Setup public routes
- [ ] Test request submission
- [ ] Test chatbot integration

---

## Success Criteria
- [ ] Public pages accessible without auth
- [ ] Announcements display correctly
- [ ] Request submission works
- [ ] Request tracking by phone works
- [ ] Chatbot responds with relevant answers
- [ ] Mobile-responsive design
- [ ] SEO meta tags present

---

## Risk Assessment

| Risk | Impact | Mitigation |
|------|--------|------------|
| Chatbot API down | Medium | Show friendly error, offer contact info |
| Spam requests | Medium | Rate limit, CAPTCHA |
| SEO not indexed | Low | Add sitemap, robots.txt |

---

## Security Considerations
- Validate phone format before query
- Rate limit request submissions (10/hour/IP)
- Sanitize HTML in announcements
- No PII exposed in public queries

---

## Next Steps
After completion:
1. → Phase 09: PWA & Offline Support
2. Add CAPTCHA to request form
3. SEO optimization
</file>

<file path="plans/260115-2249-diensanh-commune-management-app/phase-09-pwa-offline-support.md">
# Phase 09: PWA & Offline Support

## Context Links
- [Plan Overview](./plan.md)
- [PWA Research](./research/researcher-01-pwa-offline-patterns.md)

## Overview
| Field | Value |
|-------|-------|
| Priority | P1 |
| Status | pending |
| Effort | 12h |
| Dependencies | Phase 01-08 complete |

Full PWA implementation with offline support, background sync, and install prompt for rural Vietnam connectivity.

---

## Key Insights
- Firestore `persistentLocalCache` enables IndexedDB storage (50MB limit)
- vite-plugin-pwa with Workbox handles service worker
- Background Sync API queues SMS and form submissions
- `hasPendingWrites` metadata shows sync status
- Navigation preload improves cold start

---

## Requirements

### Functional
- FR1: App installable on mobile/desktop
- FR2: Works offline (cached data and UI)
- FR3: Offline form submissions queue and sync
- FR4: Clear offline/syncing indicators
- FR5: Update prompt for new versions

### Non-Functional
- NFR1: First load <3s on 3G
- NFR2: Offline load <1s
- NFR3: 50MB cache limit
- NFR4: Works on Android 7+ / iOS 12+

---

## Architecture

### PWA Configuration
```
vite.config.ts                 # PWA plugin config
src/
├── sw.ts                      # Custom service worker (if needed)
├── components/
│   ├── pwa/
│   │   ├── install-prompt.tsx     # Install banner
│   │   ├── update-prompt.tsx      # New version alert
│   │   ├── offline-indicator.tsx  # Network status
│   │   └── sync-status.tsx        # Pending writes
public/
├── manifest.json              # Web app manifest
├── icon-192.png
├── icon-512.png
├── apple-touch-icon.png
├── offline.html               # Offline fallback
└── favicon.ico
```

### Caching Strategies
| Resource Type | Strategy | Reason |
|---------------|----------|--------|
| App shell (HTML/JS/CSS) | Cache First | Instant offline load |
| Images/fonts | Cache First + 365d expiry | Rarely change |
| Firestore data | Stale-While-Revalidate | Show cached, fetch fresh |
| API calls (GET) | Network First | Need fresh data |
| API calls (POST) | Network Only + Background Sync | Queue for retry |

---

## Related Code Files

### Create
- `public/manifest.json`
- `public/offline.html`
- `public/icon-192.png`
- `public/icon-512.png`
- `public/apple-touch-icon.png`
- `src/components/pwa/install-prompt.tsx`
- `src/components/pwa/update-prompt.tsx`
- `src/components/pwa/offline-indicator.tsx`
- `src/components/pwa/sync-status.tsx`
- `src/hooks/use-network-status.ts`
- `src/hooks/use-pending-writes.ts`

### Modify
- `vite.config.ts` - Add VitePWA plugin config
- `src/main.tsx` - Register service worker
- `src/config/firebase.ts` - Enable persistence
- `src/layouts/admin-layout.tsx` - Add offline indicator
- `index.html` - Add manifest link, theme-color

---

## Implementation Steps

### 1. Configure VitePWA Plugin (2h)
```typescript
// vite.config.ts
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import { VitePWA } from 'vite-plugin-pwa'

export default defineConfig({
  plugins: [
    react(),
    VitePWA({
      strategies: 'generateSW',
      registerType: 'prompt',
      devOptions: { enabled: true },

      workbox: {
        globPatterns: ['**/*.{js,css,html,ico,png,svg,woff2}'],
        navigateFallback: '/index.html',
        navigateFallbackDenylist: [/^\/api/],
        navigationPreload: true,

        runtimeCaching: [
          // Google Fonts
          {
            urlPattern: /^https:\/\/fonts\.googleapis\.com\/.*/i,
            handler: 'CacheFirst',
            options: {
              cacheName: 'google-fonts-cache',
              expiration: { maxEntries: 10, maxAgeSeconds: 60 * 60 * 24 * 365 }
            }
          },
          // Static assets
          {
            urlPattern: /\.(?:png|jpg|jpeg|svg|gif|webp)$/,
            handler: 'CacheFirst',
            options: {
              cacheName: 'images-cache',
              expiration: { maxEntries: 100, maxAgeSeconds: 60 * 60 * 24 * 30 }
            }
          },
          // API GET requests
          {
            urlPattern: /\/api\/.*$/,
            method: 'GET',
            handler: 'NetworkFirst',
            options: {
              cacheName: 'api-cache',
              expiration: { maxEntries: 50, maxAgeSeconds: 60 * 5 },
              networkTimeoutSeconds: 10
            }
          },
          // API POST with Background Sync
          {
            urlPattern: /\/api\/sms\/.*/,
            method: 'POST',
            handler: 'NetworkOnly',
            options: {
              backgroundSync: {
                name: 'sms-queue',
                options: { maxRetentionTime: 24 * 60 }
              }
            }
          },
          {
            urlPattern: /\/api\/requests/,
            method: 'POST',
            handler: 'NetworkOnly',
            options: {
              backgroundSync: {
                name: 'requests-queue',
                options: { maxRetentionTime: 24 * 60 }
              }
            }
          }
        ]
      },

      manifest: {
        name: 'Diên Sanh - Quản Lý Xã',
        short_name: 'Diên Sanh',
        description: 'Ứng dụng quản lý UBND xã Diên Sanh',
        theme_color: '#16a34a',
        background_color: '#ffffff',
        display: 'standalone',
        orientation: 'portrait',
        start_url: '/',
        scope: '/',
        icons: [
          { src: '/icon-192.png', sizes: '192x192', type: 'image/png' },
          { src: '/icon-512.png', sizes: '512x512', type: 'image/png' },
          { src: '/icon-512.png', sizes: '512x512', type: 'image/png', purpose: 'maskable' }
        ]
      }
    })
  ]
})
```

### 2. Create Web App Manifest (0.5h)
Already generated by VitePWA plugin.

### 3. Create App Icons (1h)
Generate icons for all sizes:
- 192x192 (Android)
- 512x512 (Android splash)
- 180x180 (iOS apple-touch-icon)
- favicon.ico

### 4. Update index.html (0.5h)
```html
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#16a34a" />
  <meta name="description" content="Cổng thông tin UBND xã Diên Sanh" />

  <!-- iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Diên Sanh" />
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" />

  <title>UBND Xã Diên Sanh</title>
</head>
<body>
  <div id="root"></div>
  <script type="module" src="/src/main.tsx"></script>
</body>
</html>
```

### 5. Register Service Worker (1h)
```typescript
// src/main.tsx
import { registerSW } from 'virtual:pwa-register'

const updateSW = registerSW({
  onNeedRefresh() {
    // Show update prompt
    if (confirm('Phiên bản mới có sẵn. Tải lại?')) {
      updateSW(true)
    }
  },
  onOfflineReady() {
    console.log('App ready for offline use')
  },
  onRegisteredSW(swUrl, r) {
    // Check for updates every hour
    r && setInterval(() => r.update(), 60 * 60 * 1000)
  }
})
```

### 6. Create useNetworkStatus Hook (0.5h)
```typescript
// src/hooks/use-network-status.ts
export function useNetworkStatus() {
  const [isOnline, setIsOnline] = useState(navigator.onLine)

  useEffect(() => {
    const handleOnline = () => setIsOnline(true)
    const handleOffline = () => setIsOnline(false)

    window.addEventListener('online', handleOnline)
    window.addEventListener('offline', handleOffline)

    return () => {
      window.removeEventListener('online', handleOnline)
      window.removeEventListener('offline', handleOffline)
    }
  }, [])

  return isOnline
}
```

### 7. Create OfflineIndicator Component (1h)
```typescript
// src/components/pwa/offline-indicator.tsx
export function OfflineIndicator() {
  const isOnline = useNetworkStatus()

  if (isOnline) return null

  return (
    <div className="fixed top-0 left-0 right-0 bg-yellow-500 text-white text-center py-2 z-50">
      <WifiOff className="inline h-4 w-4 mr-2" />
      Bạn đang offline. Một số tính năng có thể bị giới hạn.
    </div>
  )
}
```

### 8. Create usePendingWrites Hook (1h)
```typescript
// src/hooks/use-pending-writes.ts
export function usePendingWrites() {
  const [hasPendingWrites, setHasPendingWrites] = useState(false)
  const { db } = useFirestore()

  useEffect(() => {
    // Listen to multiple collections for pending writes
    const collections = ['requests', 'households']

    const unsubscribes = collections.map(collName => {
      return onSnapshot(
        collection(db, collName),
        { includeMetadataChanges: true },
        (snapshot) => {
          const pending = snapshot.metadata.hasPendingWrites
          setHasPendingWrites(prev => prev || pending)
        }
      )
    })

    return () => unsubscribes.forEach(unsub => unsub())
  }, [db])

  return hasPendingWrites
}
```

### 9. Create SyncStatus Component (1h)
```typescript
// src/components/pwa/sync-status.tsx
export function SyncStatus() {
  const isOnline = useNetworkStatus()
  const hasPendingWrites = usePendingWrites()

  if (!hasPendingWrites) return null

  return (
    <div className={cn(
      'fixed bottom-4 left-4 px-4 py-2 rounded-full shadow-lg flex items-center gap-2',
      isOnline ? 'bg-blue-500 text-white' : 'bg-yellow-500 text-white'
    )}>
      {isOnline ? (
        <>
          <RefreshCw className="h-4 w-4 animate-spin" />
          <span className="text-sm">Đang đồng bộ...</span>
        </>
      ) : (
        <>
          <Cloud className="h-4 w-4" />
          <span className="text-sm">Chờ kết nối</span>
        </>
      )}
    </div>
  )
}
```

### 10. Create InstallPrompt Component (1.5h)
```typescript
// src/components/pwa/install-prompt.tsx
export function InstallPrompt() {
  const [deferredPrompt, setDeferredPrompt] = useState<any>(null)
  const [showPrompt, setShowPrompt] = useState(false)

  useEffect(() => {
    const handler = (e: Event) => {
      e.preventDefault()
      setDeferredPrompt(e)

      // Show after 30 seconds if not installed
      setTimeout(() => setShowPrompt(true), 30000)
    }

    window.addEventListener('beforeinstallprompt', handler)
    return () => window.removeEventListener('beforeinstallprompt', handler)
  }, [])

  const handleInstall = async () => {
    if (!deferredPrompt) return

    deferredPrompt.prompt()
    const { outcome } = await deferredPrompt.userChoice

    if (outcome === 'accepted') {
      setShowPrompt(false)
    }
    setDeferredPrompt(null)
  }

  if (!showPrompt || !deferredPrompt) return null

  return (
    <div className="fixed bottom-20 left-4 right-4 md:left-auto md:right-4 md:w-80 bg-white rounded-lg shadow-xl border p-4 z-50">
      <div className="flex items-start gap-3">
        <div className="w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center">
          <Download className="h-6 w-6 text-primary" />
        </div>
        <div className="flex-1">
          <h3 className="font-semibold">Cài đặt ứng dụng</h3>
          <p className="text-sm text-gray-500">
            Truy cập nhanh hơn, hoạt động offline
          </p>
        </div>
        <button onClick={() => setShowPrompt(false)}>
          <X className="h-5 w-5 text-gray-400" />
        </button>
      </div>
      <div className="flex gap-2 mt-4">
        <Button variant="outline" onClick={() => setShowPrompt(false)} className="flex-1">
          Để sau
        </Button>
        <Button onClick={handleInstall} className="flex-1">
          Cài đặt
        </Button>
      </div>
    </div>
  )
}
```

### 11. Create UpdatePrompt Component (1h)
```typescript
// src/components/pwa/update-prompt.tsx
export function UpdatePrompt() {
  const [needRefresh, setNeedRefresh] = useState(false)
  const [updateSW, setUpdateSW] = useState<((reloadPage?: boolean) => Promise<void>) | null>(null)

  useEffect(() => {
    registerSW({
      onNeedRefresh() {
        setNeedRefresh(true)
      },
      onRegistered(r) {
        // Store update function
      }
    })
  }, [])

  if (!needRefresh) return null

  return (
    <div className="fixed bottom-4 right-4 bg-primary text-white rounded-lg shadow-xl p-4 z-50">
      <p className="text-sm mb-3">Phiên bản mới có sẵn!</p>
      <div className="flex gap-2">
        <Button variant="secondary" size="sm" onClick={() => setNeedRefresh(false)}>
          Để sau
        </Button>
        <Button variant="default" size="sm" onClick={() => updateSW?.(true)}>
          Cập nhật
        </Button>
      </div>
    </div>
  )
}
```

### 12. Update Firestore Config (0.5h)
```typescript
// src/config/firebase.ts
import { initializeFirestore, persistentLocalCache, persistentMultipleTabManager } from 'firebase/firestore'

export const db = initializeFirestore(app, {
  localCache: persistentLocalCache({
    cacheSizeBytes: 50 * 1024 * 1024, // 50MB
    tabManager: persistentMultipleTabManager()
  })
})
```

### 13. Test Offline Functionality (1.5h)
- Test with Chrome DevTools offline mode
- Test on real device with airplane mode
- Verify data syncs when back online

---

## Todo List
- [ ] Install vite-plugin-pwa
- [ ] Configure VitePWA in vite.config.ts
- [ ] Create app icons (192, 512, apple-touch)
- [ ] Update index.html with meta tags
- [ ] Register service worker in main.tsx
- [ ] Create useNetworkStatus hook
- [ ] Create OfflineIndicator component
- [ ] Create usePendingWrites hook
- [ ] Create SyncStatus component
- [ ] Create InstallPrompt component
- [ ] Create UpdatePrompt component
- [ ] Update Firestore config for persistence
- [ ] Add PWA components to layouts
- [ ] Test install on Android/iOS
- [ ] Test offline mode
- [ ] Test background sync
- [ ] Test update flow

---

## Success Criteria
- [ ] App installable on Android/iOS
- [ ] Lighthouse PWA score > 90
- [ ] Offline page loads with cached data
- [ ] Offline writes sync when back online
- [ ] Install prompt shows on mobile
- [ ] Update prompt works correctly
- [ ] Network status indicator accurate

---

## Risk Assessment

| Risk | Impact | Mitigation |
|------|--------|------------|
| iOS PWA limitations | Medium | Test on iOS, document limitations |
| Cache size overflow | Medium | Set 50MB limit, evict old data |
| Service worker update issues | Low | Force update button, clear cache |

---

## Security Considerations
- Service worker scope limited to app
- No sensitive data in cache
- HTTPS required for PWA

---

## Next Steps
After completion:
1. → Phase 10: Testing & Deployment
2. Test on various devices
3. Monitor cache usage
</file>

<file path="plans/260115-2249-diensanh-commune-management-app/phase-10-testing-deployment.md">
# Phase 10: Testing & Deployment

## Context Links
- [Plan Overview](./plan.md)
- Firebase Console: https://console.firebase.google.com/project/diensanh-37701

## Overview
| Field | Value |
|-------|-------|
| Priority | P1 |
| Status | pending |
| Effort | 8h |
| Dependencies | Phase 01-09 complete |

Comprehensive testing, Firebase Hosting deployment, and production monitoring.

---

## Key Insights
- **Frontend: Vercel** (Validated Decision) - Better DX, preview deployments
- **Backend: Cloud Run** (Validated Decision) - Serverless, auto-scale
- Firestore security rules testing critical
- Full rollout to all 20 villages from day one
- Firestore scheduled exports for backup

---

## Requirements

### Functional
- FR1: All features tested manually
- FR2: Security rules tested
- FR3: Deploy frontend to Vercel
- FR4: Deploy backend to Cloud Run

### Non-Functional
- NFR1: Lighthouse score > 90 (Performance, PWA)
- NFR2: No console errors in production
- NFR3: HTTPS enforced
- NFR4: Monitoring/alerting configured

---

## Architecture

### Deployment Architecture
```
┌─────────────────────────────────────────────────────┐
│                     Vercel                           │
│               (diensanh.vercel.app)                 │
│                                                      │
│  ┌───────────────┐     ┌────────────────────────┐  │
│  │ React PWA     │────▶│ Firebase Auth/Firestore│  │
│  │ (Static)      │     │ (Direct connection)    │  │
│  └───────────────┘     └────────────────────────┘  │
│          │                                          │
│          │ /api/* proxy                             │
│          ▼                                          │
│  ┌───────────────────────────────────────────────┐ │
│  │ FastAPI Backend (Cloud Run / VPS)              │ │
│  │ - /api/chat (RAG chatbot)                      │ │
│  │ - /api/sms/* (SMS integration)                 │ │
│  └───────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────┘
```

### Environment Configuration
```
Production:
  - Frontend: Vercel
  - Backend: Cloud Run
  - Database: Firestore (Production)
  - Auth: Firebase Auth

Staging:
  - Frontend: Vercel Preview Deployments
  - Backend: Cloud Run (staging instance)
  - Database: Firestore (same project, can use emulator)
```

---

## Related Code Files

### Create
- `vercel.json` - Vercel configuration with rewrites
- `Dockerfile` - FastAPI container for Cloud Run
- `cloudbuild.yaml` - Cloud Build configuration
- `firestore.rules` - Security rules
- `firestore.indexes.json` - Indexes
- `scripts/deploy-cloudrun.sh` - Cloud Run deploy script
- `tests/` - Test files
- `.github/workflows/deploy.yml` - CI/CD

### Modify
- `vite.config.ts` - Production build config
- `.env.production` - Production env vars

---

## Implementation Steps

### 1. Configure Vercel Deployment (1h)
```json
// vercel.json
{
  "buildCommand": "cd web && npm run build",
  "outputDirectory": "web/dist",
  "framework": "vite",
  "rewrites": [
    {
      "source": "/api/:path*",
      "destination": "https://diensanh-api-xxx.asia-southeast1.run.app/api/:path*"
    }
  ],
  "headers": [
    {
      "source": "/(.*)",
      "headers": [
        { "key": "X-Content-Type-Options", "value": "nosniff" },
        { "key": "X-Frame-Options", "value": "DENY" }
      ]
    }
  ]
}
```

### 2. Create Cloud Run Dockerfile (1h)
```dockerfile
# Dockerfile
FROM python:3.11-slim

WORKDIR /app

# Install dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy application code
COPY src/ ./src/
COPY data/ ./data/

# Set environment variables
ENV PORT=8080
ENV PYTHONPATH=/app

# Run the application
CMD ["uvicorn", "src.api.api-server:app", "--host", "0.0.0.0", "--port", "8080"]
```

### 3. Create Cloud Run Deploy Script (0.5h)
```bash
#!/bin/bash
# scripts/deploy-cloudrun.sh

set -e

PROJECT_ID="diensanh-37701"
SERVICE_NAME="diensanh-api"
REGION="asia-southeast1"

echo "Building and deploying to Cloud Run..."

# Build and push container
gcloud builds submit --tag gcr.io/$PROJECT_ID/$SERVICE_NAME

# Deploy to Cloud Run
gcloud run deploy $SERVICE_NAME \
  --image gcr.io/$PROJECT_ID/$SERVICE_NAME \
  --platform managed \
  --region $REGION \
  --allow-unauthenticated \
  --set-env-vars="AI4U_API_KEY=$AI4U_API_KEY" \
  --set-env-vars="ESMS_API_KEY=$ESMS_API_KEY" \
  --set-env-vars="ESMS_SECRET_KEY=$ESMS_SECRET_KEY" \
  --memory=512Mi \
  --min-instances=0 \
  --max-instances=10

echo "Deployment complete!"
echo "URL: https://$SERVICE_NAME-xxx.$REGION.run.app"
```

### 4. Setup Firestore Scheduled Exports (0.5h)
```bash
# Enable Cloud Scheduler and create backup job
gcloud scheduler jobs create http firestore-backup \
  --schedule="0 2 * * *" \
  --uri="https://firestore.googleapis.com/v1/projects/diensanh-37701/databases/(default):exportDocuments" \
  --message-body='{"outputUriPrefix":"gs://diensanh-37701-backups/firestore"}' \
  --oauth-service-account-email="firebase-adminsdk@diensanh-37701.iam.gserviceaccount.com" \
  --time-zone="Asia/Saigon"
```

### 5. Test Security Rules (1.5h)
```typescript
// tests/firestore.rules.test.ts
import { assertFails, assertSucceeds, initializeTestEnvironment } from '@firebase/rules-unit-testing'

describe('Firestore Rules', () => {
  let testEnv: RulesTestEnvironment

  beforeAll(async () => {
    testEnv = await initializeTestEnvironment({
      projectId: 'diensanh-37701',
      firestore: { rules: readFileSync('firestore.rules', 'utf8') }
    })
  })

  describe('Villages', () => {
    it('admin can read all villages', async () => {
      const adminDb = testEnv.authenticatedContext('admin-uid', { role: 'commune_admin' }).firestore()
      await assertSucceeds(adminDb.collection('villages').get())
    })

    it('village leader can only read own village', async () => {
      const leaderDb = testEnv.authenticatedContext('leader-uid', {
        role: 'village_leader',
        villageId: 'thon-01'
      }).firestore()

      await assertSucceeds(leaderDb.doc('villages/thon-01').get())
    })

    it('unauthenticated cannot read villages', async () => {
      const unauthedDb = testEnv.unauthenticatedContext().firestore()
      await assertFails(unauthedDb.collection('villages').get())
    })
  })

  describe('Households', () => {
    it('admin can CRUD any household', async () => {
      const adminDb = testEnv.authenticatedContext('admin-uid', { role: 'commune_admin' }).firestore()
      await assertSucceeds(
        adminDb.collection('villages/thon-01/households').add({ headName: 'Test' })
      )
    })

    it('village leader can only CRUD own village households', async () => {
      const leaderDb = testEnv.authenticatedContext('leader-uid', {
        role: 'village_leader',
        villageId: 'thon-01'
      }).firestore()

      await assertSucceeds(
        leaderDb.collection('villages/thon-01/households').get()
      )
      await assertFails(
        leaderDb.collection('villages/thon-02/households').get()
      )
    })
  })

  describe('Requests', () => {
    it('anyone can create request', async () => {
      const unauthedDb = testEnv.unauthenticatedContext().firestore()
      await assertSucceeds(
        unauthedDb.collection('requests').add({
          title: 'Test',
          submitterPhone: '0912345678'
        })
      )
    })
  })
})
```

### 4. Manual Testing Checklist (1.5h)

**Authentication:**
- [ ] Phone OTP login works
- [ ] Session persists after refresh
- [ ] Role-based redirect works
- [ ] Logout clears session

**Admin Dashboard:**
- [ ] Stats display correctly
- [ ] Navigation works
- [ ] Responsive on mobile

**Village Management:**
- [ ] List all 20 villages
- [ ] Filter by region
- [ ] Assign leader works

**Household Management:**
- [ ] Add household
- [ ] Edit household
- [ ] Add resident
- [ ] Search works
- [ ] Excel import works

**SMS System:**
- [ ] Compose SMS
- [ ] Select recipients
- [ ] Send single SMS
- [ ] Send bulk SMS
- [ ] View history

**Tasks:**
- [ ] Create task
- [ ] Assign to villages
- [ ] Village leader sees assigned
- [ ] Submit report

**Public Portal:**
- [ ] View announcements
- [ ] Submit request
- [ ] Track request
- [ ] Chatbot works

**PWA:**
- [ ] Install prompt appears
- [ ] Offline indicator works
- [ ] Offline data loads
- [ ] Sync when back online

### 5. Lighthouse Audit (0.5h)
```bash
# Run Lighthouse CLI
npx lighthouse https://diensanh-37701.web.app \
  --output=html \
  --output-path=./lighthouse-report.html \
  --chrome-flags="--headless"

# Target scores:
# Performance: > 90
# Accessibility: > 90
# Best Practices: > 90
# SEO: > 90
# PWA: Pass all checks
```

### 6. Deploy Firestore Rules (0.5h)
```bash
# Deploy Firestore rules and indexes
firebase deploy --only firestore:rules,firestore:indexes
```

### 7. Production Environment Setup (1h)
```bash
# .env.production
VITE_FIREBASE_API_KEY=xxx
VITE_FIREBASE_AUTH_DOMAIN=diensanh-37701.firebaseapp.com
VITE_FIREBASE_PROJECT_ID=diensanh-37701
VITE_FIREBASE_STORAGE_BUCKET=diensanh-37701.appspot.com
VITE_FIREBASE_MESSAGING_SENDER_ID=xxx
VITE_FIREBASE_APP_ID=xxx
VITE_API_BASE_URL=https://api.diensanh.gov.vn
```

### 8. Setup CI/CD with GitHub Actions (1h)
```yaml
# .github/workflows/deploy.yml
name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: ./web

  deploy-backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Auth to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to Cloud Run
        run: |
          gcloud builds submit --tag gcr.io/diensanh-37701/diensanh-api
          gcloud run deploy diensanh-api \
            --image gcr.io/diensanh-37701/diensanh-api \
            --platform managed \
            --region asia-southeast1 \
            --allow-unauthenticated
```

### 9. Setup Monitoring (0.5h)
- Enable Firebase Performance Monitoring
- Enable Firebase Crashlytics (if using)
- Setup billing alerts
- Configure error reporting

---

## Todo List
- [ ] Configure vercel.json
- [ ] Create Cloud Run Dockerfile
- [ ] Create deploy-cloudrun.sh script
- [ ] Setup Firestore scheduled exports
- [ ] Write Firestore rules tests
- [ ] Run security rules tests
- [ ] Manual test all features
- [ ] Run Lighthouse audit
- [ ] Fix any Lighthouse issues
- [ ] Setup production env vars (Vercel + GCP)
- [ ] Build production bundle
- [ ] Deploy frontend to Vercel
- [ ] Deploy backend to Cloud Run
- [ ] Deploy Firestore rules
- [ ] Verify deployments
- [ ] Setup GitHub Actions CI/CD
- [ ] Configure monitoring
- [ ] Document deployment process

---

## Success Criteria
- [ ] All manual tests pass
- [ ] Security rules tests pass
- [ ] Lighthouse scores > 90
- [ ] Vercel production deployment successful
- [ ] Cloud Run deployment successful
- [ ] CI/CD pipeline works
- [ ] Custom domain configured (if ready)
- [ ] Monitoring enabled

---

## Risk Assessment

| Risk | Impact | Mitigation |
|------|--------|------------|
| Security vulnerability | Critical | Thorough rules testing |
| Deploy downtime | Medium | Use preview channels first |
| Performance regression | Medium | Lighthouse CI checks |

---

## Security Considerations
- Verify no secrets in git
- Review Firestore rules thoroughly
- Test unauthorized access attempts
- Enable Firebase App Check (future)

---

## Post-Deployment

### Monitoring Dashboard
- Firebase Console → Analytics
- Firebase Console → Performance
- Firebase Console → Crashlytics

### Rollback Procedure
```bash
# Vercel: Rollback to previous deployment
vercel rollback

# Cloud Run: Rollback to previous revision
gcloud run services update-traffic diensanh-api \
  --to-revisions=PREVIOUS_REVISION=100 \
  --region=asia-southeast1
```

### Maintenance Tasks
- Weekly: Check error logs
- Monthly: Review usage metrics
- Quarterly: Security audit

---

## Unresolved Questions
1. Custom domain (diensanh.gov.vn) DNS configuration for Vercel?
2. SSL certificate for custom domain? (Vercel provides automatic SSL)
3. ~~FastAPI backend hosting location?~~ → **Resolved: Cloud Run**
4. ~~Backup strategy for Firestore data?~~ → **Resolved: Scheduled exports**

---

## Next Steps
After deployment:
1. User acceptance testing with commune staff
2. Training sessions for admin/village leaders
3. Gradual rollout (pilot village first)
4. Collect feedback for v1.1
</file>

<file path="plans/260115-2249-diensanh-commune-management-app/plan.md">
---
title: "Dien Sanh Commune Management App"
description: "Full-stack PWA for commune administration with offline support, SMS notifications, and multi-role access"
status: pending
priority: P1
effort: 122h
branch: main
tags: [pwa, firebase, react, typescript, commune-management, vietnam]
created: 2026-01-15
---

# Dien Sanh Commune Management App - Implementation Plan

## Overview
Build comprehensive PWA for UBND xa Dien Sanh (Hai Lang, Quang Tri) with:
- Multi-role access (Commune Admin, Village Leader, Public)
- Offline-first architecture for rural connectivity
- SMS provider abstraction (VNPT/eSMS/Stringee)
- Firebase Auth (phone OTP), Firestore database
- Integration with existing Python/FastAPI RAG chatbot

## Tech Stack
| Layer | Technology |
|-------|------------|
| Frontend | React + Vite + TypeScript + TailwindCSS |
| State | Zustand + React Query |
| Backend | Existing FastAPI + New Firebase Functions |
| Database | Firestore (with offline persistence) |
| Auth | Firebase Auth (phone OTP) |
| PWA | vite-plugin-pwa + Workbox |
| SMS | Provider abstraction layer |

## Administrative Structure
- 18 thon + 2 KDC = 20 villages total
- 3 former regions: Dien Sanh cu (11), Hai Truong (5), Hai Dinh (4)

---

## Phases

| # | Phase | Status | Effort | Link |
|---|-------|--------|--------|------|
| 01 | Foundation & Auth Setup | pending | 14h | [phase-01](./phase-01-foundation-auth-setup.md) |
| 02 | Firestore Schema & Security Rules | pending | 10h | [phase-02](./phase-02-firestore-schema-security.md) |
| 03 | Admin Dashboard & Navigation | pending | 14h | [phase-03](./phase-03-admin-dashboard-navigation.md) |
| 04 | Village Management Module | pending | 12h | [phase-04](./phase-04-village-management.md) |
| 05 | Household & Resident Management | pending | 16h | [phase-05](./phase-05-household-resident-management.md) |
| 06 | SMS Messaging System | pending | 14h | [phase-06](./phase-06-sms-messaging-system.md) |
| 07 | Task Assignment Module | pending | 10h | [phase-07](./phase-07-task-assignment.md) |
| 08 | Public Portal & Chatbot Integration | pending | 12h | [phase-08](./phase-08-public-portal-chatbot.md) |
| 09 | PWA & Offline Support | pending | 12h | [phase-09](./phase-09-pwa-offline-support.md) |
| 10 | Testing & Deployment | pending | 8h | [phase-10](./phase-10-testing-deployment.md) |

---

## Key Dependencies
1. Firebase project configured (`diensanh-37701`)
2. SMS provider API credentials (brandname registration pending)
3. Existing FastAPI backend operational
4. Village/household data from commune

## Research Reports
- [PWA/Offline Architecture](./research/researcher-01-pwa-offline-patterns.md)
- [SMS Provider Abstraction](./research/researcher-02-sms-api-abstraction.md)

## Unresolved Questions
1. Brandname registration timeline with MIC?
2. VNeID integration requirements/timeline?
3. Existing household data format for import?
4. Commune admin contact for UAT?

---

## Validation Summary

**Validated:** 2026-01-15
**Questions asked:** 8

### Confirmed Decisions
| Decision | Choice |
|----------|--------|
| UI Framework | TailwindCSS + shadcn/ui + ui-ux-pro-max skill |
| State Management | Zustand (confirmed) |
| SMS Permission | Commune admin only |
| CCCD Storage | Encrypt in Firestore |
| Web Hosting | Vercel |
| Backend Hosting | Cloud Run |
| Rollout Strategy | Full rollout immediately (all 20 villages) |
| Data Backup | Firestore scheduled exports |

### Action Items
- [x] Update Phase 01: Add shadcn/ui to dependencies
- [x] Update Phase 02: Add CCCD encryption logic
- [x] Update Phase 06: Restrict SMS to commune_admin role only
- [x] Update Phase 10: Change hosting from Firebase Hosting to Vercel
- [x] Update Phase 10: Add Cloud Run deployment for FastAPI
</file>

<file path="plans/260116-0900-ui-ux-polish-quickwins/research/researcher-01-color-typography.md">
# UI/UX Research: Color Palette & Typography for Government Web Apps

**Date:** 2026-01-16
**Context:** Vietnamese commune management app (React 19 + Tailwind CSS 4 + Vite 7)
**Target:** WCAG AAA accessibility, government/public service trust

---

## 1. Government Color Palette Recommendations

### Core Principles
- **Trust & Authority:** Blue remains dominant (used by 60%+ of government sites globally)
- **Accessibility First:** WCAG AAA requires 7:1 contrast ratio for normal text, 4.5:1 for large text
- **Cultural Context:** Vietnamese government sites favor navy blue (#1e3a8a range) + red accents

### Recommended Palette (WCAG AAA Compliant)

```css
/* Primary - Government Blue */
--color-primary-50: oklch(97% 0.01 240);   /* Near white */
--color-primary-100: oklch(93% 0.02 240);
--color-primary-500: oklch(55% 0.12 240);  /* #1e40af equivalent - main brand */
--color-primary-700: oklch(40% 0.10 240);  /* #1e3a8a equivalent - dark */
--color-primary-900: oklch(25% 0.08 240);  /* Near black */

/* Secondary - Vietnamese Red (accents only) */
--color-secondary-500: oklch(55% 0.18 25); /* Muted red for flags/headers */

/* Semantic Colors */
--color-success: oklch(60% 0.15 145);      /* Green - 7:1 on white */
--color-warning: oklch(65% 0.14 85);       /* Amber - 7:1 on white */
--color-error: oklch(55% 0.18 25);         /* Red - 7:1 on white */
--color-info: oklch(60% 0.12 240);         /* Blue - 7:1 on white */

/* Neutrals */
--color-neutral-50: oklch(98% 0 0);
--color-neutral-500: oklch(60% 0 0);       /* 7:1 on white */
--color-neutral-900: oklch(25% 0 0);       /* 15:1 on white */
```

### Why OKLCH?
- **Perceptual uniformity:** 500-level colors appear equally bright to human eye
- **Better accessibility:** Easier to achieve consistent contrast ratios
- **Future-proof:** Supports P3 wide-gamut displays (100% mobile by 2026)

---

## 2. Vietnamese Typography Best Practices

### Core Challenge: Diacritic Rendering
Vietnamese has 134 possible character combinations with stacked diacritics (ấ, ờ, ệ). Poor font support creates "lỗi font" (mixed font rendering).

### Recommended Font Stack

```css
font-family:
  'Be Vietnam Pro',           /* Gold standard - designed for Vietnamese */
  'Inter',                    /* Excellent diacritic support + screen-optimized */
  -apple-system,              /* iOS system font */
  BlinkMacSystemFont,         /* macOS system font */
  'Segoe UI',                 /* Windows system font */
  Roboto,                     /* Android fallback */
  sans-serif;
```

### Implementation (Tailwind CSS 4 + Google Fonts)

```css
/* In your main CSS file */
@import url('https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap&subset=vietnamese');

@theme {
  /* Typography tokens */
  --font-sans: 'Be Vietnam Pro', 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;

  /* Vietnamese-specific spacing */
  --line-height-base: 1.6;        /* Extra space for diacritics */
  --line-height-tight: 1.4;       /* Headings */

  /* Font sizes (min 16px for mobile) */
  --font-size-sm: 0.875rem;       /* 14px - use sparingly */
  --font-size-base: 1rem;         /* 16px - body text */
  --font-size-lg: 1.125rem;       /* 18px - comfortable reading */
  --font-size-xl: 1.25rem;        /* 20px - subheadings */
}

/* Text rendering optimization */
body {
  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}
```

### Readability Rules
- **Line height:** 1.6 for body (vs 1.5 for English) - diacritics need vertical space
- **Line length:** 45-75 characters per line (use `max-w-prose` in Tailwind)
- **Font size:** 16px minimum (18px recommended for government sites serving elderly users)
- **Avoid uppercase:** Destroys diacritic legibility - use font-weight instead

---

## 3. Tailwind CSS 4 Configuration Pattern

### Modern Approach: CSS-First with `@theme`

```css
/* app.css or index.css */
@import "tailwindcss";

@theme {
  /* Semantic color tokens (government design system) */
  --color-brand-primary: oklch(40% 0.10 240);        /* Navy blue */
  --color-brand-secondary: oklch(55% 0.18 25);       /* Vietnamese red */

  --color-surface-primary: oklch(100% 0 0);          /* White */
  --color-surface-secondary: oklch(97% 0.01 240);    /* Off-white */
  --color-surface-tertiary: oklch(93% 0.02 240);     /* Light blue */

  --color-text-primary: oklch(25% 0.08 240);         /* Dark blue (15:1) */
  --color-text-secondary: oklch(40% 0.05 240);       /* Medium blue (7:1) */
  --color-text-disabled: oklch(60% 0 0);             /* Gray (4.5:1) */

  --color-border-default: oklch(85% 0.01 240);
  --color-border-focus: oklch(55% 0.12 240);

  /* Status colors (WCAG AAA on white) */
  --color-status-success: oklch(60% 0.15 145);
  --color-status-warning: oklch(65% 0.14 85);
  --color-status-error: oklch(55% 0.18 25);
  --color-status-info: oklch(60% 0.12 240);

  /* Typography */
  --font-sans: 'Be Vietnam Pro', 'Inter', -apple-system, sans-serif;
  --font-size-base: 1rem;
  --line-height-base: 1.6;
}
```

### Usage in Components

```tsx
// Semantic tokens make intent clear
<button className="bg-brand-primary text-surface-primary hover:bg-primary-700">
  Đăng nhập
</button>

<div className="text-text-secondary border-border-default">
  Thông tin chi tiết
</div>

// Status indicators
<div className="bg-status-error text-white">
  Lỗi xác thực
</div>
```

### Dark Mode Support (Future)

```css
@media (prefers-color-scheme: dark) {
  @theme {
    --color-surface-primary: oklch(20% 0.02 240);
    --color-text-primary: oklch(95% 0.01 240);
    /* Semantic tokens automatically adapt */
  }
}
```

---

## 4. Accessibility Checklist (WCAG AAA)

- [x] Text contrast ≥7:1 (normal text), ≥4.5:1 (large text ≥18px)
- [x] Interactive elements ≥3:1 contrast with surrounding colors
- [x] Focus indicators visible (2px outline at 3:1 contrast)
- [x] Color not sole indicator of meaning (use icons + labels)
- [x] Font size ≥16px on mobile
- [x] Line height ≥1.5 (Vietnamese: 1.6)
- [x] No uppercase Vietnamese text in UI

---

## 5. Implementation Priority

**Quick Wins (Today):**
1. Add Be Vietnam Pro font via Google Fonts
2. Define semantic color tokens in `@theme`
3. Set line-height to 1.6 globally

**Phase 2 (This Week):**
1. Convert all color utilities to OKLCH
2. Test contrast ratios with axe DevTools
3. Remove any uppercase Vietnamese text

**Phase 3 (Later):**
1. Build component library using semantic tokens
2. Add dark mode support
3. Implement focus management system

---

## Key Takeaways

- **Color:** Navy blue (#1e3a8a equivalent in OKLCH) for trust + WCAG AAA semantic palette
- **Typography:** Be Vietnam Pro (primary) + Inter (fallback) at 16-18px with 1.6 line height
- **Tailwind 4:** Use `@theme` + semantic tokens + OKLCH for maintainable design system
- **Accessibility:** 7:1 contrast ratio minimum, no uppercase Vietnamese, focus indicators

---

## Sources

- Vietnamese Typography Guide: vietnamesetypography.com
- Be Vietnam Pro Font: fonts.google.com/specimen/Be+Vietnam+Pro
- Google Web Fundamentals: developers.google.com/web/fundamentals/design-and-ux/typography
- Tailwind CSS v4 Documentation: tailwindcss.com
- WCAG 2.2 Guidelines: w3.org/WAI/WCAG22
- OKLCH Color Space: oklch.com

---

## Unresolved Questions

- Need confirmation on brand red accent usage (Vietnamese flag red vs muted government red)?
- Dark mode requirement timeline?
- Specific age demographics for font size optimization (elderly users = 18px+)?
</file>

<file path="plans/260116-0900-ui-ux-polish-quickwins/research/researcher-02-interactions-loading.md">
# UI/UX Best Practices: Interactions & Loading States

**Focus:** Loading buttons, skeleton screens, hover effects, font loading
**Stack:** React 19 + Tailwind CSS 4 + TanStack Query
**Date:** 2026-01-16

---

## 1. Loading Button States

### React 19 Patterns
**useTransition for Non-Blocking Actions**
```tsx
const [isPending, startTransition] = useTransition();

<button
  onClick={() => startTransition(async () => await saveData())}
  disabled={isPending}
  className="relative disabled:opacity-50"
>
  {isPending && <Spinner className="absolute inset-0 m-auto" />}
  {isPending ? 'Saving...' : 'Save'}
</button>
```

**TanStack Query Mutation States**
```tsx
const mutation = useMutation({ mutationFn: saveData });

<button
  onClick={() => mutation.mutate()}
  disabled={mutation.isPending}
  className="min-w-[120px]" // Prevent width shift
>
  {mutation.isPending && <Loader2 className="animate-spin" />}
  {mutation.isPending ? 'Saving...' : 'Save Changes'}
</button>
```

### Tailwind Patterns (No Layout Shift)
```tsx
// Fixed-width container prevents text change shift
<button className="relative min-w-[100px] disabled:cursor-not-allowed">
  <span className={isPending ? 'opacity-0' : ''}>Save</span>
  {isPending && (
    <span className="absolute inset-0 flex items-center justify-center">
      <Spinner />
    </span>
  )}
</button>

// Icon + Text with smooth transition
<button className="inline-flex items-center gap-2 disabled:opacity-60">
  <div className="w-4 h-4">
    {isPending ? <Spinner className="animate-spin" /> : <Check />}
  </div>
  <span>{isPending ? 'Processing...' : 'Submit'}</span>
</button>
```

---

## 2. Skeleton Screens (Dashboard)

### TanStack Query v5 Best Practices

**A. isPending Pattern (Simple)**
```tsx
const { data, isPending } = useQuery({
  queryKey: ['stats'],
  queryFn: fetchStats
});

if (isPending) return <StatsSkeleton />;
return <StatsGrid data={data} />;
```

**B. Suspense Pattern (Recommended)**
```tsx
// Parent: Declarative loading states
<Suspense fallback={<DashboardSkeleton />}>
  <DashboardContent />
</Suspense>

// Child: No loading logic needed
const { data } = useSuspenseQuery({ queryKey: ['stats'], queryFn: fetchStats });
```

**C. Stale-While-Revalidate (Best UX)**
```tsx
// Show stale data during background refetch
const { data, isPending, isFetching } = useQuery({...});

if (isPending) return <Skeleton />; // Initial load only
return (
  <>
    {isFetching && <RefetchIndicator />} {/* Subtle spinner */}
    <StatsGrid data={data} />
  </>
);
```

### Tailwind Skeleton Components
```tsx
// High-fidelity skeleton matching real content
const StatCardSkeleton = () => (
  <div className="bg-white rounded-lg border p-6 space-y-3">
    <div className="h-4 w-24 bg-gray-200 rounded animate-pulse" />
    <div className="h-8 w-16 bg-gray-300 rounded animate-pulse" />
    <div className="h-3 w-32 bg-gray-200 rounded animate-pulse" />
  </div>
);

// Dynamic list skeleton
const TableSkeleton = () => (
  <div className="space-y-2">
    {Array.from({ length: 5 }).map((_, i) => (
      <div key={i} className="flex gap-4 p-4 border rounded">
        <div className="h-10 w-10 bg-gray-200 rounded-full animate-pulse" />
        <div className="flex-1 space-y-2">
          <div className="h-4 w-3/4 bg-gray-200 rounded animate-pulse" />
          <div className="h-3 w-1/2 bg-gray-100 rounded animate-pulse" />
        </div>
      </div>
    ))}
  </div>
);
```

### Timing Rules (2025)
- **< 300ms:** Skip skeleton (flicker is jarring)
- **300ms – 3s:** Show skeleton
- **> 3s:** Add progress indicator or message

---

## 3. Hover States (No Layout Shift)

### Tailwind Anti-Shift Patterns

**Transform Instead of Layout Properties**
```tsx
// ❌ BAD: Causes layout shift
<button className="hover:border-2">Click me</button>

// ✅ GOOD: Transform-based scale
<button className="border-2 border-transparent hover:border-blue-500
  transition-colors duration-200">
  Click me
</button>

// ✅ GOOD: Scale with transform origin
<div className="hover:scale-105 transition-transform duration-200
  transform-gpu">
  Card content
</div>
```

**Shadow & Elevation (GPU-Accelerated)**
```tsx
// Smooth shadow transition
<div className="shadow-sm hover:shadow-lg transition-shadow duration-300">
  Card
</div>

// Combined effects (no layout shift)
<div className="border border-gray-200 rounded-lg
  hover:border-blue-400 hover:shadow-md
  transition-all duration-200">
  Interactive card
</div>
```

**Reserve Space for Interactive Elements**
```tsx
// Pre-allocate border space
<button className="border-2 border-gray-200 hover:border-blue-500">
  Button
</button>

// Use ring for outline effect (no layout change)
<button className="ring-2 ring-transparent hover:ring-blue-500
  transition-all">
  Button
</button>
```

---

## 4. Font Loading Strategy

### font-display Strategies (2025)

| Strategy | Behavior | Use Case |
|----------|----------|----------|
| `swap` | Immediate FOUT, swap when ready | Body text (readability priority) |
| `optional` | No swap if >100ms | Performance-critical, decorative fonts |
| `fallback` | ~100ms block, swap within 3s | Secondary text |
| `block` | 3s block | Icon fonts only (avoid for text) |

### Implementation

**Body Text (Recommended)**
```css
@font-face {
  font-family: 'Inter';
  src: url('/fonts/inter-var.woff2') format('woff2');
  font-display: swap; /* Immediate readability */
  font-weight: 100 900;
}
```

**Metric-Matching Fallback (Prevent FOUT Shift)**
```css
@font-face {
  font-family: 'Inter Fallback';
  src: local('Arial');
  ascent-override: 90%;
  descent-override: 22%;
  line-gap-override: 0%;
  size-adjust: 107%;
}

body {
  font-family: 'Inter', 'Inter Fallback', sans-serif;
}
```

**Preload Critical Fonts**
```html
<link rel="preload" href="/fonts/inter-var.woff2" as="font"
  type="font/woff2" crossorigin>
```

### Tailwind Config (v4)
```js
// tailwind.config.js
export default {
  theme: {
    fontFamily: {
      sans: ['Inter', 'Inter Fallback', 'system-ui', 'sans-serif'],
    }
  }
}
```

---

## Key Takeaways

1. **Loading Buttons:** Use `useTransition` (React 19) or TanStack Query mutations with fixed widths and absolute positioning for spinners
2. **Skeletons:** Prefer `useSuspenseQuery` + React Suspense; use `isPending` vs `isFetching` to avoid re-showing skeletons
3. **Hover Effects:** Use `transform`, `shadow`, `ring`, and pre-allocated borders to prevent layout shifts
4. **Fonts:** `font-display: swap` + preload + metric-matching fallbacks for body text; `optional` for decorative fonts

---

## Sources
- TanStack Query v5 Docs (Suspense guide)
- LogRocket: Skeleton Screen Best Practices
- web.dev: Font Loading Performance 2025
- Chrome DevTools: CLS Optimization Guide
</file>

<file path="plans/260116-0900-ui-ux-polish-quickwins/phase-01-typography-fonts.md">
# Phase 1: Typography & Fonts

## Context Links

- [Color & Typography Research](research/researcher-01-color-typography.md)

## Overview

| Priority | Status | Effort |
|----------|--------|--------|
| P0 (Critical) | pending | 45min |

Add Be Vietnam Pro font with proper Vietnamese diacritic support and optimize line-height for readability.

## Key Insights from Research

- Vietnamese has 134 character combinations with stacked diacritics
- Be Vietnam Pro = gold standard for Vietnamese web typography
- Target users: Non-technical commune workers (elderly) - **18px base font**
- `font-display: swap` for immediate text rendering
- Avoid uppercase Vietnamese (destroys diacritic legibility)

## Requirements

### Functional

- Load Be Vietnam Pro from Google Fonts
- Support weights: 400, 500, 600, 700
- Include Vietnamese subset
- Fallback to Inter, system fonts
- **Base font size: 18px** (for elderly users)

### Non-functional

- Font loads without blocking render
- No FOUT (Flash of Unstyled Text) shift
- WCAG AAA compliance (18px text, 1.6 line-height)

## Related Code Files

| Action | File Path |
|--------|-----------|
| Modify | `/Users/nad/My Drive (duc.a.nguyen@gmail.com)/diensanh/web/src/styles/globals.css` |
| Modify | `/Users/nad/My Drive (duc.a.nguyen@gmail.com)/diensanh/web/index.html` |

## Implementation Steps

### 1. Add font preload to index.html

Add in `<head>` before other styles:

```html
<!-- Preload Be Vietnam Pro for Vietnamese text -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap&subset=vietnamese">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap&subset=vietnamese">
```

### 2. Update font-sans token in globals.css

Replace current `--font-sans`:

```css
--font-sans: 'Be Vietnam Pro', 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
```

### 3. Add line-height token

Add to `@theme` block:

```css
--line-height-base: 1.6;
--line-height-tight: 1.4;
```

### 4. Update body styles

Add text rendering optimization and base font size:

```css
body {
  background-color: var(--color-background);
  color: var(--color-foreground);
  font-family: var(--font-sans);
  font-size: 18px; /* Increased from 16px for elderly users */
  line-height: var(--line-height-base);
  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}
```

## Todo List

- [ ] Add font preconnect and preload links to index.html
- [ ] Update --font-sans token with Be Vietnam Pro
- [ ] Add --line-height-base: 1.6 token
- [ ] Update body styles with font-size: 18px and line-height
- [ ] Test Vietnamese text rendering (diacritics: ấ, ờ, ệ)
- [ ] Verify no FOUT on page load

## Success Criteria

- Be Vietnam Pro loads and displays Vietnamese correctly
- Stacked diacritics (ấ, ờ, ệ) render without overlap
- Line height provides comfortable reading for Vietnamese
- Font swap happens without layout shift

## Security Considerations

- Google Fonts CDN is trusted, no CSP changes needed
- No user data involved
</file>

<file path="plans/260116-0900-ui-ux-polish-quickwins/phase-02-color-tokens.md">
# Phase 2: Color Token Refinement

## Context Links

- [Color & Typography Research](research/researcher-01-color-typography.md)

## Overview

| Priority | Status | Effort |
|----------|--------|--------|
| P1 (High) | pending | 45min |

Refine color tokens for government-official appearance with WCAG AAA compliance and semantic status colors.

## Key Insights from Research

- Navy blue (oklch(32% 0.15 260)) conveys government trust
- 60%+ of government sites use blue as primary
- WCAG AAA requires 7:1 contrast for normal text
- Semantic status colors improve accessibility
- **OKLCH format** for wider color gamut and perceptual uniformity

## Requirements

### Functional

- Update primary CTA color to authoritative blue (OKLCH)
- Add semantic status tokens (success, warning, error, info) in OKLCH
- Ensure all text meets 7:1 contrast ratio

### Non-functional

- No visual regression on existing components
- Dark mode tokens remain functional
- Consistent with Vietnamese government aesthetic

## Related Code Files

| Action | File Path |
|--------|-----------|
| Modify | `/Users/nad/My Drive (duc.a.nguyen@gmail.com)/diensanh/web/src/styles/globals.css` |

## Implementation Steps

### 1. Add semantic status colors to @theme

Add after existing color tokens (using OKLCH):

```css
/* Status colors - WCAG AAA compliant (OKLCH) */
--color-success: oklch(62% 0.19 145);            /* Green */
--color-success-foreground: oklch(100% 0 0);
--color-warning: oklch(65% 0.18 60);             /* Amber */
--color-warning-foreground: oklch(100% 0 0);
--color-error: oklch(55% 0.22 25);               /* Red */
--color-error-foreground: oklch(100% 0 0);
--color-info: oklch(60% 0.16 240);               /* Blue */
--color-info-foreground: oklch(100% 0 0);
```

### 2. Update primary button color

Update to government authoritative blue in OKLCH:

```css
/* Primary CTA - government authoritative blue */
--color-primary-cta: oklch(40% 0.22 265);       /* Deep vibrant blue */
```

### 3. Add dark mode status colors

Add inside dark mode media query:

```css
--color-success: oklch(65% 0.18 150);
--color-warning: oklch(70% 0.16 70);
--color-error: oklch(65% 0.20 25);
--color-info: oklch(65% 0.14 235);
```

## Todo List

- [ ] Add --color-success/warning/error/info tokens
- [ ] Add corresponding foreground tokens
- [ ] Add dark mode variants for status colors
- [ ] Verify contrast ratios with browser DevTools
- [ ] Update any hardcoded green-600/red-600 to use tokens

## Success Criteria

- Status colors available as Tailwind utilities (bg-success, text-warning, etc.)
- All status colors pass WCAG AAA (7:1) on white background
- Dark mode status colors remain visible
- No visual changes to existing components

## Security Considerations

- No security implications for color changes
</file>

<file path="plans/260116-0900-ui-ux-polish-quickwins/phase-03-micro-interactions.md">
# Phase 3: Micro-interactions

## Context Links

- [Interactions & Loading Research](research/researcher-02-interactions-loading.md)

## Overview

| Priority | Status | Effort |
|----------|--------|--------|
| P1 (High) | pending | 90min |

Add loading button patterns, card hover states, and improve skeleton consistency.

## Key Insights from Research

- Use **TanStack Query mutations** (`isPending`) for loading states
- Fixed width + absolute positioning prevents button shift
- Hover: use `ring`, `shadow`, `border` (not layout-changing properties)
- `transform-gpu` for smooth animations
- Skip skeleton if load <300ms (flicker is jarring)

## Requirements

### Functional

- Loading buttons show spinner + disabled state via TanStack Query `isPending`
- StatsCard has smooth hover effect
- QuickActions cards have hover state
- Skeletons match actual content dimensions

### Non-functional

- No layout shift on hover or loading state change
- GPU-accelerated animations
- Consistent animation timing (200ms)

## Related Code Files

| Action | File Path |
|--------|-----------|
| Modify | `/Users/nad/My Drive (duc.a.nguyen@gmail.com)/diensanh/web/src/components/auth/login-form.tsx` |
| Modify | `/Users/nad/My Drive (duc.a.nguyen@gmail.com)/diensanh/web/src/components/dashboard/stats-card.tsx` |
| Modify | `/Users/nad/My Drive (duc.a.nguyen@gmail.com)/diensanh/web/src/components/dashboard/quick-actions.tsx` |
| Create | `/Users/nad/My Drive (duc.a.nguyen@gmail.com)/diensanh/web/src/components/ui/spinner.tsx` |

## Implementation Steps

### 1. Create Spinner component

Create `web/src/components/ui/spinner.tsx`:

```tsx
import { cn } from '@/lib/utils'

interface SpinnerProps {
  className?: string
  size?: 'sm' | 'md' | 'lg'
}

const sizeClasses = {
  sm: 'w-4 h-4',
  md: 'w-5 h-5',
  lg: 'w-6 h-6',
}

export function Spinner({ className, size = 'md' }: SpinnerProps) {
  return (
    <svg
      className={cn('animate-spin', sizeClasses[size], className)}
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 24 24"
    >
      <circle
        className="opacity-25"
        cx="12"
        cy="12"
        r="10"
        stroke="currentColor"
        strokeWidth="4"
      />
      <path
        className="opacity-75"
        fill="currentColor"
        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"
      />
    </svg>
  )
}
```

### 2. Update login-form.tsx buttons

Replace button content with loading pattern (no layout shift) using TanStack Query `isPending`:

```tsx
// Assume mutation hook usage:
// const { mutate, isPending } = useMutation({ ... })

<button
  type="submit"
  disabled={isPending || !phone}
  className={cn(
    "w-full py-3 px-4 rounded-lg font-medium relative",
    "bg-primary-600 text-white",
    "hover:bg-primary-700 transition-colors",
    "disabled:opacity-50 disabled:cursor-not-allowed",
    "min-h-[48px]" // Fixed height prevents shift
  )}
>
  <span className={isPending ? 'opacity-0' : ''}>Nhan ma OTP</span>
  {isPending && (
    <span className="absolute inset-0 flex items-center justify-center">
      <Spinner size="sm" />
    </span>
  )}
</button>
```

### 3. Add hover state to StatsCard

Update StatsCard component:

```tsx
<div className={cn(
  'bg-card rounded-xl border p-5 shadow-sm',
  'transition-all duration-200',
  'hover:shadow-md hover:border-primary-200',
  className
)}>
```

### 4. Improve StatsCardSkeleton

Make skeleton match actual content more closely:

```tsx
function StatsCardSkeleton() {
  return (
    <div className="bg-card rounded-xl border p-5 shadow-sm">
      <div className="flex items-center justify-between">
        <div className="h-4 w-20 bg-muted rounded animate-pulse" />
        <div className="w-10 h-10 bg-primary-50 rounded-lg animate-pulse" />
      </div>
      <div className="mt-3 space-y-2">
        <div className="h-8 w-16 bg-muted rounded animate-pulse" />
        <div className="h-4 w-28 bg-muted rounded animate-pulse" />
      </div>
    </div>
  )
}
```

### 5. Add ring hover to QuickActions cards

Update Link className in quick-actions.tsx:

```tsx
className="group flex flex-col items-center p-4 rounded-lg border border-transparent
  ring-2 ring-transparent
  hover:ring-primary-200 hover:border-primary-300 hover:bg-primary-50/50
  transition-all duration-200 cursor-pointer"
```

## Todo List

- [ ] Create Spinner component at ui/spinner.tsx
- [ ] Update login-form.tsx with loading button pattern
- [ ] Add hover states to StatsCard (shadow-md, border-primary-200)
- [ ] Improve StatsCardSkeleton to match content layout
- [ ] Add ring hover effect to QuickActions cards
- [ ] Test hover effects for layout shift (use DevTools)
- [ ] Verify animations are smooth (60fps)

## Success Criteria

- Buttons show spinner centered during loading
- Button width stays constant during loading
- StatsCard lifts subtly on hover
- QuickActions cards highlight with ring on hover
- No layout shift detected in DevTools

## Security Considerations

- No security implications for UI interactions
</file>

<file path="plans/260116-0900-ui-ux-polish-quickwins/phase-04-quick-ux-fixes.md">
# Phase 4: Quick UX Fixes

## Context Links

- [Interactions & Loading Research](research/researcher-02-interactions-loading.md)

## Overview

| Priority | Status | Effort |
|----------|--------|--------|
| P2 (Medium) | pending | 30min |

Apply quick UX improvements: cursor-pointer on interactive elements, focus states, and image lazy loading.

## Key Insights from Research

- `cursor-pointer` expected on all clickable elements
- Focus states critical for keyboard navigation (WCAG)
- `ring-2 ring-offset-2` pattern for visible focus
- Native `loading="lazy"` for images below fold
- **Minimum 48px touch targets** for elderly users

## Requirements

### Functional

- All buttons/links show pointer cursor
- Focus states visible on keyboard navigation
- Images lazy load to improve LCP
- **Interactive elements have min-height/width of 48px**

### Non-functional

- No additional JS for lazy loading
- Focus styles match brand colors
- Keyboard navigable (Tab key)

## Related Code Files

| Action | File Path |
|--------|-----------|
| Modify | `/Users/nad/My Drive (duc.a.nguyen@gmail.com)/diensanh/web/src/styles/globals.css` |
| Modify | `/Users/nad/My Drive (duc.a.nguyen@gmail.com)/diensanh/web/src/components/layout/sidebar.tsx` |
| Modify | `/Users/nad/My Drive (duc.a.nguyen@gmail.com)/diensanh/web/src/components/dashboard/quick-actions.tsx` |

## Implementation Steps

### 1. Add global cursor and focus styles

Add to globals.css after body styles:

```css
/* Interactive elements */
button,
[role="button"],
a,
input[type="submit"],
input[type="button"],
input[type="checkbox"],
input[type="radio"],
select {
  cursor: pointer;
  min-height: 48px; /* Touch target size for elderly users */
  min-width: 48px;
}

button:disabled,
[disabled] {
  cursor: not-allowed;
}

/* Focus styles */
:focus-visible {
  outline: none;
  ring: 2px solid var(--color-ring);
  ring-offset: 2px;
  ring-offset-color: var(--color-background);
}

/* Tailwind focus-visible utility override */
.focus-visible\:ring-2:focus-visible {
  --tw-ring-offset-width: 2px;
  --tw-ring-color: var(--color-primary-500);
}
```

### 2. Update sidebar nav links with focus-visible

Add focus-visible classes to NavLink in sidebar.tsx:

```tsx
className={cn(
  'flex items-center gap-3 px-3 py-2.5 rounded-lg transition-colors',
  'hover:bg-muted',
  'focus-visible:ring-2 focus-visible:ring-primary-500 focus-visible:ring-offset-2',
  isActive && 'bg-primary-50 text-primary-700 font-medium',
  !open && !mobileOpen && 'justify-center'
)}
```

### 3. Update QuickActions with focus-visible

Add to Link className in quick-actions.tsx:

```tsx
className="group flex flex-col items-center p-4 rounded-lg border border-transparent
  ring-2 ring-transparent
  hover:ring-primary-200 hover:border-primary-300 hover:bg-primary-50/50
  focus-visible:ring-primary-500 focus-visible:ring-offset-2
  transition-all duration-200"
```

### 4. Add lazy loading utility class

Add to globals.css:

```css
/* Lazy loading for images */
img[loading="lazy"] {
  opacity: 0;
  transition: opacity 0.3s ease-in-out;
}

img[loading="lazy"].loaded,
img[loading="lazy"]:not([src=""]) {
  opacity: 1;
}
```

Note: Add `loading="lazy"` attribute to any `<img>` tags in the codebase as encountered.

## Todo List

- [ ] Add cursor-pointer to interactive elements in globals.css
- [ ] Add :focus-visible ring styles globally
- [ ] Update sidebar NavLink with focus-visible classes
- [ ] Update QuickActions Link with focus-visible classes
- [ ] Add lazy loading CSS transition for images
- [ ] Test keyboard navigation (Tab through sidebar, actions)
- [ ] Verify focus ring is visible on all themes

## Success Criteria

- All buttons show pointer cursor on hover
- Tab navigation shows clear focus ring
- Focus ring uses primary brand color
- Disabled elements show not-allowed cursor

## Security Considerations

- No security implications for UX fixes
</file>

<file path="plans/260116-0900-ui-ux-polish-quickwins/plan.md">
---
title: "UI/UX Polish & Quick Wins"
description: "Enhance typography, colors, and interactions for Vietnamese government commune app"
status: pending
priority: P1
effort: 4h
branch: feat/ui-ux-polish-quickwins
tags: [ui, ux, design-system, accessibility, vietnamese]
created: 2026-01-16
---

# UI/UX Polish & Quick Wins Implementation Plan

## Overview

Polish existing design system with Vietnamese-optimized typography, government-official colors, and micro-interactions. Focus on quick wins with high UX impact.

## Research References

- [Color & Typography Research](research/researcher-01-color-typography.md)
- [Interactions & Loading Research](research/researcher-02-interactions-loading.md)

## Key Files

- `web/src/styles/globals.css` - Design tokens
- `web/index.html` - Font preload
- `web/src/components/dashboard/stats-card.tsx` - Hover states
- `web/src/components/auth/login-form.tsx` - Loading buttons

## Phases

| Phase | Title | Status | Effort | Priority |
|-------|-------|--------|--------|----------|
| 1 | [Typography & Fonts](phase-01-typography-fonts.md) | pending | 45min | P0 |
| 2 | [Color Token Refinement](phase-02-color-tokens.md) | pending | 45min | P1 |
| 3 | [Micro-interactions](phase-03-micro-interactions.md) | pending | 90min | P1 |
| 4 | [Quick UX Fixes](phase-04-quick-ux-fixes.md) | pending | 30min | P2 |

## Dependencies

- Google Fonts CDN (Be Vietnam Pro)
- No new npm packages required

## Success Criteria

- [ ] Be Vietnam Pro font loads with swap strategy
- [ ] Line height 1.6 applied globally for Vietnamese text
- [ ] All buttons show loading spinner when pending
- [ ] Cards have hover states without layout shift
- [ ] Interactive elements have cursor-pointer
- [ ] Focus states visible (ring-2)

## Risk Assessment

- **Low risk**: All changes are additive CSS/token updates
- **No breaking changes**: Existing components continue working
- **Rollback**: Revert globals.css if issues arise

## Validation Summary

**Validated:** 2026-01-16
**Questions asked:** 5

### Confirmed Decisions

| Decision | User Choice |
|----------|-------------|
| Font source | Google Fonts CDN |
| Color format | **OKLCH** (differs from plan - update Phase 2) |
| Target users | Non-technical commune workers (elderly) - **18px base font** |
| Loading pattern | **TanStack Query mutations** (differs from plan - update Phase 3) |
| Scope | Listed components only |

### Action Items (Plan Updates Required)

- [x] **Phase 1:** Change base font to 18px (from 16px) for elderly users
- [x] **Phase 2:** Convert HEX colors to OKLCH format
- [x] **Phase 3:** Update loading pattern to use TanStack Query mutations instead of local state
- [x] **Phase 4:** Increase touch targets for elderly users (min 48px)
</file>

<file path="plans/reports/scout-260116-0937-docs-verification.md">
# Scout Report: Documentation Verification

## 1. Current Roadmap
- 10 phases listed.
- Status: Phase 01 In Progress (~5%).
- **Missing**: "UI/UX Polish" phase.

## 2. Current Architecture
- UI: React, Vite, Tailwind, shadcn/ui.
- Backend: FastAPI, Firebase Functions.
- **Note**: Mentions shadcn/ui but lacks specific design token definitions.

## 3. Gaps identified
- `project-roadmap.md`: Needs update with UI/UX Polish plan.
- `code-standards.md`: Needs design token and interaction standards.
- `system-architecture.md`: Needs clarification on UI customization strategy.

## Unresolved Qs
- Phase integration: standalone or interleaved?
- Branding assets availability?
</file>

<file path="scripts/seed-villages.ts">
/**
 * Village seeding script for Dien Sanh commune
 * Run with: npx ts-node scripts/seed-villages.ts
 */

import { initializeApp, cert, ServiceAccount } from 'firebase-admin/app'
import { getFirestore, Timestamp } from 'firebase-admin/firestore'
import * as path from 'path'

// Initialize Firebase Admin
const serviceAccountPath = path.join(__dirname, '../diensanh-45eb1-firebase-adminsdk-fbsvc-bac6fef000.json')

// eslint-disable-next-line @typescript-eslint/no-require-imports
const serviceAccount = require(serviceAccountPath) as ServiceAccount

initializeApp({
  credential: cert(serviceAccount)
})

const db = getFirestore()

// Village data for Dien Sanh commune
// Based on: 18 thôn + 2 KDC across 3 former regions
const villages = [
  // Diên Sanh cũ - 9 thôn + 2 KDC = 11 units
  { code: 'thon-dinh-tho', name: 'Thôn Định Thọ', region: 'dien_sanh_cu', type: 'thon' },
  { code: 'thon-dinh-hoa', name: 'Thôn Định Hòa', region: 'dien_sanh_cu', type: 'thon' },
  { code: 'thon-dinh-mon', name: 'Thôn Định Môn', region: 'dien_sanh_cu', type: 'thon' },
  { code: 'thon-dinh-thanh', name: 'Thôn Định Thành', region: 'dien_sanh_cu', type: 'thon' },
  { code: 'thon-dinh-loc', name: 'Thôn Định Lộc', region: 'dien_sanh_cu', type: 'thon' },
  { code: 'thon-dinh-an', name: 'Thôn Định An', region: 'dien_sanh_cu', type: 'thon' },
  { code: 'thon-dinh-phong', name: 'Thôn Định Phong', region: 'dien_sanh_cu', type: 'thon' },
  { code: 'thon-dinh-trung', name: 'Thôn Định Trung', region: 'dien_sanh_cu', type: 'thon' },
  { code: 'thon-dinh-son', name: 'Thôn Định Sơn', region: 'dien_sanh_cu', type: 'thon' },
  { code: 'kdc-dinh-tho', name: 'KDC Định Thọ', region: 'dien_sanh_cu', type: 'kdc' },
  { code: 'kdc-dinh-hoa', name: 'KDC Định Hòa', region: 'dien_sanh_cu', type: 'kdc' },

  // Hải Trường - 5 thôn
  { code: 'thon-truong-an', name: 'Thôn Trường An', region: 'hai_truong', type: 'thon' },
  { code: 'thon-truong-xuan', name: 'Thôn Trường Xuân', region: 'hai_truong', type: 'thon' },
  { code: 'thon-truong-son', name: 'Thôn Trường Sơn', region: 'hai_truong', type: 'thon' },
  { code: 'thon-truong-tho', name: 'Thôn Trường Thọ', region: 'hai_truong', type: 'thon' },
  { code: 'thon-truong-phuc', name: 'Thôn Trường Phúc', region: 'hai_truong', type: 'thon' },

  // Hải Định - 4 thôn
  { code: 'thon-dinh-hai', name: 'Thôn Định Hải', region: 'hai_dinh', type: 'thon' },
  { code: 'thon-dinh-binh', name: 'Thôn Định Bình', region: 'hai_dinh', type: 'thon' },
  { code: 'thon-dinh-phu', name: 'Thôn Định Phú', region: 'hai_dinh', type: 'thon' },
  { code: 'thon-dinh-vinh', name: 'Thôn Định Vĩnh', region: 'hai_dinh', type: 'thon' },
]

async function seedVillages() {
  console.log('Starting village seeding...')

  const batch = db.batch()
  const now = Timestamp.now()

  for (const village of villages) {
    const ref = db.collection('villages').doc(village.code)
    batch.set(ref, {
      ...village,
      householdCount: 0,
      residentCount: 0,
      createdAt: now,
      updatedAt: now
    })
    console.log(`  Adding: ${village.name} (${village.code})`)
  }

  await batch.commit()
  console.log(`\n✓ Successfully seeded ${villages.length} villages`)
  console.log(`  - Diên Sanh cũ: 9 thôn + 2 KDC`)
  console.log(`  - Hải Trường: 5 thôn`)
  console.log(`  - Hải Định: 4 thôn`)
}

// Run the seeding
seedVillages()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error('Error seeding villages:', error)
    process.exit(1)
  })
</file>

<file path="src/api/__init__.py">
# API modules
</file>

<file path="src/api/api-server.py">
"""
FastAPI backend for Diên Sanh chatbot.
Provides RAG-powered chat endpoint using api.ai4u.now.
"""

import os
import sys
from pathlib import Path

from dotenv import load_dotenv
from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import HTMLResponse
from openai import OpenAI
from pydantic import BaseModel

# Determine base directory
BASE_DIR = Path(__file__).parent.parent.parent if '__file__' in dir() else Path.cwd()

# Add src to path for imports
sys.path.insert(0, str(BASE_DIR / "src"))

from config import settings

# Import vector store (will be loaded lazily)
vector_store = None

# Load environment variables
load_dotenv()

# Initialize FastAPI app
app = FastAPI(
    title="Diên Sanh Chatbot API",
    description="RAG-powered chatbot for Diên Sanh commune public services",
    version="1.0.0"
)

# CORS configuration for widget embedding
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.cors_origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)


def get_vector_store():
    """Lazy-load vector store."""
    global vector_store
    if vector_store is None:
        # Import from parent directory
        import importlib.util
        vs_path = BASE_DIR / "src" / "vector-store.py"
        spec = importlib.util.spec_from_file_location("vector_store", vs_path)
        vs_module = importlib.util.module_from_spec(spec)
        spec.loader.exec_module(vs_module)
        vector_store = vs_module.VectorStore(persist_dir=str(BASE_DIR / "data" / "vector_store"))
    return vector_store


def get_llm_client() -> OpenAI:
    """Get OpenAI-compatible client for api.ai4u.now."""
    api_key = settings.ai4u_api_key or os.getenv("AI4U_API_KEY")
    if not api_key:
        raise HTTPException(
            status_code=500,
            detail="AI4U API key not configured. Set AI4U_API_KEY environment variable."
        )

    return OpenAI(
        base_url=settings.ai4u_base_url,
        api_key=api_key
    )


# Request/Response models
class ChatRequest(BaseModel):
    message: str
    conversation_id: str | None = None
    include_sources: bool = True


class ChatResponse(BaseModel):
    response: str
    sources: list[dict] | None = None
    conversation_id: str | None = None


class HealthResponse(BaseModel):
    status: str
    documents_indexed: int
    model: str


# System prompt for the chatbot
SYSTEM_PROMPT = """Bạn là trợ lý ảo của UBND xã Diên Sanh, huyện Hải Lăng, tỉnh Quảng Trị.
Nhiệm vụ của bạn là hỗ trợ người dân tìm hiểu thông tin về:
- Các thủ tục hành chính công (đăng ký khai sinh, kết hôn, cấp giấy tờ, v.v.)
- Thông tin về UBND xã và các cơ quan liên quan
- Hướng dẫn quy trình, hồ sơ cần thiết, thời gian xử lý, phí/lệ phí

Quy tắc trả lời:
1. Trả lời bằng tiếng Việt, ngắn gọn, dễ hiểu
2. Chỉ trả lời dựa trên thông tin được cung cấp trong ngữ cảnh
3. Nếu không có thông tin, nói rõ và hướng dẫn liên hệ UBND xã
4. Cung cấp thông tin liên hệ khi cần: Điện thoại, địa chỉ, email (nếu có trong ngữ cảnh)
5. Nếu thủ tục có bước thực hiện, liệt kê rõ ràng từng bước

Luôn thân thiện và sẵn sàng hỗ trợ người dân."""


def build_context(query: str, n_results: int = 5) -> str:
    """Retrieve relevant context from vector store."""
    try:
        store = get_vector_store()
        results = store.search(query, n_results=n_results)

        if not results:
            return "Không tìm thấy thông tin liên quan trong cơ sở dữ liệu."

        context_parts = []
        for i, r in enumerate(results, 1):
            title = r["metadata"].get("title", "Không có tiêu đề")
            source = r["metadata"].get("source", "unknown")
            content = r["content"][:1500]  # Limit content length

            context_parts.append(f"[{i}] {title}\n(Nguồn: {source})\n{content}")

        return "\n\n---\n\n".join(context_parts)

    except Exception as e:
        print(f"Error retrieving context: {e}")
        return ""


@app.get("/health", response_model=HealthResponse)
async def health_check():
    """Health check endpoint."""
    try:
        store = get_vector_store()
        doc_count = store.count()
    except:
        doc_count = 0

    return HealthResponse(
        status="healthy",
        documents_indexed=doc_count,
        model=settings.chat_model
    )


@app.post("/chat", response_model=ChatResponse)
async def chat(request: ChatRequest):
    """
    Main chat endpoint.
    Uses RAG to retrieve relevant context and generate response.
    """
    if not request.message.strip():
        raise HTTPException(status_code=400, detail="Message cannot be empty")

    # Retrieve relevant context
    context = build_context(request.message)

    # Build messages for LLM
    messages = [
        {"role": "system", "content": SYSTEM_PROMPT},
        {
            "role": "user",
            "content": f"""Ngữ cảnh (thông tin từ cơ sở dữ liệu):
---
{context}
---

Câu hỏi của người dân: {request.message}

Hãy trả lời câu hỏi dựa trên ngữ cảnh trên."""
        }
    ]

    # Call LLM
    try:
        client = get_llm_client()
        response = client.chat.completions.create(
            model=settings.chat_model,
            messages=messages,
            temperature=0.3,  # Lower for more factual responses
            max_tokens=1024
        )

        answer = response.choices[0].message.content

    except Exception as e:
        raise HTTPException(status_code=500, detail=f"LLM error: {str(e)}")

    # Prepare sources if requested
    sources = None
    if request.include_sources:
        try:
            store = get_vector_store()
            results = store.search(request.message, n_results=3)
            sources = [
                {
                    "title": r["metadata"].get("title", ""),
                    "url": r["metadata"].get("url", ""),
                    "score": r["score"]
                }
                for r in results
            ]
        except:
            sources = []

    return ChatResponse(
        response=answer,
        sources=sources,
        conversation_id=request.conversation_id
    )


@app.get("/", response_class=HTMLResponse)
async def root():
    """Simple test page."""
    return """
    <!DOCTYPE html>
    <html>
    <head>
        <title>Diên Sanh Chatbot API</title>
        <style>
            body { font-family: system-ui; max-width: 600px; margin: 50px auto; padding: 20px; }
            h1 { color: #1a5f2a; }
            .status { background: #e8f5e9; padding: 15px; border-radius: 8px; }
        </style>
    </head>
    <body>
        <h1>🏛️ Trợ lý ảo UBND xã Diên Sanh</h1>
        <div class="status">
            <p>✅ API đang hoạt động</p>
            <p>📖 Xem tài liệu API: <a href="/docs">/docs</a></p>
            <p>🔧 Health check: <a href="/health">/health</a></p>
        </div>
    </body>
    </html>
    """


if __name__ == "__main__":
    import uvicorn
    uvicorn.run(
        "api-server:app",
        host=settings.api_host,
        port=settings.api_port,
        reload=True
    )
</file>

<file path="src/scraper/__init__.py">
# Scraper modules
</file>

<file path="src/scraper/dichvucong-scraper.py">
"""
Playwright-based scraper for thutuc.dichvucong.gov.vn (National Public Services Portal).
Extracts all commune-level public service procedures (thủ tục hành chính cấp xã).
Updated: Since 2025, provincial portals redirect to national portal.
"""

import asyncio
import json
import re
from datetime import datetime
from pathlib import Path
from playwright.async_api import async_playwright, Page, Browser


# National portal URLs
PORTAL_URL = "https://thutuc.dichvucong.gov.vn"
PROCEDURES_URL = f"{PORTAL_URL}/p/home/dvc-tthc-thu-tuc-hanh-chinh.html"

# Common commune-level procedure search terms
COMMUNE_SEARCH_TERMS = [
    "đăng ký khai sinh",
    "đăng ký kết hôn",
    "đăng ký khai tử",
    "hộ tịch",
    "chứng thực",
    "xác nhận",
    "tạm trú",
    "tạm vắng",
    "hộ khẩu",
    "cư trú",
    "giấy xác nhận tình trạng hôn nhân",
    "bảo trợ xã hội",
    "người có công",
    "chính sách xã hội",
    "đất đai",
    "xây dựng",
    "kinh doanh",
]


async def select_commune_level(page: Page) -> bool:
    """Select commune level filter using Select2 dropdown."""
    try:
        # Wait for page to load
        await asyncio.sleep(2)

        # Click on the Select2 container for level to open dropdown
        level_container = await page.query_selector("#select2-select-level-container")
        if not level_container:
            # Try parent container
            level_container = await page.query_selector("span[aria-labelledby='select2-select-level-container']")

        if level_container:
            await level_container.click()
            await asyncio.sleep(0.5)

            # Wait for dropdown to open and find "Cấp Xã" option
            # Select2 creates dropdown in body with class select2-results
            xa_option = await page.wait_for_selector("li.select2-results__option:has-text('Cấp Xã')", timeout=5000)
            if xa_option:
                await xa_option.click()
                print("Selected: Cấp Xã (Commune level)")
                await asyncio.sleep(2)
                await page.wait_for_load_state("networkidle", timeout=15000)
                return True

        # Fallback: Use JavaScript to set value directly
        print("Using JavaScript fallback for Select2...")
        await page.evaluate("""
            $('#select-level').val('3').trigger('change');
        """)
        await asyncio.sleep(2)
        await page.wait_for_load_state("networkidle", timeout=15000)
        print("Selected: Cấp Xã (Commune level) via JS")
        return True

    except Exception as e:
        print(f"Error selecting commune level: {e}")
        # Try JavaScript fallback
        try:
            await page.evaluate("$('#select-level').val('3').trigger('change');")
            await asyncio.sleep(2)
            print("Selected via JS fallback")
            return True
        except:
            return False


async def extract_procedures_from_table(page: Page) -> list[dict]:
    """Extract procedures from the table on current page."""
    procedures = []

    # Find table rows
    rows = await page.query_selector_all("table tbody tr")
    print(f"  Found {len(rows)} rows on this page")

    for row in rows:
        try:
            cells = await row.query_selector_all("td")
            if len(cells) >= 5:
                # Extract data from cells
                code = await cells[0].inner_text()

                # Get title and link
                title_link = await cells[1].query_selector("a")
                title = await title_link.inner_text() if title_link else await cells[1].inner_text()
                href = await title_link.get_attribute("href") if title_link else ""

                authority = await cells[2].inner_text()
                implementing = await cells[3].inner_text()
                field = await cells[4].inner_text()

                if title.strip():
                    procedures.append({
                        "code": code.strip(),
                        "title": title.strip(),
                        "url": href.strip() if href else "",
                        "authority": authority.strip(),
                        "implementing": implementing.strip(),
                        "field": field.strip(),
                        "scraped_at": datetime.now().isoformat()
                    })
        except Exception as e:
            print(f"  Error extracting row: {e}")
            continue

    return procedures


async def get_total_pages(page: Page) -> int:
    """Get total number of pages from pagination."""
    try:
        # Look for pagination info
        pagination = await page.query_selector(".pagination, .paging, nav[aria-label*='Page']")
        if pagination:
            # Find last page number
            page_links = await pagination.query_selector_all("a, button, li")
            max_page = 1
            for link in page_links:
                text = await link.inner_text()
                if text.isdigit():
                    max_page = max(max_page, int(text))
            return max_page

        # Alternative: look for page count text
        body_text = await page.inner_text("body")
        match = re.search(r'Trang \d+ / (\d+)', body_text)
        if match:
            return int(match.group(1))

        return 1
    except:
        return 1


async def navigate_to_page(page: Page, page_num: int) -> bool:
    """Navigate to a specific page number."""
    try:
        # Try clicking page number link
        page_link = await page.query_selector(f"a:has-text('{page_num}'), button:has-text('{page_num}')")
        if page_link:
            await page_link.click()
            await asyncio.sleep(1)
            await page.wait_for_load_state("networkidle", timeout=15000)
            return True

        # Try using pagination input if available
        page_input = await page.query_selector("input[type='number'][class*='page']")
        if page_input:
            await page_input.fill(str(page_num))
            await page.keyboard.press("Enter")
            await asyncio.sleep(1)
            await page.wait_for_load_state("networkidle", timeout=15000)
            return True

        return False
    except Exception as e:
        print(f"Error navigating to page {page_num}: {e}")
        return False


async def extract_procedure_detail(page: Page, url: str) -> dict:
    """Extract detailed information from a single procedure page."""
    if not url:
        return {}

    try:
        await page.goto(url, wait_until="networkidle", timeout=30000)
        await asyncio.sleep(2)

        detail = {"url": url}

        # Get body text - most reliable for this page
        body_text = await page.inner_text('body')

        if body_text and len(body_text) > 100:
            # Parse sections from the text using regex
            sections = {
                "processing_time": r"(?:Thời hạn giải quyết|Thời gian)[:\s]*([^\n]+)",
                "fee": r"(?:Phí, lệ phí|Phí|Lệ phí)[:\s]*([^\n]+(?:\n[^\n]*Đồng)?)",
                "method": r"(?:Cách thức thực hiện|Hình thức nộp)[:\s]*([\s\S]+?)(?:Thành phần|Yêu cầu|Trình tự|$)",
                "legal_basis": r"(?:Căn cứ pháp lý)[:\s]*([\s\S]+?)(?:Yêu cầu|$)",
            }

            for field, pattern in sections.items():
                match = re.search(pattern, body_text, re.IGNORECASE)
                if match:
                    detail[field] = match.group(1).strip()[:1500]

            # Store cleaned full content
            # Remove navigation/header parts
            content_start = body_text.find("Chi tiết thủ tục")
            if content_start > 0:
                body_text = body_text[content_start:]

            # Remove footer parts
            content_end = body_text.find("Cơ quan chủ quản")
            if content_end > 0:
                body_text = body_text[:content_end]

            detail["full_content"] = body_text.strip()[:5000]

        return detail

    except Exception as e:
        print(f"    Error extracting detail: {e}")
        return {"url": url, "error": str(e)}


async def search_procedures(page: Page, search_term: str) -> list[dict]:
    """Search for procedures by term and extract results."""
    procedures = []

    try:
        # Find and fill search input
        search_input = await page.query_selector('input[type="text"], input[name*="search"], input[placeholder*="Tìm"]')
        if not search_input:
            print(f"  Search input not found")
            return []

        await search_input.fill(search_term)
        await asyncio.sleep(0.5)

        # Click search button
        search_btn = await page.query_selector('button:has-text("Tìm kiếm")')
        if search_btn:
            await search_btn.click()
            await asyncio.sleep(3)
            await page.wait_for_load_state('networkidle', timeout=30000)

        # Extract results from table
        rows = await page.query_selector_all('table tbody tr')

        for row in rows:
            try:
                cells = await row.query_selector_all('td')
                if len(cells) >= 5:
                    # The link is in the first cell (code column)
                    code_link = await cells[0].query_selector('a')
                    if not code_link:
                        continue

                    code = await code_link.inner_text()
                    href = await code_link.get_attribute('href')

                    # Title is plain text in second cell
                    title = await cells[1].inner_text()
                    authority = await cells[2].inner_text()
                    implementing = await cells[3].inner_text()
                    field = await cells[4].inner_text()

                    # Filter for commune-level (xã/phường) procedures
                    impl_lower = implementing.lower()
                    if 'xã' in impl_lower or 'phường' in impl_lower or 'thị trấn' in impl_lower or 'cấp xã' in impl_lower:
                        # Build full URL
                        full_url = href if href.startswith('http') else f"{PORTAL_URL}/p/home/{href}"

                        procedures.append({
                            'code': code.strip(),
                            'title': title.strip(),
                            'url': full_url,
                            'authority': authority.strip(),
                            'implementing': implementing.strip(),
                            'field': field.strip(),
                            'search_term': search_term,
                            'scraped_at': datetime.now().isoformat()
                        })
            except Exception as e:
                continue

        # Clear search for next query
        await search_input.fill('')

    except Exception as e:
        print(f"  Error searching for '{search_term}': {e}")

    return procedures


async def scrape_all_procedures(
    output_dir: str = "./data",
    max_details: int = 50,
    headless: bool = True
) -> dict:
    """
    Main scraping function.
    Searches for commune-level procedures and extracts details.
    """
    output_path = Path(output_dir)
    output_path.mkdir(parents=True, exist_ok=True)

    result = {
        "source": PORTAL_URL,
        "level": "Cấp Xã (Commune level)",
        "scraped_at": datetime.now().isoformat(),
        "procedures": [],
        "errors": []
    }

    # Track unique procedures by code
    seen_codes = set()

    async with async_playwright() as p:
        browser: Browser = await p.chromium.launch(
            headless=headless,
            args=["--ignore-certificate-errors"]
        )
        context = await browser.new_context(
            ignore_https_errors=True,
            locale="vi-VN"
        )
        page = await context.new_page()

        print(f"Loading {PROCEDURES_URL}...")

        try:
            await page.goto(PROCEDURES_URL, wait_until="networkidle", timeout=60000)
            await asyncio.sleep(3)

            # Search for each term
            for term in COMMUNE_SEARCH_TERMS:
                print(f"Searching: {term}...")
                procedures = await search_procedures(page, term)

                # Add unique procedures
                added = 0
                for proc in procedures:
                    if proc['code'] not in seen_codes:
                        seen_codes.add(proc['code'])
                        result['procedures'].append(proc)
                        added += 1

                print(f"  Found {len(procedures)}, added {added} new (total: {len(result['procedures'])})")
                await asyncio.sleep(1)

            print(f"\nTotal unique procedures: {len(result['procedures'])}")

            # Get details for procedures
            if result["procedures"] and max_details > 0:
                details_to_get = min(len(result["procedures"]), max_details)
                print(f"\nExtracting details for {details_to_get} procedures...")

                for i, proc in enumerate(result["procedures"][:details_to_get]):
                    if proc.get("url"):
                        print(f"  [{i+1}/{details_to_get}] {proc['title'][:40]}...")
                        detail = await extract_procedure_detail(page, proc["url"])
                        proc["detail"] = detail
                        await asyncio.sleep(0.5)

        except Exception as e:
            print(f"Scraping error: {e}")
            result["errors"].append(str(e))

        await browser.close()

    # Save results
    output_file = output_path / "dichvucong_procedures.json"
    with open(output_file, "w", encoding="utf-8") as f:
        json.dump(result, f, ensure_ascii=False, indent=2)

    print(f"\nSaved {len(result['procedures'])} procedures to {output_file}")
    return result


async def debug_page_structure(headless: bool = False) -> None:
    """Debug helper to understand the page structure."""
    async with async_playwright() as p:
        browser = await p.chromium.launch(
            headless=headless,
            args=["--ignore-certificate-errors"]
        )
        context = await browser.new_context(ignore_https_errors=True, locale="vi-VN")
        page = await context.new_page()

        print(f"Opening {PROCEDURES_URL}...")
        await page.goto(PROCEDURES_URL, wait_until="networkidle", timeout=60000)
        await asyncio.sleep(2)

        # Select commune level
        await select_commune_level(page)
        await asyncio.sleep(2)

        # Get page content
        body_text = await page.inner_text("body")
        print("\n--- Page visible text (first 3000 chars) ---")
        print(body_text[:3000])

        # Check table structure
        rows = await page.query_selector_all("table tbody tr")
        print(f"\nFound {len(rows)} table rows")

        if rows:
            print("\nFirst row structure:")
            cells = await rows[0].query_selector_all("td")
            for i, cell in enumerate(cells):
                text = await cell.inner_text()
                print(f"  Cell {i}: {text[:60]}...")

        # Save HTML for inspection
        html = await page.content()
        with open("./data/debug_national_portal.html", "w", encoding="utf-8") as f:
            f.write(html)
        print("\nSaved debug HTML to ./data/debug_national_portal.html")

        if not headless:
            print("\nBrowser is open. Press Enter to close...")
            input()

        await browser.close()


if __name__ == "__main__":
    import sys

    if len(sys.argv) > 1 and sys.argv[1] == "debug":
        # Run in debug mode
        asyncio.run(debug_page_structure(headless=True))
    else:
        # Run full scrape
        asyncio.run(scrape_all_procedures(headless=True))
</file>

<file path="src/scraper/mainsite-scraper.py">
"""
Scraper for diensanh.quangtri.gov.vn main site (Liferay CMS).
Uses requests/BeautifulSoup for static content extraction.
"""

import json
import re
import ssl
import urllib3
from datetime import datetime
from pathlib import Path
from urllib.parse import urljoin, unquote

import httpx
from bs4 import BeautifulSoup

# Disable SSL warnings for self-signed certificates
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

BASE_URL = "https://diensanh.quangtri.gov.vn"

# Key pages to scrape
PAGES_TO_SCRAPE = [
    {"path": "/", "name": "home", "title": "Trang chủ"},
    {"path": "/gi%E1%BB%9Bi-thi%E1%BB%86u", "name": "introduction", "title": "Giới thiệu"},
    {"path": "/t%E1%BB%95-ch%E1%BB%A9c-h%C3%A0nh-ch%C3%ADnh", "name": "organization", "title": "Tổ chức hành chính"},
    {"path": "/h%E1%BB%86-th%E1%BB%90ng-v%C4%82n-b%E1%BA%A2n", "name": "documents", "title": "Hệ thống văn bản"},
    {"path": "/th%C3%B4ng-tin-tuy%C3%AAn-truy%E1%BB%81n", "name": "news", "title": "Thông tin tuyên truyền"},
    {"path": "/li%C3%8An-h%E1%BB%86", "name": "contact", "title": "Liên hệ"},
    {"path": "/dai-hoi-dang", "name": "party_congress", "title": "Đại hội Đảng"},
]


def create_client() -> httpx.Client:
    """Create HTTP client with SSL verification disabled."""
    return httpx.Client(
        verify=False,
        timeout=30.0,
        follow_redirects=True,
        headers={
            "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36",
            "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
            "Accept-Language": "vi-VN,vi;q=0.9,en;q=0.8",
        }
    )


def clean_text(text: str) -> str:
    """Clean extracted text by removing excessive whitespace."""
    if not text:
        return ""
    # Replace multiple whitespace with single space
    text = re.sub(r'\s+', ' ', text)
    # Remove leading/trailing whitespace
    return text.strip()


def extract_main_content(soup: BeautifulSoup) -> str:
    """Extract main content from Liferay page, excluding navigation/footer."""
    content_parts = []

    # Remove unwanted elements
    for selector in ["nav", "header", "footer", ".navigation", ".menu", "script", "style", ".sidebar"]:
        for el in soup.select(selector):
            el.decompose()

    # Target content areas common in Liferay
    content_selectors = [
        ".journal-content-article",
        ".portlet-body",
        ".asset-content",
        "article",
        ".content",
        "main",
        "#main-content",
    ]

    for selector in content_selectors:
        elements = soup.select(selector)
        for el in elements:
            text = clean_text(el.get_text())
            if len(text) > 50:  # Skip tiny fragments
                content_parts.append(text)

    # If no specific content found, get body text
    if not content_parts:
        body = soup.find("body")
        if body:
            content_parts.append(clean_text(body.get_text()))

    # Deduplicate while preserving order
    seen = set()
    unique_parts = []
    for part in content_parts:
        if part not in seen and len(part) > 50:
            seen.add(part)
            unique_parts.append(part)

    return "\n\n".join(unique_parts)


def extract_links(soup: BeautifulSoup, base_url: str) -> list[dict]:
    """Extract all internal links from the page."""
    links = []
    seen_urls = set()

    for a in soup.find_all("a", href=True):
        href = a.get("href", "")
        text = clean_text(a.get_text())

        if not href or not text:
            continue

        # Skip anchors, javascript, external links
        if href.startswith("#") or href.startswith("javascript:"):
            continue

        # Convert to absolute URL
        full_url = urljoin(base_url, href)

        # Only keep internal links
        if not full_url.startswith(BASE_URL):
            continue

        if full_url in seen_urls:
            continue

        seen_urls.add(full_url)
        links.append({"url": full_url, "text": text})

    return links


def scrape_page(client: httpx.Client, url: str) -> dict:
    """Scrape a single page and extract content."""
    try:
        response = client.get(url)
        response.raise_for_status()

        soup = BeautifulSoup(response.text, "lxml")

        # Get title
        title_el = soup.find("title")
        title = clean_text(title_el.get_text()) if title_el else ""

        # Get meta description
        meta_desc = soup.find("meta", attrs={"name": "description"})
        description = meta_desc.get("content", "") if meta_desc else ""

        # Get main content
        content = extract_main_content(soup)

        # Get links for further crawling
        links = extract_links(soup, url)

        return {
            "url": url,
            "title": title,
            "description": description,
            "content": content,
            "links": links,
            "scraped_at": datetime.now().isoformat(),
            "status": "success"
        }

    except Exception as e:
        return {
            "url": url,
            "error": str(e),
            "scraped_at": datetime.now().isoformat(),
            "status": "error"
        }


def scrape_main_site(output_dir: str = "./data", crawl_depth: int = 1) -> dict:
    """
    Scrape all key pages from the main site.

    Args:
        output_dir: Directory to save scraped data
        crawl_depth: How many levels deep to follow links (0 = only key pages)
    """
    output_path = Path(output_dir)
    output_path.mkdir(parents=True, exist_ok=True)

    result = {
        "source": BASE_URL,
        "scraped_at": datetime.now().isoformat(),
        "pages": [],
        "errors": []
    }

    client = create_client()
    scraped_urls = set()

    print(f"Scraping main site: {BASE_URL}")

    # Scrape key pages
    for page_info in PAGES_TO_SCRAPE:
        url = urljoin(BASE_URL, page_info["path"])
        print(f"  Scraping: {page_info['title']} ({unquote(page_info['path'])})")

        page_data = scrape_page(client, url)
        page_data["page_name"] = page_info["name"]
        page_data["expected_title"] = page_info["title"]
        result["pages"].append(page_data)
        scraped_urls.add(url)

        if page_data["status"] == "error":
            result["errors"].append(f"{page_info['title']}: {page_data.get('error')}")

    # Optional: Crawl linked pages (depth 1)
    if crawl_depth > 0:
        additional_urls = set()
        for page in result["pages"]:
            for link in page.get("links", []):
                link_url = link["url"]
                if link_url not in scraped_urls:
                    additional_urls.add(link_url)

        print(f"\n  Found {len(additional_urls)} additional pages to crawl...")
        for i, url in enumerate(list(additional_urls)[:20]):  # Limit to 20
            print(f"    [{i+1}/20] {unquote(url)[:60]}...")
            page_data = scrape_page(client, url)
            page_data["page_name"] = "crawled"
            result["pages"].append(page_data)
            scraped_urls.add(url)

    client.close()

    # Save results
    output_file = output_path / "diensanh_pages.json"
    with open(output_file, "w", encoding="utf-8") as f:
        json.dump(result, f, ensure_ascii=False, indent=2)

    print(f"\nSaved {len(result['pages'])} pages to {output_file}")
    print(f"Errors: {len(result['errors'])}")

    return result


if __name__ == "__main__":
    scrape_main_site()
</file>

<file path="src/widget/chat-widget.html">
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trợ lý ảo UBND xã Diên Sanh</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #1a5f2a 0%, #2e7d32 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .chat-container {
            width: 100%;
            max-width: 480px;
            height: 600px;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        .chat-header {
            background: linear-gradient(135deg, #1a5f2a 0%, #2e7d32 100%);
            color: white;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-header .avatar {
            width: 48px;
            height: 48px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .chat-header .info h2 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .chat-header .info p {
            font-size: 12px;
            opacity: 0.9;
        }

        /* Messages area */
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: #f5f7f9;
        }

        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 14px;
            line-height: 1.5;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.bot {
            background: white;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .message.user {
            background: #1a5f2a;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .message.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }

        .message .sources {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e0e0e0;
            font-size: 12px;
            color: #666;
        }

        .message .sources a {
            color: #1a5f2a;
            text-decoration: none;
        }

        .message .sources a:hover {
            text-decoration: underline;
        }

        /* Typing indicator */
        .typing {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            background: white;
            border-radius: 16px;
            align-self: flex-start;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .typing span {
            width: 8px;
            height: 8px;
            background: #1a5f2a;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .typing span:nth-child(1) { animation-delay: 0s; }
        .typing span:nth-child(2) { animation-delay: 0.2s; }
        .typing span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0.6); opacity: 0.6; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* Input area */
        .chat-input {
            padding: 16px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 24px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .chat-input input:focus {
            border-color: #1a5f2a;
        }

        .chat-input button {
            width: 44px;
            height: 44px;
            background: #1a5f2a;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s, transform 0.1s;
        }

        .chat-input button:hover {
            background: #145220;
        }

        .chat-input button:active {
            transform: scale(0.95);
        }

        .chat-input button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Quick actions */
        .quick-actions {
            padding: 10px 16px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }

        .quick-actions button {
            padding: 8px 14px;
            background: #e8f5e9;
            color: #1a5f2a;
            border: 1px solid #c8e6c9;
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-actions button:hover {
            background: #c8e6c9;
        }

        /* Responsive */
        @media (max-width: 520px) {
            body {
                padding: 0;
            }
            .chat-container {
                height: 100vh;
                max-width: 100%;
                border-radius: 0;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="avatar">🏛️</div>
            <div class="info">
                <h2>Trợ lý ảo UBND xã Diên Sanh</h2>
                <p>Hỗ trợ thủ tục hành chính 24/7</p>
            </div>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div class="message bot">
                Xin chào! Tôi là trợ lý ảo của UBND xã Diên Sanh. Tôi có thể giúp bạn tìm hiểu về:
                <br><br>
                • Thủ tục hành chính (khai sinh, kết hôn, hộ khẩu...)<br>
                • Hồ sơ và giấy tờ cần thiết<br>
                • Thời gian xử lý và phí/lệ phí<br>
                • Thông tin liên hệ UBND xã
                <br><br>
                Bạn cần hỗ trợ gì?
            </div>
        </div>

        <div class="quick-actions">
            <button onclick="sendQuickMessage('Thủ tục đăng ký khai sinh')">📝 Khai sinh</button>
            <button onclick="sendQuickMessage('Thủ tục đăng ký kết hôn')">💒 Kết hôn</button>
            <button onclick="sendQuickMessage('Thủ tục cấp giấy xác nhận')">📄 Xác nhận</button>
            <button onclick="sendQuickMessage('Liên hệ UBND xã')">📞 Liên hệ</button>
        </div>

        <div class="chat-input">
            <input
                type="text"
                id="userInput"
                placeholder="Nhập câu hỏi của bạn..."
                onkeypress="handleKeyPress(event)"
            >
            <button onclick="sendMessage()" id="sendBtn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 2L11 13M22 2L15 22L11 13L2 9L22 2Z"/>
                </svg>
            </button>
        </div>
    </div>

    <script>
        // Configuration - UPDATE THIS URL TO YOUR DEPLOYED API
        const API_URL = window.CHATBOT_API_URL || 'http://localhost:8000';

        const messagesContainer = document.getElementById('chatMessages');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');

        function addMessage(content, type = 'bot', sources = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;

            let html = content.replace(/\n/g, '<br>');

            // Add sources if available
            if (sources && sources.length > 0) {
                html += '<div class="sources"><strong>Nguồn tham khảo:</strong><br>';
                sources.forEach((s, i) => {
                    if (s.url) {
                        html += `${i + 1}. <a href="${s.url}" target="_blank">${s.title || 'Xem chi tiết'}</a><br>`;
                    } else if (s.title) {
                        html += `${i + 1}. ${s.title}<br>`;
                    }
                });
                html += '</div>';
            }

            messageDiv.innerHTML = html;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTyping() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = '<span></span><span></span><span></span>';
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTyping() {
            const typing = document.getElementById('typingIndicator');
            if (typing) typing.remove();
        }

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            // Add user message
            addMessage(message, 'user');
            userInput.value = '';
            sendBtn.disabled = true;

            // Show typing indicator
            showTyping();

            try {
                const response = await fetch(`${API_URL}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        include_sources: true
                    })
                });

                hideTyping();

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                addMessage(data.response, 'bot', data.sources);

            } catch (error) {
                hideTyping();
                console.error('Chat error:', error);
                addMessage(
                    'Xin lỗi, đã xảy ra lỗi khi xử lý yêu cầu. Vui lòng thử lại sau hoặc liên hệ trực tiếp UBND xã Diên Sanh.',
                    'error'
                );
            }

            sendBtn.disabled = false;
            userInput.focus();
        }

        function sendQuickMessage(message) {
            userInput.value = message;
            sendMessage();
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Focus input on load
        userInput.focus();
    </script>
</body>
</html>
</file>

<file path="src/widget/chatbot-embed.js">
/**
 * Diên Sanh Chatbot - Embeddable Widget
 *
 * Usage: Add this script to your website:
 * <script src="https://your-domain.com/widget/chatbot-embed.js" data-api="https://your-api.com"></script>
 *
 * Or configure manually:
 * <script>
 *   window.DIENSANH_CHATBOT_CONFIG = { apiUrl: 'https://your-api.com' };
 * </script>
 * <script src="chatbot-embed.js"></script>
 */

(function() {
    'use strict';

    // Configuration
    const config = window.DIENSANH_CHATBOT_CONFIG || {};
    const scriptTag = document.currentScript;
    const API_URL = config.apiUrl || scriptTag?.dataset?.api || 'http://localhost:8000';

    // Styles
    const styles = `
        #ds-chatbot-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 999999;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        #ds-chatbot-toggle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1a5f2a 0%, #2e7d32 100%);
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        #ds-chatbot-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 25px rgba(0,0,0,0.35);
        }

        #ds-chatbot-toggle svg {
            width: 28px;
            height: 28px;
            fill: white;
        }

        #ds-chatbot-container {
            position: absolute;
            bottom: 70px;
            right: 0;
            width: 380px;
            height: 520px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            display: none;
            flex-direction: column;
            overflow: hidden;
            animation: ds-slide-up 0.3s ease;
        }

        @keyframes ds-slide-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #ds-chatbot-container.open {
            display: flex;
        }

        .ds-header {
            background: linear-gradient(135deg, #1a5f2a 0%, #2e7d32 100%);
            color: white;
            padding: 14px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ds-header .avatar {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .ds-header .info h3 {
            font-size: 14px;
            font-weight: 600;
            margin: 0;
        }

        .ds-header .info p {
            font-size: 11px;
            margin: 2px 0 0;
            opacity: 0.9;
        }

        .ds-header .close {
            margin-left: auto;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 4px;
            opacity: 0.8;
        }

        .ds-header .close:hover {
            opacity: 1;
        }

        .ds-messages {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            background: #f5f7f9;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .ds-msg {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 14px;
            font-size: 13px;
            line-height: 1.5;
        }

        .ds-msg.bot {
            background: white;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }

        .ds-msg.user {
            background: #1a5f2a;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .ds-msg.error {
            background: #ffebee;
            color: #c62828;
        }

        .ds-typing {
            display: flex;
            gap: 4px;
            padding: 10px 14px;
            background: white;
            border-radius: 14px;
            align-self: flex-start;
        }

        .ds-typing span {
            width: 6px;
            height: 6px;
            background: #1a5f2a;
            border-radius: 50%;
            animation: ds-bounce 1.4s infinite ease-in-out;
        }

        .ds-typing span:nth-child(2) { animation-delay: 0.2s; }
        .ds-typing span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes ds-bounce {
            0%, 80%, 100% { transform: scale(0.6); }
            40% { transform: scale(1); }
        }

        .ds-input-area {
            padding: 12px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 8px;
        }

        .ds-input-area input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            font-size: 13px;
            outline: none;
        }

        .ds-input-area input:focus {
            border-color: #1a5f2a;
        }

        .ds-input-area button {
            width: 38px;
            height: 38px;
            background: #1a5f2a;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
        }

        .ds-input-area button:disabled {
            background: #ccc;
        }

        @media (max-width: 420px) {
            #ds-chatbot-container {
                width: calc(100vw - 40px);
                height: calc(100vh - 100px);
                bottom: 70px;
                right: 0;
            }
        }
    `;

    // HTML template
    const widgetHTML = `
        <button id="ds-chatbot-toggle" aria-label="Mở chatbot">
            <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
        </button>
        <div id="ds-chatbot-container">
            <div class="ds-header">
                <div class="avatar">🏛️</div>
                <div class="info">
                    <h3>Trợ lý ảo xã Diên Sanh</h3>
                    <p>Hỗ trợ thủ tục hành chính</p>
                </div>
                <button class="close" aria-label="Đóng">✕</button>
            </div>
            <div class="ds-messages" id="ds-messages">
                <div class="ds-msg bot">Xin chào! Tôi có thể giúp bạn tìm hiểu về thủ tục hành chính tại xã Diên Sanh. Bạn cần hỗ trợ gì?</div>
            </div>
            <div class="ds-input-area">
                <input type="text" id="ds-input" placeholder="Nhập câu hỏi..." />
                <button id="ds-send">➤</button>
            </div>
        </div>
    `;

    // Initialize widget
    function init() {
        // Add styles
        const styleEl = document.createElement('style');
        styleEl.textContent = styles;
        document.head.appendChild(styleEl);

        // Add widget HTML
        const widgetEl = document.createElement('div');
        widgetEl.id = 'ds-chatbot-widget';
        widgetEl.innerHTML = widgetHTML;
        document.body.appendChild(widgetEl);

        // Elements
        const toggle = document.getElementById('ds-chatbot-toggle');
        const container = document.getElementById('ds-chatbot-container');
        const closeBtn = container.querySelector('.close');
        const messages = document.getElementById('ds-messages');
        const input = document.getElementById('ds-input');
        const sendBtn = document.getElementById('ds-send');

        // Toggle chat
        toggle.addEventListener('click', () => {
            container.classList.toggle('open');
            if (container.classList.contains('open')) {
                input.focus();
            }
        });

        closeBtn.addEventListener('click', () => {
            container.classList.remove('open');
        });

        // Send message
        async function send() {
            const text = input.value.trim();
            if (!text) return;

            // Add user message
            addMsg(text, 'user');
            input.value = '';
            sendBtn.disabled = true;

            // Show typing
            const typing = document.createElement('div');
            typing.className = 'ds-typing';
            typing.innerHTML = '<span></span><span></span><span></span>';
            messages.appendChild(typing);
            messages.scrollTop = messages.scrollHeight;

            try {
                const res = await fetch(`${API_URL}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text, include_sources: false })
                });

                typing.remove();

                if (!res.ok) throw new Error('API error');

                const data = await res.json();
                addMsg(data.response, 'bot');
            } catch (e) {
                typing.remove();
                addMsg('Xin lỗi, đã xảy ra lỗi. Vui lòng thử lại.', 'error');
            }

            sendBtn.disabled = false;
        }

        function addMsg(text, type) {
            const msg = document.createElement('div');
            msg.className = `ds-msg ${type}`;
            msg.textContent = text;
            messages.appendChild(msg);
            messages.scrollTop = messages.scrollHeight;
        }

        sendBtn.addEventListener('click', send);
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') send();
        });
    }

    // Initialize when DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();
</file>

<file path="src/__init__.py">
# Diên Sanh Chatbot source package
</file>

<file path="src/config.py">
"""
Configuration module for Diên Sanh Chatbot.
Loads settings from environment variables.
"""

import os
from pydantic_settings import BaseSettings
from pydantic import Field


class Settings(BaseSettings):
    """Application settings loaded from environment."""

    # API configuration
    ai4u_api_key: str = Field(default="", env="AI4U_API_KEY")
    ai4u_base_url: str = Field(default="https://api.ai4u.now/v1", env="AI4U_BASE_URL")

    # Model settings
    chat_model: str = Field(default="gemini-2.5-flash", env="CHAT_MODEL")
    embedding_model: str = Field(default="all-MiniLM-L6-v2", env="EMBEDDING_MODEL")

    # Scraping targets
    main_site_url: str = "https://diensanh.quangtri.gov.vn"
    services_portal_url: str = "https://dichvucong.quangtri.gov.vn"

    # Data paths
    data_dir: str = Field(default="./data", env="DATA_DIR")
    chroma_db_path: str = Field(default="./data/chroma_db", env="CHROMA_DB_PATH")

    # Server settings
    api_host: str = Field(default="0.0.0.0", env="API_HOST")
    api_port: int = Field(default=8000, env="API_PORT")

    # CORS for widget embedding
    cors_origins: list[str] = Field(
        default=["*"],
        env="CORS_ORIGINS"
    )

    class Config:
        env_file = ".env"
        env_file_encoding = "utf-8"
        extra = "ignore"  # Ignore extra fields from .env


# Global settings instance
settings = Settings()
</file>

<file path="src/vector-store.py">
"""
Vector store module using simple TF-IDF + cosine similarity.
Lightweight alternative to ChromaDB for Python 3.14 compatibility.
Uses the LLM API for embeddings when needed.
"""

import json
import os
import pickle
from pathlib import Path
from typing import Optional

import numpy as np
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import cosine_similarity


class VectorStore:
    """Simple TF-IDF based vector store for document retrieval."""

    def __init__(
        self,
        persist_dir: str = "./data/vector_store",
    ):
        """
        Initialize vector store.

        Args:
            persist_dir: Directory to persist index data
        """
        self.persist_dir = Path(persist_dir)
        self.persist_dir.mkdir(parents=True, exist_ok=True)

        self.documents: list[dict] = []
        # Simple word tokenization for Vietnamese
        self.vectorizer = TfidfVectorizer(
            max_features=10000,
            ngram_range=(1, 2),
            min_df=1,
            max_df=0.99,  # Higher threshold for small corpus
            token_pattern=r'(?u)\b\w+\b',  # Simple word pattern
            lowercase=True,
            strip_accents=None  # Preserve Vietnamese diacritics
        )
        self.tfidf_matrix = None

        # Try to load existing index
        self._load()

    def _save(self) -> None:
        """Persist index to disk."""
        data = {
            "documents": self.documents,
            "vectorizer": self.vectorizer,
            "tfidf_matrix": self.tfidf_matrix
        }
        with open(self.persist_dir / "index.pkl", "wb") as f:
            pickle.dump(data, f)

    def _load(self) -> bool:
        """Load index from disk."""
        index_file = self.persist_dir / "index.pkl"
        if index_file.exists():
            try:
                with open(index_file, "rb") as f:
                    data = pickle.load(f)
                self.documents = data["documents"]
                self.vectorizer = data["vectorizer"]
                self.tfidf_matrix = data["tfidf_matrix"]
                print(f"Loaded {len(self.documents)} documents from index")
                return True
            except Exception as e:
                print(f"Error loading index: {e}")
        return False

    def add_documents(
        self,
        documents: list[dict],
        id_prefix: str = "doc"
    ) -> int:
        """
        Add documents to the vector store.

        Args:
            documents: List of dicts with 'content' and optional 'metadata'
            id_prefix: Prefix for document IDs

        Returns:
            Number of documents added
        """
        if not documents:
            return 0

        added = 0
        for i, doc in enumerate(documents):
            content = doc.get("content", "")
            if not content or len(content) < 20:
                continue

            self.documents.append({
                "id": f"{id_prefix}_{len(self.documents)}",
                "content": content,
                "metadata": {k: str(v)[:500] for k, v in doc.items() if k != "content" and v}
            })
            added += 1

        if added > 0:
            # Rebuild TF-IDF matrix
            texts = [d["content"] for d in self.documents]
            self.tfidf_matrix = self.vectorizer.fit_transform(texts)
            self._save()

        print(f"Added {added} documents. Total: {len(self.documents)}")
        return added

    def search(
        self,
        query: str,
        n_results: int = 5,
        min_score: float = 0.1
    ) -> list[dict]:
        """
        Search for relevant documents.

        Args:
            query: Search query in natural language
            n_results: Maximum number of results
            min_score: Minimum similarity score (0-1)

        Returns:
            List of matching documents with scores
        """
        if not self.documents or self.tfidf_matrix is None:
            return []

        # Transform query using fitted vectorizer
        query_vec = self.vectorizer.transform([query])

        # Compute cosine similarity
        similarities = cosine_similarity(query_vec, self.tfidf_matrix).flatten()

        # Get top results
        top_indices = similarities.argsort()[::-1][:n_results]

        results = []
        for idx in top_indices:
            score = float(similarities[idx])
            if score >= min_score:
                doc = self.documents[idx]
                results.append({
                    "content": doc["content"],
                    "metadata": doc["metadata"],
                    "score": round(score, 3)
                })

        return results

    def clear(self) -> None:
        """Clear all documents from the store."""
        self.documents = []
        self.tfidf_matrix = None
        self.vectorizer = TfidfVectorizer(
            max_features=10000,
            ngram_range=(1, 2),
            min_df=1,
            max_df=0.99,
            token_pattern=r'(?u)\b\w+\b',
            lowercase=True,
            strip_accents=None
        )
        # Remove persisted file
        index_file = self.persist_dir / "index.pkl"
        if index_file.exists():
            index_file.unlink()
        print("Store cleared.")

    def count(self) -> int:
        """Return number of documents."""
        return len(self.documents)


def load_scraped_data(data_dir: str = "./data") -> list[dict]:
    """Load scraped data from JSON files and prepare for indexing."""
    data_path = Path(data_dir)
    documents = []

    # Load main site pages
    mainsite_file = data_path / "diensanh_pages.json"
    if mainsite_file.exists():
        print(f"Loading {mainsite_file}...")
        with open(mainsite_file, "r", encoding="utf-8") as f:
            data = json.load(f)
            for page in data.get("pages", []):
                if page.get("content") and page.get("status") == "success":
                    documents.append({
                        "content": page["content"],
                        "title": page.get("title", ""),
                        "url": page.get("url", ""),
                        "source": "main_site",
                        "page_name": page.get("page_name", "")
                    })

    # Load public services procedures
    services_file = data_path / "dichvucong_procedures.json"
    if services_file.exists():
        print(f"Loading {services_file}...")
        with open(services_file, "r", encoding="utf-8") as f:
            data = json.load(f)
            for proc in data.get("procedures", []):
                # Build content from procedure data
                content_parts = []

                if proc.get("title"):
                    content_parts.append(f"Thủ tục: {proc['title']}")

                # Add fields from main procedure record
                if proc.get("implementing"):
                    content_parts.append(f"Cơ quan thực hiện: {proc['implementing']}")
                if proc.get("field"):
                    content_parts.append(f"Lĩnh vực: {proc['field']}")
                if proc.get("code"):
                    content_parts.append(f"Mã thủ tục: {proc['code']}")

                # Add detail fields if available
                detail = proc.get("detail", {})

                # Use full_content from detail page if available
                if detail.get("full_content"):
                    content_parts.append(detail["full_content"])

                if content_parts:
                    documents.append({
                        "content": "\n".join(content_parts),
                        "title": proc.get("title", ""),
                        "url": proc.get("url", ""),
                        "source": "dichvucong",
                        "procedure_type": "public_service"
                    })

    print(f"Loaded {len(documents)} documents total")
    return documents


def build_index(data_dir: str = "./data", persist_dir: str = "./data/vector_store") -> VectorStore:
    """
    Build vector index from scraped data.

    Args:
        data_dir: Directory containing scraped JSON files
        persist_dir: Directory for index persistence

    Returns:
        Initialized VectorStore
    """
    # Load documents
    documents = load_scraped_data(data_dir)

    if not documents:
        print("No documents found. Run scrapers first.")
        return None

    # Initialize store and add documents
    store = VectorStore(persist_dir=persist_dir)
    store.clear()  # Start fresh
    store.add_documents(documents)

    return store


if __name__ == "__main__":
    import sys

    if len(sys.argv) > 1 and sys.argv[1] == "search":
        # Search mode
        query = " ".join(sys.argv[2:]) if len(sys.argv) > 2 else "thủ tục đăng ký khai sinh"
        store = VectorStore()
        results = store.search(query)
        print(f"\nSearch results for: {query}\n")
        for r in results:
            print(f"[{r['score']}] {r['metadata'].get('title', 'No title')[:60]}")
            print(f"    {r['content'][:200]}...")
            print()
    else:
        # Build index mode
        build_index()
</file>

<file path="web/plans/reports/code-reviewer-260116-0919-ui-ux-polish-quick-wins.md">
# Code Review Report: UI/UX Polish & Quick Wins Implementation

**Date:** 2026-01-16 09:19
**Reviewer:** code-reviewer
**Scope:** UI/UX Polish & Quick Wins implementation changes

## Scope

### Files Reviewed
- `/Users/nad/My Drive (duc.a.nguyen@gmail.com)/diensanh/web/index.html` - Font preloads
- `/Users/nad/My Drive (duc.a.nguyen@gmail.com)/diensanh/web/src/styles/globals.css` - Design tokens, typography, colors, interactions
- `/Users/nad/My Drive (duc.a.nguyen@gmail.com)/diensanh/web/src/components/ui/spinner.tsx` - New loading component
- `/Users/nad/My Drive (duc.a.nguyen@gmail.com)/diensanh/web/src/components/auth/login-form.tsx` - Loading states
- `/Users/nad/My Drive (duc.a.nguyen@gmail.com)/diensanh/web/src/components/dashboard/stats-card.tsx` - Hover effects, skeleton
- `/Users/nad/My Drive (duc.a.nguyen@gmail.com)/diensanh/web/src/components/dashboard/quick-actions.tsx` - Hover interactions
- `/Users/nad/My Drive (duc.a.nguyen@gmail.com)/diensanh/web/src/components/layout/sidebar.tsx` - Focus states

### Lines of Code Analyzed
~500 lines across 7 files

### Review Focus
Recent UI/UX polish changes including typography, colors, micro-interactions, and UX improvements

## Overall Assessment

**Score: 8.5/10**

The implementation demonstrates solid UI/UX improvements with good attention to accessibility and performance. The code follows established patterns and maintains consistency with the existing codebase. Build passes successfully with proper TypeScript compilation.

## Critical Issues

**None identified** - No security vulnerabilities or breaking changes found.

## High Priority Findings

### 1. Font Loading Performance Risk
**File:** `/Users/nad/My Drive (duc.a.nguyen@gmail.com)/diensanh/web/index.html`
**Issue:** Font preload strategy could cause FOUT (Flash of Unstyled Text)
```html
<!-- Current implementation -->
<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap&subset=vietnamese">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap&subset=vietnamese">
```
**Impact:** Potential layout shift and poor loading experience
**Recommendation:** Consider using `font-display: swap` with fallback fonts

### 2. Missing Error Boundaries for Loading States
**File:** `/Users/nad/My Drive (duc.a.nguyen@gmail.com)/diensanh/web/src/components/ui/spinner.tsx`
**Issue:** No error handling if spinner fails to render
**Impact:** Could break UI if SVG fails to load
**Recommendation:** Add error boundary or fallback text

## Medium Priority Improvements

### 1. Color Contrast Validation Needed
**File:** `/Users/nad/My Drive (duc.a.nguyen@gmail.com)/diensanh/web/src/styles/globals.css`
**Issue:** Status colors claim WCAG AAA compliance but need verification
```css
/* Status colors - WCAG AAA compliant */
--color-success: #059669;           /* Green - 7:1 on white */
--color-warning: #d97706;           /* Amber - 7:1 on white */
```
**Recommendation:** Verify actual contrast ratios with tools like WebAIM

### 2. Accessibility Improvements Needed
**File:** `/Users/nad/My Drive (duc.a.nguyen@gmail.com)/diensanh/web/src/components/ui/spinner.tsx`
**Issue:** Missing accessibility attributes
```tsx
// Missing aria-label and role
<svg className={cn('animate-spin', sizeClasses[size], className)}>
```
**Recommendation:** Add `aria-label="Loading"` and `role="status"`

### 3. Performance Optimization Opportunity
**File:** `/Users/nad/My Drive (duc.a.nguyen@gmail.com)/diensanh/web/src/components/dashboard/stats-card.tsx`
**Issue:** Skeleton animation could be optimized
**Recommendation:** Use CSS-only animations instead of multiple animated elements

## Low Priority Suggestions

### 1. Code Organization
**File:** `/Users/nad/My Drive (duc.a.nguyen@gmail.com)/diensanh/web/src/styles/globals.css`
**Issue:** Large CSS file (164 lines) could be split
**Recommendation:** Consider splitting into theme tokens and component styles

### 2. Type Safety Enhancement
**File:** `/Users/nad/My Drive (duc.a.nguyen@gmail.com)/diensanh/web/src/components/ui/spinner.tsx`
**Issue:** Size prop could be more type-safe
```tsx
// Current
size?: 'sm' | 'md' | 'lg'
// Suggested
size?: keyof typeof sizeClasses
```

## Positive Observations

### Excellent Implementation Practices
1. **Consistent Design System**: Well-structured CSS custom properties with semantic naming
2. **Accessibility Focus**: Good use of focus-visible states and proper ARIA patterns
3. **Performance Conscious**: Proper font preloading and lazy loading CSS
4. **TypeScript Usage**: Strong typing throughout components
5. **Component Composition**: Clean, reusable Spinner component
6. **Loading UX**: Excellent loading state implementation with fixed button heights
7. **Vietnamese Localization**: Proper font selection and text rendering optimization

### Code Quality Highlights
- Clean separation of concerns in component files
- Consistent use of `cn()` utility for class merging
- Proper error handling in login form
- Good use of CSS custom properties for theming
- Responsive design considerations

## Recommended Actions

### Immediate (High Priority)
1. **Add accessibility attributes to Spinner component**
   ```tsx
   <svg
     className={cn('animate-spin', sizeClasses[size], className)}
     aria-label="Đang tải"
     role="status"
     xmlns="http://www.w3.org/2000/svg"
   >
   ```

2. **Verify color contrast ratios** using automated tools or manual testing

### Short Term (Medium Priority)
3. **Add font-display strategy** to prevent FOUT
4. **Consider error boundaries** for loading components
5. **Optimize skeleton animations** for better performance

### Long Term (Low Priority)
6. **Split globals.css** into smaller, focused files
7. **Enhance type safety** where beneficial
8. **Add unit tests** for new UI components

## Metrics

- **Type Coverage**: 100% (TypeScript compilation successful)
- **Build Status**: ✅ Successful (2.68s build time)
- **Linting Issues**: 0 critical, 0 high priority
- **Bundle Size**: 683KB main chunk (consider code splitting for >500KB warning)

## Security Assessment

- **No security vulnerabilities** identified
- **Proper input handling** in form components
- **No sensitive data exposure** in client-side code
- **Safe external font loading** from Google Fonts CDN

## Performance Analysis

- **Build Performance**: Good (2.68s)
- **Bundle Size Warning**: Main chunk >500KB suggests need for code splitting
- **Font Loading**: Optimized with preload strategy
- **Animation Performance**: CSS-based animations perform well

## YAGNI/KISS/DRY Compliance

✅ **YAGNI**: No over-engineering, features serve clear purposes
✅ **KISS**: Simple, readable implementations
✅ **DRY**: Good reuse of design tokens and utility functions

## Unresolved Questions

1. Should we implement font subsetting for better Vietnamese text performance?
2. Do we need RTL support for future internationalization?
3. Should skeleton loading states be configurable per component?
</file>

<file path="web/public/icons/icon-base.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
  <!-- Background circle -->
  <circle cx="256" cy="256" r="256" fill="#0d6efd"/>

  <!-- Inner circle -->
  <circle cx="256" cy="256" r="220" fill="#ffffff" fill-opacity="0.15"/>

  <!-- Star (Vietnamese government symbol) -->
  <polygon
    points="256,80 285,175 385,175 305,235 330,330 256,275 182,330 207,235 127,175 227,175"
    fill="#ffc107"
  />

  <!-- Text "DS" for Diên Sanh -->
  <text x="256" y="420" font-family="Arial, sans-serif" font-size="120" font-weight="bold" fill="#ffffff" text-anchor="middle">DS</text>
</svg>
</file>

<file path="web/public/manifest.json">
{
  "name": "UBND Xã Diên Sanh",
  "short_name": "Diên Sanh",
  "description": "Cổng thông tin điện tử UBND xã Diên Sanh, Hải Lăng, Quảng Trị",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#0d6efd",
  "orientation": "portrait-primary",
  "scope": "/",
  "lang": "vi",
  "icons": [
    {
      "src": "/icons/icon-72x72.png",
      "sizes": "72x72",
      "type": "image/png",
      "purpose": "maskable any"
    },
    {
      "src": "/icons/icon-96x96.png",
      "sizes": "96x96",
      "type": "image/png",
      "purpose": "maskable any"
    },
    {
      "src": "/icons/icon-128x128.png",
      "sizes": "128x128",
      "type": "image/png",
      "purpose": "maskable any"
    },
    {
      "src": "/icons/icon-144x144.png",
      "sizes": "144x144",
      "type": "image/png",
      "purpose": "maskable any"
    },
    {
      "src": "/icons/icon-152x152.png",
      "sizes": "152x152",
      "type": "image/png",
      "purpose": "maskable any"
    },
    {
      "src": "/icons/icon-192x192.png",
      "sizes": "192x192",
      "type": "image/png",
      "purpose": "maskable any"
    },
    {
      "src": "/icons/icon-384x384.png",
      "sizes": "384x384",
      "type": "image/png",
      "purpose": "maskable any"
    },
    {
      "src": "/icons/icon-512x512.png",
      "sizes": "512x512",
      "type": "image/png",
      "purpose": "maskable any"
    }
  ],
  "categories": ["government", "utilities"],
  "screenshots": [],
  "shortcuts": [
    {
      "name": "Thông báo",
      "short_name": "Thông báo",
      "description": "Xem thông báo mới nhất",
      "url": "/portal/announcements",
      "icons": [{ "src": "/icons/icon-96x96.png", "sizes": "96x96" }]
    },
    {
      "name": "Gửi yêu cầu",
      "short_name": "Yêu cầu",
      "description": "Gửi đơn, kiến nghị",
      "url": "/portal/requests/new",
      "icons": [{ "src": "/icons/icon-96x96.png", "sizes": "96x96" }]
    },
    {
      "name": "Hỏi đáp",
      "short_name": "Chatbot",
      "description": "Trợ lý ảo hỗ trợ 24/7",
      "url": "/portal/chatbot",
      "icons": [{ "src": "/icons/icon-96x96.png", "sizes": "96x96" }]
    }
  ]
}
</file>

<file path="web/public/offline.html">
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Không có kết nối - UBND Xã Diên Sanh</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #f0f9ff 0%, #ffffff 100%);
      padding: 20px;
    }
    .container {
      text-align: center;
      max-width: 400px;
    }
    .icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 24px;
      background: #fee2e2;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .icon svg {
      width: 40px;
      height: 40px;
      color: #dc2626;
    }
    h1 {
      font-size: 24px;
      color: #1f2937;
      margin-bottom: 12px;
    }
    p {
      color: #6b7280;
      line-height: 1.6;
      margin-bottom: 24px;
    }
    button {
      background: #0d6efd;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover {
      background: #0b5ed7;
    }
    .tips {
      margin-top: 32px;
      padding: 16px;
      background: #f9fafb;
      border-radius: 8px;
      text-align: left;
    }
    .tips h3 {
      font-size: 14px;
      color: #374151;
      margin-bottom: 8px;
    }
    .tips ul {
      font-size: 13px;
      color: #6b7280;
      padding-left: 20px;
    }
    .tips li {
      margin-bottom: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="icon">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636a9 9 0 010 12.728m0 0l-2.829-2.829m2.829 2.829L21 21M15.536 8.464a5 5 0 010 7.072m0 0l-2.829-2.829m-4.243 2.829a4.978 4.978 0 01-1.414-2.83m-1.414 5.658a9 9 0 01-2.167-9.238m7.824 2.167a1 1 0 111.414 1.414m-1.414-1.414L3 3m8.293 8.293l1.414 1.414" />
      </svg>
    </div>
    <h1>Không có kết nối mạng</h1>
    <p>Vui lòng kiểm tra kết nối internet của bạn và thử lại.</p>
    <button onclick="window.location.reload()">Thử lại</button>

    <div class="tips">
      <h3>Gợi ý:</h3>
      <ul>
        <li>Kiểm tra kết nối WiFi hoặc dữ liệu di động</li>
        <li>Thử tắt và bật lại chế độ máy bay</li>
        <li>Di chuyển đến nơi có sóng tốt hơn</li>
      </ul>
    </div>
  </div>
</body>
</html>
</file>

<file path="web/public/sw.js">
/// <reference lib="webworker" />

const CACHE_NAME = 'diensanh-v1'
const OFFLINE_URL = '/offline.html'

// Assets to cache immediately on install
const PRECACHE_ASSETS = [
  '/',
  '/index.html',
  '/offline.html',
  '/manifest.json',
]

// Install event - cache essential assets
self.addEventListener('install', (event: ExtendableEvent) => {
  event.waitUntil(
    caches.open(CACHE_NAME).then((cache) => {
      console.log('[SW] Precaching assets')
      return cache.addAll(PRECACHE_ASSETS)
    })
  )
  // Activate immediately
  ;(self as unknown as ServiceWorkerGlobalScope).skipWaiting()
})

// Activate event - clean up old caches
self.addEventListener('activate', (event: ExtendableEvent) => {
  event.waitUntil(
    caches.keys().then((cacheNames) => {
      return Promise.all(
        cacheNames
          .filter((name) => name !== CACHE_NAME)
          .map((name) => {
            console.log('[SW] Deleting old cache:', name)
            return caches.delete(name)
          })
      )
    })
  )
  // Take control of all pages immediately
  ;(self as unknown as ServiceWorkerGlobalScope).clients.claim()
})

// Fetch event - network first, fallback to cache
self.addEventListener('fetch', (event: FetchEvent) => {
  const { request } = event

  // Skip non-GET requests
  if (request.method !== 'GET') return

  // Skip cross-origin requests
  if (!request.url.startsWith(self.location.origin)) return

  // Skip Firebase/API requests
  if (request.url.includes('firebaseio.com') ||
      request.url.includes('googleapis.com') ||
      request.url.includes('firebase')) {
    return
  }

  event.respondWith(
    // Try network first
    fetch(request)
      .then((response) => {
        // Clone response for caching
        const responseClone = response.clone()

        // Cache successful responses
        if (response.status === 200) {
          caches.open(CACHE_NAME).then((cache) => {
            cache.put(request, responseClone)
          })
        }

        return response
      })
      .catch(async () => {
        // Network failed, try cache
        const cachedResponse = await caches.match(request)
        if (cachedResponse) {
          return cachedResponse
        }

        // For navigation requests, show offline page
        if (request.mode === 'navigate') {
          const offlineResponse = await caches.match(OFFLINE_URL)
          if (offlineResponse) {
            return offlineResponse
          }
        }

        // Return a basic offline response
        return new Response('Offline', {
          status: 503,
          statusText: 'Service Unavailable',
        })
      })
  )
})

// Handle messages from the app
self.addEventListener('message', (event: MessageEvent) => {
  if (event.data === 'skipWaiting') {
    ;(self as unknown as ServiceWorkerGlobalScope).skipWaiting()
  }
})

export {}
</file>

<file path="web/public/vite.svg">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="31.88" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 257"><defs><linearGradient id="IconifyId1813088fe1fbc01fb466" x1="-.828%" x2="57.636%" y1="7.652%" y2="78.411%"><stop offset="0%" stop-color="#41D1FF"></stop><stop offset="100%" stop-color="#BD34FE"></stop></linearGradient><linearGradient id="IconifyId1813088fe1fbc01fb467" x1="43.376%" x2="50.316%" y1="2.242%" y2="89.03%"><stop offset="0%" stop-color="#FFEA83"></stop><stop offset="8.333%" stop-color="#FFDD35"></stop><stop offset="100%" stop-color="#FFA800"></stop></linearGradient></defs><path fill="url(#IconifyId1813088fe1fbc01fb466)" d="M255.153 37.938L134.897 252.976c-2.483 4.44-8.862 4.466-11.382.048L.875 37.958c-2.746-4.814 1.371-10.646 6.827-9.67l120.385 21.517a6.537 6.537 0 0 0 2.322-.004l117.867-21.483c5.438-.991 9.574 4.796 6.877 9.62Z"></path><path fill="url(#IconifyId1813088fe1fbc01fb467)" d="M185.432.063L96.44 17.501a3.268 3.268 0 0 0-2.634 3.014l-5.474 92.456a3.268 3.268 0 0 0 3.997 3.378l24.777-5.718c2.318-.535 4.413 1.507 3.936 3.838l-7.361 36.047c-.495 2.426 1.782 4.5 4.151 3.78l15.304-4.649c2.372-.72 4.652 1.36 4.15 3.788l-11.698 56.621c-.732 3.542 3.979 5.473 5.943 2.437l1.313-2.028l72.516-144.72c1.215-2.423-.88-5.186-3.54-4.672l-25.505 4.922c-2.396.462-4.435-1.77-3.759-4.114l16.646-57.705c.677-2.35-1.37-4.583-3.769-4.113Z"></path></svg>
</file>

<file path="web/src/assets/react.svg">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="35.93" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 228"><path fill="#00D8FF" d="M210.483 73.824a171.49 171.49 0 0 0-8.24-2.597c.465-1.9.893-3.777 1.273-5.621c6.238-30.281 2.16-54.676-11.769-62.708c-13.355-7.7-35.196.329-57.254 19.526a171.23 171.23 0 0 0-6.375 5.848a155.866 155.866 0 0 0-4.241-3.917C100.759 3.829 77.587-4.822 63.673 3.233C50.33 10.957 46.379 33.89 51.995 62.588a170.974 170.974 0 0 0 1.892 8.48c-3.28.932-6.445 1.924-9.474 2.98C17.309 83.498 0 98.307 0 113.668c0 15.865 18.582 31.778 46.812 41.427a145.52 145.52 0 0 0 6.921 2.165a167.467 167.467 0 0 0-2.01 9.138c-5.354 28.2-1.173 50.591 12.134 58.266c13.744 7.926 36.812-.22 59.273-19.855a145.567 145.567 0 0 0 5.342-4.923a168.064 168.064 0 0 0 6.92 6.314c21.758 18.722 43.246 26.282 56.54 18.586c13.731-7.949 18.194-32.003 12.4-61.268a145.016 145.016 0 0 0-1.535-6.842c1.62-.48 3.21-.974 4.76-1.488c29.348-9.723 48.443-25.443 48.443-41.52c0-15.417-17.868-30.326-45.517-39.844Zm-6.365 70.984c-1.4.463-2.836.91-4.3 1.345c-3.24-10.257-7.612-21.163-12.963-32.432c5.106-11 9.31-21.767 12.459-31.957c2.619.758 5.16 1.557 7.61 2.4c23.69 8.156 38.14 20.213 38.14 29.504c0 9.896-15.606 22.743-40.946 31.14Zm-10.514 20.834c2.562 12.94 2.927 24.64 1.23 33.787c-1.524 8.219-4.59 13.698-8.382 15.893c-8.067 4.67-25.32-1.4-43.927-17.412a156.726 156.726 0 0 1-6.437-5.87c7.214-7.889 14.423-17.06 21.459-27.246c12.376-1.098 24.068-2.894 34.671-5.345a134.17 134.17 0 0 1 1.386 6.193ZM87.276 214.515c-7.882 2.783-14.16 2.863-17.955.675c-8.075-4.657-11.432-22.636-6.853-46.752a156.923 156.923 0 0 1 1.869-8.499c10.486 2.32 22.093 3.988 34.498 4.994c7.084 9.967 14.501 19.128 21.976 27.15a134.668 134.668 0 0 1-4.877 4.492c-9.933 8.682-19.886 14.842-28.658 17.94ZM50.35 144.747c-12.483-4.267-22.792-9.812-29.858-15.863c-6.35-5.437-9.555-10.836-9.555-15.216c0-9.322 13.897-21.212 37.076-29.293c2.813-.98 5.757-1.905 8.812-2.773c3.204 10.42 7.406 21.315 12.477 32.332c-5.137 11.18-9.399 22.249-12.634 32.792a134.718 134.718 0 0 1-6.318-1.979Zm12.378-84.26c-4.811-24.587-1.616-43.134 6.425-47.789c8.564-4.958 27.502 2.111 47.463 19.835a144.318 144.318 0 0 1 3.841 3.545c-7.438 7.987-14.787 17.08-21.808 26.988c-12.04 1.116-23.565 2.908-34.161 5.309a160.342 160.342 0 0 1-1.76-7.887Zm110.427 27.268a347.8 347.8 0 0 0-7.785-12.803c8.168 1.033 15.994 2.404 23.343 4.08c-2.206 7.072-4.956 14.465-8.193 22.045a381.151 381.151 0 0 0-7.365-13.322Zm-45.032-43.861c5.044 5.465 10.096 11.566 15.065 18.186a322.04 322.04 0 0 0-30.257-.006c4.974-6.559 10.069-12.652 15.192-18.18ZM82.802 87.83a323.167 323.167 0 0 0-7.227 13.238c-3.184-7.553-5.909-14.98-8.134-22.152c7.304-1.634 15.093-2.97 23.209-3.984a321.524 321.524 0 0 0-7.848 12.897Zm8.081 65.352c-8.385-.936-16.291-2.203-23.593-3.793c2.26-7.3 5.045-14.885 8.298-22.6a321.187 321.187 0 0 0 7.257 13.246c2.594 4.48 5.28 8.868 8.038 13.147Zm37.542 31.03c-5.184-5.592-10.354-11.779-15.403-18.433c4.902.192 9.899.29 14.978.29c5.218 0 10.376-.117 15.453-.343c-4.985 6.774-10.018 12.97-15.028 18.486Zm52.198-57.817c3.422 7.8 6.306 15.345 8.596 22.52c-7.422 1.694-15.436 3.058-23.88 4.071a382.417 382.417 0 0 0 7.859-13.026a347.403 347.403 0 0 0 7.425-13.565Zm-16.898 8.101a358.557 358.557 0 0 1-12.281 19.815a329.4 329.4 0 0 1-23.444.823c-7.967 0-15.716-.248-23.178-.732a310.202 310.202 0 0 1-12.513-19.846h.001a307.41 307.41 0 0 1-10.923-20.627a310.278 310.278 0 0 1 10.89-20.637l-.001.001a307.318 307.318 0 0 1 12.413-19.761c7.613-.576 15.42-.876 23.31-.876H128c7.926 0 15.743.303 23.354.883a329.357 329.357 0 0 1 12.335 19.695a358.489 358.489 0 0 1 11.036 20.54a329.472 329.472 0 0 1-11 20.722Zm22.56-122.124c8.572 4.944 11.906 24.881 6.52 51.026c-.344 1.668-.73 3.367-1.15 5.09c-10.622-2.452-22.155-4.275-34.23-5.408c-7.034-10.017-14.323-19.124-21.64-27.008a160.789 160.789 0 0 1 5.888-5.4c18.9-16.447 36.564-22.941 44.612-18.3ZM128 90.808c12.625 0 22.86 10.235 22.86 22.86s-10.235 22.86-22.86 22.86s-22.86-10.235-22.86-22.86s10.235-22.86 22.86-22.86Z"></path></svg>
</file>

<file path="web/src/components/auth/login-form.tsx">
import { useState, useRef, useEffect } from 'react'
import type { FormEvent } from 'react'
import type { ConfirmationResult } from 'firebase/auth'
import { setupRecaptcha } from '@/config/firebase'
import { cn } from '@/lib/utils'
import { Spinner } from '@/components/ui/spinner'
import { useSendOtpMutation, useVerifyOtpMutation } from '../../hooks/use-auth-mutations'

interface LoginFormProps {
  onSuccess?: () => void
}

export function LoginForm({ onSuccess }: LoginFormProps) {
  const [phone, setPhone] = useState('')
  const [otp, setOtp] = useState('')
  const [step, setStep] = useState<'phone' | 'otp'>('phone')
  const [confirmationResult, setConfirmationResult] = useState<ConfirmationResult | null>(null)
  const recaptchaRef = useRef<HTMLDivElement>(null)

  const sendOtpMutation = useSendOtpMutation()
  const verifyOtpMutation = useVerifyOtpMutation()

  const loading = sendOtpMutation.isPending || verifyOtpMutation.isPending
  const error = sendOtpMutation.error?.message || verifyOtpMutation.error?.message

  useEffect(() => {
    // Setup reCAPTCHA on mount
    if (recaptchaRef.current) {
      setupRecaptcha('recaptcha-container')
    }
  }, [])

  const handleSendOTP = async (e: FormEvent) => {
    e.preventDefault()

    try {
      const verifier = setupRecaptcha('recaptcha-container')
      const result = await sendOtpMutation.mutateAsync({ phone, verifier })
      setConfirmationResult(result)
      setStep('otp')
    } catch (err) {
      console.error('Error sending OTP:', err)
      // Error is handled by mutation state
    }
  }

  const handleVerifyOTP = async (e: FormEvent) => {
    e.preventDefault()
    if (!confirmationResult) return

    try {
      await verifyOtpMutation.mutateAsync({
        otp,
        confirmationResult,
        phone
      })
      onSuccess?.()
    } catch (err) {
      console.error('Error verifying OTP:', err)
      // Error is handled by mutation state
    }
  }

  const handleResendOTP = () => {
    setStep('phone')
    setOtp('')
    setConfirmationResult(null)
    sendOtpMutation.reset()
    verifyOtpMutation.reset()
  }

  return (
    <div className="w-full max-w-md mx-auto">
      <div className="bg-card rounded-xl shadow-lg p-8">
        <div className="text-center mb-8">
          <h1 className="text-2xl font-bold text-foreground">
            UBND xã Diên Sanh
          </h1>
          <p className="text-muted-foreground mt-2">
            Hệ thống quản lý xã
          </p>
        </div>

        {error && (
          <div className="bg-destructive/10 text-destructive px-4 py-3 rounded-lg mb-6">
            {error}
          </div>
        )}

        {step === 'phone' ? (
          <form onSubmit={handleSendOTP} className="space-y-6">
            <div>
              <label htmlFor="phone" className="block text-sm font-medium mb-2">
                Số điện thoại
              </label>
              <input
                id="phone"
                type="tel"
                value={phone}
                onChange={(e) => setPhone(e.target.value)}
                placeholder="0912 345 678"
                className={cn(
                  "w-full px-4 py-3 rounded-lg border bg-background",
                  "focus:outline-none focus:ring-2 focus:ring-primary-500",
                  "placeholder:text-muted-foreground",
                  "min-h-[48px]"
                )}
                required
                disabled={loading}
              />
            </div>

            <button
              type="submit"
              disabled={loading || !phone}
              className={cn(
                "w-full py-3 px-4 rounded-lg font-medium relative",
                "bg-primary-600 text-white",
                "hover:bg-primary-700 transition-colors",
                "disabled:opacity-50 disabled:cursor-not-allowed",
                "min-h-[48px]"
              )}
            >
              <span className={loading ? 'opacity-0' : ''}>Nhận mã OTP</span>
              {loading && (
                <span className="absolute inset-0 flex items-center justify-center">
                  <Spinner size="sm" />
                </span>
              )}
            </button>
          </form>
        ) : (
          <form onSubmit={handleVerifyOTP} className="space-y-6">
            <div>
              <label htmlFor="otp" className="block text-sm font-medium mb-2">
                Mã xác thực OTP
              </label>
              <input
                id="otp"
                type="text"
                value={otp}
                onChange={(e) => setOtp(e.target.value)}
                placeholder="123456"
                maxLength={6}
                className={cn(
                  "w-full px-4 py-3 rounded-lg border bg-background text-center text-2xl tracking-widest",
                  "focus:outline-none focus:ring-2 focus:ring-primary-500",
                  "min-h-[48px]"
                )}
                required
                disabled={loading}
                autoFocus
              />
              <p className="text-sm text-muted-foreground mt-2">
                Mã OTP đã được gửi đến {phone}
              </p>
            </div>

            <button
              type="submit"
              disabled={loading || otp.length !== 6}
              className={cn(
                "w-full py-3 px-4 rounded-lg font-medium relative",
                "bg-primary-600 text-white",
                "hover:bg-primary-700 transition-colors",
                "disabled:opacity-50 disabled:cursor-not-allowed",
                "min-h-[48px]"
              )}
            >
              <span className={loading ? 'opacity-0' : ''}>Xác nhận</span>
              {loading && (
                <span className="absolute inset-0 flex items-center justify-center">
                  <Spinner size="sm" />
                </span>
              )}
            </button>

            <button
              type="button"
              onClick={handleResendOTP}
              className={cn(
                "w-full text-sm text-primary-600 hover:underline",
                "min-h-[48px] flex items-center justify-center"
              )}
            >
              Gửi lại mã OTP
            </button>
          </form>
        )}

        <div id="recaptcha-container" ref={recaptchaRef} />
      </div>
    </div>
  )
}
</file>

<file path="web/src/components/dashboard/activity-feed.tsx">
import { Clock, FileText, MessageSquare, ClipboardList, User } from 'lucide-react'
import { formatDateTime } from '@/lib/utils'

interface ActivityItem {
  id: string
  type: 'task' | 'request' | 'message' | 'user'
  title: string
  description: string
  timestamp: Date
}

// Mock data - will be replaced with real data from Firestore
const mockActivities: ActivityItem[] = [
  {
    id: '1',
    type: 'request',
    title: 'Yêu cầu mới',
    description: 'Nguyễn Văn A gửi yêu cầu xác nhận hộ khẩu',
    timestamp: new Date(Date.now() - 1000 * 60 * 30), // 30 mins ago
  },
  {
    id: '2',
    type: 'task',
    title: 'Công việc hoàn thành',
    description: 'Thôn Định Thọ hoàn thành khảo sát dân số',
    timestamp: new Date(Date.now() - 1000 * 60 * 60 * 2), // 2 hours ago
  },
  {
    id: '3',
    type: 'message',
    title: 'SMS đã gửi',
    description: 'Gửi thông báo họp đến 150 hộ dân',
    timestamp: new Date(Date.now() - 1000 * 60 * 60 * 5), // 5 hours ago
  },
  {
    id: '4',
    type: 'user',
    title: 'Trưởng thôn mới',
    description: 'Trần Văn B được bổ nhiệm trưởng thôn Định Hòa',
    timestamp: new Date(Date.now() - 1000 * 60 * 60 * 24), // 1 day ago
  },
]

const iconMap = {
  task: ClipboardList,
  request: FileText,
  message: MessageSquare,
  user: User,
}

const colorMap = {
  task: 'bg-blue-100 text-blue-600',
  request: 'bg-amber-100 text-amber-600',
  message: 'bg-green-100 text-green-600',
  user: 'bg-purple-100 text-purple-600',
}

export function ActivityFeed() {
  // TODO: Replace with real data from useQuery
  const activities = mockActivities

  return (
    <div className="bg-card rounded-xl border shadow-sm">
      <div className="p-4 border-b">
        <h2 className="font-semibold">Hoạt động gần đây</h2>
      </div>
      <div className="divide-y max-h-[400px] overflow-y-auto">
        {activities.length === 0 ? (
          <div className="p-8 text-center text-muted-foreground">
            Chưa có hoạt động nào
          </div>
        ) : (
          activities.map((activity) => {
            const Icon = iconMap[activity.type]
            return (
              <div key={activity.id} className="p-4 hover:bg-muted/50 transition-colors">
                <div className="flex gap-3">
                  <div className={`p-2 rounded-lg ${colorMap[activity.type]}`}>
                    <Icon className="w-4 h-4" />
                  </div>
                  <div className="flex-1 min-w-0">
                    <div className="font-medium text-sm">{activity.title}</div>
                    <div className="text-sm text-muted-foreground truncate">
                      {activity.description}
                    </div>
                    <div className="flex items-center gap-1 mt-1 text-xs text-muted-foreground">
                      <Clock className="w-3 h-3" />
                      {formatDateTime(activity.timestamp)}
                    </div>
                  </div>
                </div>
              </div>
            )
          })
        )}
      </div>
    </div>
  )
}
</file>

<file path="web/src/components/dashboard/pending-tasks.tsx">
import { Link } from 'react-router-dom'
import { Clock, AlertCircle, ChevronRight } from 'lucide-react'
import { cn } from '@/lib/utils'
import { formatDate } from '@/lib/utils'

interface PendingTask {
  id: string
  title: string
  priority: 'low' | 'medium' | 'high'
  dueDate: Date
  assignedVillages: number
}

// Mock data - will be replaced with real data from Firestore
const mockTasks: PendingTask[] = [
  {
    id: '1',
    title: 'Khảo sát dân số quý 1/2026',
    priority: 'high',
    dueDate: new Date(Date.now() + 1000 * 60 * 60 * 24 * 3), // 3 days
    assignedVillages: 20,
  },
  {
    id: '2',
    title: 'Cập nhật thông tin hộ nghèo',
    priority: 'medium',
    dueDate: new Date(Date.now() + 1000 * 60 * 60 * 24 * 7), // 7 days
    assignedVillages: 20,
  },
  {
    id: '3',
    title: 'Báo cáo tình hình an ninh tháng 1',
    priority: 'low',
    dueDate: new Date(Date.now() + 1000 * 60 * 60 * 24 * 14), // 14 days
    assignedVillages: 5,
  },
]

const priorityConfig = {
  high: { label: 'Cao', color: 'bg-red-100 text-red-700' },
  medium: { label: 'Trung bình', color: 'bg-amber-100 text-amber-700' },
  low: { label: 'Thấp', color: 'bg-green-100 text-green-700' },
}

export function PendingTasks() {
  // TODO: Replace with real data from useQuery
  const tasks = mockTasks

  return (
    <div className="bg-card rounded-xl border shadow-sm">
      <div className="p-4 border-b flex items-center justify-between">
        <h2 className="font-semibold">Công việc cần làm</h2>
        <Link
          to="/admin/tasks"
          className="text-sm text-primary-600 hover:underline flex items-center gap-1"
        >
          Xem tất cả
          <ChevronRight className="w-4 h-4" />
        </Link>
      </div>
      <div className="divide-y max-h-[400px] overflow-y-auto">
        {tasks.length === 0 ? (
          <div className="p-8 text-center text-muted-foreground">
            Không có công việc nào
          </div>
        ) : (
          tasks.map((task) => {
            const priority = priorityConfig[task.priority]
            const isOverdue = task.dueDate < new Date()
            const isDueSoon = !isOverdue && task.dueDate < new Date(Date.now() + 1000 * 60 * 60 * 24 * 3)

            return (
              <Link
                key={task.id}
                to={`/admin/tasks/${task.id}`}
                className="block p-4 hover:bg-muted/50 transition-colors"
              >
                <div className="flex items-start justify-between gap-3">
                  <div className="flex-1 min-w-0">
                    <div className="font-medium text-sm">{task.title}</div>
                    <div className="flex items-center gap-2 mt-2 flex-wrap">
                      <span className={cn('text-xs px-2 py-0.5 rounded-full', priority.color)}>
                        {priority.label}
                      </span>
                      <span className="text-xs text-muted-foreground">
                        {task.assignedVillages} thôn
                      </span>
                    </div>
                  </div>
                  <div className={cn(
                    'flex items-center gap-1 text-xs whitespace-nowrap',
                    isOverdue ? 'text-red-600' : isDueSoon ? 'text-amber-600' : 'text-muted-foreground'
                  )}>
                    {isOverdue ? (
                      <AlertCircle className="w-3 h-3" />
                    ) : (
                      <Clock className="w-3 h-3" />
                    )}
                    {formatDate(task.dueDate)}
                  </div>
                </div>
              </Link>
            )
          })
        )}
      </div>
    </div>
  )
}
</file>

<file path="web/src/components/dashboard/quick-actions.tsx">
import { Link } from 'react-router-dom'
import { Plus, MessageSquare, ClipboardList, Megaphone, FileText, Users } from 'lucide-react'
import { useAuth } from '@/hooks/use-auth'
import { cn } from '@/lib/utils'

interface QuickAction {
  icon: typeof Plus
  label: string
  description: string
  path: string
  color: string
}

const adminActions: QuickAction[] = [
  {
    icon: Users,
    label: 'Thêm hộ dân',
    description: 'Đăng ký hộ gia đình mới',
    path: '/admin/households/new',
    color: 'bg-blue-500',
  },
  {
    icon: MessageSquare,
    label: 'Gửi SMS',
    description: 'Gửi tin nhắn hàng loạt',
    path: '/admin/messages/new',
    color: 'bg-green-500',
  },
  {
    icon: ClipboardList,
    label: 'Tạo công việc',
    description: 'Giao việc cho trưởng thôn',
    path: '/admin/tasks/new',
    color: 'bg-amber-500',
  },
  {
    icon: Megaphone,
    label: 'Đăng thông báo',
    description: 'Thông báo đến người dân',
    path: '/admin/announcements/new',
    color: 'bg-purple-500',
  },
]

const villageActions: QuickAction[] = [
  {
    icon: Users,
    label: 'Thêm hộ dân',
    description: 'Đăng ký hộ gia đình mới',
    path: '/village/households/new',
    color: 'bg-blue-500',
  },
  {
    icon: FileText,
    label: 'Gửi yêu cầu',
    description: 'Gửi yêu cầu lên xã',
    path: '/village/requests/new',
    color: 'bg-green-500',
  },
  {
    icon: ClipboardList,
    label: 'Xem công việc',
    description: 'Công việc được giao',
    path: '/village/tasks',
    color: 'bg-amber-500',
  },
]

export function QuickActions() {
  const { userDoc } = useAuth()
  const actions = userDoc?.role === 'commune_admin' ? adminActions : villageActions

  return (
    <div className="bg-card rounded-xl border shadow-sm">
      <div className="p-4 border-b">
        <h2 className="font-semibold">Thao tác nhanh</h2>
      </div>
      <div className="p-4">
        <div className="grid grid-cols-2 lg:grid-cols-4 gap-3">
          {actions.map((action) => {
            const Icon = action.icon
            return (
              <Link
                key={action.path}
                to={action.path}
                className="group flex flex-col items-center p-4 rounded-lg border border-transparent
                  ring-2 ring-transparent
                  hover:ring-primary-200 hover:border-primary-300 hover:bg-primary-50/50
                  focus-visible:ring-primary-500 focus-visible:ring-offset-2
                  transition-all duration-200 cursor-pointer"
              >
                <div className={cn('p-3 rounded-full text-white mb-2', action.color)}>
                  <Icon className="w-5 h-5" />
                </div>
                <div className="text-sm font-medium text-center">{action.label}</div>
                <div className="text-xs text-muted-foreground text-center mt-1 hidden sm:block">
                  {action.description}
                </div>
              </Link>
            )
          })}
        </div>
      </div>
    </div>
  )
}
</file>

<file path="web/src/components/dashboard/stats-card.tsx">
import type { ReactNode } from 'react'
import { cn } from '@/lib/utils'

interface StatsCardProps {
  title: string
  value: number
  icon: ReactNode
  trend?: { value: number; isPositive: boolean }
  loading?: boolean
  className?: string
}

function StatsCardSkeleton() {
  return (
    <div className="bg-card rounded-xl border p-5 shadow-sm">
      <div className="flex items-center justify-between">
        <div className="h-4 w-20 bg-muted rounded animate-pulse" />
        <div className="w-10 h-10 bg-primary-50 rounded-lg animate-pulse" />
      </div>
      <div className="mt-3 space-y-2">
        <div className="h-8 w-16 bg-muted rounded animate-pulse" />
        <div className="h-4 w-28 bg-muted rounded animate-pulse" />
      </div>
    </div>
  )
}

export function StatsCard({ title, value, icon, trend, loading, className }: StatsCardProps) {
  if (loading) return <StatsCardSkeleton />

  return (
    <div className={cn(
      'bg-card rounded-xl border p-5 shadow-sm',
      'transition-all duration-200',
      'hover:shadow-md hover:border-primary-200',
      className
    )}>
      <div className="flex items-center justify-between">
        <div className="text-sm font-medium text-muted-foreground">{title}</div>
        <div className="p-2.5 bg-primary-50 text-primary-600 rounded-lg">{icon}</div>
      </div>
      <div className="mt-3">
        <div className="text-2xl font-bold">{value.toLocaleString('vi-VN')}</div>
        {trend && (
          <div
            className={cn(
              'text-sm mt-1',
              trend.isPositive ? 'text-green-600' : 'text-red-600'
            )}
          >
            {trend.isPositive ? '+' : ''}
            {trend.value}% so với tháng trước
          </div>
        )}
      </div>
    </div>
  )
}
</file>

<file path="web/src/components/dashboard/stats-grid.tsx">
import type { ReactNode } from 'react'

interface StatsGridProps {
  children: ReactNode
}

export function StatsGrid({ children }: StatsGridProps) {
  return (
    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      {children}
    </div>
  )
}
</file>

<file path="web/src/components/layout/admin-layout.tsx">
import { useState } from 'react'
import type { ReactNode } from 'react'
import { Sidebar } from './sidebar'
import { TopNavbar } from './top-navbar'
import { MobileNav } from './mobile-nav'
import { OfflineBanner } from './offline-banner'
import { useNetworkStatus } from '@/hooks/use-network-status'
import { cn } from '@/lib/utils'

interface AdminLayoutProps {
  children: ReactNode
}

export function AdminLayout({ children }: AdminLayoutProps) {
  const [sidebarOpen, setSidebarOpen] = useState(true)
  const [mobileSidebarOpen, setMobileSidebarOpen] = useState(false)
  const isOnline = useNetworkStatus()

  return (
    <div className="min-h-screen bg-muted">
      {/* Offline Banner */}
      {!isOnline && <OfflineBanner />}

      {/* Desktop Sidebar */}
      <Sidebar
        open={sidebarOpen}
        onToggle={() => setSidebarOpen(!sidebarOpen)}
        mobileOpen={mobileSidebarOpen}
        onMobileClose={() => setMobileSidebarOpen(false)}
      />

      {/* Main Content */}
      <div
        className={cn(
          'transition-all duration-300',
          sidebarOpen ? 'lg:ml-64' : 'lg:ml-16'
        )}
      >
        <TopNavbar
          onMenuClick={() => setMobileSidebarOpen(true)}
          onSidebarToggle={() => setSidebarOpen(!sidebarOpen)}
          sidebarOpen={sidebarOpen}
        />
        <main className="p-4 lg:p-6 pb-20 lg:pb-6">{children}</main>
      </div>

      {/* Mobile Bottom Navigation */}
      <MobileNav />
    </div>
  )
}
</file>

<file path="web/src/components/layout/mobile-nav.tsx">
import { NavLink, useLocation } from 'react-router-dom'
import { LayoutDashboard, Building2, Users, ClipboardList, Menu } from 'lucide-react'
import { useAuth } from '@/hooks/use-auth'
import { cn } from '@/lib/utils'

// Mobile navigation items (simplified for bottom nav)
const adminMobileMenu = [
  { icon: LayoutDashboard, label: 'Tổng quan', path: '/admin' },
  { icon: Building2, label: 'Thôn', path: '/admin/villages' },
  { icon: Users, label: 'Hộ dân', path: '/admin/households' },
  { icon: ClipboardList, label: 'Việc', path: '/admin/tasks' },
  { icon: Menu, label: 'Thêm', path: '/admin/more' },
]

const villageMobileMenu = [
  { icon: LayoutDashboard, label: 'Tổng quan', path: '/village' },
  { icon: Users, label: 'Hộ dân', path: '/village/households' },
  { icon: ClipboardList, label: 'Việc', path: '/village/tasks' },
  { icon: Menu, label: 'Thêm', path: '/village/more' },
]

export function MobileNav() {
  const { userDoc } = useAuth()
  const location = useLocation()
  const menu = userDoc?.role === 'commune_admin' ? adminMobileMenu : villageMobileMenu

  return (
    <nav className="fixed bottom-0 left-0 right-0 z-40 bg-card border-t lg:hidden">
      <div className="flex items-center justify-around h-16">
        {menu.map((item) => {
          const Icon = item.icon
          const isActive = location.pathname === item.path ||
            (item.path !== '/admin' && item.path !== '/village' && location.pathname.startsWith(item.path))

          return (
            <NavLink
              key={item.path}
              to={item.path}
              className={cn(
                'flex flex-col items-center justify-center gap-1 px-3 py-2 min-w-[64px]',
                'transition-colors',
                isActive ? 'text-primary-600' : 'text-muted-foreground'
              )}
            >
              <Icon className="w-5 h-5" />
              <span className="text-xs">{item.label}</span>
            </NavLink>
          )
        })}
      </div>
    </nav>
  )
}
</file>

<file path="web/src/components/layout/offline-banner.tsx">
import { WifiOff } from 'lucide-react'

export function OfflineBanner() {
  return (
    <div className="fixed top-0 left-0 right-0 z-50 bg-amber-500 text-amber-950 px-4 py-2">
      <div className="flex items-center justify-center gap-2 text-sm font-medium">
        <WifiOff className="w-4 h-4" />
        <span>Bạn đang offline. Dữ liệu sẽ được đồng bộ khi có kết nối.</span>
      </div>
    </div>
  )
}
</file>

<file path="web/src/components/layout/sidebar.tsx">
import { NavLink, useLocation } from 'react-router-dom'
import {
  LayoutDashboard,
  Building2,
  Users,
  MessageSquare,
  ClipboardList,
  FileText,
  Megaphone,
  BarChart3,
  Settings,
  ChevronLeft,
  X,
} from 'lucide-react'
import { useAuth } from '@/hooks/use-auth'
import { cn } from '@/lib/utils'

interface SidebarProps {
  open: boolean
  onToggle: () => void
  mobileOpen: boolean
  onMobileClose: () => void
}

// Admin menu items
const adminMenu = [
  { icon: LayoutDashboard, label: 'Tổng quan', path: '/admin' },
  { icon: Building2, label: 'Quản lý thôn', path: '/admin/villages' },
  { icon: Users, label: 'Hộ gia đình', path: '/admin/households' },
  { icon: MessageSquare, label: 'Tin nhắn SMS', path: '/admin/messages' },
  { icon: ClipboardList, label: 'Công việc', path: '/admin/tasks' },
  { icon: FileText, label: 'Yêu cầu', path: '/admin/requests' },
  { icon: Megaphone, label: 'Thông báo', path: '/admin/announcements' },
  { icon: BarChart3, label: 'Báo cáo', path: '/admin/reports' },
  { icon: Settings, label: 'Cài đặt', path: '/admin/settings' },
]

// Village leader menu items
const villageMenu = [
  { icon: LayoutDashboard, label: 'Tổng quan', path: '/village' },
  { icon: Users, label: 'Hộ gia đình', path: '/village/households' },
  { icon: ClipboardList, label: 'Công việc', path: '/village/tasks' },
  { icon: FileText, label: 'Yêu cầu', path: '/village/requests' },
  { icon: Megaphone, label: 'Thông báo', path: '/village/announcements' },
]

export function Sidebar({ open, onToggle, mobileOpen, onMobileClose }: SidebarProps) {
  const { userDoc } = useAuth()
  const location = useLocation()
  const menu = userDoc?.role === 'commune_admin' ? adminMenu : villageMenu

  return (
    <>
      {/* Mobile overlay */}
      {mobileOpen && (
        <div
          className="fixed inset-0 z-40 bg-black/50 lg:hidden"
          onClick={onMobileClose}
        />
      )}

      {/* Sidebar */}
      <aside
        className={cn(
          'fixed left-0 top-0 z-50 h-screen bg-card border-r transition-all duration-300',
          // Desktop
          'hidden lg:block',
          open ? 'lg:w-64' : 'lg:w-16',
          // Mobile
          mobileOpen && 'block w-64'
        )}
      >
        {/* Header */}
        <div className="flex items-center justify-between h-16 px-4 border-b">
          <div className="flex items-center gap-2 overflow-hidden">
            <div className="w-8 h-8 bg-primary-600 rounded-lg flex items-center justify-center flex-shrink-0">
              <span className="text-white font-bold text-sm">DS</span>
            </div>
            {(open || mobileOpen) && (
              <span className="font-semibold text-sm whitespace-nowrap">
                UBND Xã Diên Sanh
              </span>
            )}
          </div>

          {/* Mobile close button */}
          <button
            onClick={onMobileClose}
            className="lg:hidden p-1 hover:bg-muted rounded"
          >
            <X className="w-5 h-5" />
          </button>

          {/* Desktop collapse button */}
          <button
            onClick={onToggle}
            className={cn(
              'hidden lg:flex p-1 hover:bg-muted rounded transition-transform',
              !open && 'rotate-180'
            )}
          >
            <ChevronLeft className="w-5 h-5" />
          </button>
        </div>

        {/* Navigation */}
        <nav className="p-2 space-y-1 overflow-y-auto h-[calc(100vh-4rem)]">
          {menu.map((item) => {
            const Icon = item.icon
            const isActive = location.pathname === item.path ||
              (item.path !== '/admin' && item.path !== '/village' && location.pathname.startsWith(item.path))

            return (
              <NavLink
                key={item.path}
                to={item.path}
                onClick={onMobileClose}
                className={cn(
                  'flex items-center gap-3 px-3 py-2.5 rounded-lg transition-colors',
                  'hover:bg-muted',
                  'focus-visible:ring-2 focus-visible:ring-primary-500 focus-visible:ring-offset-2',
                  isActive && 'bg-primary-50 text-primary-700 font-medium',
                  !open && !mobileOpen && 'justify-center'
                )}
                title={!open && !mobileOpen ? item.label : undefined}
              >
                <Icon className={cn('w-5 h-5 flex-shrink-0', isActive && 'text-primary-600')} />
                {(open || mobileOpen) && (
                  <span className="truncate">{item.label}</span>
                )}
              </NavLink>
            )
          })}
        </nav>
      </aside>
    </>
  )
}
</file>

<file path="web/src/components/layout/top-navbar.tsx">
import { Menu, Bell, User, LogOut, ChevronRight } from 'lucide-react'
import { useAuth } from '@/hooks/use-auth'
import { cn } from '@/lib/utils'
import { useState, useRef, useEffect } from 'react'

interface TopNavbarProps {
  onMenuClick: () => void
  onSidebarToggle: () => void
  sidebarOpen: boolean
}

export function TopNavbar({ onMenuClick, onSidebarToggle, sidebarOpen }: TopNavbarProps) {
  const { userDoc, logout } = useAuth()
  const [dropdownOpen, setDropdownOpen] = useState(false)
  const dropdownRef = useRef<HTMLDivElement>(null)

  // Close dropdown when clicking outside
  useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {
        setDropdownOpen(false)
      }
    }
    document.addEventListener('mousedown', handleClickOutside)
    return () => document.removeEventListener('mousedown', handleClickOutside)
  }, [])

  const getRoleLabel = (role: string | undefined) => {
    switch (role) {
      case 'commune_admin':
        return 'Quản trị viên xã'
      case 'village_leader':
        return 'Trưởng thôn'
      default:
        return 'Cư dân'
    }
  }

  return (
    <header className="sticky top-0 z-30 h-16 bg-card border-b flex items-center justify-between px-4">
      {/* Left side */}
      <div className="flex items-center gap-2">
        {/* Mobile menu button */}
        <button
          onClick={onMenuClick}
          className="lg:hidden p-2 hover:bg-muted rounded-lg"
          aria-label="Mở menu"
        >
          <Menu className="w-5 h-5" />
        </button>

        {/* Desktop sidebar toggle */}
        <button
          onClick={onSidebarToggle}
          className={cn(
            'hidden lg:flex p-2 hover:bg-muted rounded-lg transition-transform',
            !sidebarOpen && 'rotate-180'
          )}
          aria-label={sidebarOpen ? 'Thu gọn sidebar' : 'Mở rộng sidebar'}
        >
          <ChevronRight className="w-5 h-5" />
        </button>
      </div>

      {/* Right side */}
      <div className="flex items-center gap-2">
        {/* Notifications */}
        <button
          className="p-2 hover:bg-muted rounded-lg relative"
          aria-label="Thông báo"
        >
          <Bell className="w-5 h-5" />
          <span className="absolute top-1 right-1 w-2 h-2 bg-destructive rounded-full" />
        </button>

        {/* User dropdown */}
        <div className="relative" ref={dropdownRef}>
          <button
            onClick={() => setDropdownOpen(!dropdownOpen)}
            className="flex items-center gap-2 p-2 hover:bg-muted rounded-lg"
          >
            <div className="w-8 h-8 bg-primary-100 rounded-full flex items-center justify-center">
              <User className="w-4 h-4 text-primary-600" />
            </div>
            <div className="hidden sm:block text-left">
              <div className="text-sm font-medium truncate max-w-[120px]">
                {userDoc?.displayName || 'Người dùng'}
              </div>
              <div className="text-xs text-muted-foreground">
                {getRoleLabel(userDoc?.role)}
              </div>
            </div>
          </button>

          {/* Dropdown menu */}
          {dropdownOpen && (
            <div className="absolute right-0 top-full mt-1 w-48 bg-card border rounded-lg shadow-lg py-1 z-50">
              <div className="px-3 py-2 border-b sm:hidden">
                <div className="text-sm font-medium">
                  {userDoc?.displayName || 'Người dùng'}
                </div>
                <div className="text-xs text-muted-foreground">
                  {getRoleLabel(userDoc?.role)}
                </div>
              </div>
              <button
                onClick={() => {
                  setDropdownOpen(false)
                  logout()
                }}
                className="w-full flex items-center gap-2 px-3 py-2 text-sm text-destructive hover:bg-muted"
              >
                <LogOut className="w-4 h-4" />
                Đăng xuất
              </button>
            </div>
          )}
        </div>
      </div>
    </header>
  )
}
</file>

<file path="web/src/components/ui/spinner.tsx">
import { cn } from '@/lib/utils'

interface SpinnerProps {
  className?: string
  size?: 'sm' | 'md' | 'lg'
}

const sizeClasses = {
  sm: 'w-4 h-4',
  md: 'w-5 h-5',
  lg: 'w-6 h-6',
}

export function Spinner({ className, size = 'md' }: SpinnerProps) {
  return (
    <svg
      className={cn('animate-spin', sizeClasses[size], className)}
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 24 24"
    >
      <circle
        className="opacity-25"
        cx="12"
        cy="12"
        r="10"
        stroke="currentColor"
        strokeWidth="4"
      />
      <path
        className="opacity-75"
        fill="currentColor"
        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"
      />
    </svg>
  )
}
</file>

<file path="web/src/config/firebase.ts">
import { initializeApp } from 'firebase/app'
import {
  getAuth,
  browserLocalPersistence,
  setPersistence,
  RecaptchaVerifier,
  signInWithPhoneNumber,
} from 'firebase/auth'
import type { ConfirmationResult, User } from 'firebase/auth'
import {
  getFirestore,
  enableIndexedDbPersistence,
  connectFirestoreEmulator
} from 'firebase/firestore'

// Firebase configuration from environment variables
const firebaseConfig = {
  apiKey: import.meta.env.VITE_FIREBASE_API_KEY,
  authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN,
  projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,
  storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID,
  appId: import.meta.env.VITE_FIREBASE_APP_ID,
}

// Initialize Firebase
const app = initializeApp(firebaseConfig)

// Initialize Auth with local persistence
export const auth = getAuth(app)
setPersistence(auth, browserLocalPersistence)

// Initialize Firestore with offline persistence
export const db = getFirestore(app)

// Enable offline persistence for Firestore
enableIndexedDbPersistence(db).catch((err) => {
  if (err.code === 'failed-precondition') {
    console.warn('Firestore persistence failed: Multiple tabs open')
  } else if (err.code === 'unimplemented') {
    console.warn('Firestore persistence not supported in this browser')
  }
})

// Connect to emulators in development
if (import.meta.env.DEV && import.meta.env.VITE_USE_EMULATORS === 'true') {
  connectFirestoreEmulator(db, 'localhost', 8080)
}

// reCAPTCHA verifier for phone auth
let recaptchaVerifier: RecaptchaVerifier | null = null

export function setupRecaptcha(containerId: string): RecaptchaVerifier {
  if (recaptchaVerifier) {
    recaptchaVerifier.clear()
  }

  recaptchaVerifier = new RecaptchaVerifier(auth, containerId, {
    size: 'invisible',
    callback: () => {
      // reCAPTCHA solved
    },
    'expired-callback': () => {
      // Reset reCAPTCHA
      recaptchaVerifier?.clear()
    }
  })

  return recaptchaVerifier
}

// Send OTP to phone number
export async function sendOTP(
  phoneNumber: string,
  verifier: RecaptchaVerifier
): Promise<ConfirmationResult> {
  // Format Vietnamese phone number
  const formattedPhone = formatVietnamesePhone(phoneNumber)
  return signInWithPhoneNumber(auth, formattedPhone, verifier)
}

// Format Vietnamese phone number to E.164 format
export function formatVietnamesePhone(phone: string): string {
  // Remove all non-digit characters
  const digits = phone.replace(/\D/g, '')

  // Handle different formats
  if (digits.startsWith('84')) {
    return `+${digits}`
  } else if (digits.startsWith('0')) {
    return `+84${digits.slice(1)}`
  } else {
    return `+84${digits}`
  }
}

export { app }
export type { User, ConfirmationResult }
</file>

<file path="web/src/contexts/auth-context.tsx">
import { createContext, useContext, useEffect, useState } from 'react'
import type { ReactNode } from 'react'
import { onAuthStateChanged, signOut } from 'firebase/auth'
import { doc, getDoc } from 'firebase/firestore'
import { auth, db } from '@/config/firebase'
import type { User } from '@/config/firebase'
import type { UserDoc, UserRole } from '@/types'

interface AuthContextType {
  user: User | null
  userDoc: UserDoc | null
  loading: boolean
  error: string | null
  logout: () => Promise<void>
  isAdmin: boolean
  isVillageLeader: boolean
  isResident: boolean
}

const AuthContext = createContext<AuthContextType | undefined>(undefined)

interface AuthProviderProps {
  children: ReactNode
}

export function AuthProvider({ children }: AuthProviderProps) {
  const [user, setUser] = useState<User | null>(null)
  const [userDoc, setUserDoc] = useState<UserDoc | null>(null)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, async (firebaseUser) => {
      setUser(firebaseUser)

      if (firebaseUser) {
        try {
          // Fetch user document from Firestore
          const userRef = doc(db, 'users', firebaseUser.uid)
          const userSnap = await getDoc(userRef)

          if (userSnap.exists()) {
            const data = userSnap.data()
            setUserDoc({
              uid: firebaseUser.uid,
              phone: data.phone,
              displayName: data.displayName,
              role: data.role as UserRole,
              villageId: data.villageId,
              createdAt: data.createdAt?.toDate(),
              updatedAt: data.updatedAt?.toDate(),
            })
          } else {
            // User exists in Auth but not in Firestore
            // This might be a new user that needs registration
            setUserDoc(null)
          }
          setError(null)
        } catch (err) {
          console.error('Error fetching user document:', err)
          setError('Không thể tải thông tin người dùng')
          setUserDoc(null)
        }
      } else {
        setUserDoc(null)
      }

      setLoading(false)
    })

    return () => unsubscribe()
  }, [])

  const logout = async () => {
    try {
      await signOut(auth)
      setUser(null)
      setUserDoc(null)
    } catch (err) {
      console.error('Error signing out:', err)
      throw err
    }
  }

  const value: AuthContextType = {
    user,
    userDoc,
    loading,
    error,
    logout,
    isAdmin: userDoc?.role === 'commune_admin',
    isVillageLeader: userDoc?.role === 'village_leader',
    isResident: userDoc?.role === 'resident',
  }

  return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>
}

export function useAuth() {
  const context = useContext(AuthContext)
  if (context === undefined) {
    throw new Error('useAuth must be used within an AuthProvider')
  }
  return context
}
</file>

<file path="web/src/hooks/use-auth-mutations.ts">
import { useMutation } from '@tanstack/react-query'
import type { RecaptchaVerifier, ConfirmationResult } from 'firebase/auth'
import { doc, getDoc, setDoc, serverTimestamp } from 'firebase/firestore'
import { db, sendOTP } from '@/config/firebase'
import type { UserRole } from '@/types'

interface SendOtpVariables {
  phone: string
  verifier: RecaptchaVerifier
}

export function useSendOtpMutation() {
  return useMutation({
    mutationFn: async ({ phone, verifier }: SendOtpVariables) => {
      return await sendOTP(phone, verifier)
    },
  })
}

interface VerifyOtpVariables {
  otp: string
  confirmationResult: ConfirmationResult
  phone: string
}

export function useVerifyOtpMutation() {
  return useMutation({
    mutationFn: async ({ otp, confirmationResult }: VerifyOtpVariables) => {
      const result = await confirmationResult.confirm(otp)
      const user = result.user

      if (!user) {
        throw new Error('User not found after verification')
      }

      const userRef = doc(db, 'users', user.uid)
      const userSnap = await getDoc(userRef)

      if (!userSnap.exists()) {
        // Create new user
        const newUser: {
          uid: string
          phone: string
          displayName: string
          role: UserRole
          createdAt: ReturnType<typeof serverTimestamp>
          updatedAt: ReturnType<typeof serverTimestamp>
          lastLogin?: ReturnType<typeof serverTimestamp>
        } = {
          uid: user.uid,
          phone: user.phoneNumber || '',
          displayName: user.phoneNumber || '',
          role: 'resident',
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
          lastLogin: serverTimestamp(),
        }

        await setDoc(userRef, newUser)
      } else {
        // Update existing user lastLogin
        await setDoc(
          userRef,
          {
            lastLogin: serverTimestamp(),
            updatedAt: serverTimestamp(),
          },
          { merge: true }
        )
      }

      return user
    },
  })
}
</file>

<file path="web/src/hooks/use-auth.ts">
import { useAuth } from '@/contexts/auth-context'

/**
 * Re-export useAuth hook for convenience
 */
export { useAuth }
</file>

<file path="web/src/hooks/use-dashboard-stats.ts">
import { useQuery } from '@tanstack/react-query'
import { collection, getDocs, query, where } from 'firebase/firestore'
import { db } from '@/config/firebase'

export interface DashboardStats {
  villageCount: number
  householdCount: number
  residentCount: number
  pendingTasks: number
  pendingRequests: number
  sentMessages: number
}

/**
 * Fetch dashboard statistics from Firestore
 */
export function useDashboardStats() {
  return useQuery({
    queryKey: ['dashboard-stats'],
    queryFn: async (): Promise<DashboardStats> => {
      // Fetch all data in parallel
      const [villagesSnap, tasksSnap, requestsSnap, messagesSnap] = await Promise.all([
        getDocs(collection(db, 'villages')),
        getDocs(query(collection(db, 'tasks'), where('status', '==', 'pending'))),
        getDocs(query(collection(db, 'requests'), where('status', '==', 'pending'))),
        getDocs(query(collection(db, 'messages'), where('status', '==', 'sent'))),
      ])

      // Calculate totals from villages
      let totalHouseholds = 0
      let totalResidents = 0

      villagesSnap.docs.forEach((doc) => {
        const data = doc.data()
        totalHouseholds += data.householdCount || 0
        totalResidents += data.residentCount || 0
      })

      return {
        villageCount: villagesSnap.size,
        householdCount: totalHouseholds,
        residentCount: totalResidents,
        pendingTasks: tasksSnap.size,
        pendingRequests: requestsSnap.size,
        sentMessages: messagesSnap.size,
      }
    },
    staleTime: 5 * 60 * 1000, // 5 minutes
    gcTime: 10 * 60 * 1000, // 10 minutes (formerly cacheTime)
  })
}
</file>

<file path="web/src/hooks/use-households.ts">
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'
import {
  collection,
  doc,
  getDocs,
  getDoc,
  addDoc,
  updateDoc,
  deleteDoc,
  query,
  orderBy,
  serverTimestamp,
  increment,
} from 'firebase/firestore'
import { db } from '@/config/firebase'
import type { Household } from '@/types'

const HOUSEHOLDS_KEY = ['households']

/**
 * Fetch all households for a village
 */
export function useHouseholds(villageId: string | undefined) {
  return useQuery({
    queryKey: [...HOUSEHOLDS_KEY, villageId],
    queryFn: async () => {
      if (!villageId) return []
      const q = query(
        collection(db, 'villages', villageId, 'households'),
        orderBy('headName')
      )
      const snapshot = await getDocs(q)
      return snapshot.docs.map((doc) => ({
        id: doc.id,
        villageId,
        ...doc.data(),
        createdAt: doc.data().createdAt?.toDate(),
        updatedAt: doc.data().updatedAt?.toDate(),
      })) as Household[]
    },
    enabled: !!villageId,
  })
}

/**
 * Fetch a single household
 */
export function useHousehold(villageId: string | undefined, householdId: string | undefined) {
  return useQuery({
    queryKey: [...HOUSEHOLDS_KEY, villageId, householdId],
    queryFn: async () => {
      if (!villageId || !householdId) return null
      const docRef = doc(db, 'villages', villageId, 'households', householdId)
      const snapshot = await getDoc(docRef)
      if (!snapshot.exists()) return null
      return {
        id: snapshot.id,
        villageId,
        ...snapshot.data(),
        createdAt: snapshot.data().createdAt?.toDate(),
        updatedAt: snapshot.data().updatedAt?.toDate(),
      } as Household
    },
    enabled: !!villageId && !!householdId,
  })
}

/**
 * Create a new household
 */
export function useCreateHousehold() {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async ({
      villageId,
      ...data
    }: Omit<Household, 'id' | 'createdAt' | 'updatedAt'>) => {
      // Add household
      const docRef = await addDoc(collection(db, 'villages', villageId, 'households'), {
        ...data,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
      })

      // Update village household count
      const villageRef = doc(db, 'villages', villageId)
      await updateDoc(villageRef, {
        householdCount: increment(1),
        updatedAt: serverTimestamp(),
      })

      return docRef.id
    },
    onSuccess: (_, variables) => {
      queryClient.invalidateQueries({ queryKey: [...HOUSEHOLDS_KEY, variables.villageId] })
      queryClient.invalidateQueries({ queryKey: ['villages'] })
    },
  })
}

/**
 * Update a household
 */
export function useUpdateHousehold() {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async ({
      villageId,
      id,
      ...data
    }: Partial<Household> & { villageId: string; id: string }) => {
      const docRef = doc(db, 'villages', villageId, 'households', id)
      await updateDoc(docRef, {
        ...data,
        updatedAt: serverTimestamp(),
      })
    },
    onSuccess: (_, variables) => {
      queryClient.invalidateQueries({ queryKey: [...HOUSEHOLDS_KEY, variables.villageId] })
      queryClient.invalidateQueries({
        queryKey: [...HOUSEHOLDS_KEY, variables.villageId, variables.id],
      })
    },
  })
}

/**
 * Delete a household
 */
export function useDeleteHousehold() {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async ({ villageId, householdId }: { villageId: string; householdId: string }) => {
      const docRef = doc(db, 'villages', villageId, 'households', householdId)
      await deleteDoc(docRef)

      // Update village household count
      const villageRef = doc(db, 'villages', villageId)
      await updateDoc(villageRef, {
        householdCount: increment(-1),
        updatedAt: serverTimestamp(),
      })
    },
    onSuccess: (_, variables) => {
      queryClient.invalidateQueries({ queryKey: [...HOUSEHOLDS_KEY, variables.villageId] })
      queryClient.invalidateQueries({ queryKey: ['villages'] })
    },
  })
}
</file>

<file path="web/src/hooks/use-network-status.ts">
import { useState, useEffect } from 'react'

/**
 * Hook to track online/offline network status
 */
export function useNetworkStatus() {
  const [isOnline, setIsOnline] = useState(navigator.onLine)

  useEffect(() => {
    const handleOnline = () => setIsOnline(true)
    const handleOffline = () => setIsOnline(false)

    window.addEventListener('online', handleOnline)
    window.addEventListener('offline', handleOffline)

    return () => {
      window.removeEventListener('online', handleOnline)
      window.removeEventListener('offline', handleOffline)
    }
  }, [])

  return isOnline
}
</file>

<file path="web/src/hooks/use-residents.ts">
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'
import {
  collection,
  doc,
  getDocs,
  getDoc,
  addDoc,
  updateDoc,
  deleteDoc,
  query,
  orderBy,
  where,
  serverTimestamp,
  increment,
} from 'firebase/firestore'
import { db } from '@/config/firebase'
import { encryptCCCD, decryptCCCD, hashCCCD } from '@/lib/encryption'
import type { Resident } from '@/types'

const RESIDENTS_KEY = ['residents']

/**
 * Fetch all residents for a household
 */
export function useResidents(villageId: string | undefined, householdId: string | undefined) {
  return useQuery({
    queryKey: [...RESIDENTS_KEY, villageId, householdId],
    queryFn: async () => {
      if (!villageId || !householdId) return []
      const q = query(
        collection(db, 'villages', villageId, 'households', householdId, 'residents'),
        orderBy('isHead', 'desc'),
        orderBy('name')
      )
      const snapshot = await getDocs(q)
      return snapshot.docs.map((doc) => ({
        id: doc.id,
        villageId,
        householdId,
        ...doc.data(),
        birthDate: doc.data().birthDate?.toDate(),
        createdAt: doc.data().createdAt?.toDate(),
        updatedAt: doc.data().updatedAt?.toDate(),
      })) as Resident[]
    },
    enabled: !!villageId && !!householdId,
  })
}

/**
 * Fetch a single resident
 */
export function useResident(
  villageId: string | undefined,
  householdId: string | undefined,
  residentId: string | undefined
) {
  return useQuery({
    queryKey: [...RESIDENTS_KEY, villageId, householdId, residentId],
    queryFn: async () => {
      if (!villageId || !householdId || !residentId) return null
      const docRef = doc(
        db,
        'villages',
        villageId,
        'households',
        householdId,
        'residents',
        residentId
      )
      const snapshot = await getDoc(docRef)
      if (!snapshot.exists()) return null
      return {
        id: snapshot.id,
        villageId,
        householdId,
        ...snapshot.data(),
        birthDate: snapshot.data().birthDate?.toDate(),
        createdAt: snapshot.data().createdAt?.toDate(),
        updatedAt: snapshot.data().updatedAt?.toDate(),
      } as Resident
    },
    enabled: !!villageId && !!householdId && !!residentId,
  })
}

interface CreateResidentInput extends Omit<Resident, 'id' | 'createdAt' | 'updatedAt' | 'idNumberEncrypted' | 'idNumberHash'> {
  idNumber?: string // Plain CCCD number to be encrypted
}

/**
 * Create a new resident with CCCD encryption
 */
export function useCreateResident() {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async ({ villageId, householdId, idNumber, ...data }: CreateResidentInput) => {
      // Encrypt CCCD if provided
      let encryptedData = {}
      if (idNumber) {
        const { encrypted, hash } = encryptCCCD(idNumber)
        encryptedData = {
          idNumberEncrypted: encrypted,
          idNumberHash: hash,
        }
      }

      // Add resident
      const docRef = await addDoc(
        collection(db, 'villages', villageId, 'households', householdId, 'residents'),
        {
          ...data,
          ...encryptedData,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
        }
      )

      // Update household member count
      const householdRef = doc(db, 'villages', villageId, 'households', householdId)
      await updateDoc(householdRef, {
        memberCount: increment(1),
        updatedAt: serverTimestamp(),
      })

      // Update village resident count
      const villageRef = doc(db, 'villages', villageId)
      await updateDoc(villageRef, {
        residentCount: increment(1),
        updatedAt: serverTimestamp(),
      })

      return docRef.id
    },
    onSuccess: (_, variables) => {
      queryClient.invalidateQueries({
        queryKey: [...RESIDENTS_KEY, variables.villageId, variables.householdId],
      })
      queryClient.invalidateQueries({ queryKey: ['households', variables.villageId] })
      queryClient.invalidateQueries({ queryKey: ['villages'] })
    },
  })
}

interface UpdateResidentInput extends Partial<Omit<Resident, 'idNumberEncrypted' | 'idNumberHash'>> {
  villageId: string
  householdId: string
  id: string
  idNumber?: string // Plain CCCD number to be encrypted
}

/**
 * Update a resident with CCCD encryption
 */
export function useUpdateResident() {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async ({ villageId, householdId, id, idNumber, ...data }: UpdateResidentInput) => {
      // Encrypt CCCD if provided
      let encryptedData = {}
      if (idNumber) {
        const { encrypted, hash } = encryptCCCD(idNumber)
        encryptedData = {
          idNumberEncrypted: encrypted,
          idNumberHash: hash,
        }
      }

      const docRef = doc(db, 'villages', villageId, 'households', householdId, 'residents', id)
      await updateDoc(docRef, {
        ...data,
        ...encryptedData,
        updatedAt: serverTimestamp(),
      })
    },
    onSuccess: (_, variables) => {
      queryClient.invalidateQueries({
        queryKey: [...RESIDENTS_KEY, variables.villageId, variables.householdId],
      })
      queryClient.invalidateQueries({
        queryKey: [...RESIDENTS_KEY, variables.villageId, variables.householdId, variables.id],
      })
    },
  })
}

/**
 * Delete a resident
 */
export function useDeleteResident() {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async ({
      villageId,
      householdId,
      residentId,
    }: {
      villageId: string
      householdId: string
      residentId: string
    }) => {
      const docRef = doc(db, 'villages', villageId, 'households', householdId, 'residents', residentId)
      await deleteDoc(docRef)

      // Update household member count
      const householdRef = doc(db, 'villages', villageId, 'households', householdId)
      await updateDoc(householdRef, {
        memberCount: increment(-1),
        updatedAt: serverTimestamp(),
      })

      // Update village resident count
      const villageRef = doc(db, 'villages', villageId)
      await updateDoc(villageRef, {
        residentCount: increment(-1),
        updatedAt: serverTimestamp(),
      })
    },
    onSuccess: (_, variables) => {
      queryClient.invalidateQueries({
        queryKey: [...RESIDENTS_KEY, variables.villageId, variables.householdId],
      })
      queryClient.invalidateQueries({ queryKey: ['households', variables.villageId] })
      queryClient.invalidateQueries({ queryKey: ['villages'] })
    },
  })
}

/**
 * Search resident by CCCD hash (without decryption)
 */
export function useSearchResidentByCCCD(cccd: string | undefined, villageId?: string) {
  return useQuery({
    queryKey: ['residents', 'search', cccd],
    queryFn: async () => {
      if (!cccd) return null
      const hash = hashCCCD(cccd)

      // Search across all villages or specific village
      // Note: This requires a collection group query
      const q = villageId
        ? query(
            collection(db, 'villages', villageId, 'households'),
            where('idNumberHash', '==', hash)
          )
        : null // Collection group queries need special setup

      if (!q) return null

      const snapshot = await getDocs(q)
      if (snapshot.empty) return null

      return snapshot.docs[0].data()
    },
    enabled: !!cccd,
  })
}

/**
 * Decrypt CCCD for display (use sparingly, only for authorized users)
 */
export function decryptResidentCCCD(encryptedCCCD: string): string {
  return decryptCCCD(encryptedCCCD)
}
</file>

<file path="web/src/hooks/use-sms.ts">
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'
import {
  collection,
  doc,
  getDocs,
  addDoc,
  updateDoc,
  query,
  orderBy,
  limit,
  where,
  serverTimestamp,
} from 'firebase/firestore'
import { db } from '@/config/firebase'
import { sendBulkSMS } from '@/lib/sms'
import type { SMSMessage, SMSStatus } from '@/types'
import type { SMSRecipient, SMSBatchResult } from '@/lib/sms'

const SMS_KEY = ['sms-messages']

/**
 * Fetch SMS message history
 */
export function useSMSMessages(options?: { limit?: number; status?: SMSStatus }) {
  return useQuery({
    queryKey: [...SMS_KEY, options],
    queryFn: async () => {
      let q = query(
        collection(db, 'sms_messages'),
        orderBy('createdAt', 'desc'),
        limit(options?.limit || 50)
      )

      if (options?.status) {
        q = query(
          collection(db, 'sms_messages'),
          where('status', '==', options.status),
          orderBy('createdAt', 'desc'),
          limit(options?.limit || 50)
        )
      }

      const snapshot = await getDocs(q)
      return snapshot.docs.map((doc) => ({
        id: doc.id,
        ...doc.data(),
        sentAt: doc.data().sentAt?.toDate(),
        createdAt: doc.data().createdAt?.toDate(),
      })) as SMSMessage[]
    },
  })
}

interface SendSMSInput {
  recipients: SMSRecipient[]
  content: string
  sentBy: string
  targetVillages?: string[]
}

/**
 * Send bulk SMS and save to Firestore
 */
export function useSendSMS() {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async ({ recipients, content, sentBy, targetVillages }: SendSMSInput) => {
      // Create SMS record in Firestore first
      const smsDoc = await addDoc(collection(db, 'sms_messages'), {
        recipients: recipients.map((r) => r.phone),
        content,
        status: 'pending' as SMSStatus,
        sentBy,
        targetVillages: targetVillages || [],
        deliveredCount: 0,
        failedCount: 0,
        createdAt: serverTimestamp(),
      })

      // Send SMS via provider
      const result: SMSBatchResult = await sendBulkSMS(recipients, content)

      // Update SMS record with results
      await updateDoc(doc(db, 'sms_messages', smsDoc.id), {
        status: result.totalFailed === 0 ? 'sent' : 'failed',
        deliveredCount: result.totalSent,
        failedCount: result.totalFailed,
        sentAt: serverTimestamp(),
      })

      return {
        messageId: smsDoc.id,
        ...result,
      }
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: SMS_KEY })
    },
  })
}

/**
 * Get SMS statistics
 */
export function useSMSStats() {
  return useQuery({
    queryKey: [...SMS_KEY, 'stats'],
    queryFn: async () => {
      const snapshot = await getDocs(collection(db, 'sms_messages'))

      let totalSent = 0
      let totalFailed = 0
      let totalMessages = 0

      snapshot.docs.forEach((doc) => {
        const data = doc.data()
        totalMessages++
        totalSent += data.deliveredCount || 0
        totalFailed += data.failedCount || 0
      })

      return {
        totalMessages,
        totalSent,
        totalFailed,
        successRate: totalSent + totalFailed > 0
          ? Math.round((totalSent / (totalSent + totalFailed)) * 100)
          : 0,
      }
    },
  })
}
</file>

<file path="web/src/hooks/use-tasks.ts">
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'
import {
  collection,
  doc,
  getDocs,
  getDoc,
  addDoc,
  updateDoc,
  deleteDoc,
  query,
  orderBy,
  where,
  serverTimestamp,
} from 'firebase/firestore'
import { db } from '@/config/firebase'
import type { Task, TaskStatus, TaskPriority } from '@/types'

const TASKS_KEY = ['tasks']

/**
 * Fetch all tasks with optional filters
 */
export function useTasks(options?: { status?: TaskStatus; villageId?: string }) {
  return useQuery({
    queryKey: [...TASKS_KEY, options],
    queryFn: async () => {
      let q = query(collection(db, 'tasks'), orderBy('createdAt', 'desc'))

      if (options?.status) {
        q = query(
          collection(db, 'tasks'),
          where('status', '==', options.status),
          orderBy('createdAt', 'desc')
        )
      }

      if (options?.villageId) {
        q = query(
          collection(db, 'tasks'),
          where('assignedTo', 'array-contains', options.villageId),
          orderBy('createdAt', 'desc')
        )
      }

      const snapshot = await getDocs(q)
      return snapshot.docs.map((doc) => ({
        id: doc.id,
        ...doc.data(),
        dueDate: doc.data().dueDate?.toDate(),
        completedAt: doc.data().completedAt?.toDate(),
        createdAt: doc.data().createdAt?.toDate(),
        updatedAt: doc.data().updatedAt?.toDate(),
      })) as Task[]
    },
  })
}

/**
 * Fetch a single task
 */
export function useTask(taskId: string | undefined) {
  return useQuery({
    queryKey: [...TASKS_KEY, taskId],
    queryFn: async () => {
      if (!taskId) return null
      const docRef = doc(db, 'tasks', taskId)
      const snapshot = await getDoc(docRef)
      if (!snapshot.exists()) return null
      return {
        id: snapshot.id,
        ...snapshot.data(),
        dueDate: snapshot.data().dueDate?.toDate(),
        completedAt: snapshot.data().completedAt?.toDate(),
        createdAt: snapshot.data().createdAt?.toDate(),
        updatedAt: snapshot.data().updatedAt?.toDate(),
      } as Task
    },
    enabled: !!taskId,
  })
}

interface CreateTaskInput {
  title: string
  description: string
  type: Task['type']
  priority: TaskPriority
  assignedTo: string[]
  createdBy: string
  dueDate?: Date
}

/**
 * Create a new task
 */
export function useCreateTask() {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async (data: CreateTaskInput) => {
      const docRef = await addDoc(collection(db, 'tasks'), {
        ...data,
        status: 'pending' as TaskStatus,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
      })
      return docRef.id
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: TASKS_KEY })
    },
  })
}

interface UpdateTaskInput {
  id: string
  title?: string
  description?: string
  type?: Task['type']
  priority?: TaskPriority
  status?: TaskStatus
  assignedTo?: string[]
  dueDate?: Date
  completedAt?: Date
}

/**
 * Update a task
 */
export function useUpdateTask() {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async ({ id, ...data }: UpdateTaskInput) => {
      const docRef = doc(db, 'tasks', id)
      await updateDoc(docRef, {
        ...data,
        updatedAt: serverTimestamp(),
      })
    },
    onSuccess: (_, variables) => {
      queryClient.invalidateQueries({ queryKey: TASKS_KEY })
      queryClient.invalidateQueries({ queryKey: [...TASKS_KEY, variables.id] })
    },
  })
}

/**
 * Delete a task
 */
export function useDeleteTask() {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async (taskId: string) => {
      await deleteDoc(doc(db, 'tasks', taskId))
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: TASKS_KEY })
    },
  })
}

/**
 * Get task statistics
 */
export function useTaskStats() {
  return useQuery({
    queryKey: [...TASKS_KEY, 'stats'],
    queryFn: async () => {
      const snapshot = await getDocs(collection(db, 'tasks'))
      const stats = {
        total: 0,
        pending: 0,
        inProgress: 0,
        completed: 0,
        cancelled: 0,
        overdue: 0,
      }

      const now = new Date()
      snapshot.docs.forEach((doc) => {
        const data = doc.data()
        stats.total++

        switch (data.status) {
          case 'pending': stats.pending++; break
          case 'in_progress': stats.inProgress++; break
          case 'completed': stats.completed++; break
          case 'cancelled': stats.cancelled++; break
        }

        if (data.dueDate && data.status !== 'completed' && data.status !== 'cancelled') {
          const dueDate = data.dueDate.toDate()
          if (dueDate < now) stats.overdue++
        }
      })

      return stats
    },
  })
}
</file>

<file path="web/src/hooks/use-villages.ts">
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'
import {
  collection,
  doc,
  getDocs,
  getDoc,
  addDoc,
  updateDoc,
  deleteDoc,
  query,
  orderBy,
  serverTimestamp,
} from 'firebase/firestore'
import { db } from '@/config/firebase'
import type { Village } from '@/types'

const VILLAGES_KEY = ['villages']

/**
 * Fetch all villages
 */
export function useVillages() {
  return useQuery({
    queryKey: VILLAGES_KEY,
    queryFn: async () => {
      const q = query(collection(db, 'villages'), orderBy('region'), orderBy('name'))
      const snapshot = await getDocs(q)
      return snapshot.docs.map((doc) => ({
        id: doc.id,
        ...doc.data(),
        createdAt: doc.data().createdAt?.toDate(),
        updatedAt: doc.data().updatedAt?.toDate(),
      })) as Village[]
    },
  })
}

/**
 * Fetch a single village by ID
 */
export function useVillage(villageId: string | undefined) {
  return useQuery({
    queryKey: [...VILLAGES_KEY, villageId],
    queryFn: async () => {
      if (!villageId) return null
      const docRef = doc(db, 'villages', villageId)
      const snapshot = await getDoc(docRef)
      if (!snapshot.exists()) return null
      return {
        id: snapshot.id,
        ...snapshot.data(),
        createdAt: snapshot.data().createdAt?.toDate(),
        updatedAt: snapshot.data().updatedAt?.toDate(),
      } as Village
    },
    enabled: !!villageId,
  })
}

/**
 * Create a new village
 */
export function useCreateVillage() {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async (data: Omit<Village, 'id' | 'createdAt' | 'updatedAt'>) => {
      const docRef = await addDoc(collection(db, 'villages'), {
        ...data,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
      })
      return docRef.id
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: VILLAGES_KEY })
    },
  })
}

/**
 * Update a village
 */
export function useUpdateVillage() {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async ({ id, ...data }: Partial<Village> & { id: string }) => {
      const docRef = doc(db, 'villages', id)
      await updateDoc(docRef, {
        ...data,
        updatedAt: serverTimestamp(),
      })
    },
    onSuccess: (_, variables) => {
      queryClient.invalidateQueries({ queryKey: VILLAGES_KEY })
      queryClient.invalidateQueries({ queryKey: [...VILLAGES_KEY, variables.id] })
    },
  })
}

/**
 * Delete a village
 */
export function useDeleteVillage() {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async (villageId: string) => {
      const docRef = doc(db, 'villages', villageId)
      await deleteDoc(docRef)
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: VILLAGES_KEY })
    },
  })
}

/**
 * Get villages grouped by region
 */
export function useVillagesByRegion() {
  const { data: villages, ...rest } = useVillages()

  const grouped = villages?.reduce(
    (acc, village) => {
      const region = village.region
      if (!acc[region]) {
        acc[region] = []
      }
      acc[region].push(village)
      return acc
    },
    {} as Record<string, Village[]>
  )

  return { data: grouped, ...rest }
}
</file>

<file path="web/src/lib/sms/index.ts">
// SMS Service - Provider abstraction layer

import type { SMSProvider, SMSProviderConfig, SMSSendResult, SMSBatchResult, SMSRecipient } from './types'
import { MockSMSProvider } from './mock-provider'

let currentProvider: SMSProvider | null = null

/**
 * Initialize SMS provider based on config
 */
export function initSMSProvider(config: SMSProviderConfig): SMSProvider {
  switch (config.provider) {
    case 'mock':
      currentProvider = new MockSMSProvider({ delay: config.sandbox ? 100 : 500 })
      break
    case 'esms':
      // TODO: Implement eSMS provider for Vietnam
      console.warn('eSMS provider not implemented, falling back to mock')
      currentProvider = new MockSMSProvider()
      break
    case 'speedsms':
      // TODO: Implement SpeedSMS provider for Vietnam
      console.warn('SpeedSMS provider not implemented, falling back to mock')
      currentProvider = new MockSMSProvider()
      break
    case 'twilio':
      // TODO: Implement Twilio provider
      console.warn('Twilio provider not implemented, falling back to mock')
      currentProvider = new MockSMSProvider()
      break
    default:
      currentProvider = new MockSMSProvider()
  }
  return currentProvider
}

/**
 * Get current SMS provider
 */
export function getSMSProvider(): SMSProvider {
  if (!currentProvider) {
    // Default to mock provider in development
    currentProvider = new MockSMSProvider()
  }
  return currentProvider
}

/**
 * Send SMS to single recipient
 */
export async function sendSMS(phone: string, message: string): Promise<SMSSendResult> {
  const provider = getSMSProvider()
  return provider.send(phone, message)
}

/**
 * Send SMS to multiple recipients
 */
export async function sendBulkSMS(recipients: SMSRecipient[], message: string): Promise<SMSBatchResult> {
  const provider = getSMSProvider()
  return provider.sendBatch(recipients, message)
}

/**
 * Get SMS balance (if supported by provider)
 */
export async function getSMSBalance(): Promise<number | null> {
  const provider = getSMSProvider()
  if (provider.getBalance) {
    return provider.getBalance()
  }
  return null
}

// Export types
export * from './types'
</file>

<file path="web/src/lib/sms/mock-provider.ts">
// Mock SMS Provider for development and testing

import type { SMSProvider, SMSSendResult, SMSBatchResult, SMSRecipient } from './types'
import { isValidVietnamesePhone, normalizePhone } from './types'

export class MockSMSProvider implements SMSProvider {
  name = 'mock'
  private delay: number
  private failRate: number

  constructor(options?: { delay?: number; failRate?: number }) {
    this.delay = options?.delay ?? 500
    this.failRate = options?.failRate ?? 0.05 // 5% fail rate by default
  }

  validatePhone(phone: string): boolean {
    return isValidVietnamesePhone(phone)
  }

  async send(phone: string, message: string): Promise<SMSSendResult> {
    await this.simulateDelay()

    const normalized = normalizePhone(phone)
    const shouldFail = Math.random() < this.failRate

    if (!this.validatePhone(phone)) {
      return {
        success: false,
        recipient: normalized,
        error: 'Invalid phone number',
        provider: this.name,
        sentAt: new Date(),
      }
    }

    if (shouldFail) {
      return {
        success: false,
        recipient: normalized,
        error: 'Simulated failure',
        provider: this.name,
        sentAt: new Date(),
      }
    }

    console.log(`[MockSMS] Sent to ${normalized}: ${message.substring(0, 50)}...`)

    return {
      success: true,
      messageId: `mock_${Date.now()}_${Math.random().toString(36).slice(2)}`,
      recipient: normalized,
      provider: this.name,
      sentAt: new Date(),
    }
  }

  async sendBatch(recipients: SMSRecipient[], message: string): Promise<SMSBatchResult> {
    const results: SMSSendResult[] = []
    let totalSent = 0
    let totalFailed = 0

    // Process in parallel with concurrency limit
    const batchSize = 10
    for (let i = 0; i < recipients.length; i += batchSize) {
      const batch = recipients.slice(i, i + batchSize)
      const batchResults = await Promise.all(
        batch.map((r) => this.send(r.phone, message))
      )

      for (const result of batchResults) {
        results.push(result)
        if (result.success) totalSent++
        else totalFailed++
      }
    }

    return { totalSent, totalFailed, results }
  }

  async getBalance(): Promise<number> {
    await this.simulateDelay()
    return 999999 // Unlimited for mock
  }

  private simulateDelay(): Promise<void> {
    return new Promise((resolve) => setTimeout(resolve, this.delay))
  }
}
</file>

<file path="web/src/lib/sms/types.ts">
// SMS Provider types and interfaces

export interface SMSRecipient {
  phone: string
  name?: string
  villageId?: string
  householdId?: string
}

export interface SMSSendRequest {
  recipients: SMSRecipient[]
  message: string
  scheduledAt?: Date
}

export interface SMSSendResult {
  success: boolean
  messageId?: string
  recipient: string
  error?: string
  provider: string
  sentAt: Date
}

export interface SMSBatchResult {
  totalSent: number
  totalFailed: number
  results: SMSSendResult[]
}

export interface SMSProvider {
  name: string
  send(phone: string, message: string): Promise<SMSSendResult>
  sendBatch(recipients: SMSRecipient[], message: string): Promise<SMSBatchResult>
  getBalance?(): Promise<number>
  validatePhone(phone: string): boolean
}

export interface SMSProviderConfig {
  provider: 'esms' | 'speedsms' | 'twilio' | 'mock'
  apiKey?: string
  apiSecret?: string
  brandName?: string
  sandbox?: boolean
}

// Vietnamese phone number validation
export function isValidVietnamesePhone(phone: string): boolean {
  // Remove spaces and dashes
  const cleaned = phone.replace(/[\s-]/g, '')
  // Vietnamese phone: starts with 0 or +84, followed by 9 digits
  const regex = /^(\+84|84|0)(3|5|7|8|9)[0-9]{8}$/
  return regex.test(cleaned)
}

// Normalize phone to E.164 format (+84...)
export function normalizePhone(phone: string): string {
  const cleaned = phone.replace(/[\s-]/g, '')
  if (cleaned.startsWith('+84')) return cleaned
  if (cleaned.startsWith('84')) return '+' + cleaned
  if (cleaned.startsWith('0')) return '+84' + cleaned.slice(1)
  return cleaned
}
</file>

<file path="web/src/lib/encryption.ts">
import CryptoJS from 'crypto-js'

// Encryption key from environment variable
const ENCRYPTION_KEY = import.meta.env.VITE_ENCRYPTION_KEY || 'default-dev-key-change-in-production'

/**
 * Encrypt CCCD (Citizen ID) number using AES-256-GCM
 * Returns both encrypted value and hash for lookup
 */
export function encryptCCCD(cccd: string): { encrypted: string; hash: string } {
  // Encrypt with AES
  const encrypted = CryptoJS.AES.encrypt(cccd, ENCRYPTION_KEY).toString()

  // Create SHA-256 hash for lookup without decryption
  const hash = CryptoJS.SHA256(cccd).toString()

  return { encrypted, hash }
}

/**
 * Decrypt CCCD number
 */
export function decryptCCCD(encrypted: string): string {
  const bytes = CryptoJS.AES.decrypt(encrypted, ENCRYPTION_KEY)
  return bytes.toString(CryptoJS.enc.Utf8)
}

/**
 * Hash CCCD for lookup (without storing the actual number)
 */
export function hashCCCD(cccd: string): string {
  return CryptoJS.SHA256(cccd).toString()
}

/**
 * Verify if a CCCD matches a hash
 */
export function verifyCCCD(cccd: string, hash: string): boolean {
  return hashCCCD(cccd) === hash
}
</file>

<file path="web/src/lib/utils.ts">
import { type ClassValue, clsx } from 'clsx'
import { twMerge } from 'tailwind-merge'

/**
 * Merge Tailwind CSS classes with clsx
 */
export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}

/**
 * Format date to Vietnamese locale
 */
export function formatDate(date: Date | string | number): string {
  const d = new Date(date)
  return d.toLocaleDateString('vi-VN', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
  })
}

/**
 * Format datetime to Vietnamese locale
 */
export function formatDateTime(date: Date | string | number): string {
  const d = new Date(date)
  return d.toLocaleString('vi-VN', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
  })
}

/**
 * Format number to Vietnamese locale
 */
export function formatNumber(num: number): string {
  return num.toLocaleString('vi-VN')
}

/**
 * Truncate text with ellipsis
 */
export function truncate(text: string, length: number): string {
  if (text.length <= length) return text
  return text.slice(0, length) + '...'
}

/**
 * Debounce function
 */
export function debounce<T extends (...args: unknown[]) => unknown>(
  fn: T,
  delay: number
): (...args: Parameters<T>) => void {
  let timeoutId: ReturnType<typeof setTimeout>
  return (...args: Parameters<T>) => {
    clearTimeout(timeoutId)
    timeoutId = setTimeout(() => fn(...args), delay)
  }
}

/**
 * Sleep utility
 */
export function sleep(ms: number): Promise<void> {
  return new Promise((resolve) => setTimeout(resolve, ms))
}
</file>

<file path="web/src/pages/admin/households/[householdId].tsx">
import { useState } from 'react'
import { useParams, Link, useNavigate } from 'react-router-dom'
import { ArrowLeft, Home, Users, Phone, MapPin, Edit2, Trash2, UserPlus, Calendar } from 'lucide-react'
import { AdminLayout } from '@/components/layout/admin-layout'
import { useHousehold, useDeleteHousehold } from '@/hooks/use-households'
import { useResidents, useDeleteResident } from '@/hooks/use-residents'
import { useVillage } from '@/hooks/use-villages'
import { cn } from '@/lib/utils'
import type { Resident } from '@/types'

export function HouseholdDetailPage() {
  const { villageId, householdId } = useParams<{ villageId: string; householdId: string }>()
  const navigate = useNavigate()
  const { data: household, isLoading } = useHousehold(villageId, householdId)
  const { data: village } = useVillage(villageId)
  const { data: residents } = useResidents(villageId, householdId)
  const deleteHousehold = useDeleteHousehold()
  const [showDeleteModal, setShowDeleteModal] = useState(false)

  const basePath = `/admin/villages/${villageId}/households`

  const handleDelete = async () => {
    if (!householdId || !villageId) return
    try {
      await deleteHousehold.mutateAsync({ villageId, householdId })
      navigate(basePath)
    } catch (error) {
      console.error('Failed to delete household:', error)
    }
  }

  if (isLoading) {
    return (
      <AdminLayout>
        <div className="animate-pulse space-y-6">
          <div className="h-8 w-48 bg-muted rounded" />
          <div className="h-32 bg-muted rounded-xl" />
        </div>
      </AdminLayout>
    )
  }

  if (!household) {
    return (
      <AdminLayout>
        <div className="text-center py-12">
          <p className="text-muted-foreground">Không tìm thấy hộ gia đình</p>
          <Link to={basePath} className="text-primary-600 hover:underline mt-2 inline-block">
            Quay lại danh sách
          </Link>
        </div>
      </AdminLayout>
    )
  }

  return (
    <AdminLayout>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-center gap-4">
          <Link to={basePath} className="p-2 hover:bg-muted rounded-lg transition-colors">
            <ArrowLeft className="w-5 h-5" />
          </Link>
          <div className="flex-1">
            <h1 className="text-2xl font-bold">{household.headName}</h1>
            <p className="text-muted-foreground">{village?.name || 'Đang tải...'}</p>
          </div>
          <div className="flex items-center gap-2">
            <Link
              to={`${basePath}/${householdId}/edit`}
              className="flex items-center gap-2 px-4 py-2 rounded-lg bg-muted hover:bg-muted/80 transition-colors"
            >
              <Edit2 className="w-4 h-4" />
              <span className="hidden sm:inline">Sửa</span>
            </Link>
            <button
              onClick={() => setShowDeleteModal(true)}
              className="flex items-center gap-2 px-4 py-2 rounded-lg bg-red-50 text-red-600 hover:bg-red-100 transition-colors"
            >
              <Trash2 className="w-4 h-4" />
              <span className="hidden sm:inline">Xóa</span>
            </button>
          </div>
        </div>

        {/* Info Cards */}
        <div className="grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
          <div className="bg-card rounded-xl border p-4">
            <div className="flex items-center gap-3">
              <div className="p-2 bg-blue-50 text-blue-600 rounded-lg">
                <Home className="w-5 h-5" />
              </div>
              <div>
                <div className="text-sm text-muted-foreground">Số hộ khẩu</div>
                <div className="font-semibold">{household.code}</div>
              </div>
            </div>
          </div>
          <div className="bg-card rounded-xl border p-4">
            <div className="flex items-center gap-3">
              <div className="p-2 bg-green-50 text-green-600 rounded-lg">
                <Users className="w-5 h-5" />
              </div>
              <div>
                <div className="text-sm text-muted-foreground">Nhân khẩu</div>
                <div className="font-semibold">{household.memberCount} người</div>
              </div>
            </div>
          </div>
          <div className="bg-card rounded-xl border p-4">
            <div className="flex items-center gap-3">
              <div className="p-2 bg-purple-50 text-purple-600 rounded-lg">
                <Phone className="w-5 h-5" />
              </div>
              <div>
                <div className="text-sm text-muted-foreground">Điện thoại</div>
                <div className="font-semibold">{household.phone || 'Chưa có'}</div>
              </div>
            </div>
          </div>
          <div className="bg-card rounded-xl border p-4">
            <div className="flex items-center gap-3">
              <div className="p-2 bg-orange-50 text-orange-600 rounded-lg">
                <MapPin className="w-5 h-5" />
              </div>
              <div>
                <div className="text-sm text-muted-foreground">Địa chỉ</div>
                <div className="font-semibold truncate max-w-[150px]">{household.address}</div>
              </div>
            </div>
          </div>
        </div>

        {/* Residents List */}
        <div className="bg-card rounded-xl border">
          <div className="p-4 border-b flex items-center justify-between">
            <h2 className="font-semibold">Thành viên hộ gia đình</h2>
            <Link
              to={`${basePath}/${householdId}/residents/new`}
              className={cn(
                'flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm',
                'bg-primary-600 text-white hover:bg-primary-700 transition-colors'
              )}
            >
              <UserPlus className="w-4 h-4" />
              Thêm thành viên
            </Link>
          </div>
          <div className="divide-y">
            {residents?.map((resident) => (
              <ResidentRow
                key={resident.id}
                resident={resident}
                villageId={villageId!}
                householdId={householdId!}
                basePath={`${basePath}/${householdId}/residents`}
                isHead={resident.id === household.headId}
              />
            ))}
            {(!residents || residents.length === 0) && (
              <div className="p-8 text-center text-muted-foreground">
                Chưa có thành viên nào
              </div>
            )}
          </div>
        </div>

        {/* Notes */}
        {household.notes && (
          <div className="bg-card rounded-xl border p-4">
            <h2 className="font-semibold mb-2">Ghi chú</h2>
            <p className="text-muted-foreground whitespace-pre-wrap">{household.notes}</p>
          </div>
        )}
      </div>

      {/* Delete Confirmation Modal */}
      {showDeleteModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
          <div className="bg-card rounded-xl p-6 w-full max-w-md mx-4">
            <h3 className="text-lg font-semibold mb-2">Xác nhận xóa</h3>
            <p className="text-muted-foreground mb-4">
              Bạn có chắc muốn xóa hộ gia đình của <strong>{household.headName}</strong>?
              Tất cả thành viên trong hộ cũng sẽ bị xóa.
            </p>
            <div className="flex gap-3">
              <button
                onClick={() => setShowDeleteModal(false)}
                className="flex-1 py-2 bg-muted rounded-lg hover:bg-muted/80"
              >
                Hủy
              </button>
              <button
                onClick={handleDelete}
                disabled={deleteHousehold.isPending}
                className="flex-1 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50"
              >
                {deleteHousehold.isPending ? 'Đang xóa...' : 'Xóa'}
              </button>
            </div>
          </div>
        </div>
      )}
    </AdminLayout>
  )
}

function ResidentRow({
  resident,
  villageId,
  householdId,
  basePath,
  isHead
}: {
  resident: Resident
  villageId: string
  householdId: string
  basePath: string
  isHead: boolean
}) {
  const deleteResident = useDeleteResident()
  const [showDelete, setShowDelete] = useState(false)

  const handleDelete = async () => {
    try {
      await deleteResident.mutateAsync({ villageId, householdId, residentId: resident.id })
      setShowDelete(false)
    } catch (error) {
      console.error('Failed to delete resident:', error)
    }
  }

  return (
    <div className="flex items-center justify-between p-4 hover:bg-muted/30 transition-colors">
      <div className="flex items-center gap-3">
        <div className={cn(
          'w-10 h-10 rounded-full flex items-center justify-center text-sm font-medium',
          isHead ? 'bg-primary-100 text-primary-700' : 'bg-muted'
        )}>
          {(resident.fullName || resident.name || '?').charAt(0)}
        </div>
        <div>
          <div className="font-medium flex items-center gap-2">
            {resident.fullName || resident.name}
            {isHead && (
              <span className="text-xs px-2 py-0.5 bg-primary-100 text-primary-700 rounded-full">
                Chủ hộ
              </span>
            )}
          </div>
          <div className="text-sm text-muted-foreground flex items-center gap-3">
            <span>{resident.relationship}</span>
            {(resident.dateOfBirth || resident.birthDate) && (
              <span className="flex items-center gap-1">
                <Calendar className="w-3 h-3" />
                {resident.dateOfBirth
                  ? new Date(resident.dateOfBirth).toLocaleDateString('vi-VN')
                  : resident.birthDate
                    ? new Date(resident.birthDate).toLocaleDateString('vi-VN')
                    : ''}
              </span>
            )}
          </div>
        </div>
      </div>
      <div className="flex items-center gap-2">
        <Link
          to={`${basePath}/${resident.id}/edit`}
          className="p-2 hover:bg-muted rounded-lg"
        >
          <Edit2 className="w-4 h-4" />
        </Link>
        <button
          onClick={() => setShowDelete(true)}
          className="p-2 hover:bg-red-50 text-red-600 rounded-lg"
        >
          <Trash2 className="w-4 h-4" />
        </button>
      </div>

      {showDelete && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
          <div className="bg-card rounded-xl p-6 w-full max-w-sm mx-4">
            <h3 className="font-semibold mb-2">Xóa thành viên?</h3>
            <p className="text-sm text-muted-foreground mb-4">
              Xóa {resident.fullName || resident.name} khỏi hộ gia đình?
            </p>
            <div className="flex gap-3">
              <button onClick={() => setShowDelete(false)} className="flex-1 py-2 bg-muted rounded-lg">
                Hủy
              </button>
              <button
                onClick={handleDelete}
                disabled={deleteResident.isPending}
                className="flex-1 py-2 bg-red-600 text-white rounded-lg disabled:opacity-50"
              >
                Xóa
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}
</file>

<file path="web/src/pages/admin/households/form.tsx">
import { useState, useEffect } from 'react'
import { useParams, useNavigate, Link } from 'react-router-dom'
import { ArrowLeft, Save, Loader2 } from 'lucide-react'
import { AdminLayout } from '@/components/layout/admin-layout'
import { useHousehold, useCreateHousehold, useUpdateHousehold } from '@/hooks/use-households'
import { useVillage } from '@/hooks/use-villages'
import { cn } from '@/lib/utils'

export function HouseholdFormPage() {
  const { villageId, householdId } = useParams<{ villageId: string; householdId?: string }>()
  const navigate = useNavigate()
  const isEditing = !!householdId

  const { data: household, isLoading: loadingHousehold } = useHousehold(villageId, householdId)
  const { data: village } = useVillage(villageId)
  const createHousehold = useCreateHousehold()
  const updateHousehold = useUpdateHousehold()

  const [formData, setFormData] = useState({
    code: '',
    headName: '',
    address: '',
    phone: '',
    notes: '',
  })
  const [errors, setErrors] = useState<Record<string, string>>({})

  useEffect(() => {
    if (household && isEditing) {
      setFormData({
        code: household.code,
        headName: household.headName,
        address: household.address,
        phone: household.phone || '',
        notes: household.notes || '',
      })
    }
  }, [household, isEditing])

  const basePath = `/admin/villages/${villageId}/households`

  const validate = () => {
    const newErrors: Record<string, string> = {}
    if (!formData.code.trim()) newErrors.code = 'Vui lòng nhập số hộ khẩu'
    if (!formData.headName.trim()) newErrors.headName = 'Vui lòng nhập tên chủ hộ'
    if (!formData.address.trim()) newErrors.address = 'Vui lòng nhập địa chỉ'
    setErrors(newErrors)
    return Object.keys(newErrors).length === 0
  }

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    if (!validate() || !villageId) return

    try {
      if (isEditing && householdId) {
        await updateHousehold.mutateAsync({
          villageId,
          id: householdId,
          ...formData,
        })
        navigate(`${basePath}/${householdId}`)
      } else {
        const newId = await createHousehold.mutateAsync({
          villageId,
          ...formData,
          memberCount: 0,
        })
        navigate(`${basePath}/${newId}`)
      }
    } catch (error) {
      console.error('Failed to save household:', error)
    }
  }

  const isPending = createHousehold.isPending || updateHousehold.isPending

  if (isEditing && loadingHousehold) {
    return (
      <AdminLayout>
        <div className="animate-pulse space-y-6">
          <div className="h-8 w-48 bg-muted rounded" />
          <div className="h-64 bg-muted rounded-xl" />
        </div>
      </AdminLayout>
    )
  }

  return (
    <AdminLayout>
      <form onSubmit={handleSubmit} className="space-y-6">
        {/* Header */}
        <div className="flex items-center gap-4">
          <Link to={basePath} className="p-2 hover:bg-muted rounded-lg transition-colors">
            <ArrowLeft className="w-5 h-5" />
          </Link>
          <div className="flex-1">
            <h1 className="text-2xl font-bold">
              {isEditing ? 'Sửa hộ gia đình' : 'Thêm hộ gia đình mới'}
            </h1>
            {village && (
              <p className="text-muted-foreground">{village.name}</p>
            )}
          </div>
          <button
            type="submit"
            disabled={isPending}
            className={cn(
              'flex items-center gap-2 px-4 py-2 rounded-lg',
              'bg-primary-600 text-white hover:bg-primary-700 transition-colors',
              'disabled:opacity-50 disabled:cursor-not-allowed'
            )}
          >
            {isPending ? (
              <Loader2 className="w-4 h-4 animate-spin" />
            ) : (
              <Save className="w-4 h-4" />
            )}
            <span className="hidden sm:inline">{isEditing ? 'Cập nhật' : 'Lưu'}</span>
          </button>
        </div>

        {/* Form */}
        <div className="bg-card rounded-xl border p-6 space-y-5">
          {/* Household Code */}
          <div>
            <label className="block text-sm font-medium mb-1.5">
              Số hộ khẩu <span className="text-red-500">*</span>
            </label>
            <input
              type="text"
              value={formData.code}
              onChange={(e) => setFormData({ ...formData, code: e.target.value })}
              placeholder="VD: 001/2024"
              className={cn(
                'w-full px-3 py-2.5 rounded-lg border bg-background',
                'focus:outline-none focus:ring-2 focus:ring-primary-500',
                errors.code && 'border-red-500'
              )}
            />
            {errors.code && (
              <p className="text-sm text-red-500 mt-1">{errors.code}</p>
            )}
          </div>

          {/* Head Name */}
          <div>
            <label className="block text-sm font-medium mb-1.5">
              Tên chủ hộ <span className="text-red-500">*</span>
            </label>
            <input
              type="text"
              value={formData.headName}
              onChange={(e) => setFormData({ ...formData, headName: e.target.value })}
              placeholder="Nguyễn Văn A"
              className={cn(
                'w-full px-3 py-2.5 rounded-lg border bg-background',
                'focus:outline-none focus:ring-2 focus:ring-primary-500',
                errors.headName && 'border-red-500'
              )}
            />
            {errors.headName && (
              <p className="text-sm text-red-500 mt-1">{errors.headName}</p>
            )}
          </div>

          {/* Address */}
          <div>
            <label className="block text-sm font-medium mb-1.5">
              Địa chỉ <span className="text-red-500">*</span>
            </label>
            <input
              type="text"
              value={formData.address}
              onChange={(e) => setFormData({ ...formData, address: e.target.value })}
              placeholder="Số nhà, đường, thôn..."
              className={cn(
                'w-full px-3 py-2.5 rounded-lg border bg-background',
                'focus:outline-none focus:ring-2 focus:ring-primary-500',
                errors.address && 'border-red-500'
              )}
            />
            {errors.address && (
              <p className="text-sm text-red-500 mt-1">{errors.address}</p>
            )}
          </div>

          {/* Phone */}
          <div>
            <label className="block text-sm font-medium mb-1.5">Số điện thoại</label>
            <input
              type="tel"
              value={formData.phone}
              onChange={(e) => setFormData({ ...formData, phone: e.target.value })}
              placeholder="0912345678"
              className="w-full px-3 py-2.5 rounded-lg border bg-background focus:outline-none focus:ring-2 focus:ring-primary-500"
            />
          </div>

          {/* Notes */}
          <div>
            <label className="block text-sm font-medium mb-1.5">Ghi chú</label>
            <textarea
              value={formData.notes}
              onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
              rows={3}
              placeholder="Ghi chú thêm về hộ gia đình..."
              className="w-full px-3 py-2.5 rounded-lg border bg-background focus:outline-none focus:ring-2 focus:ring-primary-500 resize-none"
            />
          </div>
        </div>
      </form>
    </AdminLayout>
  )
}
</file>

<file path="web/src/pages/admin/households/index.tsx">
import { useState } from 'react'
import { Link, useParams } from 'react-router-dom'
import { Plus, Search, Home, Users, ChevronRight, ArrowLeft } from 'lucide-react'
import { AdminLayout } from '@/components/layout/admin-layout'
import { useHouseholds } from '@/hooks/use-households'
import { useVillage } from '@/hooks/use-villages'
import { cn } from '@/lib/utils'
import type { Household } from '@/types'

export function HouseholdsPage() {
  const { villageId } = useParams<{ villageId: string }>()
  const { data: village } = useVillage(villageId)
  const { data: households, isLoading } = useHouseholds(villageId)
  const [search, setSearch] = useState('')

  // Filter households
  const filteredHouseholds = households?.filter((h) =>
    h.headName.toLowerCase().includes(search.toLowerCase()) ||
    h.code.toLowerCase().includes(search.toLowerCase()) ||
    h.address.toLowerCase().includes(search.toLowerCase())
  )

  return (
    <AdminLayout>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-center gap-4">
          {villageId && (
            <Link
              to={`/admin/villages/${villageId}`}
              className="p-2 hover:bg-muted rounded-lg transition-colors"
            >
              <ArrowLeft className="w-5 h-5" />
            </Link>
          )}
          <div className="flex-1">
            <h1 className="text-2xl font-bold">Hộ gia đình</h1>
            {village && (
              <p className="text-muted-foreground">{village.name}</p>
            )}
          </div>
          <Link
            to={villageId ? `/admin/villages/${villageId}/households/new` : '/admin/households/new'}
            className={cn(
              'flex items-center gap-2 px-4 py-2 rounded-lg',
              'bg-primary-600 text-white hover:bg-primary-700 transition-colors'
            )}
          >
            <Plus className="w-4 h-4" />
            <span className="hidden sm:inline">Thêm hộ</span>
          </Link>
        </div>

        {/* Search */}
        <div className="relative">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground" />
          <input
            type="text"
            placeholder="Tìm theo tên chủ hộ, số hộ khẩu, địa chỉ..."
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            className="w-full pl-10 pr-4 py-2.5 rounded-lg border bg-background focus:outline-none focus:ring-2 focus:ring-primary-500"
          />
        </div>

        {/* Households Table */}
        <div className="bg-card rounded-xl border overflow-hidden">
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-muted/50">
                <tr>
                  <th className="text-left px-4 py-3 text-sm font-medium">Chủ hộ</th>
                  <th className="text-left px-4 py-3 text-sm font-medium hidden sm:table-cell">Số hộ khẩu</th>
                  <th className="text-left px-4 py-3 text-sm font-medium hidden md:table-cell">Địa chỉ</th>
                  <th className="text-center px-4 py-3 text-sm font-medium">Nhân khẩu</th>
                  <th className="w-10"></th>
                </tr>
              </thead>
              <tbody className="divide-y">
                {isLoading ? (
                  [...Array(5)].map((_, i) => (
                    <tr key={i} className="animate-pulse">
                      <td className="px-4 py-3"><div className="h-5 w-32 bg-muted rounded" /></td>
                      <td className="px-4 py-3 hidden sm:table-cell"><div className="h-5 w-24 bg-muted rounded" /></td>
                      <td className="px-4 py-3 hidden md:table-cell"><div className="h-5 w-40 bg-muted rounded" /></td>
                      <td className="px-4 py-3 text-center"><div className="h-5 w-8 bg-muted rounded mx-auto" /></td>
                      <td className="px-4 py-3"></td>
                    </tr>
                  ))
                ) : filteredHouseholds?.length === 0 ? (
                  <tr>
                    <td colSpan={5} className="px-4 py-12 text-center text-muted-foreground">
                      {search ? 'Không tìm thấy hộ gia đình nào' : 'Chưa có hộ gia đình nào'}
                    </td>
                  </tr>
                ) : (
                  filteredHouseholds?.map((household) => (
                    <HouseholdRow key={household.id} household={household} villageId={villageId} />
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </AdminLayout>
  )
}

function HouseholdRow({ household, villageId }: { household: Household; villageId?: string }) {
  const basePath = villageId ? `/admin/villages/${villageId}/households` : '/admin/households'

  return (
    <tr className="hover:bg-muted/30 transition-colors">
      <td className="px-4 py-3">
        <div className="flex items-center gap-3">
          <div className="p-2 bg-primary-50 text-primary-600 rounded-lg">
            <Home className="w-4 h-4" />
          </div>
          <div>
            <div className="font-medium">{household.headName}</div>
            <div className="text-sm text-muted-foreground sm:hidden">{household.code}</div>
          </div>
        </div>
      </td>
      <td className="px-4 py-3 hidden sm:table-cell text-muted-foreground">
        {household.code}
      </td>
      <td className="px-4 py-3 hidden md:table-cell text-muted-foreground truncate max-w-[200px]">
        {household.address}
      </td>
      <td className="px-4 py-3 text-center">
        <div className="flex items-center justify-center gap-1">
          <Users className="w-4 h-4 text-muted-foreground" />
          <span>{household.memberCount}</span>
        </div>
      </td>
      <td className="px-4 py-3">
        <Link
          to={`${basePath}/${household.id}`}
          className="p-2 hover:bg-muted rounded-lg inline-flex"
        >
          <ChevronRight className="w-4 h-4" />
        </Link>
      </td>
    </tr>
  )
}
</file>

<file path="web/src/pages/admin/residents/form.tsx">
import { useState, useEffect } from 'react'
import { useParams, useNavigate, Link } from 'react-router-dom'
import { ArrowLeft, Save, Loader2 } from 'lucide-react'
import { AdminLayout } from '@/components/layout/admin-layout'
import { useResident, useCreateResident, useUpdateResident } from '@/hooks/use-residents'
import { useHousehold } from '@/hooks/use-households'
import { cn } from '@/lib/utils'
import type { Gender } from '@/types'

const genderOptions: { value: Gender; label: string }[] = [
  { value: 'male', label: 'Nam' },
  { value: 'female', label: 'Nữ' },
  { value: 'other', label: 'Khác' },
]

const relationshipOptions = [
  'Chủ hộ',
  'Vợ/Chồng',
  'Con',
  'Cha/Mẹ',
  'Ông/Bà',
  'Cháu',
  'Anh/Chị/Em',
  'Khác',
]

export function ResidentFormPage() {
  const { villageId, householdId, residentId } = useParams<{
    villageId: string
    householdId: string
    residentId?: string
  }>()
  const navigate = useNavigate()
  const isEditing = !!residentId

  const { data: resident, isLoading: loadingResident } = useResident(villageId, householdId, residentId)
  const { data: household } = useHousehold(villageId, householdId)
  const createResident = useCreateResident()
  const updateResident = useUpdateResident()

  const [formData, setFormData] = useState({
    fullName: '',
    dateOfBirth: '',
    gender: 'male' as Gender,
    idNumber: '',
    phone: '',
    relationship: 'Chủ hộ',
    occupation: '',
    notes: '',
  })
  const [errors, setErrors] = useState<Record<string, string>>({})

  useEffect(() => {
    if (resident && isEditing) {
      setFormData({
        fullName: resident.fullName || resident.name || '',
        dateOfBirth: resident.dateOfBirth || (resident.birthDate ? new Date(resident.birthDate).toISOString().split('T')[0] : ''),
        gender: resident.gender,
        idNumber: '',
        phone: resident.phone || '',
        relationship: resident.relationship || 'Khác',
        occupation: resident.occupation || '',
        notes: resident.notes || '',
      })
    }
  }, [resident, isEditing])

  const basePath = `/admin/villages/${villageId}/households/${householdId}`

  const validate = () => {
    const newErrors: Record<string, string> = {}
    if (!formData.fullName.trim()) newErrors.fullName = 'Vui lòng nhập họ tên'
    if (!formData.dateOfBirth) newErrors.dateOfBirth = 'Vui lòng nhập ngày sinh'
    if (!formData.relationship) newErrors.relationship = 'Vui lòng chọn quan hệ với chủ hộ'
    if (!isEditing && !formData.idNumber.trim()) newErrors.idNumber = 'Vui lòng nhập số CCCD'
    if (formData.idNumber && !/^\d{12}$/.test(formData.idNumber)) {
      newErrors.idNumber = 'Số CCCD phải có 12 chữ số'
    }
    setErrors(newErrors)
    return Object.keys(newErrors).length === 0
  }

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    if (!validate() || !villageId || !householdId) return

    try {
      const data = {
        name: formData.fullName,
        fullName: formData.fullName,
        birthDate: new Date(formData.dateOfBirth),
        dateOfBirth: formData.dateOfBirth,
        gender: formData.gender,
        phone: formData.phone,
        relationship: formData.relationship,
        occupation: formData.occupation,
        notes: formData.notes,
        isHead: formData.relationship === 'Chủ hộ',
        villageId,
        householdId,
        ...(formData.idNumber ? { idNumber: formData.idNumber } : {}),
      }

      if (isEditing && residentId) {
        await updateResident.mutateAsync({ ...data, id: residentId })
      } else {
        await createResident.mutateAsync(data)
      }
      navigate(basePath)
    } catch (error) {
      console.error('Failed to save resident:', error)
    }
  }

  const isPending = createResident.isPending || updateResident.isPending

  if (isEditing && loadingResident) {
    return (
      <AdminLayout>
        <div className="animate-pulse space-y-6">
          <div className="h-8 w-48 bg-muted rounded" />
          <div className="h-64 bg-muted rounded-xl" />
        </div>
      </AdminLayout>
    )
  }

  return (
    <AdminLayout>
      <form onSubmit={handleSubmit} className="space-y-6">
        {/* Header */}
        <div className="flex items-center gap-4">
          <Link to={basePath} className="p-2 hover:bg-muted rounded-lg transition-colors">
            <ArrowLeft className="w-5 h-5" />
          </Link>
          <div className="flex-1">
            <h1 className="text-2xl font-bold">
              {isEditing ? 'Sửa thông tin nhân khẩu' : 'Thêm nhân khẩu mới'}
            </h1>
            {household && (
              <p className="text-muted-foreground">Hộ: {household.headName}</p>
            )}
          </div>
          <button
            type="submit"
            disabled={isPending}
            className={cn(
              'flex items-center gap-2 px-4 py-2 rounded-lg',
              'bg-primary-600 text-white hover:bg-primary-700 transition-colors',
              'disabled:opacity-50 disabled:cursor-not-allowed'
            )}
          >
            {isPending ? <Loader2 className="w-4 h-4 animate-spin" /> : <Save className="w-4 h-4" />}
            <span className="hidden sm:inline">{isEditing ? 'Cập nhật' : 'Lưu'}</span>
          </button>
        </div>

        {/* Form */}
        <div className="bg-card rounded-xl border p-6 space-y-5">
          {/* Full Name */}
          <div>
            <label className="block text-sm font-medium mb-1.5">
              Họ và tên <span className="text-red-500">*</span>
            </label>
            <input
              type="text"
              value={formData.fullName}
              onChange={(e) => setFormData({ ...formData, fullName: e.target.value })}
              placeholder="Nguyễn Văn A"
              className={cn(
                'w-full px-3 py-2.5 rounded-lg border bg-background',
                'focus:outline-none focus:ring-2 focus:ring-primary-500',
                errors.fullName && 'border-red-500'
              )}
            />
            {errors.fullName && <p className="text-sm text-red-500 mt-1">{errors.fullName}</p>}
          </div>

          {/* Date of Birth & Gender */}
          <div className="grid sm:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium mb-1.5">
                Ngày sinh <span className="text-red-500">*</span>
              </label>
              <input
                type="date"
                value={formData.dateOfBirth}
                onChange={(e) => setFormData({ ...formData, dateOfBirth: e.target.value })}
                className={cn(
                  'w-full px-3 py-2.5 rounded-lg border bg-background',
                  'focus:outline-none focus:ring-2 focus:ring-primary-500',
                  errors.dateOfBirth && 'border-red-500'
                )}
              />
              {errors.dateOfBirth && <p className="text-sm text-red-500 mt-1">{errors.dateOfBirth}</p>}
            </div>
            <div>
              <label className="block text-sm font-medium mb-1.5">Giới tính</label>
              <select
                value={formData.gender}
                onChange={(e) => setFormData({ ...formData, gender: e.target.value as Gender })}
                className="w-full px-3 py-2.5 rounded-lg border bg-background focus:outline-none focus:ring-2 focus:ring-primary-500"
              >
                {genderOptions.map((opt) => (
                  <option key={opt.value} value={opt.value}>{opt.label}</option>
                ))}
              </select>
            </div>
          </div>

          {/* CCCD */}
          <div>
            <label className="block text-sm font-medium mb-1.5">
              Số CCCD {!isEditing && <span className="text-red-500">*</span>}
            </label>
            <input
              type="text"
              value={formData.idNumber}
              onChange={(e) => setFormData({ ...formData, idNumber: e.target.value.replace(/\D/g, '') })}
              placeholder={isEditing ? 'Để trống nếu không thay đổi' : '001234567890'}
              maxLength={12}
              className={cn(
                'w-full px-3 py-2.5 rounded-lg border bg-background',
                'focus:outline-none focus:ring-2 focus:ring-primary-500',
                errors.idNumber && 'border-red-500'
              )}
            />
            {errors.idNumber && <p className="text-sm text-red-500 mt-1">{errors.idNumber}</p>}
            <p className="text-xs text-muted-foreground mt-1">
              Số CCCD sẽ được mã hóa để bảo mật
            </p>
          </div>

          {/* Relationship */}
          <div>
            <label className="block text-sm font-medium mb-1.5">
              Quan hệ với chủ hộ <span className="text-red-500">*</span>
            </label>
            <select
              value={formData.relationship}
              onChange={(e) => setFormData({ ...formData, relationship: e.target.value })}
              className={cn(
                'w-full px-3 py-2.5 rounded-lg border bg-background',
                'focus:outline-none focus:ring-2 focus:ring-primary-500',
                errors.relationship && 'border-red-500'
              )}
            >
              {relationshipOptions.map((rel) => (
                <option key={rel} value={rel}>{rel}</option>
              ))}
            </select>
            {errors.relationship && <p className="text-sm text-red-500 mt-1">{errors.relationship}</p>}
          </div>

          {/* Phone & Occupation */}
          <div className="grid sm:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium mb-1.5">Số điện thoại</label>
              <input
                type="tel"
                value={formData.phone}
                onChange={(e) => setFormData({ ...formData, phone: e.target.value })}
                placeholder="0912345678"
                className="w-full px-3 py-2.5 rounded-lg border bg-background focus:outline-none focus:ring-2 focus:ring-primary-500"
              />
            </div>
            <div>
              <label className="block text-sm font-medium mb-1.5">Nghề nghiệp</label>
              <input
                type="text"
                value={formData.occupation}
                onChange={(e) => setFormData({ ...formData, occupation: e.target.value })}
                placeholder="Nông dân, Công nhân..."
                className="w-full px-3 py-2.5 rounded-lg border bg-background focus:outline-none focus:ring-2 focus:ring-primary-500"
              />
            </div>
          </div>

          {/* Notes */}
          <div>
            <label className="block text-sm font-medium mb-1.5">Ghi chú</label>
            <textarea
              value={formData.notes}
              onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
              rows={3}
              placeholder="Ghi chú thêm..."
              className="w-full px-3 py-2.5 rounded-lg border bg-background focus:outline-none focus:ring-2 focus:ring-primary-500 resize-none"
            />
          </div>
        </div>
      </form>
    </AdminLayout>
  )
}
</file>

<file path="web/src/pages/admin/sms/compose-modal.tsx">
import { X, Send, Loader2 } from 'lucide-react'
import { cn } from '@/lib/utils'
import type { Village } from '@/types'

interface ComposeModalProps {
  villages: Village[]
  selectedVillages: string[]
  setSelectedVillages: (villages: string[]) => void
  messageContent: string
  setMessageContent: (content: string) => void
  recipientType: 'all' | 'villages' | 'custom'
  setRecipientType: (type: 'all' | 'villages' | 'custom') => void
  customPhones: string
  setCustomPhones: (phones: string) => void
  onSend: () => void
  onClose: () => void
  isPending: boolean
}

export function ComposeModal({
  villages,
  selectedVillages,
  setSelectedVillages,
  messageContent,
  setMessageContent,
  recipientType,
  setRecipientType,
  customPhones,
  setCustomPhones,
  onSend,
  onClose,
  isPending,
}: ComposeModalProps) {
  const charCount = messageContent.length
  const smsCount = Math.ceil(charCount / 160) || 1

  const toggleVillage = (villageId: string) => {
    if (selectedVillages.includes(villageId)) {
      setSelectedVillages(selectedVillages.filter((v) => v !== villageId))
    } else {
      setSelectedVillages([...selectedVillages, villageId])
    }
  }

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
      <div className="bg-card rounded-xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
        {/* Header */}
        <div className="p-4 border-b flex items-center justify-between">
          <h2 className="text-lg font-semibold">Soạn tin nhắn SMS</h2>
          <button onClick={onClose} className="p-2 hover:bg-muted rounded-lg">
            <X className="w-5 h-5" />
          </button>
        </div>

        {/* Content */}
        <div className="p-4 space-y-4 overflow-y-auto flex-1">
          {/* Recipient Type */}
          <div>
            <label className="block text-sm font-medium mb-2">Người nhận</label>
            <div className="flex flex-wrap gap-2">
              <button
                type="button"
                onClick={() => setRecipientType('all')}
                className={cn(
                  'px-4 py-2 rounded-lg text-sm font-medium transition-colors',
                  recipientType === 'all'
                    ? 'bg-primary-600 text-white'
                    : 'bg-muted hover:bg-muted/80'
                )}
              >
                Tất cả
              </button>
              <button
                type="button"
                onClick={() => setRecipientType('villages')}
                className={cn(
                  'px-4 py-2 rounded-lg text-sm font-medium transition-colors',
                  recipientType === 'villages'
                    ? 'bg-primary-600 text-white'
                    : 'bg-muted hover:bg-muted/80'
                )}
              >
                Theo thôn
              </button>
              <button
                type="button"
                onClick={() => setRecipientType('custom')}
                className={cn(
                  'px-4 py-2 rounded-lg text-sm font-medium transition-colors',
                  recipientType === 'custom'
                    ? 'bg-primary-600 text-white'
                    : 'bg-muted hover:bg-muted/80'
                )}
              >
                Tùy chọn
              </button>
            </div>
          </div>

          {/* Village Selection */}
          {recipientType === 'villages' && (
            <div>
              <label className="block text-sm font-medium mb-2">Chọn thôn</label>
              <div className="flex flex-wrap gap-2 max-h-32 overflow-y-auto p-2 border rounded-lg">
                {villages.map((village) => (
                  <button
                    key={village.id}
                    type="button"
                    onClick={() => toggleVillage(village.id)}
                    className={cn(
                      'px-3 py-1.5 rounded-lg text-sm transition-colors',
                      selectedVillages.includes(village.id)
                        ? 'bg-primary-100 text-primary-700 border border-primary-300'
                        : 'bg-muted hover:bg-muted/80'
                    )}
                  >
                    {village.name}
                  </button>
                ))}
              </div>
              {selectedVillages.length > 0 && (
                <p className="text-xs text-muted-foreground mt-1">
                  Đã chọn {selectedVillages.length} thôn
                </p>
              )}
            </div>
          )}

          {/* Custom Phones */}
          {recipientType === 'custom' && (
            <div>
              <label className="block text-sm font-medium mb-2">
                Số điện thoại (mỗi số một dòng hoặc cách nhau bằng dấu phẩy)
              </label>
              <textarea
                value={customPhones}
                onChange={(e) => setCustomPhones(e.target.value)}
                rows={3}
                placeholder="0901234567&#10;0912345678&#10;..."
                className="w-full px-3 py-2 rounded-lg border bg-background focus:outline-none focus:ring-2 focus:ring-primary-500 resize-none"
              />
            </div>
          )}

          {/* Message Content */}
          <div>
            <label className="block text-sm font-medium mb-2">Nội dung tin nhắn</label>
            <textarea
              value={messageContent}
              onChange={(e) => setMessageContent(e.target.value)}
              rows={5}
              placeholder="Nhập nội dung tin nhắn..."
              className="w-full px-3 py-2 rounded-lg border bg-background focus:outline-none focus:ring-2 focus:ring-primary-500 resize-none"
            />
            <div className="flex justify-between text-xs text-muted-foreground mt-1">
              <span>{charCount} ký tự</span>
              <span>{smsCount} tin nhắn SMS</span>
            </div>
          </div>

          {/* Preview */}
          {messageContent && (
            <div className="p-3 bg-muted/50 rounded-lg">
              <div className="text-xs font-medium text-muted-foreground mb-1">Xem trước:</div>
              <div className="text-sm whitespace-pre-wrap">{messageContent}</div>
            </div>
          )}
        </div>

        {/* Footer */}
        <div className="p-4 border-t flex justify-end gap-3">
          <button
            onClick={onClose}
            className="px-4 py-2 rounded-lg bg-muted hover:bg-muted/80 transition-colors"
          >
            Hủy
          </button>
          <button
            onClick={onSend}
            disabled={isPending || !messageContent.trim()}
            className={cn(
              'flex items-center gap-2 px-4 py-2 rounded-lg',
              'bg-primary-600 text-white hover:bg-primary-700 transition-colors',
              'disabled:opacity-50 disabled:cursor-not-allowed'
            )}
          >
            {isPending ? (
              <Loader2 className="w-4 h-4 animate-spin" />
            ) : (
              <Send className="w-4 h-4" />
            )}
            Gửi tin nhắn
          </button>
        </div>
      </div>
    </div>
  )
}
</file>

<file path="web/src/pages/admin/sms/index.tsx">
import { useState } from 'react'
import { Send, MessageSquare, Users, CheckCircle, XCircle, Clock, Filter } from 'lucide-react'
import { AdminLayout } from '@/components/layout/admin-layout'
import { useSMSMessages, useSMSStats, useSendSMS } from '@/hooks/use-sms'
import { useVillages } from '@/hooks/use-villages'
import { useAuth } from '@/hooks/use-auth'
import { cn } from '@/lib/utils'
import { ComposeModal } from './compose-modal'
import type { SMSRecipient } from '@/lib/sms'
import type { SMSStatus } from '@/types'

const statusConfig: Record<SMSStatus, { label: string; color: string; icon: typeof CheckCircle }> = {
  pending: { label: 'Đang chờ', color: 'text-yellow-600 bg-yellow-50', icon: Clock },
  sent: { label: 'Đã gửi', color: 'text-blue-600 bg-blue-50', icon: Send },
  delivered: { label: 'Đã nhận', color: 'text-green-600 bg-green-50', icon: CheckCircle },
  failed: { label: 'Thất bại', color: 'text-red-600 bg-red-50', icon: XCircle },
}

export function SMSPage() {
  const { user } = useAuth()
  const { data: messages, isLoading } = useSMSMessages({ limit: 20 })
  const { data: stats } = useSMSStats()
  const { data: villages } = useVillages()
  const sendSMS = useSendSMS()

  const [showCompose, setShowCompose] = useState(false)
  const [selectedVillages, setSelectedVillages] = useState<string[]>([])
  const [messageContent, setMessageContent] = useState('')
  const [recipientType, setRecipientType] = useState<'all' | 'villages' | 'custom'>('all')
  const [customPhones, setCustomPhones] = useState('')

  const handleSend = async () => {
    if (!messageContent.trim() || !user) return

    let recipients: SMSRecipient[] = []

    if (recipientType === 'custom') {
      // Parse custom phone numbers
      const phones = customPhones.split(/[,\n]/).map((p) => p.trim()).filter(Boolean)
      recipients = phones.map((phone) => ({ phone }))
    } else {
      // TODO: Fetch actual phone numbers from households
      // For now, use mock data
      recipients = [
        { phone: '0901234567', name: 'Test User 1' },
        { phone: '0912345678', name: 'Test User 2' },
      ]
    }

    if (recipients.length === 0) {
      alert('Vui lòng chọn người nhận')
      return
    }

    try {
      await sendSMS.mutateAsync({
        recipients,
        content: messageContent,
        sentBy: user.uid,
        targetVillages: recipientType === 'villages' ? selectedVillages : undefined,
      })
      setShowCompose(false)
      setMessageContent('')
      setSelectedVillages([])
      setCustomPhones('')
    } catch (error) {
      console.error('Failed to send SMS:', error)
      alert('Gửi tin nhắn thất bại')
    }
  }

  return (
    <AdminLayout>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          <div>
            <h1 className="text-2xl font-bold">Tin nhắn SMS</h1>
            <p className="text-muted-foreground">Gửi thông báo đến người dân</p>
          </div>
          <button
            onClick={() => setShowCompose(true)}
            className={cn(
              'flex items-center gap-2 px-4 py-2 rounded-lg',
              'bg-primary-600 text-white hover:bg-primary-700 transition-colors'
            )}
          >
            <Send className="w-4 h-4" />
            Soạn tin nhắn
          </button>
        </div>

        {/* Stats */}
        <div className="grid sm:grid-cols-4 gap-4">
          <div className="bg-card rounded-xl border p-4">
            <div className="flex items-center gap-3">
              <div className="p-2 bg-blue-50 text-blue-600 rounded-lg">
                <MessageSquare className="w-5 h-5" />
              </div>
              <div>
                <div className="text-2xl font-bold">{stats?.totalMessages || 0}</div>
                <div className="text-sm text-muted-foreground">Tổng tin nhắn</div>
              </div>
            </div>
          </div>
          <div className="bg-card rounded-xl border p-4">
            <div className="flex items-center gap-3">
              <div className="p-2 bg-green-50 text-green-600 rounded-lg">
                <CheckCircle className="w-5 h-5" />
              </div>
              <div>
                <div className="text-2xl font-bold">{stats?.totalSent || 0}</div>
                <div className="text-sm text-muted-foreground">Đã gửi</div>
              </div>
            </div>
          </div>
          <div className="bg-card rounded-xl border p-4">
            <div className="flex items-center gap-3">
              <div className="p-2 bg-red-50 text-red-600 rounded-lg">
                <XCircle className="w-5 h-5" />
              </div>
              <div>
                <div className="text-2xl font-bold">{stats?.totalFailed || 0}</div>
                <div className="text-sm text-muted-foreground">Thất bại</div>
              </div>
            </div>
          </div>
          <div className="bg-card rounded-xl border p-4">
            <div className="flex items-center gap-3">
              <div className="p-2 bg-purple-50 text-purple-600 rounded-lg">
                <Users className="w-5 h-5" />
              </div>
              <div>
                <div className="text-2xl font-bold">{stats?.successRate || 0}%</div>
                <div className="text-sm text-muted-foreground">Tỷ lệ thành công</div>
              </div>
            </div>
          </div>
        </div>

        {/* Message History */}
        <div className="bg-card rounded-xl border">
          <div className="p-4 border-b flex items-center justify-between">
            <h2 className="font-semibold">Lịch sử tin nhắn</h2>
            <button className="flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground">
              <Filter className="w-4 h-4" />
              Lọc
            </button>
          </div>
          <div className="divide-y">
            {isLoading ? (
              [...Array(3)].map((_, i) => (
                <div key={i} className="p-4 animate-pulse">
                  <div className="h-4 w-48 bg-muted rounded mb-2" />
                  <div className="h-3 w-full bg-muted rounded" />
                </div>
              ))
            ) : messages?.length === 0 ? (
              <div className="p-8 text-center text-muted-foreground">
                Chưa có tin nhắn nào
              </div>
            ) : (
              messages?.map((msg) => {
                const config = statusConfig[msg.status]
                const StatusIcon = config.icon
                return (
                  <div key={msg.id} className="p-4 hover:bg-muted/30 transition-colors">
                    <div className="flex items-start justify-between gap-4">
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-2 mb-1">
                          <span className={cn('text-xs px-2 py-0.5 rounded-full flex items-center gap-1', config.color)}>
                            <StatusIcon className="w-3 h-3" />
                            {config.label}
                          </span>
                          <span className="text-xs text-muted-foreground">
                            {msg.recipients.length} người nhận
                          </span>
                        </div>
                        <p className="text-sm truncate">{msg.content}</p>
                        <div className="text-xs text-muted-foreground mt-1">
                          {msg.deliveredCount} gửi thành công, {msg.failedCount} thất bại
                        </div>
                      </div>
                      <div className="text-xs text-muted-foreground whitespace-nowrap">
                        {msg.createdAt?.toLocaleDateString('vi-VN')}
                      </div>
                    </div>
                  </div>
                )
              })
            )}
          </div>
        </div>
      </div>

      {/* Compose Modal */}
      {showCompose && (
        <ComposeModal
          villages={villages || []}
          selectedVillages={selectedVillages}
          setSelectedVillages={setSelectedVillages}
          messageContent={messageContent}
          setMessageContent={setMessageContent}
          recipientType={recipientType}
          setRecipientType={setRecipientType}
          customPhones={customPhones}
          setCustomPhones={setCustomPhones}
          onSend={handleSend}
          onClose={() => setShowCompose(false)}
          isPending={sendSMS.isPending}
        />
      )}
    </AdminLayout>
  )
}
</file>

<file path="web/src/pages/admin/tasks/[taskId].tsx">
import { useState } from 'react'
import { useParams, Link, useNavigate } from 'react-router-dom'
import {
  ArrowLeft, Edit2, Trash2, CheckCircle, Clock, XCircle,
  Calendar, Users
} from 'lucide-react'
import { AdminLayout } from '@/components/layout/admin-layout'
import { useTask, useUpdateTask, useDeleteTask } from '@/hooks/use-tasks'
import { useVillages } from '@/hooks/use-villages'
import { cn } from '@/lib/utils'
import type { TaskStatus, TaskPriority } from '@/types'

const statusConfig: Record<TaskStatus, { label: string; color: string; bgColor: string }> = {
  pending: { label: 'Chờ xử lý', color: 'text-yellow-600', bgColor: 'bg-yellow-50' },
  in_progress: { label: 'Đang thực hiện', color: 'text-blue-600', bgColor: 'bg-blue-50' },
  completed: { label: 'Hoàn thành', color: 'text-green-600', bgColor: 'bg-green-50' },
  cancelled: { label: 'Đã hủy', color: 'text-gray-600', bgColor: 'bg-gray-50' },
}

const priorityConfig: Record<TaskPriority, { label: string; color: string }> = {
  low: { label: 'Thấp', color: 'text-gray-500' },
  medium: { label: 'Trung bình', color: 'text-yellow-600' },
  high: { label: 'Cao', color: 'text-red-600' },
}

const typeLabels: Record<string, string> = {
  survey: 'Khảo sát',
  notification: 'Thông báo',
  report: 'Báo cáo',
  other: 'Khác',
}

export function TaskDetailPage() {
  const { taskId } = useParams<{ taskId: string }>()
  const navigate = useNavigate()
  const { data: task, isLoading } = useTask(taskId)
  const { data: villages } = useVillages()
  const updateTask = useUpdateTask()
  const deleteTask = useDeleteTask()
  const [showDeleteModal, setShowDeleteModal] = useState(false)

  const handleStatusChange = async (newStatus: TaskStatus) => {
    if (!taskId) return
    await updateTask.mutateAsync({
      id: taskId,
      status: newStatus,
      ...(newStatus === 'completed' ? { completedAt: new Date() } : {}),
    })
  }

  const handleDelete = async () => {
    if (!taskId) return
    await deleteTask.mutateAsync(taskId)
    navigate('/admin/tasks')
  }

  const assignedVillages = villages?.filter((v) => task?.assignedTo.includes(v.id)) || []
  const isOverdue = task?.dueDate && new Date(task.dueDate) < new Date() &&
    task.status !== 'completed' && task.status !== 'cancelled'

  if (isLoading) {
    return (
      <AdminLayout>
        <div className="animate-pulse space-y-6">
          <div className="h-8 w-48 bg-muted rounded" />
          <div className="h-32 bg-muted rounded-xl" />
        </div>
      </AdminLayout>
    )
  }

  if (!task) {
    return (
      <AdminLayout>
        <div className="text-center py-12">
          <p className="text-muted-foreground">Không tìm thấy công việc</p>
          <Link to="/admin/tasks" className="text-primary-600 hover:underline mt-2 inline-block">
            Quay lại danh sách
          </Link>
        </div>
      </AdminLayout>
    )
  }

  const status = statusConfig[task.status]
  const priority = priorityConfig[task.priority]

  return (
    <AdminLayout>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-center gap-4">
          <Link to="/admin/tasks" className="p-2 hover:bg-muted rounded-lg transition-colors">
            <ArrowLeft className="w-5 h-5" />
          </Link>
          <div className="flex-1">
            <div className="flex items-center gap-2 mb-1">
              <span className={cn('text-xs px-2 py-0.5 rounded-full', status.bgColor, status.color)}>
                {status.label}
              </span>
              <span className={cn('text-xs font-medium', priority.color)}>
                Ưu tiên: {priority.label}
              </span>
            </div>
            <h1 className="text-2xl font-bold">{task.title}</h1>
          </div>
          <div className="flex items-center gap-2">
            <Link
              to={`/admin/tasks/${taskId}/edit`}
              className="flex items-center gap-2 px-4 py-2 rounded-lg bg-muted hover:bg-muted/80 transition-colors"
            >
              <Edit2 className="w-4 h-4" />
              <span className="hidden sm:inline">Sửa</span>
            </Link>
            <button
              onClick={() => setShowDeleteModal(true)}
              className="flex items-center gap-2 px-4 py-2 rounded-lg bg-red-50 text-red-600 hover:bg-red-100 transition-colors"
            >
              <Trash2 className="w-4 h-4" />
              <span className="hidden sm:inline">Xóa</span>
            </button>
          </div>
        </div>

        {/* Info Cards */}
        <div className="grid sm:grid-cols-3 gap-4">
          <div className="bg-card rounded-xl border p-4">
            <div className="flex items-center gap-3">
              <div className="p-2 bg-blue-50 text-blue-600 rounded-lg">
                <Clock className="w-5 h-5" />
              </div>
              <div>
                <div className="text-sm text-muted-foreground">Loại công việc</div>
                <div className="font-semibold">{typeLabels[task.type]}</div>
              </div>
            </div>
          </div>
          <div className="bg-card rounded-xl border p-4">
            <div className="flex items-center gap-3">
              <div className="p-2 bg-green-50 text-green-600 rounded-lg">
                <Users className="w-5 h-5" />
              </div>
              <div>
                <div className="text-sm text-muted-foreground">Giao cho</div>
                <div className="font-semibold">{assignedVillages.length} thôn</div>
              </div>
            </div>
          </div>
          <div className="bg-card rounded-xl border p-4">
            <div className="flex items-center gap-3">
              <div className={cn('p-2 rounded-lg', isOverdue ? 'bg-red-50 text-red-600' : 'bg-purple-50 text-purple-600')}>
                <Calendar className="w-5 h-5" />
              </div>
              <div>
                <div className="text-sm text-muted-foreground">Hạn hoàn thành</div>
                <div className={cn('font-semibold', isOverdue && 'text-red-600')}>
                  {task.dueDate ? new Date(task.dueDate).toLocaleDateString('vi-VN') : 'Không có'}
                  {isOverdue && ' (Quá hạn)'}
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* Description */}
        <div className="bg-card rounded-xl border p-5">
          <h2 className="font-semibold mb-3">Mô tả công việc</h2>
          <p className="text-muted-foreground whitespace-pre-wrap">{task.description}</p>
        </div>

        {/* Assigned Villages */}
        <div className="bg-card rounded-xl border p-5">
          <h2 className="font-semibold mb-3">Thôn được giao</h2>
          <div className="flex flex-wrap gap-2">
            {assignedVillages.map((village) => (
              <Link
                key={village.id}
                to={`/admin/villages/${village.id}`}
                className="px-3 py-1.5 bg-muted rounded-lg text-sm hover:bg-muted/80 transition-colors"
              >
                {village.name}
              </Link>
            ))}
          </div>
        </div>

        {/* Status Actions */}
        <div className="bg-card rounded-xl border p-5">
          <h2 className="font-semibold mb-3">Cập nhật trạng thái</h2>
          <div className="flex flex-wrap gap-2">
            {task.status !== 'in_progress' && task.status !== 'completed' && (
              <button
                onClick={() => handleStatusChange('in_progress')}
                disabled={updateTask.isPending}
                className="flex items-center gap-2 px-4 py-2 rounded-lg bg-blue-50 text-blue-600 hover:bg-blue-100 transition-colors disabled:opacity-50"
              >
                <Clock className="w-4 h-4" />
                Bắt đầu thực hiện
              </button>
            )}
            {task.status !== 'completed' && (
              <button
                onClick={() => handleStatusChange('completed')}
                disabled={updateTask.isPending}
                className="flex items-center gap-2 px-4 py-2 rounded-lg bg-green-50 text-green-600 hover:bg-green-100 transition-colors disabled:opacity-50"
              >
                <CheckCircle className="w-4 h-4" />
                Đánh dấu hoàn thành
              </button>
            )}
            {task.status !== 'cancelled' && task.status !== 'completed' && (
              <button
                onClick={() => handleStatusChange('cancelled')}
                disabled={updateTask.isPending}
                className="flex items-center gap-2 px-4 py-2 rounded-lg bg-gray-50 text-gray-600 hover:bg-gray-100 transition-colors disabled:opacity-50"
              >
                <XCircle className="w-4 h-4" />
                Hủy công việc
              </button>
            )}
          </div>
        </div>

        {/* Timestamps */}
        <div className="text-sm text-muted-foreground">
          <p>Tạo lúc: {task.createdAt?.toLocaleString('vi-VN')}</p>
          {task.completedAt && <p>Hoàn thành lúc: {task.completedAt.toLocaleString('vi-VN')}</p>}
        </div>
      </div>

      {/* Delete Modal */}
      {showDeleteModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
          <div className="bg-card rounded-xl p-6 w-full max-w-md mx-4">
            <h3 className="text-lg font-semibold mb-2">Xác nhận xóa</h3>
            <p className="text-muted-foreground mb-4">
              Bạn có chắc muốn xóa công việc "{task.title}"?
            </p>
            <div className="flex gap-3">
              <button
                onClick={() => setShowDeleteModal(false)}
                className="flex-1 py-2 bg-muted rounded-lg hover:bg-muted/80"
              >
                Hủy
              </button>
              <button
                onClick={handleDelete}
                disabled={deleteTask.isPending}
                className="flex-1 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50"
              >
                {deleteTask.isPending ? 'Đang xóa...' : 'Xóa'}
              </button>
            </div>
          </div>
        </div>
      )}
    </AdminLayout>
  )
}
</file>

<file path="web/src/pages/admin/tasks/form.tsx">
import { useState, useEffect } from 'react'
import { useParams, useNavigate, Link } from 'react-router-dom'
import { ArrowLeft, Save, Loader2 } from 'lucide-react'
import { AdminLayout } from '@/components/layout/admin-layout'
import { useTask, useCreateTask, useUpdateTask } from '@/hooks/use-tasks'
import { useVillages } from '@/hooks/use-villages'
import { useAuth } from '@/hooks/use-auth'
import { cn } from '@/lib/utils'
import type { TaskType, TaskPriority } from '@/types'

const typeOptions: { value: TaskType; label: string }[] = [
  { value: 'survey', label: 'Khảo sát' },
  { value: 'notification', label: 'Thông báo' },
  { value: 'report', label: 'Báo cáo' },
  { value: 'other', label: 'Khác' },
]

const priorityOptions: { value: TaskPriority; label: string }[] = [
  { value: 'low', label: 'Thấp' },
  { value: 'medium', label: 'Trung bình' },
  { value: 'high', label: 'Cao' },
]

export function TaskFormPage() {
  const { taskId } = useParams<{ taskId?: string }>()
  const navigate = useNavigate()
  const { user } = useAuth()
  const isEditing = !!taskId

  const { data: task, isLoading: loadingTask } = useTask(taskId)
  const { data: villages } = useVillages()
  const createTask = useCreateTask()
  const updateTask = useUpdateTask()

  const [formData, setFormData] = useState({
    title: '',
    description: '',
    type: 'notification' as TaskType,
    priority: 'medium' as TaskPriority,
    assignedTo: [] as string[],
    dueDate: '',
  })
  const [errors, setErrors] = useState<Record<string, string>>({})

  useEffect(() => {
    if (task && isEditing) {
      setFormData({
        title: task.title,
        description: task.description,
        type: task.type,
        priority: task.priority,
        assignedTo: task.assignedTo,
        dueDate: task.dueDate ? new Date(task.dueDate).toISOString().split('T')[0] : '',
      })
    }
  }, [task, isEditing])

  const validate = () => {
    const newErrors: Record<string, string> = {}
    if (!formData.title.trim()) newErrors.title = 'Vui lòng nhập tiêu đề'
    if (!formData.description.trim()) newErrors.description = 'Vui lòng nhập mô tả'
    if (formData.assignedTo.length === 0) newErrors.assignedTo = 'Vui lòng chọn ít nhất một thôn'
    setErrors(newErrors)
    return Object.keys(newErrors).length === 0
  }

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    if (!validate() || !user) return

    try {
      const data = {
        ...formData,
        dueDate: formData.dueDate ? new Date(formData.dueDate) : undefined,
      }

      if (isEditing && taskId) {
        await updateTask.mutateAsync({ id: taskId, ...data })
        navigate(`/admin/tasks/${taskId}`)
      } else {
        const newId = await createTask.mutateAsync({ ...data, createdBy: user.uid })
        navigate(`/admin/tasks/${newId}`)
      }
    } catch (error) {
      console.error('Failed to save task:', error)
    }
  }

  const toggleVillage = (villageId: string) => {
    if (formData.assignedTo.includes(villageId)) {
      setFormData({ ...formData, assignedTo: formData.assignedTo.filter((v) => v !== villageId) })
    } else {
      setFormData({ ...formData, assignedTo: [...formData.assignedTo, villageId] })
    }
  }

  const selectAllVillages = () => {
    if (villages) {
      setFormData({ ...formData, assignedTo: villages.map((v) => v.id) })
    }
  }

  const isPending = createTask.isPending || updateTask.isPending

  if (isEditing && loadingTask) {
    return (
      <AdminLayout>
        <div className="animate-pulse space-y-6">
          <div className="h-8 w-48 bg-muted rounded" />
          <div className="h-64 bg-muted rounded-xl" />
        </div>
      </AdminLayout>
    )
  }

  return (
    <AdminLayout>
      <form onSubmit={handleSubmit} className="space-y-6">
        {/* Header */}
        <div className="flex items-center gap-4">
          <Link to="/admin/tasks" className="p-2 hover:bg-muted rounded-lg transition-colors">
            <ArrowLeft className="w-5 h-5" />
          </Link>
          <div className="flex-1">
            <h1 className="text-2xl font-bold">
              {isEditing ? 'Sửa công việc' : 'Tạo công việc mới'}
            </h1>
          </div>
          <button
            type="submit"
            disabled={isPending}
            className={cn(
              'flex items-center gap-2 px-4 py-2 rounded-lg',
              'bg-primary-600 text-white hover:bg-primary-700 transition-colors',
              'disabled:opacity-50 disabled:cursor-not-allowed'
            )}
          >
            {isPending ? <Loader2 className="w-4 h-4 animate-spin" /> : <Save className="w-4 h-4" />}
            <span className="hidden sm:inline">{isEditing ? 'Cập nhật' : 'Tạo'}</span>
          </button>
        </div>

        {/* Form */}
        <div className="bg-card rounded-xl border p-6 space-y-5">
          {/* Title */}
          <div>
            <label className="block text-sm font-medium mb-1.5">
              Tiêu đề <span className="text-red-500">*</span>
            </label>
            <input
              type="text"
              value={formData.title}
              onChange={(e) => setFormData({ ...formData, title: e.target.value })}
              placeholder="VD: Khảo sát tình hình dân cư"
              className={cn(
                'w-full px-3 py-2.5 rounded-lg border bg-background',
                'focus:outline-none focus:ring-2 focus:ring-primary-500',
                errors.title && 'border-red-500'
              )}
            />
            {errors.title && <p className="text-sm text-red-500 mt-1">{errors.title}</p>}
          </div>

          {/* Type & Priority */}
          <div className="grid sm:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium mb-1.5">Loại công việc</label>
              <select
                value={formData.type}
                onChange={(e) => setFormData({ ...formData, type: e.target.value as TaskType })}
                className="w-full px-3 py-2.5 rounded-lg border bg-background focus:outline-none focus:ring-2 focus:ring-primary-500"
              >
                {typeOptions.map((opt) => (
                  <option key={opt.value} value={opt.value}>{opt.label}</option>
                ))}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium mb-1.5">Độ ưu tiên</label>
              <select
                value={formData.priority}
                onChange={(e) => setFormData({ ...formData, priority: e.target.value as TaskPriority })}
                className="w-full px-3 py-2.5 rounded-lg border bg-background focus:outline-none focus:ring-2 focus:ring-primary-500"
              >
                {priorityOptions.map((opt) => (
                  <option key={opt.value} value={opt.value}>{opt.label}</option>
                ))}
              </select>
            </div>
          </div>

          {/* Description */}
          <div>
            <label className="block text-sm font-medium mb-1.5">
              Mô tả <span className="text-red-500">*</span>
            </label>
            <textarea
              value={formData.description}
              onChange={(e) => setFormData({ ...formData, description: e.target.value })}
              rows={4}
              placeholder="Mô tả chi tiết công việc cần thực hiện..."
              className={cn(
                'w-full px-3 py-2.5 rounded-lg border bg-background',
                'focus:outline-none focus:ring-2 focus:ring-primary-500 resize-none',
                errors.description && 'border-red-500'
              )}
            />
            {errors.description && <p className="text-sm text-red-500 mt-1">{errors.description}</p>}
          </div>

          {/* Due Date */}
          <div>
            <label className="block text-sm font-medium mb-1.5">Hạn hoàn thành</label>
            <input
              type="date"
              value={formData.dueDate}
              onChange={(e) => setFormData({ ...formData, dueDate: e.target.value })}
              className="w-full px-3 py-2.5 rounded-lg border bg-background focus:outline-none focus:ring-2 focus:ring-primary-500"
            />
          </div>

          {/* Assigned Villages */}
          <div>
            <div className="flex items-center justify-between mb-2">
              <label className="text-sm font-medium">
                Giao cho thôn <span className="text-red-500">*</span>
              </label>
              <button
                type="button"
                onClick={selectAllVillages}
                className="text-xs text-primary-600 hover:underline"
              >
                Chọn tất cả
              </button>
            </div>
            <div className={cn(
              'flex flex-wrap gap-2 max-h-40 overflow-y-auto p-3 border rounded-lg',
              errors.assignedTo && 'border-red-500'
            )}>
              {villages?.map((village) => (
                <button
                  key={village.id}
                  type="button"
                  onClick={() => toggleVillage(village.id)}
                  className={cn(
                    'px-3 py-1.5 rounded-lg text-sm transition-colors',
                    formData.assignedTo.includes(village.id)
                      ? 'bg-primary-100 text-primary-700 border border-primary-300'
                      : 'bg-muted hover:bg-muted/80'
                  )}
                >
                  {village.name}
                </button>
              ))}
            </div>
            {errors.assignedTo && <p className="text-sm text-red-500 mt-1">{errors.assignedTo}</p>}
            {formData.assignedTo.length > 0 && (
              <p className="text-xs text-muted-foreground mt-1">
                Đã chọn {formData.assignedTo.length} thôn
              </p>
            )}
          </div>
        </div>
      </form>
    </AdminLayout>
  )
}
</file>

<file path="web/src/pages/admin/tasks/index.tsx">
import { useState } from 'react'
import { Link } from 'react-router-dom'
import {
  Plus, ClipboardList, Clock, CheckCircle, XCircle, AlertTriangle,
  ChevronRight, Calendar
} from 'lucide-react'
import { AdminLayout } from '@/components/layout/admin-layout'
import { useTasks, useTaskStats } from '@/hooks/use-tasks'
import { cn } from '@/lib/utils'
import type { Task, TaskStatus, TaskPriority } from '@/types'

const statusConfig: Record<TaskStatus, { label: string; color: string; bgColor: string }> = {
  pending: { label: 'Chờ xử lý', color: 'text-yellow-600', bgColor: 'bg-yellow-50' },
  in_progress: { label: 'Đang thực hiện', color: 'text-blue-600', bgColor: 'bg-blue-50' },
  completed: { label: 'Hoàn thành', color: 'text-green-600', bgColor: 'bg-green-50' },
  cancelled: { label: 'Đã hủy', color: 'text-gray-600', bgColor: 'bg-gray-50' },
}

const priorityConfig: Record<TaskPriority, { label: string; color: string }> = {
  low: { label: 'Thấp', color: 'text-gray-500' },
  medium: { label: 'Trung bình', color: 'text-yellow-600' },
  high: { label: 'Cao', color: 'text-red-600' },
}

const typeLabels: Record<Task['type'], string> = {
  survey: 'Khảo sát',
  notification: 'Thông báo',
  report: 'Báo cáo',
  other: 'Khác',
}

export function TasksPage() {
  const { data: tasks, isLoading } = useTasks()
  const { data: stats } = useTaskStats()
  const [statusFilter, setStatusFilter] = useState<TaskStatus | 'all'>('all')

  const filteredTasks = tasks?.filter((task) =>
    statusFilter === 'all' || task.status === statusFilter
  )

  return (
    <AdminLayout>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          <div>
            <h1 className="text-2xl font-bold">Quản lý công việc</h1>
            <p className="text-muted-foreground">Giao việc cho các thôn</p>
          </div>
          <Link
            to="/admin/tasks/new"
            className={cn(
              'flex items-center gap-2 px-4 py-2 rounded-lg',
              'bg-primary-600 text-white hover:bg-primary-700 transition-colors'
            )}
          >
            <Plus className="w-4 h-4" />
            Tạo công việc
          </Link>
        </div>

        {/* Stats */}
        <div className="grid sm:grid-cols-5 gap-4">
          <StatCard
            icon={ClipboardList}
            label="Tổng công việc"
            value={stats?.total || 0}
            color="blue"
          />
          <StatCard
            icon={Clock}
            label="Chờ xử lý"
            value={stats?.pending || 0}
            color="yellow"
          />
          <StatCard
            icon={AlertTriangle}
            label="Đang thực hiện"
            value={stats?.inProgress || 0}
            color="purple"
          />
          <StatCard
            icon={CheckCircle}
            label="Hoàn thành"
            value={stats?.completed || 0}
            color="green"
          />
          <StatCard
            icon={XCircle}
            label="Quá hạn"
            value={stats?.overdue || 0}
            color="red"
          />
        </div>

        {/* Filter */}
        <div className="flex flex-wrap gap-2">
          <button
            onClick={() => setStatusFilter('all')}
            className={cn(
              'px-4 py-2 rounded-lg text-sm font-medium transition-colors',
              statusFilter === 'all' ? 'bg-primary-600 text-white' : 'bg-muted hover:bg-muted/80'
            )}
          >
            Tất cả
          </button>
          {(['pending', 'in_progress', 'completed', 'cancelled'] as TaskStatus[]).map((status) => (
            <button
              key={status}
              onClick={() => setStatusFilter(status)}
              className={cn(
                'px-4 py-2 rounded-lg text-sm font-medium transition-colors',
                statusFilter === status ? 'bg-primary-600 text-white' : 'bg-muted hover:bg-muted/80'
              )}
            >
              {statusConfig[status].label}
            </button>
          ))}
        </div>

        {/* Task List */}
        <div className="bg-card rounded-xl border">
          <div className="divide-y">
            {isLoading ? (
              [...Array(3)].map((_, i) => (
                <div key={i} className="p-4 animate-pulse">
                  <div className="h-5 w-48 bg-muted rounded mb-2" />
                  <div className="h-4 w-full bg-muted rounded" />
                </div>
              ))
            ) : filteredTasks?.length === 0 ? (
              <div className="p-8 text-center text-muted-foreground">
                Chưa có công việc nào
              </div>
            ) : (
              filteredTasks?.map((task) => <TaskRow key={task.id} task={task} />)
            )}
          </div>
        </div>
      </div>
    </AdminLayout>
  )
}

function StatCard({
  icon: Icon,
  label,
  value,
  color,
}: {
  icon: typeof ClipboardList
  label: string
  value: number
  color: 'blue' | 'yellow' | 'green' | 'red' | 'purple'
}) {
  const colors = {
    blue: 'bg-blue-50 text-blue-600',
    yellow: 'bg-yellow-50 text-yellow-600',
    green: 'bg-green-50 text-green-600',
    red: 'bg-red-50 text-red-600',
    purple: 'bg-purple-50 text-purple-600',
  }

  return (
    <div className="bg-card rounded-xl border p-4">
      <div className="flex items-center gap-3">
        <div className={cn('p-2 rounded-lg', colors[color])}>
          <Icon className="w-5 h-5" />
        </div>
        <div>
          <div className="text-2xl font-bold">{value}</div>
          <div className="text-sm text-muted-foreground">{label}</div>
        </div>
      </div>
    </div>
  )
}

function TaskRow({ task }: { task: Task }) {
  const status = statusConfig[task.status]
  const priority = priorityConfig[task.priority]
  const isOverdue = task.dueDate && new Date(task.dueDate) < new Date() &&
    task.status !== 'completed' && task.status !== 'cancelled'

  return (
    <Link
      to={`/admin/tasks/${task.id}`}
      className="flex items-center justify-between p-4 hover:bg-muted/30 transition-colors"
    >
      <div className="flex-1 min-w-0">
        <div className="flex items-center gap-2 mb-1">
          <span className={cn('text-xs px-2 py-0.5 rounded-full', status.bgColor, status.color)}>
            {status.label}
          </span>
          <span className={cn('text-xs font-medium', priority.color)}>
            {priority.label}
          </span>
          <span className="text-xs text-muted-foreground">
            {typeLabels[task.type]}
          </span>
        </div>
        <h3 className="font-medium truncate">{task.title}</h3>
        <p className="text-sm text-muted-foreground truncate">{task.description}</p>
        <div className="flex items-center gap-4 mt-2 text-xs text-muted-foreground">
          <span>{task.assignedTo.length} thôn được giao</span>
          {task.dueDate && (
            <span className={cn('flex items-center gap-1', isOverdue && 'text-red-600')}>
              <Calendar className="w-3 h-3" />
              {new Date(task.dueDate).toLocaleDateString('vi-VN')}
              {isOverdue && ' (Quá hạn)'}
            </span>
          )}
        </div>
      </div>
      <ChevronRight className="w-5 h-5 text-muted-foreground" />
    </Link>
  )
}
</file>

<file path="web/src/pages/admin/villages/[villageId].tsx">
import { useState } from 'react'
import { useParams, Link } from 'react-router-dom'
import { ArrowLeft, Building2, Users, Home, Phone, Edit2, UserPlus } from 'lucide-react'
import { AdminLayout } from '@/components/layout/admin-layout'
import { useVillage } from '@/hooks/use-villages'
import { useHouseholds } from '@/hooks/use-households'
import type { VillageRegion } from '@/types'

const regionLabels: Record<VillageRegion, string> = {
  dien_sanh_cu: 'Diên Sanh cũ',
  hai_truong: 'Hải Trường',
  hai_dinh: 'Hải Định',
}

export function VillageDetailPage() {
  const { villageId } = useParams<{ villageId: string }>()
  const { data: village, isLoading } = useVillage(villageId)
  const { data: households } = useHouseholds(villageId)
  const [showLeaderModal, setShowLeaderModal] = useState(false)

  if (isLoading) {
    return (
      <AdminLayout>
        <div className="animate-pulse space-y-6">
          <div className="h-8 w-48 bg-muted rounded" />
          <div className="h-32 bg-muted rounded-xl" />
        </div>
      </AdminLayout>
    )
  }

  if (!village) {
    return (
      <AdminLayout>
        <div className="text-center py-12">
          <p className="text-muted-foreground">Không tìm thấy thôn</p>
          <Link to="/admin/villages" className="text-primary-600 hover:underline mt-2 inline-block">
            Quay lại danh sách
          </Link>
        </div>
      </AdminLayout>
    )
  }

  return (
    <AdminLayout>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-center gap-4">
          <Link
            to="/admin/villages"
            className="p-2 hover:bg-muted rounded-lg transition-colors"
          >
            <ArrowLeft className="w-5 h-5" />
          </Link>
          <div>
            <h1 className="text-2xl font-bold">{village.name}</h1>
            <p className="text-muted-foreground">{regionLabels[village.region]}</p>
          </div>
        </div>

        {/* Stats Cards */}
        <div className="grid sm:grid-cols-3 gap-4">
          <div className="bg-card rounded-xl border p-5">
            <div className="flex items-center gap-3">
              <div className="p-2.5 bg-blue-50 text-blue-600 rounded-lg">
                <Home className="w-5 h-5" />
              </div>
              <div>
                <div className="text-2xl font-bold">{village.householdCount}</div>
                <div className="text-sm text-muted-foreground">Hộ gia đình</div>
              </div>
            </div>
          </div>
          <div className="bg-card rounded-xl border p-5">
            <div className="flex items-center gap-3">
              <div className="p-2.5 bg-green-50 text-green-600 rounded-lg">
                <Users className="w-5 h-5" />
              </div>
              <div>
                <div className="text-2xl font-bold">{village.residentCount}</div>
                <div className="text-sm text-muted-foreground">Nhân khẩu</div>
              </div>
            </div>
          </div>
          <div className="bg-card rounded-xl border p-5">
            <div className="flex items-center gap-3">
              <div className="p-2.5 bg-purple-50 text-purple-600 rounded-lg">
                <Building2 className="w-5 h-5" />
              </div>
              <div>
                <div className="text-2xl font-bold">
                  {village.householdCount > 0
                    ? (village.residentCount / village.householdCount).toFixed(1)
                    : 0}
                </div>
                <div className="text-sm text-muted-foreground">Người/hộ</div>
              </div>
            </div>
          </div>
        </div>

        {/* Leader Info */}
        <div className="bg-card rounded-xl border p-5">
          <div className="flex items-center justify-between mb-4">
            <h2 className="font-semibold">Trưởng thôn</h2>
            <button
              onClick={() => setShowLeaderModal(true)}
              className="flex items-center gap-1.5 text-sm text-primary-600 hover:underline"
            >
              {village.leaderId ? <Edit2 className="w-4 h-4" /> : <UserPlus className="w-4 h-4" />}
              {village.leaderId ? 'Thay đổi' : 'Chỉ định'}
            </button>
          </div>
          {village.leaderName ? (
            <div className="flex items-center gap-4">
              <div className="w-12 h-12 bg-primary-100 rounded-full flex items-center justify-center">
                <Users className="w-6 h-6 text-primary-600" />
              </div>
              <div>
                <div className="font-medium">{village.leaderName}</div>
                {village.leaderPhone && (
                  <div className="flex items-center gap-1.5 text-sm text-muted-foreground">
                    <Phone className="w-4 h-4" />
                    {village.leaderPhone}
                  </div>
                )}
              </div>
            </div>
          ) : (
            <p className="text-muted-foreground">Chưa có trưởng thôn</p>
          )}
        </div>

        {/* Households Preview */}
        <div className="bg-card rounded-xl border">
          <div className="p-4 border-b flex items-center justify-between">
            <h2 className="font-semibold">Hộ gia đình</h2>
            <Link
              to={`/admin/villages/${villageId}/households`}
              className="text-sm text-primary-600 hover:underline"
            >
              Xem tất cả
            </Link>
          </div>
          <div className="divide-y">
            {households?.slice(0, 5).map((household) => (
              <Link
                key={household.id}
                to={`/admin/villages/${villageId}/households/${household.id}`}
                className="flex items-center justify-between p-4 hover:bg-muted/50 transition-colors"
              >
                <div>
                  <div className="font-medium">{household.headName}</div>
                  <div className="text-sm text-muted-foreground">{household.address}</div>
                </div>
                <div className="text-sm text-muted-foreground">
                  {household.memberCount} người
                </div>
              </Link>
            ))}
            {(!households || households.length === 0) && (
              <div className="p-8 text-center text-muted-foreground">
                Chưa có hộ gia đình nào
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Leader Assignment Modal - TODO: Implement */}
      {showLeaderModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
          <div className="bg-card rounded-xl p-6 w-full max-w-md mx-4">
            <h3 className="text-lg font-semibold mb-4">Chỉ định trưởng thôn</h3>
            <p className="text-muted-foreground mb-4">
              Tính năng đang được phát triển...
            </p>
            <button
              onClick={() => setShowLeaderModal(false)}
              className="w-full py-2 bg-muted rounded-lg hover:bg-muted/80"
            >
              Đóng
            </button>
          </div>
        </div>
      )}
    </AdminLayout>
  )
}
</file>

<file path="web/src/pages/admin/villages/index.tsx">
import { useState } from 'react'
import { Link } from 'react-router-dom'
import { Building2, Users, Home, Search, ChevronRight } from 'lucide-react'
import { AdminLayout } from '@/components/layout/admin-layout'
import { useVillages } from '@/hooks/use-villages'
import { cn } from '@/lib/utils'
import type { Village, VillageRegion } from '@/types'

const regionLabels: Record<VillageRegion, string> = {
  dien_sanh_cu: 'Diên Sanh cũ',
  hai_truong: 'Hải Trường',
  hai_dinh: 'Hải Định',
}

const regionColors: Record<VillageRegion, string> = {
  dien_sanh_cu: 'bg-blue-100 text-blue-700',
  hai_truong: 'bg-green-100 text-green-700',
  hai_dinh: 'bg-purple-100 text-purple-700',
}

export function VillagesPage() {
  const { data: villages, isLoading } = useVillages()
  const [search, setSearch] = useState('')
  const [regionFilter, setRegionFilter] = useState<VillageRegion | 'all'>('all')

  // Filter villages
  const filteredVillages = villages?.filter((village) => {
    const matchesSearch = village.name.toLowerCase().includes(search.toLowerCase()) ||
      village.code.toLowerCase().includes(search.toLowerCase())
    const matchesRegion = regionFilter === 'all' || village.region === regionFilter
    return matchesSearch && matchesRegion
  })

  // Group by region for stats
  const regionStats = villages?.reduce((acc, v) => {
    acc[v.region] = (acc[v.region] || 0) + 1
    return acc
  }, {} as Record<string, number>)

  return (
    <AdminLayout>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          <div>
            <h1 className="text-2xl font-bold">Quản lý thôn</h1>
            <p className="text-muted-foreground">
              {villages?.length || 0} thôn/KDC
            </p>
          </div>
        </div>

        {/* Region Filter */}
        <div className="flex flex-wrap gap-2">
          <button
            onClick={() => setRegionFilter('all')}
            className={cn(
              'px-4 py-2 rounded-lg text-sm font-medium transition-colors',
              regionFilter === 'all'
                ? 'bg-primary-600 text-white'
                : 'bg-muted hover:bg-muted/80'
            )}
          >
            Tất cả ({villages?.length || 0})
          </button>
          {(['dien_sanh_cu', 'hai_truong', 'hai_dinh'] as VillageRegion[]).map((region) => (
            <button
              key={region}
              onClick={() => setRegionFilter(region)}
              className={cn(
                'px-4 py-2 rounded-lg text-sm font-medium transition-colors',
                regionFilter === region
                  ? 'bg-primary-600 text-white'
                  : 'bg-muted hover:bg-muted/80'
              )}
            >
              {regionLabels[region]} ({regionStats?.[region] || 0})
            </button>
          ))}
        </div>

        {/* Search */}
        <div className="relative">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground" />
          <input
            type="text"
            placeholder="Tìm kiếm thôn..."
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            className="w-full pl-10 pr-4 py-2.5 rounded-lg border bg-background focus:outline-none focus:ring-2 focus:ring-primary-500"
          />
        </div>

        {/* Village Grid */}
        {isLoading ? (
          <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
            {[...Array(6)].map((_, i) => (
              <div key={i} className="bg-card rounded-xl border p-5 animate-pulse">
                <div className="h-5 w-32 bg-muted rounded mb-3" />
                <div className="h-4 w-20 bg-muted rounded mb-4" />
                <div className="flex gap-4">
                  <div className="h-4 w-16 bg-muted rounded" />
                  <div className="h-4 w-16 bg-muted rounded" />
                </div>
              </div>
            ))}
          </div>
        ) : filteredVillages?.length === 0 ? (
          <div className="text-center py-12 text-muted-foreground">
            Không tìm thấy thôn nào
          </div>
        ) : (
          <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
            {filteredVillages?.map((village) => (
              <VillageCard key={village.id} village={village} />
            ))}
          </div>
        )}
      </div>
    </AdminLayout>
  )
}

function VillageCard({ village }: { village: Village }) {
  return (
    <Link
      to={`/admin/villages/${village.id}`}
      className="bg-card rounded-xl border p-5 hover:border-primary-300 hover:shadow-md transition-all group"
    >
      <div className="flex items-start justify-between">
        <div className="flex items-center gap-3">
          <div className="p-2.5 bg-primary-50 text-primary-600 rounded-lg">
            <Building2 className="w-5 h-5" />
          </div>
          <div>
            <h3 className="font-semibold">{village.name}</h3>
            <span className={cn(
              'text-xs px-2 py-0.5 rounded-full',
              regionColors[village.region]
            )}>
              {regionLabels[village.region]}
            </span>
          </div>
        </div>
        <ChevronRight className="w-5 h-5 text-muted-foreground group-hover:text-primary-600 transition-colors" />
      </div>

      <div className="mt-4 flex items-center gap-4 text-sm text-muted-foreground">
        <div className="flex items-center gap-1.5">
          <Home className="w-4 h-4" />
          <span>{village.householdCount} hộ</span>
        </div>
        <div className="flex items-center gap-1.5">
          <Users className="w-4 h-4" />
          <span>{village.residentCount} người</span>
        </div>
      </div>

      {village.leaderName && (
        <div className="mt-3 pt-3 border-t text-sm">
          <span className="text-muted-foreground">Trưởng thôn: </span>
          <span className="font-medium">{village.leaderName}</span>
        </div>
      )}
    </Link>
  )
}
</file>

<file path="web/src/pages/admin/dashboard.tsx">
import { Building2, Home, Users, ClipboardList, FileText, MessageSquare } from 'lucide-react'
import { AdminLayout } from '@/components/layout/admin-layout'
import { StatsCard } from '@/components/dashboard/stats-card'
import { StatsGrid } from '@/components/dashboard/stats-grid'
import { ActivityFeed } from '@/components/dashboard/activity-feed'
import { PendingTasks } from '@/components/dashboard/pending-tasks'
import { QuickActions } from '@/components/dashboard/quick-actions'
import { useDashboardStats } from '@/hooks/use-dashboard-stats'
import { formatDateTime } from '@/lib/utils'

export function AdminDashboardPage() {
  const { data: stats, isLoading } = useDashboardStats()

  return (
    <AdminLayout>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
          <h1 className="text-2xl font-bold">Tổng quan</h1>
          <div className="text-sm text-muted-foreground">
            Cập nhật: {formatDateTime(new Date())}
          </div>
        </div>

        {/* Stats Grid */}
        <StatsGrid>
          <StatsCard
            title="Số thôn/KDC"
            value={stats?.villageCount ?? 0}
            icon={<Building2 className="w-5 h-5" />}
            loading={isLoading}
          />
          <StatsCard
            title="Hộ gia đình"
            value={stats?.householdCount ?? 0}
            icon={<Home className="w-5 h-5" />}
            loading={isLoading}
          />
          <StatsCard
            title="Nhân khẩu"
            value={stats?.residentCount ?? 0}
            icon={<Users className="w-5 h-5" />}
            loading={isLoading}
          />
          <StatsCard
            title="Việc cần làm"
            value={stats?.pendingTasks ?? 0}
            icon={<ClipboardList className="w-5 h-5" />}
            loading={isLoading}
          />
        </StatsGrid>

        {/* Secondary Stats */}
        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <StatsCard
            title="Yêu cầu chờ xử lý"
            value={stats?.pendingRequests ?? 0}
            icon={<FileText className="w-5 h-5" />}
            loading={isLoading}
          />
          <StatsCard
            title="SMS đã gửi"
            value={stats?.sentMessages ?? 0}
            icon={<MessageSquare className="w-5 h-5" />}
            loading={isLoading}
          />
        </div>

        {/* Activity and Tasks */}
        <div className="grid lg:grid-cols-2 gap-6">
          <ActivityFeed />
          <PendingTasks />
        </div>

        {/* Quick Actions */}
        <QuickActions />
      </div>
    </AdminLayout>
  )
}
</file>

<file path="web/src/pages/portal/announcements.tsx">
import { useState } from 'react'
import { Link } from 'react-router-dom'
import { ArrowLeft, Bell, Calendar, ChevronRight } from 'lucide-react'
import { useQuery } from '@tanstack/react-query'
import { collection, getDocs, query, orderBy, where, limit } from 'firebase/firestore'
import { db } from '@/config/firebase'
import { cn } from '@/lib/utils'
import type { Announcement } from '@/types'

export function AnnouncementsPage() {
  const { data: announcements, isLoading } = useQuery({
    queryKey: ['announcements', 'public'],
    queryFn: async () => {
      const now = new Date()
      const q = query(
        collection(db, 'announcements'),
        where('isPublic', '==', true),
        orderBy('publishedAt', 'desc'),
        limit(20)
      )
      const snapshot = await getDocs(q)
      return snapshot.docs
        .map((doc) => ({
          id: doc.id,
          ...doc.data(),
          publishedAt: doc.data().publishedAt?.toDate(),
          expiresAt: doc.data().expiresAt?.toDate(),
          createdAt: doc.data().createdAt?.toDate(),
        }))
        .filter((a) => !a.expiresAt || a.expiresAt > now) as Announcement[]
    },
  })

  return (
    <div className="min-h-screen bg-muted/30">
      {/* Header */}
      <header className="bg-white border-b sticky top-0 z-10">
        <div className="max-w-4xl mx-auto px-4 py-4 flex items-center gap-4">
          <Link to="/portal" className="p-2 hover:bg-muted rounded-lg">
            <ArrowLeft className="w-5 h-5" />
          </Link>
          <div>
            <h1 className="text-lg font-bold">Thông báo</h1>
            <p className="text-xs text-muted-foreground">UBND Xã Diên Sanh</p>
          </div>
        </div>
      </header>

      {/* Content */}
      <div className="max-w-4xl mx-auto px-4 py-6">
        <div className="bg-white rounded-xl border divide-y">
          {isLoading ? (
            [...Array(3)].map((_, i) => (
              <div key={i} className="p-4 animate-pulse">
                <div className="h-5 w-3/4 bg-muted rounded mb-2" />
                <div className="h-4 w-1/2 bg-muted rounded" />
              </div>
            ))
          ) : announcements?.length === 0 ? (
            <div className="p-8 text-center text-muted-foreground">
              <Bell className="w-12 h-12 mx-auto mb-3 opacity-50" />
              <p>Chưa có thông báo nào</p>
            </div>
          ) : (
            announcements?.map((announcement) => (
              <AnnouncementItem key={announcement.id} announcement={announcement} />
            ))
          )}
        </div>
      </div>
    </div>
  )
}

function AnnouncementItem({ announcement }: { announcement: Announcement }) {
  const [expanded, setExpanded] = useState(false)

  return (
    <div className="p-4">
      <button
        onClick={() => setExpanded(!expanded)}
        className="w-full text-left"
      >
        <div className="flex items-start justify-between gap-4">
          <div className="flex-1">
            <h3 className="font-medium">{announcement.title}</h3>
            <div className="flex items-center gap-2 text-xs text-muted-foreground mt-1">
              <Calendar className="w-3 h-3" />
              {announcement.publishedAt?.toLocaleDateString('vi-VN')}
            </div>
          </div>
          <ChevronRight className={cn(
            'w-5 h-5 text-muted-foreground transition-transform',
            expanded && 'rotate-90'
          )} />
        </div>
      </button>
      {expanded && (
        <div className="mt-3 pt-3 border-t">
          <p className="text-sm text-muted-foreground whitespace-pre-wrap">
            {announcement.content}
          </p>
        </div>
      )}
    </div>
  )
}
</file>

<file path="web/src/pages/portal/chatbot.tsx">
import { useState, useRef, useEffect } from 'react'
import { Link } from 'react-router-dom'
import { ArrowLeft, Send, Bot, User, Loader2 } from 'lucide-react'
import { cn } from '@/lib/utils'

interface Message {
  id: string
  role: 'user' | 'assistant'
  content: string
  timestamp: Date
}

// Simple FAQ-based responses
const faqResponses: Record<string, string> = {
  'xin chào': 'Xin chào! Tôi là trợ lý ảo của UBND xã Diên Sanh. Tôi có thể giúp bạn:\n- Hướng dẫn thủ tục hành chính\n- Tra cứu thông tin liên hệ\n- Giải đáp thắc mắc chung\n\nBạn cần hỗ trợ gì?',
  'giờ làm việc': 'Giờ làm việc của UBND xã Diên Sanh:\n- Thứ 2 đến Thứ 6\n- Sáng: 7:30 - 11:30\n- Chiều: 13:30 - 17:00\n\nNghỉ thứ 7, Chủ nhật và các ngày lễ.',
  'địa chỉ': 'Địa chỉ: UBND xã Diên Sanh, Huyện Hải Lăng, Tỉnh Quảng Trị.\n\nĐiện thoại: 0233.xxx.xxx\nEmail: ubnd.diensanh@quangtri.gov.vn',
  'xác nhận cư trú': 'Để xin giấy xác nhận cư trú, bạn cần:\n1. CMND/CCCD bản gốc\n2. Sổ hộ khẩu bản gốc\n3. Đơn xin xác nhận (có mẫu tại UBND xã)\n\nThời gian giải quyết: 1-2 ngày làm việc.\nLệ phí: Miễn phí.',
  'đăng ký kết hôn': 'Thủ tục đăng ký kết hôn:\n1. Tờ khai đăng ký kết hôn (theo mẫu)\n2. CMND/CCCD của hai bên\n3. Giấy xác nhận tình trạng hôn nhân\n\nThời gian: 3-5 ngày làm việc.\nLệ phí: Theo quy định.',
  'khai sinh': 'Thủ tục đăng ký khai sinh:\n1. Giấy chứng sinh (từ bệnh viện)\n2. CMND/CCCD của cha mẹ\n3. Sổ hộ khẩu\n4. Giấy đăng ký kết hôn (nếu có)\n\nThời gian: 1-2 ngày làm việc.\nLệ phí: Miễn phí.',
  'khai tử': 'Thủ tục đăng ký khai tử:\n1. Giấy báo tử hoặc giấy chứng tử\n2. CMND/CCCD người khai\n3. Sổ hộ khẩu\n\nThời gian: 1 ngày làm việc.\nLệ phí: Miễn phí.',
}

function findResponse(input: string): string {
  const normalized = input.toLowerCase().trim()

  for (const [key, response] of Object.entries(faqResponses)) {
    if (normalized.includes(key)) {
      return response
    }
  }

  // Default response
  return 'Xin lỗi, tôi chưa có thông tin về vấn đề này. Bạn có thể:\n\n1. Gọi điện: 0233.xxx.xxx\n2. Đến trực tiếp UBND xã\n3. Gửi yêu cầu qua mục "Gửi yêu cầu"\n\nHoặc thử hỏi về:\n- Giờ làm việc\n- Địa chỉ liên hệ\n- Xác nhận cư trú\n- Đăng ký kết hôn\n- Khai sinh, khai tử'
}

export function ChatbotPage() {
  const [messages, setMessages] = useState<Message[]>([
    {
      id: '1',
      role: 'assistant',
      content: 'Xin chào! Tôi là trợ lý ảo của UBND xã Diên Sanh. Tôi có thể giúp bạn tìm hiểu về các thủ tục hành chính, giờ làm việc, và thông tin liên hệ. Bạn cần hỗ trợ gì?',
      timestamp: new Date(),
    },
  ])
  const [input, setInput] = useState('')
  const [isTyping, setIsTyping] = useState(false)
  const messagesEndRef = useRef<HTMLDivElement>(null)

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' })
  }

  useEffect(() => {
    scrollToBottom()
  }, [messages])

  const handleSend = async () => {
    if (!input.trim()) return

    const userMessage: Message = {
      id: Date.now().toString(),
      role: 'user',
      content: input.trim(),
      timestamp: new Date(),
    }

    setMessages((prev) => [...prev, userMessage])
    setInput('')
    setIsTyping(true)

    // Simulate typing delay
    await new Promise((resolve) => setTimeout(resolve, 800 + Math.random() * 500))

    const response = findResponse(input)
    const assistantMessage: Message = {
      id: (Date.now() + 1).toString(),
      role: 'assistant',
      content: response,
      timestamp: new Date(),
    }

    setMessages((prev) => [...prev, assistantMessage])
    setIsTyping(false)
  }

  const handleKeyPress = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault()
      handleSend()
    }
  }

  return (
    <div className="min-h-screen bg-muted/30 flex flex-col">
      {/* Header */}
      <header className="bg-white border-b sticky top-0 z-10">
        <div className="max-w-4xl mx-auto px-4 py-4 flex items-center gap-4">
          <Link to="/portal" className="p-2 hover:bg-muted rounded-lg">
            <ArrowLeft className="w-5 h-5" />
          </Link>
          <div className="flex items-center gap-3">
            <div className="p-2 bg-primary-100 text-primary-600 rounded-lg">
              <Bot className="w-5 h-5" />
            </div>
            <div>
              <h1 className="text-lg font-bold">Trợ lý ảo</h1>
              <p className="text-xs text-muted-foreground">Hỗ trợ 24/7</p>
            </div>
          </div>
        </div>
      </header>

      {/* Messages */}
      <div className="flex-1 overflow-y-auto">
        <div className="max-w-4xl mx-auto px-4 py-6 space-y-4">
          {messages.map((message) => (
            <div
              key={message.id}
              className={cn(
                'flex gap-3',
                message.role === 'user' && 'flex-row-reverse'
              )}
            >
              <div className={cn(
                'w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0',
                message.role === 'assistant' ? 'bg-primary-100 text-primary-600' : 'bg-muted'
              )}>
                {message.role === 'assistant' ? (
                  <Bot className="w-4 h-4" />
                ) : (
                  <User className="w-4 h-4" />
                )}
              </div>
              <div className={cn(
                'max-w-[80%] rounded-2xl px-4 py-3',
                message.role === 'assistant'
                  ? 'bg-white border'
                  : 'bg-primary-600 text-white'
              )}>
                <p className="text-sm whitespace-pre-wrap">{message.content}</p>
                <p className={cn(
                  'text-xs mt-1',
                  message.role === 'assistant' ? 'text-muted-foreground' : 'text-primary-200'
                )}>
                  {message.timestamp.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' })}
                </p>
              </div>
            </div>
          ))}
          {isTyping && (
            <div className="flex gap-3">
              <div className="w-8 h-8 rounded-full bg-primary-100 text-primary-600 flex items-center justify-center">
                <Bot className="w-4 h-4" />
              </div>
              <div className="bg-white border rounded-2xl px-4 py-3">
                <div className="flex gap-1">
                  <span className="w-2 h-2 bg-muted-foreground rounded-full animate-bounce" style={{ animationDelay: '0ms' }} />
                  <span className="w-2 h-2 bg-muted-foreground rounded-full animate-bounce" style={{ animationDelay: '150ms' }} />
                  <span className="w-2 h-2 bg-muted-foreground rounded-full animate-bounce" style={{ animationDelay: '300ms' }} />
                </div>
              </div>
            </div>
          )}
          <div ref={messagesEndRef} />
        </div>
      </div>

      {/* Input */}
      <div className="bg-white border-t sticky bottom-0">
        <div className="max-w-4xl mx-auto px-4 py-4">
          <div className="flex gap-3">
            <input
              type="text"
              value={input}
              onChange={(e) => setInput(e.target.value)}
              onKeyPress={handleKeyPress}
              placeholder="Nhập câu hỏi của bạn..."
              className="flex-1 px-4 py-3 rounded-full border bg-muted/50 focus:outline-none focus:ring-2 focus:ring-primary-500"
            />
            <button
              onClick={handleSend}
              disabled={!input.trim() || isTyping}
              className={cn(
                'p-3 rounded-full transition-colors',
                'bg-primary-600 text-white hover:bg-primary-700',
                'disabled:opacity-50 disabled:cursor-not-allowed'
              )}
            >
              {isTyping ? (
                <Loader2 className="w-5 h-5 animate-spin" />
              ) : (
                <Send className="w-5 h-5" />
              )}
            </button>
          </div>
          <p className="text-xs text-muted-foreground text-center mt-2">
            Trợ lý ảo có thể mắc lỗi. Vui lòng xác minh thông tin quan trọng.
          </p>
        </div>
      </div>
    </div>
  )
}
</file>

<file path="web/src/pages/portal/index.tsx">
import { Link } from 'react-router-dom'
import { MessageSquare, FileText, Bell, HelpCircle } from 'lucide-react'

export function PortalHomePage() {
  return (
    <div className="min-h-screen bg-gradient-to-b from-primary-50 to-white">
      {/* Header */}
      <header className="bg-white border-b sticky top-0 z-10">
        <div className="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
          <div>
            <h1 className="text-lg font-bold text-primary-700">UBND Xã Diên Sanh</h1>
            <p className="text-xs text-muted-foreground">Cổng thông tin điện tử</p>
          </div>
          <Link
            to="/login"
            className="text-sm text-primary-600 hover:underline"
          >
            Đăng nhập
          </Link>
        </div>
      </header>

      {/* Hero */}
      <div className="bg-primary-600 text-white py-12 px-4">
        <div className="max-w-4xl mx-auto text-center">
          <h2 className="text-2xl font-bold mb-2">Xin chào!</h2>
          <p className="text-primary-100">
            Chào mừng bạn đến với cổng thông tin điện tử xã Diên Sanh
          </p>
        </div>
      </div>

      {/* Quick Actions */}
      <div className="max-w-4xl mx-auto px-4 -mt-6">
        <div className="grid grid-cols-2 gap-4">
          <Link
            to="/portal/announcements"
            className="bg-white rounded-xl border shadow-sm p-5 hover:shadow-md transition-shadow"
          >
            <div className="p-3 bg-blue-50 text-blue-600 rounded-lg w-fit mb-3">
              <Bell className="w-6 h-6" />
            </div>
            <h3 className="font-semibold mb-1">Thông báo</h3>
            <p className="text-sm text-muted-foreground">Xem các thông báo mới nhất</p>
          </Link>

          <Link
            to="/portal/requests/new"
            className="bg-white rounded-xl border shadow-sm p-5 hover:shadow-md transition-shadow"
          >
            <div className="p-3 bg-green-50 text-green-600 rounded-lg w-fit mb-3">
              <FileText className="w-6 h-6" />
            </div>
            <h3 className="font-semibold mb-1">Gửi yêu cầu</h3>
            <p className="text-sm text-muted-foreground">Gửi đơn, kiến nghị, phản ánh</p>
          </Link>

          <Link
            to="/portal/requests"
            className="bg-white rounded-xl border shadow-sm p-5 hover:shadow-md transition-shadow"
          >
            <div className="p-3 bg-purple-50 text-purple-600 rounded-lg w-fit mb-3">
              <MessageSquare className="w-6 h-6" />
            </div>
            <h3 className="font-semibold mb-1">Tra cứu</h3>
            <p className="text-sm text-muted-foreground">Tra cứu tình trạng yêu cầu</p>
          </Link>

          <Link
            to="/portal/chatbot"
            className="bg-white rounded-xl border shadow-sm p-5 hover:shadow-md transition-shadow"
          >
            <div className="p-3 bg-orange-50 text-orange-600 rounded-lg w-fit mb-3">
              <HelpCircle className="w-6 h-6" />
            </div>
            <h3 className="font-semibold mb-1">Hỏi đáp</h3>
            <p className="text-sm text-muted-foreground">Chatbot hỗ trợ 24/7</p>
          </Link>
        </div>
      </div>

      {/* Info Section */}
      <div className="max-w-4xl mx-auto px-4 py-8">
        <div className="bg-white rounded-xl border p-5">
          <h3 className="font-semibold mb-4">Thông tin liên hệ</h3>
          <div className="space-y-3 text-sm">
            <div>
              <span className="text-muted-foreground">Địa chỉ:</span>
              <p>Xã Diên Sanh, Huyện Hải Lăng, Tỉnh Quảng Trị</p>
            </div>
            <div>
              <span className="text-muted-foreground">Điện thoại:</span>
              <p>0233.xxx.xxx</p>
            </div>
            <div>
              <span className="text-muted-foreground">Email:</span>
              <p>ubnd.diensanh@quangtri.gov.vn</p>
            </div>
            <div>
              <span className="text-muted-foreground">Giờ làm việc:</span>
              <p>Thứ 2 - Thứ 6: 7:30 - 11:30, 13:30 - 17:00</p>
            </div>
          </div>
        </div>
      </div>

      {/* Footer */}
      <footer className="bg-muted/50 border-t py-6 px-4">
        <div className="max-w-4xl mx-auto text-center text-sm text-muted-foreground">
          <p>© 2026 UBND Xã Diên Sanh. Bản quyền thuộc về UBND xã Diên Sanh.</p>
        </div>
      </footer>
    </div>
  )
}
</file>

<file path="web/src/pages/portal/request-form.tsx">
import { useState } from 'react'
import { Link } from 'react-router-dom'
import { ArrowLeft, Send, Loader2, CheckCircle } from 'lucide-react'
import { addDoc, collection, serverTimestamp } from 'firebase/firestore'
import { db } from '@/config/firebase'
import { cn } from '@/lib/utils'
import type { RequestType } from '@/types'

const requestTypes: { value: RequestType; label: string; description: string }[] = [
  { value: 'certificate', label: 'Xin giấy xác nhận', description: 'Xác nhận cư trú, hộ khẩu, tình trạng hôn nhân...' },
  { value: 'complaint', label: 'Khiếu nại', description: 'Khiếu nại về quyết định hành chính...' },
  { value: 'suggestion', label: 'Kiến nghị', description: 'Đề xuất, góp ý về các vấn đề địa phương...' },
  { value: 'other', label: 'Khác', description: 'Các yêu cầu khác...' },
]

export function RequestFormPage() {
  const [submitted, setSubmitted] = useState(false)
  const [submitting, setSubmitting] = useState(false)
  const [formData, setFormData] = useState({
    type: 'certificate' as RequestType,
    title: '',
    content: '',
    submitterName: '',
    submitterPhone: '',
  })
  const [errors, setErrors] = useState<Record<string, string>>({})

  const validate = () => {
    const newErrors: Record<string, string> = {}
    if (!formData.title.trim()) newErrors.title = 'Vui lòng nhập tiêu đề'
    if (!formData.content.trim()) newErrors.content = 'Vui lòng nhập nội dung'
    if (!formData.submitterName.trim()) newErrors.submitterName = 'Vui lòng nhập họ tên'
    if (!formData.submitterPhone.trim()) newErrors.submitterPhone = 'Vui lòng nhập số điện thoại'
    if (formData.submitterPhone && !/^0[0-9]{9}$/.test(formData.submitterPhone)) {
      newErrors.submitterPhone = 'Số điện thoại không hợp lệ'
    }
    setErrors(newErrors)
    return Object.keys(newErrors).length === 0
  }

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    if (!validate()) return

    setSubmitting(true)
    try {
      await addDoc(collection(db, 'requests'), {
        ...formData,
        status: 'pending',
        submittedBy: formData.submitterPhone,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
      })
      setSubmitted(true)
    } catch (error) {
      console.error('Failed to submit request:', error)
      alert('Gửi yêu cầu thất bại. Vui lòng thử lại.')
    } finally {
      setSubmitting(false)
    }
  }

  if (submitted) {
    return (
      <div className="min-h-screen bg-muted/30 flex items-center justify-center p-4">
        <div className="bg-white rounded-xl border p-8 max-w-md w-full text-center">
          <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <CheckCircle className="w-8 h-8 text-green-600" />
          </div>
          <h2 className="text-xl font-bold mb-2">Gửi yêu cầu thành công!</h2>
          <p className="text-muted-foreground mb-6">
            Yêu cầu của bạn đã được ghi nhận. Chúng tôi sẽ liên hệ qua số điện thoại {formData.submitterPhone}.
          </p>
          <div className="flex gap-3">
            <Link
              to="/portal"
              className="flex-1 py-2.5 bg-muted rounded-lg hover:bg-muted/80 transition-colors"
            >
              Về trang chủ
            </Link>
            <button
              onClick={() => {
                setSubmitted(false)
                setFormData({ type: 'certificate', title: '', content: '', submitterName: '', submitterPhone: '' })
              }}
              className="flex-1 py-2.5 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors"
            >
              Gửi yêu cầu khác
            </button>
          </div>
        </div>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-muted/30">
      {/* Header */}
      <header className="bg-white border-b sticky top-0 z-10">
        <div className="max-w-4xl mx-auto px-4 py-4 flex items-center gap-4">
          <Link to="/portal" className="p-2 hover:bg-muted rounded-lg">
            <ArrowLeft className="w-5 h-5" />
          </Link>
          <div>
            <h1 className="text-lg font-bold">Gửi yêu cầu</h1>
            <p className="text-xs text-muted-foreground">UBND Xã Diên Sanh</p>
          </div>
        </div>
      </header>

      {/* Form */}
      <form onSubmit={handleSubmit} className="max-w-4xl mx-auto px-4 py-6 space-y-6">
        {/* Request Type */}
        <div className="bg-white rounded-xl border p-5">
          <label className="block text-sm font-medium mb-3">Loại yêu cầu</label>
          <div className="grid sm:grid-cols-2 gap-3">
            {requestTypes.map((type) => (
              <button
                key={type.value}
                type="button"
                onClick={() => setFormData({ ...formData, type: type.value })}
                className={cn(
                  'p-4 rounded-lg border text-left transition-colors',
                  formData.type === type.value
                    ? 'border-primary-500 bg-primary-50'
                    : 'hover:bg-muted/50'
                )}
              >
                <div className="font-medium">{type.label}</div>
                <div className="text-xs text-muted-foreground mt-1">{type.description}</div>
              </button>
            ))}
          </div>
        </div>

        {/* Request Details */}
        <div className="bg-white rounded-xl border p-5 space-y-4">
          <h3 className="font-medium">Nội dung yêu cầu</h3>

          <div>
            <label className="block text-sm font-medium mb-1.5">
              Tiêu đề <span className="text-red-500">*</span>
            </label>
            <input
              type="text"
              value={formData.title}
              onChange={(e) => setFormData({ ...formData, title: e.target.value })}
              placeholder="VD: Xin giấy xác nhận cư trú"
              className={cn(
                'w-full px-3 py-2.5 rounded-lg border bg-background',
                'focus:outline-none focus:ring-2 focus:ring-primary-500',
                errors.title && 'border-red-500'
              )}
            />
            {errors.title && <p className="text-sm text-red-500 mt-1">{errors.title}</p>}
          </div>

          <div>
            <label className="block text-sm font-medium mb-1.5">
              Nội dung chi tiết <span className="text-red-500">*</span>
            </label>
            <textarea
              value={formData.content}
              onChange={(e) => setFormData({ ...formData, content: e.target.value })}
              rows={5}
              placeholder="Mô tả chi tiết yêu cầu của bạn..."
              className={cn(
                'w-full px-3 py-2.5 rounded-lg border bg-background resize-none',
                'focus:outline-none focus:ring-2 focus:ring-primary-500',
                errors.content && 'border-red-500'
              )}
            />
            {errors.content && <p className="text-sm text-red-500 mt-1">{errors.content}</p>}
          </div>
        </div>

        {/* Contact Info */}
        <div className="bg-white rounded-xl border p-5 space-y-4">
          <h3 className="font-medium">Thông tin liên hệ</h3>

          <div>
            <label className="block text-sm font-medium mb-1.5">
              Họ và tên <span className="text-red-500">*</span>
            </label>
            <input
              type="text"
              value={formData.submitterName}
              onChange={(e) => setFormData({ ...formData, submitterName: e.target.value })}
              placeholder="Nguyễn Văn A"
              className={cn(
                'w-full px-3 py-2.5 rounded-lg border bg-background',
                'focus:outline-none focus:ring-2 focus:ring-primary-500',
                errors.submitterName && 'border-red-500'
              )}
            />
            {errors.submitterName && <p className="text-sm text-red-500 mt-1">{errors.submitterName}</p>}
          </div>

          <div>
            <label className="block text-sm font-medium mb-1.5">
              Số điện thoại <span className="text-red-500">*</span>
            </label>
            <input
              type="tel"
              value={formData.submitterPhone}
              onChange={(e) => setFormData({ ...formData, submitterPhone: e.target.value.replace(/\D/g, '') })}
              placeholder="0912345678"
              maxLength={10}
              className={cn(
                'w-full px-3 py-2.5 rounded-lg border bg-background',
                'focus:outline-none focus:ring-2 focus:ring-primary-500',
                errors.submitterPhone && 'border-red-500'
              )}
            />
            {errors.submitterPhone && <p className="text-sm text-red-500 mt-1">{errors.submitterPhone}</p>}
            <p className="text-xs text-muted-foreground mt-1">
              Chúng tôi sẽ liên hệ qua số này để thông báo kết quả
            </p>
          </div>
        </div>

        {/* Submit */}
        <button
          type="submit"
          disabled={submitting}
          className={cn(
            'w-full flex items-center justify-center gap-2 py-3 rounded-lg',
            'bg-primary-600 text-white hover:bg-primary-700 transition-colors',
            'disabled:opacity-50 disabled:cursor-not-allowed'
          )}
        >
          {submitting ? (
            <Loader2 className="w-5 h-5 animate-spin" />
          ) : (
            <Send className="w-5 h-5" />
          )}
          Gửi yêu cầu
        </button>
      </form>
    </div>
  )
}
</file>

<file path="web/src/pages/village/dashboard.tsx">
import { Home, Users, ClipboardList, FileText } from 'lucide-react'
import { AdminLayout } from '@/components/layout/admin-layout'
import { StatsCard } from '@/components/dashboard/stats-card'
import { StatsGrid } from '@/components/dashboard/stats-grid'
import { ActivityFeed } from '@/components/dashboard/activity-feed'
import { PendingTasks } from '@/components/dashboard/pending-tasks'
import { QuickActions } from '@/components/dashboard/quick-actions'
import { useAuth } from '@/hooks/use-auth'
import { useVillage } from '@/hooks/use-villages'
import { formatDateTime } from '@/lib/utils'

export function VillageDashboardPage() {
  const { userDoc } = useAuth()
  const { data: village, isLoading } = useVillage(userDoc?.villageId)

  return (
    <AdminLayout>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
          <div>
            <h1 className="text-2xl font-bold">Tổng quan</h1>
            {village && (
              <p className="text-muted-foreground">{village.name}</p>
            )}
          </div>
          <div className="text-sm text-muted-foreground">
            Cập nhật: {formatDateTime(new Date())}
          </div>
        </div>

        {/* Stats Grid */}
        <StatsGrid>
          <StatsCard
            title="Hộ gia đình"
            value={village?.householdCount ?? 0}
            icon={<Home className="w-5 h-5" />}
            loading={isLoading}
          />
          <StatsCard
            title="Nhân khẩu"
            value={village?.residentCount ?? 0}
            icon={<Users className="w-5 h-5" />}
            loading={isLoading}
          />
          <StatsCard
            title="Việc cần làm"
            value={0}
            icon={<ClipboardList className="w-5 h-5" />}
            loading={isLoading}
          />
          <StatsCard
            title="Yêu cầu đã gửi"
            value={0}
            icon={<FileText className="w-5 h-5" />}
            loading={isLoading}
          />
        </StatsGrid>

        {/* Activity and Tasks */}
        <div className="grid lg:grid-cols-2 gap-6">
          <ActivityFeed />
          <PendingTasks />
        </div>

        {/* Quick Actions */}
        <QuickActions />
      </div>
    </AdminLayout>
  )
}
</file>

<file path="web/src/pages/dashboard.tsx">
import { useAuth } from '@/hooks/use-auth'

export function DashboardPage() {
  const { userDoc, logout } = useAuth()

  return (
    <div className="min-h-screen bg-muted">
      <header className="bg-card border-b px-6 py-4">
        <div className="flex items-center justify-between">
          <h1 className="text-xl font-bold">UBND xã Diên Sanh</h1>
          <div className="flex items-center gap-4">
            <span className="text-sm text-muted-foreground">
              {userDoc?.displayName}
            </span>
            <button
              onClick={logout}
              className="text-sm text-primary-600 hover:underline"
            >
              Đăng xuất
            </button>
          </div>
        </div>
      </header>

      <main className="p-6">
        <div className="bg-card rounded-lg p-6 shadow-sm">
          <h2 className="text-lg font-semibold mb-4">Tổng quan</h2>
          <p className="text-muted-foreground">
            Chào mừng bạn đến với hệ thống quản lý xã Diên Sanh.
          </p>
          <p className="text-sm text-muted-foreground mt-2">
            Vai trò: {userDoc?.role === 'commune_admin' ? 'Quản trị viên xã' :
                      userDoc?.role === 'village_leader' ? 'Trưởng thôn' : 'Cư dân'}
          </p>
        </div>
      </main>
    </div>
  )
}
</file>

<file path="web/src/pages/login.tsx">
import { LoginForm } from '@/components/auth/login-form'
import { useNavigate } from 'react-router-dom'
import { useAuth } from '@/hooks/use-auth'
import { useEffect } from 'react'

export function LoginPage() {
  const navigate = useNavigate()
  const { user, userDoc, loading } = useAuth()

  useEffect(() => {
    if (!loading && user && userDoc) {
      // Redirect based on role
      if (userDoc.role === 'commune_admin') {
        navigate('/admin')
      } else if (userDoc.role === 'village_leader') {
        navigate('/village')
      } else {
        navigate('/portal')
      }
    }
  }, [user, userDoc, loading, navigate])

  const handleSuccess = () => {
    // Auth context will handle redirect
  }

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-muted">
        <div className="animate-pulse text-muted-foreground">
          Đang tải...
        </div>
      </div>
    )
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-muted p-4">
      <LoginForm onSuccess={handleSuccess} />
    </div>
  )
}
</file>

<file path="web/src/pages/not-found.tsx">
import { Link } from 'react-router-dom'

export function NotFoundPage() {
  return (
    <div className="min-h-screen flex items-center justify-center bg-muted">
      <div className="text-center">
        <h1 className="text-6xl font-bold text-primary-600">404</h1>
        <p className="text-xl text-muted-foreground mt-4">
          Trang không tồn tại
        </p>
        <Link
          to="/"
          className="inline-block mt-6 px-6 py-3 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors"
        >
          Về trang chủ
        </Link>
      </div>
    </div>
  )
}
</file>

<file path="web/src/routes/index.tsx">
import { BrowserRouter, Routes, Route, Navigate } from 'react-router-dom'
import { lazy, Suspense, type ReactNode } from 'react'
import { useAuth } from '@/hooks/use-auth'

// Lazy load all pages for code splitting
const LoginPage = lazy(() => import('@/pages/login').then(m => ({ default: m.LoginPage })))
const AdminDashboardPage = lazy(() => import('@/pages/admin/dashboard').then(m => ({ default: m.AdminDashboardPage })))
const VillageDashboardPage = lazy(() => import('@/pages/village/dashboard').then(m => ({ default: m.VillageDashboardPage })))
const VillagesPage = lazy(() => import('@/pages/admin/villages/index').then(m => ({ default: m.VillagesPage })))
const VillageDetailPage = lazy(() => import('@/pages/admin/villages/[villageId]').then(m => ({ default: m.VillageDetailPage })))
const HouseholdsPage = lazy(() => import('@/pages/admin/households/index').then(m => ({ default: m.HouseholdsPage })))
const HouseholdDetailPage = lazy(() => import('@/pages/admin/households/[householdId]').then(m => ({ default: m.HouseholdDetailPage })))
const HouseholdFormPage = lazy(() => import('@/pages/admin/households/form').then(m => ({ default: m.HouseholdFormPage })))
const ResidentFormPage = lazy(() => import('@/pages/admin/residents/form').then(m => ({ default: m.ResidentFormPage })))
const SMSPage = lazy(() => import('@/pages/admin/sms/index').then(m => ({ default: m.SMSPage })))
const TasksPage = lazy(() => import('@/pages/admin/tasks/index').then(m => ({ default: m.TasksPage })))
const TaskDetailPage = lazy(() => import('@/pages/admin/tasks/[taskId]').then(m => ({ default: m.TaskDetailPage })))
const TaskFormPage = lazy(() => import('@/pages/admin/tasks/form').then(m => ({ default: m.TaskFormPage })))
const PortalHomePage = lazy(() => import('@/pages/portal/index').then(m => ({ default: m.PortalHomePage })))
const AnnouncementsPage = lazy(() => import('@/pages/portal/announcements').then(m => ({ default: m.AnnouncementsPage })))
const RequestFormPage = lazy(() => import('@/pages/portal/request-form').then(m => ({ default: m.RequestFormPage })))
const ChatbotPage = lazy(() => import('@/pages/portal/chatbot').then(m => ({ default: m.ChatbotPage })))
const NotFoundPage = lazy(() => import('@/pages/not-found').then(m => ({ default: m.NotFoundPage })))

// Loading fallback component
function PageLoader() {
  return (
    <div className="min-h-screen flex items-center justify-center bg-muted">
      <div className="animate-pulse text-muted-foreground">Đang tải...</div>
    </div>
  )
}

// Protected route wrapper
interface ProtectedRouteProps {
  children: ReactNode
  allowedRoles?: string[]
}

function ProtectedRoute({ children, allowedRoles }: ProtectedRouteProps) {
  const { user, userDoc, loading } = useAuth()

  if (loading) {
    return <PageLoader />
  }

  if (!user) {
    return <Navigate to="/login" replace />
  }

  if (allowedRoles && userDoc && !allowedRoles.includes(userDoc.role)) {
    if (userDoc.role === 'commune_admin') {
      return <Navigate to="/admin" replace />
    } else if (userDoc.role === 'village_leader') {
      return <Navigate to="/village" replace />
    } else {
      return <Navigate to="/portal" replace />
    }
  }

  return <>{children}</>
}

export function AppRoutes() {
  return (
    <BrowserRouter>
      <Suspense fallback={<PageLoader />}>
        <Routes>
          {/* Public routes */}
          <Route path="/login" element={<LoginPage />} />

          {/* Admin routes */}
          <Route
            path="/admin"
            element={
              <ProtectedRoute allowedRoles={['commune_admin']}>
                <AdminDashboardPage />
              </ProtectedRoute>
            }
          />
          <Route
            path="/admin/villages"
            element={
              <ProtectedRoute allowedRoles={['commune_admin']}>
                <VillagesPage />
              </ProtectedRoute>
            }
          />
          <Route
            path="/admin/villages/:villageId"
            element={
              <ProtectedRoute allowedRoles={['commune_admin']}>
                <VillageDetailPage />
              </ProtectedRoute>
            }
          />
          <Route
            path="/admin/villages/:villageId/households"
            element={
              <ProtectedRoute allowedRoles={['commune_admin']}>
                <HouseholdsPage />
              </ProtectedRoute>
            }
          />
          <Route
            path="/admin/villages/:villageId/households/new"
            element={
              <ProtectedRoute allowedRoles={['commune_admin']}>
                <HouseholdFormPage />
              </ProtectedRoute>
            }
          />
          <Route
            path="/admin/villages/:villageId/households/:householdId"
            element={
              <ProtectedRoute allowedRoles={['commune_admin']}>
                <HouseholdDetailPage />
              </ProtectedRoute>
            }
          />
          <Route
            path="/admin/villages/:villageId/households/:householdId/edit"
            element={
              <ProtectedRoute allowedRoles={['commune_admin']}>
                <HouseholdFormPage />
              </ProtectedRoute>
            }
          />
          <Route
            path="/admin/villages/:villageId/households/:householdId/residents/new"
            element={
              <ProtectedRoute allowedRoles={['commune_admin']}>
                <ResidentFormPage />
              </ProtectedRoute>
            }
          />
          <Route
            path="/admin/villages/:villageId/households/:householdId/residents/:residentId/edit"
            element={
              <ProtectedRoute allowedRoles={['commune_admin']}>
                <ResidentFormPage />
              </ProtectedRoute>
            }
          />
          <Route
            path="/admin/households"
            element={
              <ProtectedRoute allowedRoles={['commune_admin']}>
                <HouseholdsPage />
              </ProtectedRoute>
            }
          />
          <Route
            path="/admin/sms"
            element={
              <ProtectedRoute allowedRoles={['commune_admin']}>
                <SMSPage />
              </ProtectedRoute>
            }
          />
          <Route
            path="/admin/tasks"
            element={
              <ProtectedRoute allowedRoles={['commune_admin']}>
                <TasksPage />
              </ProtectedRoute>
            }
          />
          <Route
            path="/admin/tasks/new"
            element={
              <ProtectedRoute allowedRoles={['commune_admin']}>
                <TaskFormPage />
              </ProtectedRoute>
            }
          />
          <Route
            path="/admin/tasks/:taskId"
            element={
              <ProtectedRoute allowedRoles={['commune_admin']}>
                <TaskDetailPage />
              </ProtectedRoute>
            }
          />
          <Route
            path="/admin/tasks/:taskId/edit"
            element={
              <ProtectedRoute allowedRoles={['commune_admin']}>
                <TaskFormPage />
              </ProtectedRoute>
            }
          />
          <Route
            path="/admin/*"
            element={
              <ProtectedRoute allowedRoles={['commune_admin']}>
                <AdminDashboardPage />
              </ProtectedRoute>
            }
          />

          {/* Village leader routes */}
          <Route
            path="/village"
            element={
              <ProtectedRoute allowedRoles={['village_leader']}>
                <VillageDashboardPage />
              </ProtectedRoute>
            }
          />
          <Route
            path="/village/*"
            element={
              <ProtectedRoute allowedRoles={['village_leader']}>
                <VillageDashboardPage />
              </ProtectedRoute>
            }
          />

          {/* Public portal routes - no auth required */}
          <Route path="/portal" element={<PortalHomePage />} />
          <Route path="/portal/announcements" element={<AnnouncementsPage />} />
          <Route path="/portal/requests/new" element={<RequestFormPage />} />
          <Route path="/portal/chatbot" element={<ChatbotPage />} />

          {/* Default redirect */}
          <Route path="/" element={<Navigate to="/portal" replace />} />

          {/* 404 */}
          <Route path="*" element={<NotFoundPage />} />
        </Routes>
      </Suspense>
    </BrowserRouter>
  )
}
</file>

<file path="web/src/styles/globals.css">
@import "tailwindcss";

@theme {
  --font-sans: 'Be Vietnam Pro', 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;

  /* Line height tokens for Vietnamese text */
  --line-height-base: 1.6;
  --line-height-tight: 1.4;

  /* Primary colors - Vietnamese government blue */
  --color-primary-50: #eff6ff;
  --color-primary-100: #dbeafe;
  --color-primary-200: #bfdbfe;
  --color-primary-300: #93c5fd;
  --color-primary-400: #60a5fa;
  --color-primary-500: #3b82f6;
  --color-primary-600: #2563eb;
  --color-primary-700: oklch(60% 0.2 250);
  --color-primary-800: #1e40af;
  --color-primary-900: #1e3a8a;

  /* Semantic colors */
  --color-background: #ffffff;
  --color-foreground: #0f172a;
  --color-muted: oklch(0.87 0 0);
  --color-muted-foreground: #64748b;
  --color-border: #e2e8f0;
  --color-input: #e2e8f0;
  --color-ring: #3b82f6;

  /* Component colors */
  --color-card: #ffffff;
  --color-card-foreground: #0f172a;
  --color-popover: #ffffff;
  --color-popover-foreground: #0f172a;
  --color-secondary: #f1f5f9;
  --color-secondary-foreground: #0f172a;
  --color-accent: #f1f5f9;
  --color-accent-foreground: #0f172a;
  --color-destructive: #ef4444;
  --color-destructive-foreground: #ffffff;

  /* Status colors - WCAG AAA compliant */
  --color-success: oklch(65% 0.18 150);
  --color-success-foreground: #ffffff;
  --color-warning: oklch(75% 0.15 85);
  --color-warning-foreground: #ffffff;
  --color-error: oklch(60% 0.2 25);
  --color-error-foreground: #ffffff;
  --color-info: oklch(65% 0.18 250);
  --color-info-foreground: #ffffff;

  /* Primary CTA - government authoritative blue */
  --color-primary-cta: oklch(60% 0.2 250);

  /* Border radius */
  --radius-sm: 0.25rem;
  --radius-md: 0.375rem;
  --radius-lg: 0.5rem;
  --radius-xl: 0.75rem;
}

/* Dark mode */
@media (prefers-color-scheme: dark) {
  @theme {
    --color-background: #0f172a;
    --color-foreground: #f8fafc;
    --color-muted: #1e293b;
    --color-muted-foreground: #94a3b8;
    --color-border: #334155;
    --color-input: #334155;
    --color-card: #1e293b;
    --color-card-foreground: #f8fafc;
    --color-popover: #1e293b;
    --color-popover-foreground: #f8fafc;
    --color-secondary: #1e293b;
    --color-secondary-foreground: #f8fafc;
    --color-accent: #1e293b;
    --color-accent-foreground: #f8fafc;

    /* Dark mode status colors */
    --color-success: #10b981;
    --color-warning: #f59e0b;
    --color-error: #f87171;
    --color-info: #38bdf8;
  }
}

/* Base styles */
html {
  font-size: 18px;
}

* {
  border-color: var(--color-border);
}

body {
  background-color: var(--color-background);
  color: var(--color-foreground);
  font-family: var(--font-sans);
  line-height: var(--line-height-base);
  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* Interactive elements */
button, input, select, textarea, [role="button"] {
  min-height: 48px;
  min-width: 48px;
}

button,
[role="button"],
a,
input[type="submit"],
input[type="button"],
input[type="checkbox"],
input[type="radio"],
select {
  cursor: pointer;
}

/* Text input elements should have text cursor */
input[type="text"],
input[type="email"],
input[type="tel"],
input[type="password"],
input[type="search"],
input[type="url"],
input[type="number"],
input[type="date"],
input[type="time"],
input[type="datetime-local"],
textarea {
  cursor: text;
}

button:disabled,
[disabled] {
  cursor: not-allowed;
}

/* Focus styles */
:focus-visible {
  outline: none;
  box-shadow: 0 0 0 2px var(--color-ring), 0 0 0 4px var(--color-background);
}

/* Tailwind focus-visible utility override */
.focus-visible\:ring-2:focus-visible {
  --tw-ring-offset-width: 2px;
  --tw-ring-color: var(--color-primary-500);
}

/* Lazy loading for images */
img[loading="lazy"] {
  opacity: 0;
  transition: opacity 0.3s ease-in-out;
}

img[loading="lazy"].loaded,
img[loading="lazy"]:not([src=""]) {
  opacity: 1;
}

/* Scrollbar styling */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: var(--color-muted);
}

::-webkit-scrollbar-thumb {
  background: var(--color-muted-foreground);
  border-radius: var(--radius-md);
}

::-webkit-scrollbar-thumb:hover {
  background: var(--color-foreground);
}
</file>

<file path="web/src/types/index.ts">
// User roles
export type UserRole = 'commune_admin' | 'village_leader' | 'resident'

// Gender type
export type Gender = 'male' | 'female' | 'other'

// User document in Firestore
export interface UserDoc {
  uid: string
  phone: string
  displayName: string
  role: UserRole
  villageId?: string // For village leaders
  createdAt: Date
  updatedAt: Date
}

// Village types
export type VillageType = 'thon' | 'kdc'
export type VillageRegion = 'dien_sanh_cu' | 'hai_truong' | 'hai_dinh'

// Village document
export interface Village {
  id: string
  name: string
  code: string
  region: VillageRegion
  type: VillageType
  leaderId?: string
  leaderName?: string
  leaderPhone?: string
  householdCount: number
  residentCount: number
  createdAt: Date
  updatedAt: Date
}

// Household document
export interface Household {
  id: string
  villageId: string
  code: string // So ho khau
  headName: string
  headId?: string // Reference to head resident
  headPhone?: string
  phone?: string
  address: string
  memberCount: number
  notes?: string
  createdAt: Date
  updatedAt: Date
}

// Resident document
export interface Resident {
  id: string
  householdId: string
  villageId: string
  name: string
  fullName?: string
  birthDate?: Date
  dateOfBirth?: string
  gender: Gender
  idNumberEncrypted?: string // CCCD encrypted
  idNumberHash?: string // SHA-256 hash for lookup
  phone?: string
  relationship: string // Quan he voi chu ho
  occupation?: string
  notes?: string
  isHead: boolean
  createdAt: Date
  updatedAt: Date
}

// Task types
export type TaskType = 'survey' | 'notification' | 'report' | 'other'
export type TaskStatus = 'pending' | 'in_progress' | 'completed' | 'cancelled'
export type TaskPriority = 'low' | 'medium' | 'high'

// Task document
export interface Task {
  id: string
  title: string
  description: string
  type: TaskType
  status: TaskStatus
  priority: TaskPriority
  assignedTo: string[] // villageIds
  createdBy: string // uid
  dueDate?: Date
  completedAt?: Date
  createdAt: Date
  updatedAt: Date
}

// SMS Message types
export type SMSStatus = 'pending' | 'sent' | 'failed' | 'delivered'

export interface SMSMessage {
  id: string
  recipients: string[] // phone numbers
  content: string
  status: SMSStatus
  sentBy: string // uid
  sentAt?: Date
  deliveredCount: number
  failedCount: number
  createdAt: Date
}

// Request types
export type RequestType = 'certificate' | 'complaint' | 'suggestion' | 'other'
export type RequestStatus = 'pending' | 'processing' | 'resolved' | 'rejected'

export interface Request {
  id: string
  type: RequestType
  title: string
  content: string
  submittedBy: string // uid or phone
  submitterName: string
  submitterPhone: string
  villageId?: string
  status: RequestStatus
  response?: string
  respondedBy?: string
  respondedAt?: Date
  createdAt: Date
  updatedAt: Date
}

// Announcement document
export interface Announcement {
  id: string
  title: string
  content: string
  targetVillages: string[] // villageIds, empty = all
  isPublic: boolean
  createdBy: string
  publishedAt?: Date
  expiresAt?: Date
  createdAt: Date
  updatedAt: Date
}

// API Response types
export interface ApiResponse<T> {
  success: boolean
  data?: T
  error?: string
  message?: string
}

// Pagination
export interface PaginatedResponse<T> {
  items: T[]
  total: number
  page: number
  pageSize: number
  hasMore: boolean
}
</file>

<file path="web/src/App.css">
#root {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

.logo {
  height: 6em;
  padding: 1.5em;
  will-change: filter;
  transition: filter 300ms;
}
.logo:hover {
  filter: drop-shadow(0 0 2em #646cffaa);
}
.logo.react:hover {
  filter: drop-shadow(0 0 2em #61dafbaa);
}

@keyframes logo-spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

@media (prefers-reduced-motion: no-preference) {
  a:nth-of-type(2) .logo {
    animation: logo-spin infinite 20s linear;
  }
}

.card {
  padding: 2em;
}

.read-the-docs {
  color: #888;
}
</file>

<file path="web/src/App.tsx">
import { QueryClient, QueryClientProvider } from '@tanstack/react-query'
import { AuthProvider } from '@/contexts/auth-context'
import { AppRoutes } from '@/routes'

// Create a client
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 1000 * 60 * 5, // 5 minutes
      retry: 1,
    },
  },
})

function App() {
  return (
    <QueryClientProvider client={queryClient}>
      <AuthProvider>
        <AppRoutes />
      </AuthProvider>
    </QueryClientProvider>
  )
}

export default App
</file>

<file path="web/src/index.css">
:root {
  font-family: system-ui, Avenir, Helvetica, Arial, sans-serif;
  line-height: 1.5;
  font-weight: 400;

  color-scheme: light dark;
  color: rgba(255, 255, 255, 0.87);
  background-color: #242424;

  font-synthesis: none;
  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

a {
  font-weight: 500;
  color: #646cff;
  text-decoration: inherit;
}
a:hover {
  color: #535bf2;
}

body {
  margin: 0;
  display: flex;
  place-items: center;
  min-width: 320px;
  min-height: 100vh;
}

h1 {
  font-size: 3.2em;
  line-height: 1.1;
}

button {
  border-radius: 8px;
  border: 1px solid transparent;
  padding: 0.6em 1.2em;
  font-size: 1em;
  font-weight: 500;
  font-family: inherit;
  background-color: #1a1a1a;
  cursor: pointer;
  transition: border-color 0.25s;
}
button:hover {
  border-color: #646cff;
}
button:focus,
button:focus-visible {
  outline: 4px auto -webkit-focus-ring-color;
}

@media (prefers-color-scheme: light) {
  :root {
    color: #213547;
    background-color: #ffffff;
  }
  a:hover {
    color: #747bff;
  }
  button {
    background-color: #f9f9f9;
  }
}
</file>

<file path="web/src/main.tsx">
import { StrictMode } from 'react'
import { createRoot } from 'react-dom/client'
import '@/styles/globals.css'
import App from './App.tsx'

createRoot(document.getElementById('root')!).render(
  <StrictMode>
    <App />
  </StrictMode>,
)
</file>

<file path="web/tests/e2e/lib/test-utils.sh">
#!/bin/bash
# Test Utilities for agent-browser E2E tests
# Common functions and helpers

# Colors for output
export RED='\033[0;31m'
export GREEN='\033[0;32m'
export YELLOW='\033[1;33m'
export BLUE='\033[0;34m'
export CYAN='\033[0;36m'
export NC='\033[0m' # No Color

# Test counters (shared via temp file for subshell compatibility)
COUNTER_FILE="/tmp/e2e-test-counters-$$"
echo "0 0 0" > "$COUNTER_FILE"

# Configuration
export BASE_URL="${BASE_URL:-http://localhost:5173}"
export SESSION_NAME="${SESSION_NAME:-diensanh-e2e-$(date +%s)}"
export SCREENSHOTS_DIR="${SCREENSHOTS_DIR:-./test-screenshots}"
export HEADED_MODE="${HEADED_MODE:-}"

# Create screenshots directory
mkdir -p "$SCREENSHOTS_DIR"

# Logging functions
log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() {
  echo -e "${GREEN}[PASS]${NC} $1"
  local counts=$(cat "$COUNTER_FILE")
  local passed=$(echo $counts | cut -d' ' -f1)
  local failed=$(echo $counts | cut -d' ' -f2)
  local total=$(echo $counts | cut -d' ' -f3)
  echo "$((passed+1)) $failed $((total+1))" > "$COUNTER_FILE"
}
log_fail() {
  echo -e "${RED}[FAIL]${NC} $1"
  local counts=$(cat "$COUNTER_FILE")
  local passed=$(echo $counts | cut -d' ' -f1)
  local failed=$(echo $counts | cut -d' ' -f2)
  local total=$(echo $counts | cut -d' ' -f3)
  echo "$passed $((failed+1)) $((total+1))" > "$COUNTER_FILE"
}
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_section() {
  echo ""
  echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  echo -e "${CYAN}  $1${NC}"
  echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  echo ""
}

# Run agent-browser command with session
ab() {
  agent-browser --session "$SESSION_NAME" $HEADED_MODE "$@"
}

# Take screenshot with descriptive name
screenshot() {
  local name="$1"
  local timestamp=$(date +%H%M%S)
  ab screenshot "$SCREENSHOTS_DIR/${name}-${timestamp}.png" 2>/dev/null
}

# Wait for element with timeout
wait_for() {
  local selector="$1"
  local timeout="${2:-5000}"
  ab wait "$selector" --timeout "$timeout" 2>/dev/null || true
}

# Check if element is visible
is_visible() {
  ab is visible "$1" 2>/dev/null && return 0 || return 1
}

# Check if element exists
element_exists() {
  local count=$(ab get count "$1" 2>/dev/null || echo "0")
  [ "$count" -gt 0 ] && return 0 || return 1
}

# Get text content from element
get_text() {
  ab get text "$1" 2>/dev/null
}

# Get current URL
get_url() {
  ab get url 2>/dev/null
}

# Fill input field (clear first)
fill_input() {
  local selector="$1"
  local value="$2"
  ab fill "$selector" "$value" 2>/dev/null
}

# Click element
click_element() {
  ab click "$1" 2>/dev/null
}

# Navigate to URL
navigate_to() {
  local path="$1"
  ab open "${BASE_URL}${path}" 2>/dev/null
  sleep 1
}

# Assert URL contains path
assert_url_contains() {
  local expected="$1"
  local current_url=$(get_url)
  if [[ "$current_url" == *"$expected"* ]]; then
    return 0
  else
    return 1
  fi
}

# Assert element has text
assert_has_text() {
  local selector="$1"
  local expected="$2"
  local text=$(get_text "$selector")
  if [[ "$text" == *"$expected"* ]]; then
    return 0
  else
    return 1
  fi
}

# Get test summary
get_test_summary() {
  local counts=$(cat "$COUNTER_FILE")
  local passed=$(echo $counts | cut -d' ' -f1)
  local failed=$(echo $counts | cut -d' ' -f2)
  local total=$(echo $counts | cut -d' ' -f3)
  echo "Total: $total | Passed: $passed | Failed: $failed"
}

# Print final summary
print_summary() {
  local counts=$(cat "$COUNTER_FILE")
  local passed=$(echo $counts | cut -d' ' -f1)
  local failed=$(echo $counts | cut -d' ' -f2)
  local total=$(echo $counts | cut -d' ' -f3)

  if [ "$total" -eq 0 ]; then
    total=1  # Prevent division by zero
  fi

  local rate=$((passed * 100 / total))

  echo ""
  echo "╔══════════════════════════════════════════════════════════════╗"
  echo "║                      TEST SUMMARY                            ║"
  echo "╠══════════════════════════════════════════════════════════════╣"
  echo "║  Total Tests: $total"
  echo "║  Passed: $passed"
  echo "║  Failed: $failed"
  echo "║  Success Rate: ${rate}%"
  echo "╚══════════════════════════════════════════════════════════════╝"
  echo ""
  echo "Screenshots saved to: $SCREENSHOTS_DIR"

  # Cleanup
  rm -f "$COUNTER_FILE"

  return $failed
}

# Initialize browser session
init_browser() {
  log_info "Initializing browser session: $SESSION_NAME"
  ab set viewport 1280 720 2>/dev/null || true
}

# Cleanup browser session
cleanup_browser() {
  log_info "Closing browser session..."
  ab close 2>/dev/null || true
}

# Trap for cleanup
trap cleanup_browser EXIT
</file>

<file path="web/tests/e2e/run-all-tests.sh">
#!/bin/bash
# ============================================================
# Diên Sanh App - Comprehensive E2E Test Runner
# Uses agent-browser for automated browser testing
# ============================================================
#
# Usage:
#   ./run-all-tests.sh [BASE_URL] [OPTIONS]
#
# Options:
#   --headed        Run in headed mode (show browser)
#   --portal        Run only portal tests
#   --auth          Run only auth tests
#   --navigation    Run only navigation tests
#   --a11y          Run only accessibility/performance tests
#   --quick         Run quick smoke tests only
#   --help          Show this help
#
# Examples:
#   ./run-all-tests.sh                              # Run all tests against localhost:5173
#   ./run-all-tests.sh http://localhost:3000        # Run against different port
#   ./run-all-tests.sh --headed                     # Run with visible browser
#   ./run-all-tests.sh --portal --auth              # Run specific test suites
#
# ============================================================

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Default configuration
export BASE_URL="${1:-http://localhost:5173}"
export SESSION_NAME="diensanh-e2e-$(date +%s)"
export SCREENSHOTS_DIR="$SCRIPT_DIR/test-screenshots"
export HEADED_MODE=""

# Test suite flags
RUN_PORTAL=false
RUN_AUTH=false
RUN_NAVIGATION=false
RUN_A11Y=false
RUN_QUICK=false
RUN_ALL=true

# Parse arguments
shift || true  # Skip first arg (URL) if present
while [[ $# -gt 0 ]]; do
  case $1 in
    --headed)
      export HEADED_MODE="--headed"
      ;;
    --portal)
      RUN_PORTAL=true
      RUN_ALL=false
      ;;
    --auth)
      RUN_AUTH=true
      RUN_ALL=false
      ;;
    --navigation)
      RUN_NAVIGATION=true
      RUN_ALL=false
      ;;
    --a11y)
      RUN_A11Y=true
      RUN_ALL=false
      ;;
    --quick)
      RUN_QUICK=true
      RUN_ALL=false
      ;;
    --help|-h)
      head -35 "$0" | tail -30
      exit 0
      ;;
    http*)
      export BASE_URL="$1"
      ;;
  esac
  shift
done

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Print banner
echo ""
echo -e "${CYAN}╔══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${CYAN}║                                                              ║${NC}"
echo -e "${CYAN}║      🏘️  Diên Sanh App - E2E Test Suite                       ║${NC}"
echo -e "${CYAN}║          Comprehensive Browser Automation Tests              ║${NC}"
echo -e "${CYAN}║                                                              ║${NC}"
echo -e "${CYAN}╚══════════════════════════════════════════════════════════════╝${NC}"
echo ""
echo -e "${BLUE}Configuration:${NC}"
echo -e "  Base URL:    ${GREEN}$BASE_URL${NC}"
echo -e "  Session:     ${GREEN}$SESSION_NAME${NC}"
echo -e "  Screenshots: ${GREEN}$SCREENSHOTS_DIR${NC}"
echo -e "  Mode:        ${GREEN}${HEADED_MODE:-headless}${NC}"
echo ""

# Create screenshots directory
mkdir -p "$SCREENSHOTS_DIR"

# Check if agent-browser is installed
if ! command -v agent-browser &> /dev/null; then
  echo -e "${RED}Error: agent-browser is not installed${NC}"
  echo "Install with: npm install -g agent-browser"
  exit 1
fi

# Check if dev server is running
check_server() {
  echo -e "${BLUE}Checking if server is running...${NC}"
  if curl -s --head "$BASE_URL" > /dev/null 2>&1; then
    echo -e "${GREEN}Server is running at $BASE_URL${NC}"
    return 0
  else
    echo -e "${YELLOW}Warning: Server may not be running at $BASE_URL${NC}"
    echo -e "${YELLOW}Tests may fail. Start server with: npm run dev${NC}"
    return 1
  fi
}

# Track overall results
TOTAL_SUITES=0
PASSED_SUITES=0
FAILED_SUITES=0

# Run a test suite
run_suite() {
  local suite_name="$1"
  local suite_script="$2"

  echo ""
  echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  echo -e "${CYAN}  Running: $suite_name${NC}"
  echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"

  ((TOTAL_SUITES++))

  if bash "$suite_script"; then
    echo -e "${GREEN}✓ $suite_name passed${NC}"
    ((PASSED_SUITES++))
  else
    echo -e "${RED}✗ $suite_name failed${NC}"
    ((FAILED_SUITES++))
  fi
}

# Quick smoke test
run_quick_tests() {
  echo -e "${BLUE}Running quick smoke tests...${NC}"

  source "$SCRIPT_DIR/lib/test-utils.sh"
  init_browser

  # Quick portal check
  navigate_to "/portal"
  sleep 2
  if is_visible "header"; then
    log_success "Portal loads correctly"
  else
    log_fail "Portal failed to load"
  fi

  # Quick login check
  navigate_to "/login"
  sleep 2
  if is_visible "input[type='tel']"; then
    log_success "Login page loads correctly"
  else
    log_fail "Login page failed to load"
  fi

  # Quick chatbot check
  navigate_to "/portal/chatbot"
  sleep 2
  if is_visible "input[type='text']"; then
    log_success "Chatbot loads correctly"
  else
    log_fail "Chatbot failed to load"
  fi

  screenshot "smoke-test-final"
  print_summary
  cleanup_browser
}

# Main execution
main() {
  check_server || true

  if $RUN_QUICK; then
    run_quick_tests
    exit $?
  fi

  if $RUN_ALL || $RUN_PORTAL; then
    run_suite "Portal Features" "$SCRIPT_DIR/test-portal.sh"
  fi

  if $RUN_ALL || $RUN_AUTH; then
    run_suite "Authentication" "$SCRIPT_DIR/test-auth.sh"
  fi

  if $RUN_ALL || $RUN_NAVIGATION; then
    run_suite "Navigation & Responsive" "$SCRIPT_DIR/test-navigation.sh"
  fi

  if $RUN_ALL || $RUN_A11Y; then
    run_suite "Accessibility & Performance" "$SCRIPT_DIR/test-a11y-perf.sh"
  fi

  # Final summary
  echo ""
  echo -e "${CYAN}╔══════════════════════════════════════════════════════════════╗${NC}"
  echo -e "${CYAN}║                    FINAL TEST SUMMARY                        ║${NC}"
  echo -e "${CYAN}╠══════════════════════════════════════════════════════════════╣${NC}"
  echo -e "${CYAN}║${NC}  Test Suites Run:    ${GREEN}$TOTAL_SUITES${NC}"
  echo -e "${CYAN}║${NC}  Suites Passed:      ${GREEN}$PASSED_SUITES${NC}"
  echo -e "${CYAN}║${NC}  Suites Failed:      ${RED}$FAILED_SUITES${NC}"
  echo -e "${CYAN}╚══════════════════════════════════════════════════════════════╝${NC}"
  echo ""
  echo -e "${BLUE}Screenshots saved to: $SCREENSHOTS_DIR${NC}"
  echo ""

  if [ $FAILED_SUITES -gt 0 ]; then
    echo -e "${RED}Some test suites failed!${NC}"
    exit 1
  else
    echo -e "${GREEN}All test suites passed!${NC}"
    exit 0
  fi
}

main
</file>

<file path="web/tests/e2e/simulation-test.sh">
#!/bin/bash
# Comprehensive Simulation Test for Diên Sanh App
# Uses agent-browser for automated browser testing
#
# Usage: ./simulation-test.sh [BASE_URL] [--headed]
# Example: ./simulation-test.sh http://localhost:5173 --headed

set -e

# Configuration
BASE_URL="${1:-http://localhost:5173}"
SESSION_NAME="diensanh-test-$(date +%s)"
SCREENSHOTS_DIR="./test-screenshots"
HEADED_MODE=""

# Parse arguments
for arg in "$@"; do
  case $arg in
    --headed)
      HEADED_MODE="--headed"
      shift
      ;;
  esac
done

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Test counters
PASSED=0
FAILED=0
TOTAL=0

# Create screenshots directory
mkdir -p "$SCREENSHOTS_DIR"

# Helper functions
log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[PASS]${NC} $1"; ((PASSED++)); ((TOTAL++)); }
log_fail() { echo -e "${RED}[FAIL]${NC} $1"; ((FAILED++)); ((TOTAL++)); }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_section() { echo -e "\n${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"; echo -e "${BLUE}  $1${NC}"; echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}\n"; }

# Run agent-browser command with session
ab() {
  agent-browser --session "$SESSION_NAME" $HEADED_MODE "$@"
}

# Take screenshot with name
screenshot() {
  ab screenshot "$SCREENSHOTS_DIR/$1-$(date +%H%M%S).png"
}

# Wait for element or timeout
wait_for() {
  ab wait "$1" 2>/dev/null || true
}

# Check if element is visible
is_visible() {
  ab is visible "$1" 2>/dev/null && return 0 || return 1
}

# Get text content
get_text() {
  ab get text "$1" 2>/dev/null
}

# Assert page contains text
assert_text_exists() {
  local selector="$1"
  local expected="$2"
  local text=$(get_text "$selector")
  if [[ "$text" == *"$expected"* ]]; then
    return 0
  else
    return 1
  fi
}

# Cleanup function
cleanup() {
  log_info "Cleaning up browser session..."
  ab close 2>/dev/null || true
}

trap cleanup EXIT

# ============================================================
# TEST SUITE: Portal Public Features
# ============================================================
test_portal_home() {
  log_section "Testing Portal Home Page"

  log_info "Opening portal home page..."
  ab open "$BASE_URL/portal"
  sleep 2
  screenshot "portal-home"

  # Check header elements
  if is_visible "h1"; then
    log_success "Portal header is visible"
  else
    log_fail "Portal header not found"
  fi

  # Check hero section
  if is_visible ".bg-primary-600"; then
    log_success "Hero section is visible"
  else
    log_fail "Hero section not found"
  fi

  # Check navigation links
  log_info "Checking quick action cards..."
  ab snapshot -i

  # Test announcements link
  if is_visible "a[href='/portal/announcements']"; then
    log_success "Announcements link is visible"
  else
    log_fail "Announcements link not found"
  fi

  # Test request form link
  if is_visible "a[href='/portal/requests/new']"; then
    log_success "Request form link is visible"
  else
    log_fail "Request form link not found"
  fi

  # Test chatbot link
  if is_visible "a[href='/portal/chatbot']"; then
    log_success "Chatbot link is visible"
  else
    log_fail "Chatbot link not found"
  fi

  # Test login link
  if is_visible "a[href='/login']"; then
    log_success "Login link is visible"
  else
    log_fail "Login link not found"
  fi

  # Check contact info section
  if is_visible "footer"; then
    log_success "Footer is visible"
  else
    log_fail "Footer not found"
  fi
}

test_portal_announcements() {
  log_section "Testing Announcements Page"

  ab open "$BASE_URL/portal/announcements"
  sleep 2
  screenshot "announcements"

  # Check back button
  if is_visible "a[href='/portal']"; then
    log_success "Back to portal link is visible"
  else
    log_fail "Back link not found"
  fi

  # Check page header
  log_info "Verifying announcements page loaded..."
  ab snapshot -i
}

test_portal_chatbot() {
  log_section "Testing Chatbot Page"

  ab open "$BASE_URL/portal/chatbot"
  sleep 2
  screenshot "chatbot-initial"

  # Check chat interface
  if is_visible "header"; then
    log_success "Chatbot header is visible"
  else
    log_fail "Chatbot header not found"
  fi

  # Check initial message
  log_info "Looking for initial assistant message..."
  sleep 1

  # Check input field
  if is_visible "input[type='text']"; then
    log_success "Chat input field is visible"
  else
    log_fail "Chat input field not found"
  fi

  # Check send button
  if is_visible "button"; then
    log_success "Send button is visible"
  else
    log_fail "Send button not found"
  fi

  # Test sending a message
  log_info "Testing chat interaction..."
  ab fill "input[type='text']" "xin chào"
  sleep 0.5
  ab click "button:last-of-type"
  sleep 2
  screenshot "chatbot-after-message"

  log_success "Chat message sent successfully"

  # Test FAQ response
  log_info "Testing FAQ response for 'giờ làm việc'..."
  ab fill "input[type='text']" "giờ làm việc"
  ab click "button:last-of-type"
  sleep 2
  screenshot "chatbot-faq-response"
}

test_portal_request_form() {
  log_section "Testing Request Form"

  ab open "$BASE_URL/portal/requests/new"
  sleep 2
  screenshot "request-form-initial"

  # Check form header
  if is_visible "header h1"; then
    log_success "Request form header is visible"
  else
    log_fail "Request form header not found"
  fi

  # Check request type options
  log_info "Checking request type buttons..."
  if is_visible "button"; then
    log_success "Request type buttons are visible"
  else
    log_fail "Request type buttons not found"
  fi

  # Select a request type
  log_info "Selecting 'Khiếu nại' request type..."
  ab find text "Khiếu nại" click
  sleep 0.5

  # Fill form fields
  log_info "Filling form fields..."
  ab fill "input[placeholder*='tiêu đề']" "Kiểm tra hệ thống"
  ab fill "textarea" "Đây là nội dung kiểm tra hệ thống tự động"
  ab fill "input[placeholder*='Nguyễn']" "Nguyễn Văn Test"
  ab fill "input[type='tel']" "0912345678"

  screenshot "request-form-filled"
  log_success "Form fields filled successfully"

  # Note: Not submitting to avoid creating test data
  log_info "Form validation passed (skipping actual submission)"
}

# ============================================================
# TEST SUITE: Authentication
# ============================================================
test_login_page() {
  log_section "Testing Login Page"

  ab open "$BASE_URL/login"
  sleep 2
  screenshot "login-page"

  # Check login form header
  if is_visible "h1"; then
    log_success "Login page header is visible"
  else
    log_fail "Login page header not found"
  fi

  # Check phone input
  if is_visible "input[type='tel']"; then
    log_success "Phone input field is visible"
  else
    log_fail "Phone input field not found"
  fi

  # Check submit button
  if is_visible "button[type='submit']"; then
    log_success "Submit button is visible"
  else
    log_fail "Submit button not found"
  fi

  # Test phone input
  log_info "Testing phone number input..."
  ab fill "input[type='tel']" "0912345678"
  sleep 0.5
  screenshot "login-phone-entered"
  log_success "Phone number entered successfully"

  # Note: Not submitting to avoid OTP flow
  log_info "Login form validation passed (skipping OTP submission)"
}

# ============================================================
# TEST SUITE: Navigation & Routing
# ============================================================
test_navigation_routing() {
  log_section "Testing Navigation & Routing"

  # Test redirect from root
  log_info "Testing root redirect to portal..."
  ab open "$BASE_URL/"
  sleep 2

  # Should redirect to portal
  local current_url=$(ab get url 2>/dev/null)
  if [[ "$current_url" == *"/portal"* ]]; then
    log_success "Root redirects to portal correctly"
  else
    log_fail "Root redirect not working (got: $current_url)"
  fi

  # Test 404 page
  log_info "Testing 404 page..."
  ab open "$BASE_URL/nonexistent-page-xyz"
  sleep 2
  screenshot "404-page"
  log_success "404 page test completed"

  # Test protected route redirect
  log_info "Testing protected route redirect (admin without auth)..."
  ab open "$BASE_URL/admin"
  sleep 2

  current_url=$(ab get url 2>/dev/null)
  if [[ "$current_url" == *"/login"* ]]; then
    log_success "Protected route redirects to login"
  else
    log_warn "Protected route redirect may not be working (got: $current_url)"
  fi
}

# ============================================================
# TEST SUITE: Responsive Design
# ============================================================
test_responsive_design() {
  log_section "Testing Responsive Design"

  # Mobile viewport
  log_info "Testing mobile viewport (375x667)..."
  ab set viewport 375 667
  ab open "$BASE_URL/portal"
  sleep 2
  screenshot "mobile-portal"

  # Check elements are visible
  if is_visible "header"; then
    log_success "Mobile header is visible"
  else
    log_fail "Mobile header not visible"
  fi

  # Tablet viewport
  log_info "Testing tablet viewport (768x1024)..."
  ab set viewport 768 1024
  ab reload
  sleep 2
  screenshot "tablet-portal"
  log_success "Tablet viewport test completed"

  # Desktop viewport
  log_info "Testing desktop viewport (1920x1080)..."
  ab set viewport 1920 1080
  ab reload
  sleep 2
  screenshot "desktop-portal"
  log_success "Desktop viewport test completed"

  # Reset to default
  ab set viewport 1280 720
}

# ============================================================
# TEST SUITE: Accessibility Snapshot
# ============================================================
test_accessibility() {
  log_section "Testing Accessibility (Snapshot)"

  ab open "$BASE_URL/portal"
  sleep 2

  log_info "Getting accessibility tree..."
  ab snapshot -i > "$SCREENSHOTS_DIR/accessibility-tree.txt"
  log_success "Accessibility snapshot saved"

  log_info "Checking for interactive elements..."
  ab snapshot -i -c
  log_success "Interactive elements check completed"
}

# ============================================================
# TEST SUITE: Form Validation
# ============================================================
test_form_validation() {
  log_section "Testing Form Validation"

  ab open "$BASE_URL/portal/requests/new"
  sleep 2

  # Try to submit empty form
  log_info "Testing empty form submission..."
  ab click "button[type='submit']"
  sleep 1
  screenshot "form-validation-errors"

  # Check for validation errors
  if is_visible ".text-red-500"; then
    log_success "Validation errors are shown"
  else
    log_warn "Validation errors may not be visible"
  fi

  # Test phone validation
  log_info "Testing invalid phone number..."
  ab fill "input[type='tel']" "123"
  ab click "button[type='submit']"
  sleep 1

  if is_visible ".text-red-500"; then
    log_success "Phone validation error is shown"
  else
    log_warn "Phone validation may not be visible"
  fi
}

# ============================================================
# TEST SUITE: Performance
# ============================================================
test_performance() {
  log_section "Testing Performance"

  log_info "Starting trace recording..."
  ab trace start "$SCREENSHOTS_DIR/trace.json"

  ab open "$BASE_URL/portal"
  sleep 2
  ab open "$BASE_URL/portal/chatbot"
  sleep 2
  ab open "$BASE_URL/portal/requests/new"
  sleep 2

  ab trace stop
  log_success "Performance trace saved to $SCREENSHOTS_DIR/trace.json"
}

# ============================================================
# MAIN TEST RUNNER
# ============================================================
main() {
  echo ""
  echo "╔══════════════════════════════════════════════════════════════╗"
  echo "║           Diên Sanh App - Comprehensive Test Suite           ║"
  echo "║                    Using agent-browser                       ║"
  echo "╚══════════════════════════════════════════════════════════════╝"
  echo ""
  echo "Base URL: $BASE_URL"
  echo "Session: $SESSION_NAME"
  echo "Screenshots: $SCREENSHOTS_DIR"
  echo "Mode: ${HEADED_MODE:-headless}"
  echo ""

  # Run all test suites
  test_portal_home
  test_portal_announcements
  test_portal_chatbot
  test_portal_request_form
  test_login_page
  test_navigation_routing
  test_responsive_design
  test_accessibility
  test_form_validation
  test_performance

  # Summary
  echo ""
  echo "╔══════════════════════════════════════════════════════════════╗"
  echo "║                      TEST SUMMARY                            ║"
  echo "╠══════════════════════════════════════════════════════════════╣"
  echo "║  Total Tests: $TOTAL"
  echo "║  Passed: $PASSED"
  echo "║  Failed: $FAILED"
  echo "║  Success Rate: $(( PASSED * 100 / TOTAL ))%"
  echo "╚══════════════════════════════════════════════════════════════╝"
  echo ""
  echo "Screenshots saved to: $SCREENSHOTS_DIR"
  echo ""

  if [ $FAILED -gt 0 ]; then
    exit 1
  fi
}

main "$@"
</file>

<file path="web/tests/e2e/test-a11y-perf.sh">
#!/bin/bash
# Accessibility & Performance Tests
# Tests: A11y tree, console errors, performance traces

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lib/test-utils.sh"

# ============================================================
# TEST: Accessibility Snapshot
# ============================================================
test_accessibility_snapshot() {
  log_section "Accessibility Snapshot"

  navigate_to "/portal"
  sleep 2

  log_info "Generating accessibility tree..."
  ab snapshot -i > "$SCREENSHOTS_DIR/a11y-portal.txt" 2>/dev/null
  if [ -s "$SCREENSHOTS_DIR/a11y-portal.txt" ]; then
    log_success "Portal a11y tree generated"
  else
    log_fail "Portal a11y tree empty"
  fi

  navigate_to "/portal/chatbot"
  sleep 2
  ab snapshot -i > "$SCREENSHOTS_DIR/a11y-chatbot.txt" 2>/dev/null
  if [ -s "$SCREENSHOTS_DIR/a11y-chatbot.txt" ]; then
    log_success "Chatbot a11y tree generated"
  else
    log_fail "Chatbot a11y tree empty"
  fi

  navigate_to "/login"
  sleep 2
  ab snapshot -i > "$SCREENSHOTS_DIR/a11y-login.txt" 2>/dev/null
  if [ -s "$SCREENSHOTS_DIR/a11y-login.txt" ]; then
    log_success "Login a11y tree generated"
  else
    log_fail "Login a11y tree empty"
  fi
}

# ============================================================
# TEST: Interactive Elements
# ============================================================
test_interactive_elements() {
  log_section "Interactive Elements Check"

  navigate_to "/portal"
  sleep 2

  # Count interactive elements
  log_info "Counting interactive elements on portal..."
  local snapshot=$(ab snapshot -i -c 2>/dev/null)
  local link_count=$(echo "$snapshot" | grep -c "link" || echo "0")
  local button_count=$(echo "$snapshot" | grep -c "button" || echo "0")

  log_info "Found ~$link_count links, ~$button_count buttons"
  log_success "Interactive elements scan complete"

  navigate_to "/portal/requests/new"
  sleep 2
  log_info "Checking form interactivity..."

  snapshot=$(ab snapshot -i -c 2>/dev/null)
  local input_count=$(echo "$snapshot" | grep -c "textbox\|combobox" || echo "0")
  log_info "Found ~$input_count form inputs"
  log_success "Form elements scan complete"
}

# ============================================================
# TEST: Console Errors
# ============================================================
test_console_errors() {
  log_section "Console Errors Check"

  # Clear console first
  ab console --clear 2>/dev/null || true

  navigate_to "/portal"
  sleep 3
  navigate_to "/portal/chatbot"
  sleep 2
  navigate_to "/login"
  sleep 2

  log_info "Checking for console errors..."
  local errors=$(ab errors 2>/dev/null || echo "")

  if [ -z "$errors" ] || [[ "$errors" == *"No errors"* ]]; then
    log_success "No console errors detected"
  else
    echo "$errors" > "$SCREENSHOTS_DIR/console-errors.txt"
    log_warn "Console errors found - saved to console-errors.txt"
  fi
}

# ============================================================
# TEST: Performance Trace
# ============================================================
test_performance_trace() {
  log_section "Performance Trace"

  log_info "Starting performance trace..."
  ab trace start "$SCREENSHOTS_DIR/perf-trace.json" 2>/dev/null || true

  navigate_to "/portal"
  sleep 2
  navigate_to "/portal/chatbot"
  sleep 2

  # Interact with chatbot
  fill_input "input[type='text']" "hello"
  click_element "button:last-of-type"
  sleep 2

  navigate_to "/portal/requests/new"
  sleep 2

  ab trace stop 2>/dev/null || true

  if [ -f "$SCREENSHOTS_DIR/perf-trace.json" ]; then
    log_success "Performance trace saved"
  else
    log_warn "Performance trace may not have saved"
  fi
}

# ============================================================
# TEST: Network Requests
# ============================================================
test_network_requests() {
  log_section "Network Requests"

  # Clear previous requests
  ab network requests --clear 2>/dev/null || true

  navigate_to "/portal"
  sleep 3

  log_info "Capturing network requests..."
  local requests=$(ab network requests 2>/dev/null || echo "")

  if [ -n "$requests" ]; then
    echo "$requests" > "$SCREENSHOTS_DIR/network-requests.txt"
    log_success "Network requests captured"
  else
    log_warn "No network requests captured"
  fi
}

# ============================================================
# RUN ALL A11Y/PERF TESTS
# ============================================================
run_a11y_perf_tests() {
  echo ""
  echo "╔══════════════════════════════════════════════════════════════╗"
  echo "║          Accessibility & Performance Tests                   ║"
  echo "╚══════════════════════════════════════════════════════════════╝"
  echo ""

  init_browser
  test_accessibility_snapshot
  test_interactive_elements
  test_console_errors
  test_performance_trace
  test_network_requests
  print_summary
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  run_a11y_perf_tests
fi
</file>

<file path="web/tests/e2e/test-auth.sh">
#!/bin/bash
# Authentication Tests
# Tests: Login page, OTP flow, redirects, protected routes

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lib/test-utils.sh"

# ============================================================
# TEST: Login Page UI
# ============================================================
test_login_page_ui() {
  log_section "Login Page UI"

  navigate_to "/login"
  sleep 2
  screenshot "login-page"

  # Test header/title
  if is_visible "h1"; then
    log_success "Login page header visible"
  else
    log_fail "Login page header not visible"
  fi

  # Test subtitle
  if element_exists ".text-muted-foreground"; then
    log_success "Login page subtitle visible"
  else
    log_fail "Login page subtitle not visible"
  fi

  # Test phone input field
  if is_visible "input[type='tel']"; then
    log_success "Phone input field visible"
  else
    log_fail "Phone input field not visible"
  fi

  # Test phone input label
  if element_exists "label[for='phone']"; then
    log_success "Phone input label exists"
  else
    log_fail "Phone input label not found"
  fi

  # Test submit button
  if is_visible "button[type='submit']"; then
    log_success "Submit button visible"
  else
    log_fail "Submit button not visible"
  fi

  # Test button is disabled when empty
  log_info "Testing button disabled state..."
  local button_disabled=$(ab eval "document.querySelector('button[type=submit]')?.disabled" 2>/dev/null)
  if [[ "$button_disabled" == "true" ]]; then
    log_success "Submit button disabled when phone empty"
  else
    log_warn "Submit button may not be properly disabled"
  fi

  # Test reCAPTCHA container exists
  if element_exists "#recaptcha-container"; then
    log_success "reCAPTCHA container exists"
  else
    log_fail "reCAPTCHA container not found"
  fi
}

# ============================================================
# TEST: Phone Input Validation
# ============================================================
test_phone_input() {
  log_section "Phone Input Validation"

  navigate_to "/login"
  sleep 2

  # Test typing phone number
  log_info "Testing phone number input..."
  fill_input "input[type='tel']" "0912345678"
  sleep 0.5
  screenshot "login-phone-entered"

  # Check button becomes enabled
  local button_disabled=$(ab eval "document.querySelector('button[type=submit]')?.disabled" 2>/dev/null)
  if [[ "$button_disabled" == "false" ]]; then
    log_success "Submit button enabled after phone entry"
  else
    log_fail "Submit button still disabled after phone entry"
  fi

  # Test clearing phone
  fill_input "input[type='tel']" ""
  sleep 0.3
  button_disabled=$(ab eval "document.querySelector('button[type=submit]')?.disabled" 2>/dev/null)
  if [[ "$button_disabled" == "true" ]]; then
    log_success "Submit button disabled after clearing phone"
  else
    log_warn "Submit button state may not be correct"
  fi

  # Test various phone formats
  local phone_formats=("0912345678" "0123456789" "0987654321")
  for phone in "${phone_formats[@]}"; do
    fill_input "input[type='tel']" "$phone"
    log_success "Accepted phone format: $phone"
  done
}

# ============================================================
# TEST: Protected Route Redirects
# ============================================================
test_protected_routes() {
  log_section "Protected Route Redirects"

  # Clear any existing session first
  ab storage local clear 2>/dev/null || true
  ab cookies clear 2>/dev/null || true

  # Test admin route redirect
  log_info "Testing /admin redirect without auth..."
  navigate_to "/admin"
  sleep 2

  if assert_url_contains "/login"; then
    log_success "Admin route redirects to login"
  else
    log_warn "Admin route may not redirect properly (could be loading)"
  fi
  screenshot "protected-admin-redirect"

  # Test village route redirect
  log_info "Testing /village redirect without auth..."
  navigate_to "/village"
  sleep 2

  if assert_url_contains "/login"; then
    log_success "Village route redirects to login"
  else
    log_warn "Village route may not redirect properly"
  fi

  # Test nested admin routes
  log_info "Testing /admin/villages redirect..."
  navigate_to "/admin/villages"
  sleep 2

  if assert_url_contains "/login"; then
    log_success "Nested admin route redirects to login"
  else
    log_warn "Nested admin route may not redirect properly"
  fi

  # Test admin tasks route
  log_info "Testing /admin/tasks redirect..."
  navigate_to "/admin/tasks"
  sleep 2

  if assert_url_contains "/login"; then
    log_success "Admin tasks route redirects to login"
  else
    log_warn "Admin tasks route may not redirect properly"
  fi

  # Test admin SMS route
  log_info "Testing /admin/sms redirect..."
  navigate_to "/admin/sms"
  sleep 2

  if assert_url_contains "/login"; then
    log_success "Admin SMS route redirects to login"
  else
    log_warn "Admin SMS route may not redirect properly"
  fi
}

# ============================================================
# TEST: Public Routes Accessibility
# ============================================================
test_public_routes() {
  log_section "Public Routes Accessibility"

  # Test portal is accessible without auth
  log_info "Testing /portal accessibility..."
  navigate_to "/portal"
  sleep 2

  if assert_url_contains "/portal"; then
    log_success "Portal is publicly accessible"
  else
    log_fail "Portal not accessible"
  fi

  # Test portal announcements
  log_info "Testing /portal/announcements accessibility..."
  navigate_to "/portal/announcements"
  sleep 2

  if assert_url_contains "/portal/announcements"; then
    log_success "Announcements page is publicly accessible"
  else
    log_fail "Announcements not accessible"
  fi

  # Test portal chatbot
  log_info "Testing /portal/chatbot accessibility..."
  navigate_to "/portal/chatbot"
  sleep 2

  if assert_url_contains "/portal/chatbot"; then
    log_success "Chatbot page is publicly accessible"
  else
    log_fail "Chatbot not accessible"
  fi

  # Test request form
  log_info "Testing /portal/requests/new accessibility..."
  navigate_to "/portal/requests/new"
  sleep 2

  if assert_url_contains "/portal/requests/new"; then
    log_success "Request form is publicly accessible"
  else
    log_fail "Request form not accessible"
  fi

  # Test login page
  log_info "Testing /login accessibility..."
  navigate_to "/login"
  sleep 2

  if assert_url_contains "/login"; then
    log_success "Login page is accessible"
  else
    log_fail "Login page not accessible"
  fi
}

# ============================================================
# TEST: Root Redirect
# ============================================================
test_root_redirect() {
  log_section "Root URL Redirect"

  log_info "Testing root URL redirect..."
  navigate_to "/"
  sleep 2

  if assert_url_contains "/portal"; then
    log_success "Root URL redirects to /portal"
  else
    log_fail "Root URL redirect not working"
  fi
  screenshot "root-redirect"
}

# ============================================================
# RUN ALL AUTH TESTS
# ============================================================
run_auth_tests() {
  echo ""
  echo "╔══════════════════════════════════════════════════════════════╗"
  echo "║              Authentication & Authorization Tests            ║"
  echo "╚══════════════════════════════════════════════════════════════╝"
  echo ""
  echo "Base URL: $BASE_URL"
  echo "Session: $SESSION_NAME"
  echo ""

  init_browser

  test_login_page_ui
  test_phone_input
  test_root_redirect
  test_public_routes
  test_protected_routes

  print_summary
}

# Run if executed directly
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  run_auth_tests
fi
</file>

<file path="web/tests/e2e/test-navigation.sh">
#!/bin/bash
# Navigation & Responsive Design Tests
# Tests: URL routing, 404 page, viewport responsiveness

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lib/test-utils.sh"

# ============================================================
# TEST: 404 Not Found Page
# ============================================================
test_404_page() {
  log_section "404 Not Found Page"
  navigate_to "/nonexistent-page-xyz-123"
  sleep 2
  screenshot "404-page"

  if is_visible "h1"; then
    log_success "404 page renders content"
  else
    log_fail "404 page missing content"
  fi
}

# ============================================================
# TEST: Navigation Between Pages
# ============================================================
test_navigation_flow() {
  log_section "Navigation Flow"

  navigate_to "/portal"
  sleep 2

  # Navigate to announcements
  click_element "a[href='/portal/announcements']"
  sleep 2
  if assert_url_contains "/portal/announcements"; then
    log_success "Navigated to announcements"
  else
    log_fail "Failed to navigate to announcements"
  fi

  # Navigate back
  click_element "a[href='/portal']"
  sleep 2
  if assert_url_contains "/portal"; then
    log_success "Navigated back to portal"
  else
    log_fail "Failed to navigate back"
  fi

  # Browser back/forward
  click_element "a[href='/portal/chatbot']"
  sleep 2
  ab back 2>/dev/null
  sleep 2
  if assert_url_contains "/portal"; then
    log_success "Browser back works"
  else
    log_fail "Browser back failed"
  fi
}

# ============================================================
# TEST: Responsive Viewports
# ============================================================
test_responsive() {
  log_section "Responsive Design"

  # Mobile
  ab set viewport 375 667
  navigate_to "/portal"
  sleep 2
  screenshot "mobile-portal"
  if is_visible "header"; then
    log_success "Mobile: Header visible"
  else
    log_fail "Mobile: Header not visible"
  fi

  # Tablet
  ab set viewport 768 1024
  ab reload
  sleep 2
  screenshot "tablet-portal"
  log_success "Tablet: Layout rendered"

  # Desktop
  ab set viewport 1920 1080
  ab reload
  sleep 2
  screenshot "desktop-portal"
  log_success "Desktop: Layout rendered"

  # Reset
  ab set viewport 1280 720
}

# ============================================================
# RUN ALL NAVIGATION TESTS
# ============================================================
run_navigation_tests() {
  echo ""
  echo "╔══════════════════════════════════════════════════════════════╗"
  echo "║          Navigation & Responsive Design Tests                ║"
  echo "╚══════════════════════════════════════════════════════════════╝"
  echo ""

  init_browser
  test_404_page
  test_navigation_flow
  test_responsive
  print_summary
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  run_navigation_tests
fi
</file>

<file path="web/tests/e2e/test-portal.sh">
#!/bin/bash
# Portal Feature Tests - Public pages testing
# Tests: Home, Announcements, Chatbot, Request Form

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lib/test-utils.sh"

# ============================================================
# TEST: Portal Home Page
# ============================================================
test_portal_home() {
  log_section "Portal Home Page"

  navigate_to "/portal"
  sleep 2
  screenshot "portal-home"

  # Test header visibility
  if is_visible "header"; then
    log_success "Header is visible"
  else
    log_fail "Header not visible"
  fi

  # Test hero section
  if is_visible ".bg-primary-600"; then
    log_success "Hero section is visible"
  else
    log_fail "Hero section not visible"
  fi

  # Test quick action cards
  local cards=("announcements" "requests/new" "chatbot")
  for card in "${cards[@]}"; do
    if is_visible "a[href='/portal/$card']"; then
      log_success "Quick action link /$card is visible"
    else
      log_fail "Quick action link /$card not found"
    fi
  done

  # Test login link
  if is_visible "a[href='/login']"; then
    log_success "Login link is visible"
  else
    log_fail "Login link not visible"
  fi

  # Test footer
  if is_visible "footer"; then
    log_success "Footer is visible"
  else
    log_fail "Footer not visible"
  fi

  # Test contact info section
  if element_exists ".bg-white.rounded-xl"; then
    log_success "Contact info section exists"
  else
    log_fail "Contact info section not found"
  fi
}

# ============================================================
# TEST: Announcements Page
# ============================================================
test_announcements() {
  log_section "Announcements Page"

  navigate_to "/portal/announcements"
  sleep 2
  screenshot "announcements"

  # Test back navigation
  if is_visible "a[href='/portal']"; then
    log_success "Back to portal link visible"
  else
    log_fail "Back link not found"
  fi

  # Test page header
  if is_visible "header"; then
    log_success "Page header visible"
  else
    log_fail "Page header not visible"
  fi

  # Test back navigation works
  click_element "a[href='/portal']"
  sleep 1
  if assert_url_contains "/portal"; then
    log_success "Back navigation works"
  else
    log_fail "Back navigation failed"
  fi
}

# ============================================================
# TEST: Chatbot Page
# ============================================================
test_chatbot() {
  log_section "Chatbot Page"

  navigate_to "/portal/chatbot"
  sleep 2
  screenshot "chatbot-initial"

  # Test chatbot header
  if is_visible "header h1"; then
    log_success "Chatbot header visible"
  else
    log_fail "Chatbot header not visible"
  fi

  # Test chat input
  if is_visible "input[type='text']"; then
    log_success "Chat input field visible"
  else
    log_fail "Chat input not visible"
  fi

  # Test send button
  if is_visible "button"; then
    log_success "Send button visible"
  else
    log_fail "Send button not visible"
  fi

  # Test initial bot message
  log_info "Checking for initial assistant message..."
  sleep 1

  # Test sending a message
  log_info "Testing chat interaction..."
  fill_input "input[type='text']" "xin chào"
  sleep 0.5
  click_element "button:last-of-type"
  sleep 2
  screenshot "chatbot-greeting"
  log_success "Greeting message sent"

  # Test FAQ: working hours
  log_info "Testing FAQ response..."
  fill_input "input[type='text']" "giờ làm việc"
  click_element "button:last-of-type"
  sleep 2
  screenshot "chatbot-faq-hours"
  log_success "FAQ query sent"

  # Test FAQ: address
  fill_input "input[type='text']" "địa chỉ"
  click_element "button:last-of-type"
  sleep 2
  screenshot "chatbot-faq-address"
  log_success "Address query sent"

  # Test FAQ: birth registration
  fill_input "input[type='text']" "khai sinh"
  click_element "button:last-of-type"
  sleep 2
  screenshot "chatbot-faq-birth"
  log_success "Birth registration query sent"

  # Test unknown query response
  fill_input "input[type='text']" "xyz không biết gì"
  click_element "button:last-of-type"
  sleep 2
  screenshot "chatbot-unknown"
  log_success "Unknown query handled"
}

# ============================================================
# TEST: Request Form Page
# ============================================================
test_request_form() {
  log_section "Request Form Page"

  navigate_to "/portal/requests/new"
  sleep 2
  screenshot "request-form-initial"

  # Test header
  if is_visible "header h1"; then
    log_success "Form header visible"
  else
    log_fail "Form header not visible"
  fi

  # Test request type buttons
  log_info "Testing request type selection..."
  if element_exists "button"; then
    log_success "Request type buttons exist"
  else
    log_fail "Request type buttons not found"
  fi

  # Test selecting different request types
  local types=("Khiếu nại" "Kiến nghị" "Khác")
  for type in "${types[@]}"; do
    ab find text "$type" click 2>/dev/null
    sleep 0.3
    log_success "Selected request type: $type"
  done

  # Select certificate type for form filling
  ab find text "Xin giấy xác nhận" click 2>/dev/null
  sleep 0.5

  # Test form validation - submit empty
  log_info "Testing empty form validation..."
  click_element "button[type='submit']"

  # Wait for specific validation errors to appear (up to 5 seconds with polling)
  local validation_found=false
  for i in {1..10}; do
    # Check for specific Vietnamese validation messages
    if ab find text "Vui lòng nhập tiêu đề" 2>/dev/null || \
       ab find text "Vui lòng nhập nội dung" 2>/dev/null || \
       ab find text "Vui lòng nhập họ tên" 2>/dev/null || \
       ab find text "Vui lòng nhập số điện thoại" 2>/dev/null; then
      validation_found=true
      break
    fi
    sleep 0.5
  done

  screenshot "request-form-validation"

  if $validation_found; then
    log_success "Validation errors shown for empty form"
  else
    log_fail "Validation errors not visible"
  fi

  # Test filling the form
  log_info "Filling form fields..."
  fill_input "input[placeholder*='tiêu đề']" "Xin giấy xác nhận cư trú"
  fill_input "textarea" "Tôi cần xin giấy xác nhận cư trú để làm hồ sơ xin việc. Địa chỉ: Thôn 1, Xã Diên Sanh."
  fill_input "input[placeholder*='Nguyễn']" "Nguyễn Văn Test"

  # Test phone validation with invalid number
  log_info "Testing phone validation..."
  fill_input "input[type='tel']" "123"
  click_element "button[type='submit']"
  sleep 1

  if is_visible ".text-red-500"; then
    log_success "Phone validation error shown"
  else
    log_warn "Phone validation may not be visible"
  fi

  # Fill valid phone
  fill_input "input[type='tel']" "0912345678"
  screenshot "request-form-filled"
  log_success "Form filled with valid data"

  # Note: Not submitting to avoid creating test data in production
  log_info "Form validated (skipping submission to avoid test data)"
}

# ============================================================
# RUN ALL PORTAL TESTS
# ============================================================
run_portal_tests() {
  echo ""
  echo "╔══════════════════════════════════════════════════════════════╗"
  echo "║            Portal Feature Tests - Public Pages               ║"
  echo "╚══════════════════════════════════════════════════════════════╝"
  echo ""
  echo "Base URL: $BASE_URL"
  echo "Session: $SESSION_NAME"
  echo ""

  init_browser

  test_portal_home
  test_announcements
  test_chatbot
  test_request_form

  print_summary
}

# Run if executed directly
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  run_portal_tests
fi
</file>

<file path="web/.env.example">
# Firebase Configuration
VITE_FIREBASE_API_KEY=your-api-key
VITE_FIREBASE_AUTH_DOMAIN=diensanh-37701.firebaseapp.com
VITE_FIREBASE_PROJECT_ID=diensanh-37701
VITE_FIREBASE_STORAGE_BUCKET=diensanh-37701.firebasestorage.app
VITE_FIREBASE_MESSAGING_SENDER_ID=your-sender-id
VITE_FIREBASE_APP_ID=your-app-id

# Encryption key for CCCD (change in production!)
VITE_ENCRYPTION_KEY=change-this-in-production-use-strong-key

# Development settings
VITE_USE_EMULATORS=false

# API URL (Cloud Run backend)
VITE_API_URL=http://localhost:8000

# SMS Provider Configuration (mock, esms, speedsms, twilio)
VITE_SMS_PROVIDER=mock
VITE_SMS_API_KEY=your-sms-api-key
VITE_SMS_BRAND_NAME=DIENSANH
</file>

<file path="web/.gitignore">
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
.vercel
</file>

<file path="web/eslint.config.js">
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import tseslint from 'typescript-eslint'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      js.configs.recommended,
      tseslint.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
    },
  },
])
</file>

<file path="web/firestore.indexes.json">
{
  "indexes": [],
  "fieldOverrides": []
}
</file>

<file path="web/firestore.rules">
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isAdmin() {
      return isAuthenticated() && getUserDoc().role == 'commune_admin';
    }

    function isVillageLeader() {
      return isAuthenticated() && getUserDoc().role == 'village_leader';
    }

    function isVillageLeaderOf(villageId) {
      return isVillageLeader() && getUserDoc().villageId == villageId;
    }

    function isAdminOrVillageLeaderOf(villageId) {
      return isAdmin() || isVillageLeaderOf(villageId);
    }

    // Users collection
    match /users/{userId} {
      // Users can read their own document
      allow read: if isAuthenticated() && request.auth.uid == userId;
      // Admins can read/write all users
      allow read, write: if isAdmin();
      // Allow creating user doc on first login (for phone auth)
      allow create: if isAuthenticated() && request.auth.uid == userId;
    }

    // Villages collection
    match /villages/{villageId} {
      // Anyone authenticated can read villages
      allow read: if isAuthenticated();
      // Only admins can create/update/delete villages
      allow write: if isAdmin();

      // Households subcollection
      match /households/{householdId} {
        // Admins and village leaders of this village can read
        allow read: if isAdminOrVillageLeaderOf(villageId);
        // Admins can write, village leaders can update
        allow create, delete: if isAdmin();
        allow update: if isAdminOrVillageLeaderOf(villageId);

        // Residents subcollection
        match /residents/{residentId} {
          // Admins and village leaders of this village can read
          allow read: if isAdminOrVillageLeaderOf(villageId);
          // Admins can write, village leaders can update
          allow create, delete: if isAdmin();
          allow update: if isAdminOrVillageLeaderOf(villageId);
        }
      }
    }

    // Announcements collection (public read)
    match /announcements/{announcementId} {
      // Anyone can read announcements (public portal)
      allow read: if true;
      // Only admins can write
      allow write: if isAdmin();
    }

    // Tasks collection
    match /tasks/{taskId} {
      // Admins can read all tasks
      allow read: if isAdmin();
      // Village leaders can read tasks assigned to them
      allow read: if isVillageLeader() &&
        resource.data.assignedTo == request.auth.uid;
      // Village leaders can read tasks for their village
      allow read: if isVillageLeader() &&
        resource.data.villageId == getUserDoc().villageId;
      // Only admins can create/delete tasks
      allow create, delete: if isAdmin();
      // Admins can update any task
      allow update: if isAdmin();
      // Village leaders can update tasks assigned to them (status, notes)
      allow update: if isVillageLeader() &&
        resource.data.assignedTo == request.auth.uid;
    }

    // SMS logs collection
    match /sms_logs/{logId} {
      // Only admins can read/write SMS logs
      allow read, write: if isAdmin();
    }

    // Requests collection (citizen requests)
    match /requests/{requestId} {
      // Anyone can create a request (public portal)
      allow create: if true;
      // Admins can read all requests
      allow read: if isAdmin();
      // Village leaders can read requests for their village
      allow read: if isVillageLeader() &&
        resource.data.villageId == getUserDoc().villageId;
      // Only admins can update/delete requests
      allow update, delete: if isAdmin();
    }

    // Statistics collection (cached stats)
    match /statistics/{statId} {
      // Admins can read/write stats
      allow read, write: if isAdmin();
      // Village leaders can read stats for their village
      allow read: if isVillageLeader() &&
        resource.data.villageId == getUserDoc().villageId;
    }

    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
</file>

<file path="web/index.html">
<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#0d6efd" />
    <meta name="description" content="Cổng thông tin điện tử UBND xã Diên Sanh, Hải Lăng, Quảng Trị" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Diên Sanh" />
    <link rel="manifest" href="/manifest.json" />
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png" />

    <!-- Preload Be Vietnam Pro for Vietnamese text -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap&subset=vietnamese">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap&subset=vietnamese">

    <title>UBND Xã Diên Sanh</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
    <script>
      // Register service worker
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then((registration) => {
              console.log('SW registered:', registration.scope);
            })
            .catch((error) => {
              console.log('SW registration failed:', error);
            });
        });
      }
    </script>
  </body>
</html>
</file>

<file path="web/package.json">
{
  "name": "web",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc -b && vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "@tanstack/react-query": "^5.90.17",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "crypto-js": "^4.2.0",
    "firebase": "^12.8.0",
    "lucide-react": "^0.562.0",
    "react": "^19.2.0",
    "react-dom": "^19.2.0",
    "react-router-dom": "^7.12.0",
    "tailwind-merge": "^3.4.0",
    "zustand": "^5.0.10"
  },
  "devDependencies": {
    "@eslint/js": "^9.39.1",
    "@tailwindcss/vite": "^4.1.18",
    "@types/crypto-js": "^4.2.2",
    "@types/node": "^24.10.1",
    "@types/react": "^19.2.5",
    "@types/react-dom": "^19.2.3",
    "@vitejs/plugin-react": "^5.1.1",
    "autoprefixer": "^10.4.23",
    "eslint": "^9.39.1",
    "eslint-plugin-react-hooks": "^7.0.1",
    "eslint-plugin-react-refresh": "^0.4.24",
    "globals": "^16.5.0",
    "postcss": "^8.5.6",
    "tailwindcss": "^4.1.18",
    "typescript": "~5.9.3",
    "typescript-eslint": "^8.46.4",
    "vite": "^7.2.4"
  }
}
</file>

<file path="web/README.md">
# React + TypeScript + Vite

This template provides a minimal setup to get React working in Vite with HMR and some ESLint rules.

Currently, two official plugins are available:

- [@vitejs/plugin-react](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react) uses [Babel](https://babeljs.io/) (or [oxc](https://oxc.rs) when used in [rolldown-vite](https://vite.dev/guide/rolldown)) for Fast Refresh
- [@vitejs/plugin-react-swc](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react-swc) uses [SWC](https://swc.rs/) for Fast Refresh

## React Compiler

The React Compiler is not enabled on this template because of its impact on dev & build performances. To add it, see [this documentation](https://react.dev/learn/react-compiler/installation).

## Expanding the ESLint configuration

If you are developing a production application, we recommend updating the configuration to enable type-aware lint rules:

```js
export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      // Other configs...

      // Remove tseslint.configs.recommended and replace with this
      tseslint.configs.recommendedTypeChecked,
      // Alternatively, use this for stricter rules
      tseslint.configs.strictTypeChecked,
      // Optionally, add this for stylistic rules
      tseslint.configs.stylisticTypeChecked,

      // Other configs...
    ],
    languageOptions: {
      parserOptions: {
        project: ['./tsconfig.node.json', './tsconfig.app.json'],
        tsconfigRootDir: import.meta.dirname,
      },
      // other options...
    },
  },
])
```

You can also install [eslint-plugin-react-x](https://github.com/Rel1cx/eslint-react/tree/main/packages/plugins/eslint-plugin-react-x) and [eslint-plugin-react-dom](https://github.com/Rel1cx/eslint-react/tree/main/packages/plugins/eslint-plugin-react-dom) for React-specific lint rules:

```js
// eslint.config.js
import reactX from 'eslint-plugin-react-x'
import reactDom from 'eslint-plugin-react-dom'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      // Other configs...
      // Enable lint rules for React
      reactX.configs['recommended-typescript'],
      // Enable lint rules for React DOM
      reactDom.configs.recommended,
    ],
    languageOptions: {
      parserOptions: {
        project: ['./tsconfig.node.json', './tsconfig.app.json'],
        tsconfigRootDir: import.meta.dirname,
      },
      // other options...
    },
  },
])
```
</file>

<file path="web/tsconfig.app.json">
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.app.tsbuildinfo",
    "target": "ES2022",
    "useDefineForClassFields": true,
    "lib": ["ES2022", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "types": ["vite/client"],
    "skipLibCheck": true,

    /* Path aliases */
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    },

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,
    "jsx": "react-jsx",

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["src"]
}
</file>

<file path="web/tsconfig.json">
{
  "files": [],
  "references": [
    { "path": "./tsconfig.app.json" },
    { "path": "./tsconfig.node.json" }
  ]
}
</file>

<file path="web/tsconfig.node.json">
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.node.tsbuildinfo",
    "target": "ES2023",
    "lib": ["ES2023"],
    "module": "ESNext",
    "types": ["node"],
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["vite.config.ts"]
}
</file>

<file path="web/vercel.json">
{
  "buildCommand": "npm run build",
  "outputDirectory": "dist",
  "installCommand": "npm install",
  "framework": "vite",
  "rewrites": [
    { "source": "/(.*)", "destination": "/index.html" }
  ],
  "headers": [
    {
      "source": "/sw.js",
      "headers": [
        { "key": "Cache-Control", "value": "no-cache" },
        { "key": "Service-Worker-Allowed", "value": "/" }
      ]
    },
    {
      "source": "/manifest.json",
      "headers": [
        { "key": "Cache-Control", "value": "no-cache" }
      ]
    },
    {
      "source": "/(.*)",
      "headers": [
        { "key": "X-Content-Type-Options", "value": "nosniff" },
        { "key": "X-Frame-Options", "value": "DENY" },
        { "key": "X-XSS-Protection", "value": "1; mode=block" }
      ]
    }
  ]
}
</file>

<file path="web/vite.config.ts">
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import tailwindcss from '@tailwindcss/vite'
import path from 'path'

// https://vite.dev/config/
export default defineConfig({
  plugins: [react(), tailwindcss()],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
})
</file>

<file path=".env.example">
# Diên Sanh Chatbot - Environment Variables

# API Key for api.ai4u.now (required)
AI4U_API_KEY=your_api_key_here

# API Base URL (optional, defaults to https://api.ai4u.now/v1)
# AI4U_BASE_URL=https://api.ai4u.now/v1

# Chat model (optional, defaults to gemini-2.5-flash)
# CHAT_MODEL=gemini-2.5-flash

# Server settings (optional)
# API_HOST=0.0.0.0
# API_PORT=8000

# Data paths (optional)
# DATA_DIR=./data
# CHROMA_DB_PATH=./data/chroma_db
</file>

<file path=".firebaserc">
{
  "projects": {},
  "targets": {},
  "etags": {}
}
</file>

<file path=".gitignore">
# Environment variables and secrets
.env
.env.local
.env.production
.env.staging
*.env

# Firebase service account keys
*firebase-adminsdk*.json
*service-account*.json

# Node.js dependencies
node_modules/
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*

# Build outputs
dist/
build/
.next/
out/

# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
venv/
env/
ENV/
.venv/
pip-log.txt
pip-delete-this-directory.txt

# IDEs and editors
.vscode/
.idea/
*.swp
*.swo
*~

# OS generated files
.DS_Store
.DS_Store?
._*
.Spotlight-V100
.Trashes
ehthumbs.db
Thumbs.db

# Logs
logs/
*.log

# Runtime data
pids/
*.pid
*.seed
*.pid.lock

# Coverage directory used by tools like istanbul
coverage/
*.lcov

# Firebase
.firebase/
firebase-debug.log
firestore-debug.log

# Temporary files
tmp/
temp/

# Data files (may contain sensitive information)
data/*.json
data/*.csv
data/vector-store/
data/scraped/

# Cache directories
.cache/
.parcel-cache/

# Optional npm cache directory
.npm

# Optional eslint cache
.eslintcache

# Microbundle cache
.rpt2_cache/
.rts2_cache_cjs/
.rts2_cache_es/
.rts2_cache_umd/

# Optional REPL history
.node_repl_history

# Output of 'npm pack'
*.tgz

# Yarn Integrity file
.yarn-integrity

# dotenv environment variables file
.env.test

# Stores VSCode versions used for testing VSCode extensions
.vscode-test

# Vercel
.vercel

# TypeScript
*.tsbuildinfo

# Storybook build outputs
storybook-static

# Temporary folders
tmp/
temp/
</file>

<file path="CLAUDE.md">
# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview
This is a Firebase-based project (`diensanh`) using a React + TypeScript + Vite frontend (`web/` directory) and Python-based data/analytics backend components.

## Environment & Tools
- **Project IDs**: `diensanh-37701` (Active) or `diensanh-45eb1` (Service Account)
- **Frontend**: React 19, TypeScript 5.9, Vite 7, Tailwind CSS 4, Zustand, TanStack Query
- **Backend/Data**: Python 3.14 (in `src/` and `venv`), Firebase (Firestore, etc.)
- **Hosting**: Vercel (frontend), Firebase (backend services)

## Common Commands

### Frontend (`web/` directory)
- `npm run dev` - Start development server
- `npm run build` - Type check and build for production
- `npm run lint` - Lint code using ESLint
- `npm run preview` - Preview production build
- `vercel deploy --prod` - Deploy frontend to Vercel (requires token)

### Backend / Data
- `python3 src/scraper/dichvucong-scraper.py` - Run public service scraper
- `python3 src/vector-store.py` - Run vector store operations

### Firebase Operations
- `firebase login` - Login to Firebase
- `firebase init` - Initialize Firebase services
- `firebase deploy` - Deploy all services
- `firebase emulators:start` - Start local Firebase emulators

### Maintenance
- `python3 ~/.claude/scripts/generate_catalogs.py --skills` - Update skills catalog
- `python3 ~/.claude/scripts/generate_catalogs.py --commands` - Update commands catalog

## Project Structure
- `web/` - Frontend application (React + Vite)
- `src/` - Python source code (scrapers, vector store, API)
- `plans/` - Strategy and implementation plans
- `docs/` - Project documentation
- `data/` - Data storage (vector store, scraped content)
- `scripts/` - Utility scripts (e.g., seeding)
- `firebase.json` - Firebase configuration
- `firestore.rules` - Firestore security rules

## Coding Standards
- **Frontend**:
  - Use Functional Components with Hooks
  - Use Zustand for global state management
  - Use TanStack Query for data fetching
  - Use Tailwind CSS for styling (v4)
  - Follow ESLint configuration
- **General**:
  - Follow **YAGNI**, **KISS**, and **DRY** principles
  - Use **kebab-case** for file naming
  - Organize documentation in `docs/` and plans in `plans/`
</file>

<file path="firebase.json">
{
  "firestore": {
    "database": "(default)",
    "location": "asia-southeast1",
    "rules": "firestore.rules",
    "indexes": "firestore.indexes.json"
  }
}
</file>

<file path="firestore.indexes.json">
{
  "indexes": [
    {
      "collectionGroup": "households",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "headName", "order": "ASCENDING" },
        { "fieldPath": "createdAt", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "tasks",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "status", "order": "ASCENDING" },
        { "fieldPath": "dueDate", "order": "ASCENDING" }
      ]
    },
    {
      "collectionGroup": "tasks",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "status", "order": "ASCENDING" },
        { "fieldPath": "createdAt", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "messages",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "status", "order": "ASCENDING" },
        { "fieldPath": "createdAt", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "requests",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "status", "order": "ASCENDING" },
        { "fieldPath": "createdAt", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "announcements",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "isPublished", "order": "ASCENDING" },
        { "fieldPath": "publishedAt", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "residents",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "idNumberHash", "order": "ASCENDING" }
      ]
    }
  ],
  "fieldOverrides": []
}
</file>

<file path="firestore.rules">
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'commune_admin';
    }

    function isVillageLeader(villageId) {
      let user = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return user.data.role == 'village_leader' && user.data.villageId == villageId;
    }

    function isAdminOrVillageLeader(villageId) {
      return isAdmin() || isVillageLeader(villageId);
    }

    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAdmin() || request.auth.uid == userId;
      allow delete: if isAdmin();
    }

    // Villages collection
    match /villages/{villageId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();

      // Households subcollection
      match /households/{householdId} {
        allow read: if isAdminOrVillageLeader(villageId);
        allow write: if isAdminOrVillageLeader(villageId);

        // Residents subcollection
        match /residents/{residentId} {
          allow read: if isAdminOrVillageLeader(villageId);
          allow write: if isAdminOrVillageLeader(villageId);
        }
      }
    }

    // Tasks collection
    match /tasks/{taskId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin();
      allow update: if isAdmin() ||
        (resource.data.assignedTo.hasAny([get(/databases/$(database)/documents/users/$(request.auth.uid)).data.villageId]));
      allow delete: if isAdmin();

      match /reports/{reportId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update, delete: if isAdmin() || request.auth.uid == resource.data.submittedBy;
      }
    }

    // Messages - admin only (SMS feature restricted to commune_admin)
    match /messages/{messageId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // Requests - public can submit
    match /requests/{requestId} {
      allow read: if isAdmin() || request.auth.uid == resource.data.submittedBy;
      allow create: if true;
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Announcements
    match /announcements/{announcementId} {
      allow read: if resource.data.isPublished == true || isAdmin();
      allow write: if isAdmin();
    }
  }
}
</file>

<file path="requirements.txt">
# Diên Sanh Chatbot - Python Dependencies
# Compatible with Python 3.12+

# Web scraping
playwright>=1.40.0
beautifulsoup4>=4.12.0
lxml>=5.0.0

# Vector store - using lightweight alternative for Python 3.14 compatibility
chromadb-client>=0.5.0  # Client-only, no onnxruntime dependency

# For embeddings, we'll use the API instead of local models
# This avoids onnxruntime/torch compatibility issues

# API server
fastapi>=0.100.0
uvicorn[standard]>=0.30.0
python-multipart>=0.0.9

# LLM client (OpenAI-compatible for api.ai4u.now)
openai>=1.0.0

# Utilities
python-dotenv>=1.0.0
httpx>=0.25.0
pydantic>=2.0.0
pydantic-settings>=2.0.0

# For simple vector similarity without heavy ML dependencies
numpy>=1.26.0
scikit-learn>=1.4.0
</file>

<file path="run.sh">
#!/bin/bash
# Run script for Diên Sanh Chatbot

set -e

# Activate virtual environment
if [ -d "venv" ]; then
    source venv/bin/activate
else
    echo "❌ Virtual environment not found. Run ./setup.sh first"
    exit 1
fi

# Load environment variables
if [ -f ".env" ]; then
    export $(cat .env | grep -v '^#' | xargs)
fi

case "$1" in
    scrape)
        echo "🕷️ Running scrapers..."
        echo ""
        echo "Scraping main site..."
        python3 src/scraper/mainsite-scraper.py
        echo ""
        echo "Scraping public services portal (this may take a while)..."
        python3 src/scraper/dichvucong-scraper.py
        echo ""
        echo "✅ Scraping complete! Data saved to ./data/"
        ;;

    scrape-main)
        echo "🕷️ Scraping main site only..."
        python3 src/scraper/mainsite-scraper.py
        ;;

    scrape-services)
        echo "🕷️ Scraping public services portal..."
        python3 src/scraper/dichvucong-scraper.py
        ;;

    scrape-debug)
        echo "🔍 Debug mode - opening browser..."
        python3 src/scraper/dichvucong-scraper.py debug
        ;;

    index)
        echo "📊 Building vector index..."
        python3 src/vector-store.py
        echo "✅ Index built successfully!"
        ;;

    search)
        shift
        echo "🔍 Searching: $*"
        python3 src/vector-store.py search "$@"
        ;;

    serve)
        echo "🚀 Starting API server..."
        echo "   API: http://localhost:8000"
        echo "   Docs: http://localhost:8000/docs"
        echo ""
        cd src/api && python3 -m uvicorn api-server:app --host 0.0.0.0 --port 8000 --reload
        ;;

    widget)
        echo "🌐 Opening chat widget in browser..."
        open src/widget/chat-widget.html || xdg-open src/widget/chat-widget.html
        ;;

    all)
        echo "🚀 Running full pipeline..."
        $0 scrape
        $0 index
        echo ""
        echo "✅ Ready! Start server with: ./run.sh serve"
        ;;

    *)
        echo "🏛️ Diên Sanh Chatbot - Commands"
        echo ""
        echo "Usage: ./run.sh <command>"
        echo ""
        echo "Commands:"
        echo "  setup          - Initial setup (run setup.sh instead)"
        echo "  scrape         - Run all scrapers"
        echo "  scrape-main    - Scrape main site only"
        echo "  scrape-services - Scrape public services portal only"
        echo "  scrape-debug   - Debug scraper with visible browser"
        echo "  index          - Build vector search index"
        echo "  search <query> - Test search functionality"
        echo "  serve          - Start API server"
        echo "  widget         - Open chat widget in browser"
        echo "  all            - Run scrape + index (full pipeline)"
        echo ""
        ;;
esac
</file>

<file path="setup.sh">
#!/bin/bash
# Setup script for Diên Sanh Chatbot

set -e

echo "🏛️ Diên Sanh Chatbot - Setup"
echo "================================"

# Check Python version
python3 --version || { echo "❌ Python 3 is required"; exit 1; }

# Create virtual environment
if [ ! -d "venv" ]; then
    echo "📦 Creating virtual environment..."
    python3 -m venv venv
fi

# Activate virtual environment
source venv/bin/activate

# Install dependencies
echo "📦 Installing Python dependencies..."
pip install --upgrade pip
pip install -r requirements.txt

# Install Playwright browsers
echo "🌐 Installing Playwright browsers..."
playwright install chromium

# Create data directory
mkdir -p data

# Check for API key
if [ ! -f ".env" ] || ! grep -q "AI4U_API_KEY" .env; then
    echo ""
    echo "⚠️  API key not found in .env file"
    echo "Please add your API key:"
    echo ""
    echo "  echo 'AI4U_API_KEY=your_key_here' >> .env"
    echo ""
fi

echo ""
echo "✅ Setup complete!"
echo ""
echo "Next steps:"
echo "  1. Add your API key: echo 'AI4U_API_KEY=your_key' >> .env"
echo "  2. Run scrapers: ./run.sh scrape"
echo "  3. Build index: ./run.sh index"
echo "  4. Start server: ./run.sh serve"
</file>

</files>
